<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c5f2d">
    <link rel="manifest" href="/manifest.json">
    <title>Checkout - Mountain Made 2.0</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-enhancements.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand"><span class="logo-icon">üèîÔ∏è</span>Mountain Made 2.0</a>
            <ul class="navbar-menu">
                <li><a href="/">Home</a></li>
                <li><a href="/products">Products</a></li>
            </ul>
            <div class="navbar-actions">
                <div id="auth-buttons"><a href="/login" class="btn btn-secondary btn-sm">Login</a></div>
                <div id="user-menu" class="hidden flex gap-2" style="align-items: center;">
                    <a href="/orders" class="icon-button" title="My Orders">
                        <i class="fas fa-shopping-bag"></i>
                    </a>
                    <a href="/cart" class="icon-button"><i class="fas fa-shopping-cart"></i><span id="cart-badge" class="cart-badge hidden">0</span></a>
                    <div class="account-menu">
                        <button id="account-toggle" class="icon-button" title="Account">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div id="account-dropdown" class="account-dropdown hidden">
                            <div class="account-section">
                                <strong>Account</strong>
                                <button class="account-link" onclick="openProfileModal()">Edit Profile</button>
                            </div>
                            <div class="account-section">
                                <strong>Billing Management</strong>
                                <div class="account-text">Payment methods: GPay / Cash on Delivery</div>
                                <div class="account-text">UPI ID: <span id="billing-upi">mountainmade@upi</span></div>
                                <div class="account-text">Bank: Mountain Made Foods</div>
                                <button id="manage-billing-btn" class="account-link" type="button">Manage Billing Details</button>
                            </div>
                            <div class="account-section">
                                <strong>Appearance</strong>
                                <button id="theme-toggle" class="account-link">Toggle Dark / Light</button>
                            </div>
                            <div class="account-section">
                                <button id="account-logout" class="account-link account-link-danger">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
                <button class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <section class="container">
        <div class="section-title"><h2>Checkout</h2></div>
        <div class="checkout-layout">
            <form id="checkout-form" novalidate>
                <div class="card" style="margin-bottom: 1.5rem;">
                    <div class="card-content">
                        <div class="checkout-header-row">
                            <h3>Shipping Information</h3>
                            <a href="/addresses" class="btn btn-sm btn-secondary">
                                <i class="fas fa-cog"></i> Manage Addresses
                            </a>
                        </div>
                        
                        <div id="saved-addresses" style="margin-bottom: 1.5rem;"></div>
                        
                        <div id="address-form" style="display: none;">
                            <div class="form-group">
                                <label class="form-label">Full Name</label>
                                <input type="text" id="name" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address Line 1</label>
                                <input type="text" id="address" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Address Line 2</label>
                                <input type="text" id="address2" class="form-input">
                            </div>
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                                <div class="form-group">
                                    <label class="form-label">City</label>
                                    <input type="text" id="city" class="form-input" required>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">State</label>
                                    <input type="text" id="state" class="form-input" required>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Zip Code</label>
                                <input type="text" id="zip" class="form-input" required>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Phone</label>
                                <input type="tel" id="phone" class="form-input" required>
                            </div>
                            <div class="form-group" style="margin-top: 0.75rem;">
                                <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem; font-weight: 500;">
                                    <input type="checkbox" id="save_address" style="width: auto;">
                                    Save this address to my delivery addresses
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card">
                    <div class="card-content">
                        <h3 style="margin-bottom: 1.5rem;">Payment Method</h3>
                        <div class="form-group">
                            <label class="form-label">Select Payment</label>
                            <select id="payment_method" class="form-select" required>
                                <option value="gpay">Google Pay (UPI)</option>
                                <option value="cash_on_delivery">Cash on Delivery</option>
                            </select>
                        </div>
                        <div id="gpay-details" class="gpay-details hidden">
                            <div class="form-group">
                                <label class="form-label">GPay detail to share</label>
                                <select id="gpay-detail-type" class="form-select">
                                    <option value="upi">UPI ID</option>
                                    <option value="phone">Phone Number</option>
                                    <option value="qr">QR Code / Link</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label id="gpay-detail-label" class="form-label">UPI ID</label>
                                <input type="text" id="gpay-detail-value" class="form-input" placeholder="e.g. name@upi">
                                <div class="form-help">This is shared only with the owner for payment confirmation.</div>
                            </div>
                            <div class="form-help" id="gpay-prefill-hint">Prefilled from your Billing Management details.</div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Order Notes (Optional)</label>
                            <textarea id="notes" class="form-textarea"></textarea>
                        </div>
                    </div>
                </div>
            </form>
            <div class="checkout-summary-wrapper">
                <div class="card" style="margin-bottom: 1rem;">
                    <div class="card-content">
                        <h3 style="margin-bottom: 1.5rem;">Order Summary</h3>
                        <div id="order-items" style="margin-bottom: 1rem;"></div>
                        <div id="delivery-options" class="delivery-options" style="border-top: 1px solid var(--border); padding-top: 1rem; margin-top: 0.75rem;">
                            <h4 style="margin: 0 0 0.75rem; font-size: 0.95rem;">Delivery Options</h4>
                            <div class="delivery-option">
                                <label style="display:flex; align-items:flex-start; gap:0.5rem; cursor:pointer;">
                                    <input type="radio" name="delivery_speed" value="standard" checked onchange="selectDeliverySpeed('standard')" style="margin-top:0.2rem;">
                                    <span>
                                        <strong>Standard Delivery</strong>
                                        <span style="display:block; font-size:0.85rem; color: var(--text-secondary);">3-5 days ¬∑ Free</span>
                                    </span>
                                </label>
                            </div>
                            <div class="delivery-option" id="fast-delivery-option">
                                <label style="display:flex; align-items:flex-start; gap:0.5rem; cursor:pointer;">
                                    <input type="radio" name="delivery_speed" value="fast" onchange="selectDeliverySpeed('fast')" style="margin-top:0.2rem;">
                                    <span>
                                        <strong>Fast Delivery</strong>
                                        <span style="display:block; font-size:0.85rem; color: var(--text-secondary);">
                                            1-2 days ¬∑ <span id="fast-delivery-charge-label">‚Çπ0.00</span>
                                        </span>
                                        <span class="delivery-option-note">Fast delivery charge is managed from the Admin &gt; Site Settings.</span>
                                    </span>
                                </label>
                            </div>
                        </div>

                        <div style="border-top: 2px solid var(--border); padding-top: 1rem; margin-top: 1rem;">
                            <div style="display:flex; justify-content:space-between; font-size:0.95rem; margin-bottom:0.35rem; color: var(--text-secondary);">
                                <span>Subtotal</span>
                                <span id="order-subtotal">‚Çπ0.00</span>
                            </div>
                            <div style="display:flex; justify-content:space-between; font-size:0.95rem; margin-bottom:1rem; color: var(--text-secondary);">
                                <span>Delivery</span>
                                <span id="order-delivery">Free</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; font-size: 1.1rem; margin-bottom: 1.5rem; font-weight:600;">
                                <strong>Total:</strong><strong id="order-total" style="color: var(--primary);">‚Çπ0.00</strong>
                            </div>
                            <button type="submit" form="checkout-form" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-check"></i> Place Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Billing Management Modal -->
    <div id="billing-modal" class="billing-modal hidden" aria-hidden="true">
        <div class="billing-modal-dialog">
            <h3 style="margin-top:0; margin-bottom:0.5rem;">Manage Billing Details</h3>
            <p style="color: var(--text-light); margin-top:0;">These details prefill your GPay options during checkout.</p>
            <div class="form-group" style="margin-top: 1rem;">
                <label class="form-label">Preferred GPay detail</label>
                <select id="billing-preferred" class="form-select">
                    <option value="upi">UPI ID</option>
                    <option value="phone">Phone Number</option>
                    <option value="qr">QR Code / Link</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">UPI ID</label>
                <input type="text" id="billing-upi-input" class="form-input" placeholder="yourname@upi">
            </div>
            <div class="form-group">
                <label class="form-label">GPay Phone Number</label>
                <input type="text" id="billing-phone-input" class="form-input" placeholder="10-digit phone">
            </div>
            <div class="form-group">
                <label class="form-label">QR Code Link / Note</label>
                <input type="text" id="billing-qr-input" class="form-input" placeholder="https://... or note about QR">
            </div>
            <div class="billing-modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal('billing-modal')">Cancel</button>
                <button type="button" id="billing-save" class="btn btn-primary">Save Billing</button>
            </div>
        </div>
    </div>

    <!-- Order Status Modal -->
    <div id="order-status-modal" class="order-modal-overlay hidden">
        <div class="order-modal">
            <div id="order-status-content"></div>
        </div>
    </div>

    <style>
        .checkout-layout {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 2rem;
            align-items: flex-start;
        }

        .checkout-summary-wrapper {
            position: sticky;
            top: 100px;
        }

        .checkout-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        /* Saved delivery addresses styling */
        #saved-addresses {
            margin-bottom: 1.5rem;
        }

        .saved-addresses-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        .saved-addresses-header h4 {
            margin: 0;
            font-size: 1rem;
        }

        .saved-addresses-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(230px, 1fr));
            gap: 0.75rem;
        }

        .address-option {
            background: var(--surface);
            border-radius: 8px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease, background-color 0.2s ease;
        }

        .address-option.selected {
            border-color: var(--primary) !important;
            box-shadow: 0 0 0 1px rgba(44, 95, 45, 0.15);
            background: #f7faf7;
        }

        .address-label-row {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .address-label-chip {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.15rem 0.55rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: rgba(0,0,0,0.03);
        }

        .address-default-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.1rem 0.5rem;
            border-radius: 999px;
            font-size: 0.7rem;
            background: var(--primary);
            color: #fff;
            margin-left: 0.35rem;
        }

        @media (max-width: 900px) {
            .checkout-layout {
                grid-template-columns: 1fr;
            }

            .checkout-summary-wrapper {
                position: static;
            }
        }

        @media (max-width: 600px) {
            .checkout-layout {
                gap: 1.5rem;
            }

            .checkout-header-row a.btn {
                width: 100%;
                text-align: center;
            }
        }

        .order-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1200;
            padding: 1rem;
        }

        .order-modal {
            position: relative;
            background: var(--background, #fff);
            border-radius: 12px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
            max-width: 420px;
            width: 100%;
            padding: 2rem 1.5rem;
            text-align: center;
        }

        .order-modal-close {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            border: none;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            font-size: 1.1rem;
            padding: 0.25rem;
        }

        .order-modal-close:hover {
            color: var(--text-primary);
        }

        .order-modal-icon {
            width: 64px;
            height: 64px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.8rem;
        }

        .order-modal-icon.processing {
            background: rgba(59, 130, 246, 0.1);
            color: #2563eb;
        }

        .order-modal-icon.success {
            background: rgba(16, 185, 129, 0.1);
            color: #059669;
        }

        .order-modal-title {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
        }

        .order-modal-text {
            font-size: 0.95rem;
            color: var(--text-secondary);
            margin-bottom: 1.5rem;
        }

        .order-modal-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            justify-content: center;
        }

        .order-modal-actions .btn {
            min-width: 140px;
        }

        /* GPay Details */
        .gpay-details {
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 1rem;
            background: var(--surface);
            margin-bottom: 1rem;
        }

        .gpay-details .form-help {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        /* Billing Modal */
        .billing-modal {
            position: fixed;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
        }

        .billing-modal.hidden {
            display: none;
        }

        .billing-modal-dialog {
            background: var(--background);
            border-radius: 12px;
            max-width: 480px;
            width: 92%;
            padding: 1.5rem;
            box-shadow: 0 20px 50px rgba(0,0,0,0.25);
            border: 1px solid var(--border);
        }

        .billing-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .delivery-options {
            background: var(--surface);
            border-radius: 8px;
            padding: 0.9rem 0.9rem 0.75rem;
            margin-bottom: 0.5rem;
        }

        .delivery-option {
            padding: 0.35rem 0;
        }

        .delivery-option-note {
            display: block;
            font-size: 0.78rem;
            color: var(--text-muted);
            margin-top: 0.2rem;
        }

        /* Account Dropdown Styles */
        .account-menu {
            position: relative;
        }

        .account-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem);
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            min-width: 280px;
            z-index: 1000;
            border: 1px solid var(--border-primary);
        }

        .account-dropdown.hidden {
            display: none;
        }

        .account-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .account-section:last-child {
            border-bottom: none;
        }

        .account-section strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .account-link {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 0.2s;
            display: block;
            text-align: left;
            margin-top: 0.5rem;
        }

        .account-link:hover {
            background: var(--primary-100);
            border-color: var(--primary-400);
        }

        .account-link-danger {
            background: var(--error-bg);
            color: var(--error);
            border-color: var(--error);
        }

        .account-link-danger:hover {
            background: var(--error);
            color: white;
        }

        .account-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            padding: 0.25rem 0;
        }

        /* Dark Mode Styles */
        body.dark-mode {
            background-color: #1a1a1a;
            color: #e0e0e0;
        }

        body.dark-mode .navbar {
            background: #2d2d2d;
            border-bottom-color: #404040;
        }

        body.dark-mode .card,
        body.dark-mode .account-dropdown {
            background: #2d2d2d;
            border-color: #404040;
        }

        body.dark-mode .form-input,
        body.dark-mode .form-select,
        body.dark-mode .form-textarea {
            background: #2d2d2d;
            color: #e0e0e0;
            border-color: #404040;
        }
    </style>

    <script src="/js/main.js"></script>
    <script>
        let cartData = null;
        let userAddresses = [];
        let selectedAddressId = null;
        let checkoutCartSubtotal = 0;
        let checkoutDeliverySpeed = 'standard';
        let checkoutSettings = {
            fastDeliveryEnabled: false,
            fastDeliveryCharge: 0
        };

        function setManualAddressRequired(isRequired) {
            const ids = ['name', 'address', 'city', 'state', 'zip', 'phone'];
            ids.forEach(id => {
                const input = document.getElementById(id);
                if (input) input.required = isRequired;
            });
        }

        async function loadCheckout() {
            cartData = await cart.fetch();
            if (!cartData || cartData.cartItems.length === 0) {
                window.location.href = '/cart';
                return;
            }

            checkoutCartSubtotal = parseFloat(cartData.total || 0);
            
            document.getElementById('order-items').innerHTML = cartData.cartItems.map(item => {
                const priceBlock = (() => {
                    const base = item.original_price != null ? parseFloat(item.original_price) : null;
                    const sale = item.price != null ? parseFloat(item.price) : null;
                    const showDiscount = base != null && sale != null && sale < base;
                    if (showDiscount) {
                        return `<span style="text-decoration: line-through; color: #d14343; font-size: 0.9em; margin-right: 6px;">${formatCurrency(base)}</span><span style="color: var(--primary); font-weight: 700;">${formatCurrency(sale)}</span>`;
                    }
                    return sale != null ? formatCurrency(sale) : '‚Äî';
                })();

                return `<div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem; gap:0.75rem; align-items:center;">
                    <span>
                        <div>${item.name}</div>
                        <div style="display:flex; align-items:center; gap:0.4rem; color: var(--text-secondary); font-size: 0.9rem; margin-top:0.2rem;">
                            <label for="checkout-qty-${item.id}" style="font-size:0.8rem;">Qty</label>
                            <input type="number"
                                   id="checkout-qty-${item.id}"
                                   value="${item.quantity}"
                                   min="1"
                                   max="${item.stock_quantity || ''}"
                                   style="width:60px; padding:0.2rem 0.35rem; font-size:0.85rem; border:1px solid var(--border); border-radius:4px;"
                                   onchange="updateCheckoutQuantity(${item.id}, this.value)">
                            <span>√ó ${priceBlock}</span>
                        </div>
                    </span>
                    <strong>${formatCurrency(item.subtotal)}</strong>
                </div>`;
            }).join('');
            updateOrderSummaryTotals();
            
            await loadUserAddresses();
        }

        function updateOrderSummaryTotals() {
            const subtotalEl = document.getElementById('order-subtotal');
            const deliveryEl = document.getElementById('order-delivery');
            const totalEl = document.getElementById('order-total');

            const deliveryCharge = checkoutDeliverySpeed === 'fast' && checkoutSettings.fastDeliveryEnabled
                ? (checkoutSettings.fastDeliveryCharge || 0)
                : 0;

            const subtotal = checkoutCartSubtotal || 0;
            const total = subtotal + deliveryCharge;

            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if (deliveryEl) {
                if (deliveryCharge > 0) {
                    deliveryEl.textContent = formatCurrency(deliveryCharge);
                } else {
                    deliveryEl.textContent = 'Free';
                }
            }
            if (totalEl) totalEl.textContent = formatCurrency(total);
        }

        function selectDeliverySpeed(speed) {
            if (speed === 'fast' && !checkoutSettings.fastDeliveryEnabled) {
                // If fast delivery is disabled in settings, fall back to standard
                checkoutDeliverySpeed = 'standard';
                const standardRadio = document.querySelector('input[name="delivery_speed"][value="standard"]');
                const fastRadio = document.querySelector('input[name="delivery_speed"][value="fast"]');
                if (fastRadio) fastRadio.checked = false;
                if (standardRadio) standardRadio.checked = true;
            } else {
                checkoutDeliverySpeed = speed === 'fast' ? 'fast' : 'standard';
            }
            updateOrderSummaryTotals();
        }

        async function updateCheckoutQuantity(itemId, quantity) {
            const qty = parseInt(quantity, 10);
            if (!qty || qty < 1) {
                // Reset to current value from cartData if invalid
                const current = cartData?.cartItems?.find(i => i.id === itemId);
                const input = document.getElementById(`checkout-qty-${itemId}`);
                if (current && input) input.value = current.quantity;
                return;
            }
            try {
                await cart.update(itemId, qty);
                await loadCheckout();
            } catch (err) {
                console.error('Failed to update quantity in checkout:', err);
                showAlert('Failed to update quantity. Please try again.', 'error');
            }
        }

        async function loadUserAddresses() {
            try {
                const data = await api.get('/addresses');
                userAddresses = data.addresses;
                renderAddresses();
            } catch (error) {
                console.error('Failed to load addresses:', error);
                // Show manual form if no addresses
                document.getElementById('address-form').style.display = 'block';
                setManualAddressRequired(true);
                const user = await api.get('/auth/profile');
                document.getElementById('name').value = user.user.full_name;
                document.getElementById('phone').value = user.user.phone || '';
            }
        }

        function renderAddresses() {
            const container = document.getElementById('saved-addresses');
            
            if (userAddresses.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 2rem; background: var(--surface); border-radius: 8px;">
                        <i class="fas fa-map-marker-alt" style="font-size: 2rem; color: var(--text-secondary); margin-bottom: 1rem;"></i>
                        <p style="color: var(--text-secondary); margin-bottom: 1rem;">No saved addresses</p>
                        <button type="button" class="btn btn-primary btn-sm" onclick="showManualAddressForm()">
                            <i class="fas fa-plus"></i> Add Address Manually
                        </button>
                    </div>
                `;
                return;
            }
            
            const defaultAddress = userAddresses.find(a => a.is_default) || userAddresses[0];
            selectedAddressId = defaultAddress.id;
            
            const countText = userAddresses.length === 1
                ? '1 saved delivery address'
                : `${userAddresses.length} saved delivery addresses`;

            container.innerHTML = `
                <div class="saved-addresses-header">
                    <h4><i class="fas fa-map-marker-alt" style="margin-right: 0.35rem;"></i>${countText}</h4>
                    <button type="button" class="btn btn-secondary btn-sm" onclick="showManualAddressForm()">
                        <i class="fas fa-plus"></i> Use Different Address
                    </button>
                </div>
                <div class="saved-addresses-grid">
                    ${userAddresses.map(addr => `
                        <div class="address-option ${addr.id === selectedAddressId ? 'selected' : ''}" 
                             style="padding: 0.9rem 0.9rem 0.85rem; border: 2px solid ${addr.id === selectedAddressId ? 'var(--primary)' : 'var(--border)'}; cursor: pointer;" 
                             onclick="selectAddress(${addr.id})" id="address-option-${addr.id}">
                            <div style="display: flex; align-items: flex-start; gap: 0.6rem;">
                                <input type="radio" name="address" value="${addr.id}" ${addr.id === selectedAddressId ? 'checked' : ''} 
                                       onchange="selectAddress(${addr.id})">
                                <div style="flex: 1;">
                                    <div class="address-label-row">
                                        <span class="address-label-chip">
                                            <i class="fas fa-${addr.label === 'Home' ? 'home' : addr.label === 'Work' ? 'briefcase' : 'map-marker-alt'}"></i>
                                            ${addr.label}
                                        </span>
                                        ${addr.is_default ? '<span class="address-default-badge"><i class="fas fa-star"></i> Default</span>' : ''}
                                    </div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem; line-height: 1.5;">
                                        <strong>${addr.full_name}</strong><br>
                                        ${addr.address_line1}${addr.address_line2 ? ', ' + addr.address_line2 : ''}<br>
                                        ${addr.city}, ${addr.state} ${addr.postal_code}<br>
                                        ${addr.phone}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function selectAddress(addressId) {
            selectedAddressId = addressId;
            
            // Update UI
            document.querySelectorAll('.address-option').forEach(el => {
                el.style.borderColor = 'var(--border)';
                el.classList.remove('selected');
            });
            const selected = document.getElementById(`address-option-${addressId}`);
            if (selected) {
                selected.style.borderColor = 'var(--primary)';
                selected.classList.add('selected');
                selected.querySelector('input[type="radio"]').checked = true;
            }
            
            // Hide manual form
            document.getElementById('address-form').style.display = 'none';
            setManualAddressRequired(false);
        }

        function showManualAddressForm() {
            selectedAddressId = null;
            document.getElementById('address-form').style.display = 'block';
            setManualAddressRequired(true);
            
            // Uncheck all address radios
            document.querySelectorAll('input[name="address"]').forEach(radio => {
                radio.checked = false;
            });
            document.querySelectorAll('.address-option').forEach(el => {
                el.style.borderColor = 'var(--border)';
            });
        }

        function showOrderProcessing() {
            const modal = document.getElementById('order-status-modal');
            const content = document.getElementById('order-status-content');
            if (!modal || !content) return;

            modal.classList.remove('hidden');
            content.innerHTML = `
                <button type="button" class="order-modal-close" onclick="hideOrderStatusModal()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="order-modal-icon processing">
                    <div class="spinner" style="width: 28px; height: 28px; border-width: 3px;"></div>
                </div>
                <h3 class="order-modal-title">Processing your order...</h3>
                <p class="order-modal-text">Please wait while we confirm your order details and update your cart.</p>
            `;
        }

        function showOrderSuccess(order) {
            const modal = document.getElementById('order-status-modal');
            const content = document.getElementById('order-status-content');
            if (!modal || !content) return;

            const orderNumber = order?.order_number || '‚Äî';

            modal.classList.remove('hidden');
            content.innerHTML = `
                <button type="button" class="order-modal-close" onclick="hideOrderStatusModal()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="order-modal-icon success">
                    <i class="fas fa-check"></i>
                </div>
                <h3 class="order-modal-title">Order placed successfully!</h3>
                <p class="order-modal-text">Thank you for your purchase. Your order number is <strong>${orderNumber}</strong>. You can track it anytime from the My Orders page.</p>
                <div class="order-modal-actions">
                    <button class="btn btn-primary" onclick="window.location.href='/orders'">
                        <i class="fas fa-box"></i> View My Orders
                    </button>
                    <button class="btn btn-secondary" onclick="window.location.href='/products'">
                        <i class="fas fa-store"></i> Continue Shopping
                    </button>
                </div>
            `;
        }

        function hideOrderStatusModal() {
            const modal = document.getElementById('order-status-modal');
            if (modal) {
                modal.classList.add('hidden');
            }
        }

        const BILLING_STORAGE_KEY = 'mm_billing_profile';

        function loadBillingProfile() {
            try {
                const raw = localStorage.getItem(BILLING_STORAGE_KEY);
                if (!raw) return { preferred: 'upi', upi: 'mountainmade@upi', phone: '', qr: '' };
                const parsed = JSON.parse(raw);
                return {
                    preferred: parsed.preferred || 'upi',
                    upi: parsed.upi || 'mountainmade@upi',
                    phone: parsed.phone || '',
                    qr: parsed.qr || ''
                };
            } catch (e) {
                console.warn('Billing profile parse error', e);
                return { preferred: 'upi', upi: 'mountainmade@upi', phone: '', qr: '' };
            }
        }

        function saveBillingProfile(data) {
            const current = loadBillingProfile();
            const next = { ...current, ...data };
            localStorage.setItem(BILLING_STORAGE_KEY, JSON.stringify(next));
            return next;
        }

        function formatGpayLabel(type) {
            if (type === 'phone') return 'Phone Number';
            if (type === 'qr') return 'QR Code / Link';
            return 'UPI ID';
        }

        function updateGpayLabelAndPrefill(profile) {
            const typeSelect = document.getElementById('gpay-detail-type');
            const valueInput = document.getElementById('gpay-detail-value');
            const label = document.getElementById('gpay-detail-label');
            const hint = document.getElementById('gpay-prefill-hint');

            if (!typeSelect || !valueInput || !label) return;

            const type = typeSelect.value || 'upi';
            label.textContent = formatGpayLabel(type);

            const placeholders = {
                upi: 'e.g. name@upi',
                phone: '10-digit GPay phone',
                qr: 'URL or note about your QR code'
            };
            valueInput.placeholder = placeholders[type] || 'Enter details';

            const valueByType = { upi: profile.upi, phone: profile.phone, qr: profile.qr };
            if (valueByType[type]) {
                valueInput.value = valueByType[type];
                if (hint) hint.textContent = `Prefilled with your saved ${formatGpayLabel(type)}.`;
            } else {
                valueInput.value = '';
                if (hint) hint.textContent = 'Add your detail once and we will remember it for next time.';
            }
        }

        function toggleGpayDetails() {
            const paymentSelect = document.getElementById('payment_method');
            const gpaySection = document.getElementById('gpay-details');
            if (!paymentSelect || !gpaySection) return;
            const isGpay = paymentSelect.value === 'gpay';
            gpaySection.classList.toggle('hidden', !isGpay);
        }

        function openBillingManager() {
            const profile = loadBillingProfile();
            const prefSelect = document.getElementById('billing-preferred');
            const upiInput = document.getElementById('billing-upi-input');
            const phoneInput = document.getElementById('billing-phone-input');
            const qrInput = document.getElementById('billing-qr-input');

            if (prefSelect) prefSelect.value = profile.preferred || 'upi';
            if (upiInput) upiInput.value = profile.upi || '';
            if (phoneInput) phoneInput.value = profile.phone || '';
            if (qrInput) qrInput.value = profile.qr || '';

            openModal('billing-modal');
        }

        function wireBillingUI() {
            const paymentSelect = document.getElementById('payment_method');
            const typeSelect = document.getElementById('gpay-detail-type');
            const manageBtn = document.getElementById('manage-billing-btn');
            const saveBtn = document.getElementById('billing-save');

            const profile = loadBillingProfile();
            if (typeSelect) {
                typeSelect.value = profile.preferred || 'upi';
                typeSelect.addEventListener('change', () => updateGpayLabelAndPrefill(loadBillingProfile()));
                updateGpayLabelAndPrefill(profile);
            }

            if (paymentSelect) {
                paymentSelect.addEventListener('change', toggleGpayDetails);
                toggleGpayDetails();
            }

            if (manageBtn) {
                manageBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    openBillingManager();
                });
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', () => {
                    const updated = saveBillingProfile({
                        preferred: document.getElementById('billing-preferred')?.value || 'upi',
                        upi: document.getElementById('billing-upi-input')?.value || '',
                        phone: document.getElementById('billing-phone-input')?.value || '',
                        qr: document.getElementById('billing-qr-input')?.value || ''
                    });
                    updateGpayLabelAndPrefill(updated);
                    closeModal('billing-modal');
                    showAlert('Billing details saved.', 'success');
                });
            }
        }

        async function loadCheckoutSettings() {
            try {
                const resp = await api.get('/products/settings');
                const settings = resp.settings || {};

                const enabledRaw = (settings.fast_delivery_enabled ?? 'false').toString().toLowerCase();
                const enabled = enabledRaw === 'true';
                let charge = settings.fast_delivery_charge != null ? parseFloat(settings.fast_delivery_charge) : 0;
                if (Number.isNaN(charge) || charge < 0) {
                    charge = 0;
                }

                checkoutSettings.fastDeliveryEnabled = enabled;
                checkoutSettings.fastDeliveryCharge = charge;

                const fastOption = document.getElementById('fast-delivery-option');
                const fastLabel = document.getElementById('fast-delivery-charge-label');
                const fastRadio = document.querySelector('input[name="delivery_speed"][value="fast"]');
                const standardRadio = document.querySelector('input[name="delivery_speed"][value="standard"]');

                if (fastLabel) {
                    fastLabel.textContent = formatCurrency(charge);
                }

                if (!enabled) {
                    if (fastOption) fastOption.style.display = 'none';
                    // Ensure we default back to standard if fast was selected
                    checkoutDeliverySpeed = 'standard';
                    if (fastRadio) fastRadio.checked = false;
                    if (standardRadio) standardRadio.checked = true;
                } else {
                    if (fastOption) fastOption.style.display = '';
                }

                updateOrderSummaryTotals();
            } catch (error) {
                console.error('Failed to load checkout settings:', error);
                // On error, keep defaults (standard delivery only / free)
                const fastOption = document.getElementById('fast-delivery-option');
                if (fastOption) fastOption.style.display = 'none';
                checkoutSettings.fastDeliveryEnabled = false;
                checkoutSettings.fastDeliveryCharge = 0;
                checkoutDeliverySpeed = 'standard';
                updateOrderSummaryTotals();
            }
        }

        document.getElementById('checkout-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            const placeOrderBtn = document.querySelector('button[form="checkout-form"]');
            
            let shippingAddress;
            
            if (selectedAddressId) {
                // Use selected saved address
                const addr = userAddresses.find(a => a.id === selectedAddressId);
                shippingAddress = {
                    address_id: addr.id,
                    full_name: addr.full_name,
                    phone: addr.phone,
                    address_line1: addr.address_line1,
                    address_line2: addr.address_line2,
                    city: addr.city,
                    state: addr.state,
                    postal_code: addr.postal_code,
                    country: addr.country
                };
            } else {
                // Use manual address form
                const nameEl = document.getElementById('name');
                const addrEl = document.getElementById('address');
                const cityEl = document.getElementById('city');
                const stateEl = document.getElementById('state');
                const zipEl = document.getElementById('zip');
                const phoneEl = document.getElementById('phone');

                if (!nameEl.value || !addrEl.value || !cityEl.value || !stateEl.value || !zipEl.value || !phoneEl.value) {
                    showAlert('Please fill in all required shipping address fields.', 'error');
                    if (nameEl) nameEl.focus();
                    return;
                }

                shippingAddress = {
                    full_name: nameEl.value,
                    address_line1: addrEl.value,
                    address_line2: document.getElementById('address2').value,
                    city: cityEl.value,
                    state: stateEl.value,
                    postal_code: zipEl.value,
                    phone: phoneEl.value,
                    country: 'USA'
                };
            }
            
            if (placeOrderBtn) {
                placeOrderBtn.disabled = true;
                placeOrderBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Placing Order...';
            }

            showOrderProcessing();

            const paymentMethod = document.getElementById('payment_method').value;
            let gpayDetailType = null;
            let gpayDetailValue = null;

            if (paymentMethod === 'gpay') {
                const typeSelect = document.getElementById('gpay-detail-type');
                const valueInput = document.getElementById('gpay-detail-value');
                gpayDetailType = typeSelect?.value || 'upi';
                gpayDetailValue = (valueInput?.value || '').trim();

                if (!gpayDetailValue) {
                    showAlert(`Please enter your ${formatGpayLabel(gpayDetailType)} for GPay.`, 'error');
                    if (valueInput) valueInput.focus();
                    hideOrderStatusModal();
                    if (placeOrderBtn) {
                        placeOrderBtn.disabled = false;
                        placeOrderBtn.innerHTML = '<i class="fas fa-check"></i> Place Order';
                    }
                    return;
                }

                saveBillingProfile({ preferred: gpayDetailType, [gpayDetailType]: gpayDetailValue });
            }

            const userNotes = document.getElementById('notes').value || '';
            const combinedNotes = paymentMethod === 'gpay'
                ? `GPay via ${formatGpayLabel(gpayDetailType)}: ${gpayDetailValue}${userNotes ? ' | ' + userNotes : ''}`
                : userNotes;

            const delivery_charge = checkoutDeliverySpeed === 'fast' && checkoutSettings.fastDeliveryEnabled
                ? (checkoutSettings.fastDeliveryCharge || 0)
                : 0;
            const totalAmount = (checkoutCartSubtotal || 0) + delivery_charge;

            const orderData = {
                shipping_address: shippingAddress,
                payment_method: paymentMethod,
                payment_details: paymentMethod === 'gpay' ? { method: gpayDetailType, value: gpayDetailValue } : null,
                notes: combinedNotes,
                total_amount: totalAmount,
                delivery_speed: checkoutDeliverySpeed,
                delivery_charge,
                items: cartData.cartItems.map(item => ({
                    product_id: item.product_id,
                    product_name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    subtotal: item.subtotal
                }))
            };

            try {
                // If using a manual address and user chose to save it, persist it first
                if (!selectedAddressId && document.getElementById('save_address')?.checked) {
                    try {
                        await api.post('/addresses', {
                            label: 'Home',
                            full_name: shippingAddress.full_name,
                            phone: shippingAddress.phone,
                            address_line1: shippingAddress.address_line1,
                            address_line2: shippingAddress.address_line2,
                            city: shippingAddress.city,
                            state: shippingAddress.state,
                            postal_code: shippingAddress.postal_code,
                            country: shippingAddress.country,
                            is_default: userAddresses.length === 0
                        });
                    } catch (addrError) {
                        console.warn('Failed to save address before order:', addrError);
                    }
                }

                const result = await api.post('/orders', orderData);

                // Reflect success state in the underlying order summary as well
                if (placeOrderBtn) {
                    placeOrderBtn.disabled = true;
                    placeOrderBtn.innerHTML = '<i class="fas fa-check"></i> Order Placed';
                }
                
                const itemsContainer = document.getElementById('order-items');
                const totalEl = document.getElementById('order-total');
                if (itemsContainer) {
                    itemsContainer.innerHTML = '<p class="text-center">Your order has been placed and the cart has been cleared.</p>';
                }
                if (totalEl) {
                    totalEl.textContent = formatCurrency(0);
                }

                showOrderSuccess(result.order);
            } catch (error) {
                hideOrderStatusModal();
                if (placeOrderBtn) {
                    placeOrderBtn.disabled = false;
                    placeOrderBtn.innerHTML = '<i class="fas fa-check"></i> Place Order';
                }
                showAlert(error.message || 'Failed to place order', 'error');
            }
        });

        // Ensure we check authentication asynchronously before loading checkout
        (async () => {
            const user = await auth.checkAuth();
            
            if (!user) {
                // Redirect to login with return URL back to checkout
                const redirect = encodeURIComponent('/checkout');
                window.location.href = `/login?redirect=${redirect}`;
            } else {
                await loadCheckout();
                await loadCheckoutSettings();
            }

            wireBillingUI();

            // Account dropdown toggle
            const accountToggle = document.getElementById('account-toggle');
            const accountDropdown = document.getElementById('account-dropdown');

            if (accountToggle && accountDropdown) {
                accountToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    accountDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.account-menu')) {
                        accountDropdown.classList.add('hidden');
                    }
                });
            }

            // Account logout handler
            const accountLogout = document.getElementById('account-logout');
            if (accountLogout) {
                accountLogout.addEventListener('click', async () => {
                    if (confirm('Are you sure you want to logout?')) {
                        await auth.logout();
                    }
                });
            }

            // Theme toggle handler
            const themeToggle = document.getElementById('theme-toggle');
            if (themeToggle) {
                // Load saved theme
                const savedTheme = localStorage.getItem('theme') || 'light';
                if (savedTheme === 'dark') {
                    document.body.classList.add('dark-mode');
                }

                themeToggle.addEventListener('click', () => {
                    document.body.classList.toggle('dark-mode');
                    const isDark = document.body.classList.contains('dark-mode');
                    localStorage.setItem('theme', isDark ? 'dark' : 'light');
                });
            }
        })();
    </script>
</body>
</html>
