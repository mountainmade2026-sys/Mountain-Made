<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Mountain Made 2.0</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-enhancements.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c5f2d;
            --primary-dark: #1e4420;
            --primary-light: #4a8f4a;
            --secondary: #97bc62;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --text-dark: #333;
            --text: #555;
            --text-muted: #888;
            --bg: #f5f5f5;
            --border: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); }
        
        /* Navbar */
        .navbar { 
            background: white; 
            box-shadow: var(--shadow); 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar-brand { 
            color: var(--primary); 
            font-size: 1.5rem; 
            font-weight: 700; 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        .navbar-actions { display: flex; align-items: center; gap: 1rem; }
        
        /* Admin Layout */
        .admin-container { 
            display: flex; 
            min-height: calc(100vh - 70px); 
            position: relative;
        }
        
        /* Sidebar */
        .admin-sidebar { 
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); 
            width: 260px; 
            height: calc(100vh - 70px);
            overflow-y: auto; 
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            transition: all 0.3s ease;
        }
        
        .sidebar-brand { 
            padding: 1.5rem 1.5rem; 
            font-size: 1.2rem; 
            font-weight: 700; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            color: white; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        
        .sidebar-section-title {
            padding: 1.5rem 1.5rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        .sidebar-section-title:first-of-type {
            margin-top: 0;
        }

        .admin-nav-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: rgba(255,255,255,0.8);
            font-size: 0.95rem;
        }

        .admin-nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .admin-nav-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: var(--secondary);
            color: white;
            font-weight: 600;
        }

        .admin-nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .admin-nav-item .badge-count {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            padding: 2rem;
            background: var(--bg);
            overflow-x: auto;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-header h1 {
            font-size: 1.8rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .admin-header h1 i {
            color: var(--primary);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.75rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.primary { border-left-color: var(--primary); }
        .stat-card.success { border-left-color: var(--success); }
        .stat-card.info { border-left-color: var(--info); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.danger { border-left-color: var(--danger); }

        .stat-card-icon {
            font-size: 2.2rem;
            margin-bottom: 0.75rem;
        }

        .stat-card.primary .stat-card-icon { color: var(--primary); }
        .stat-card.success .stat-card-icon { color: var(--success); }
        .stat-card.info .stat-card-icon { color: var(--info); }
        .stat-card.warning .stat-card-icon { color: var(--warning); }
        .stat-card.danger .stat-card-icon { color: var(--danger); }

        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0.5rem 0;
        }

        .stat-card-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Data Table */
        .data-table-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow-x: auto;
            overflow-y: hidden;
            margin-bottom: 1.5rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header h3 {
            color: var(--text-dark);
            font-size: 1.2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
        }

        .data-table thead {
            background: var(--bg);
            border-bottom: 2px solid var(--border);
        }

        .data-table thead th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .data-table tbody td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-size: 0.95rem;
        }

        .data-table tbody tr:hover {
            background: #fafafa;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: var(--warning);
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Table Actions */
        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 0.9rem;
            font-size: 0.8rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .action-btn-edit {
            background: var(--info);
            color: white;
        }

        .action-btn-edit:hover {
            background: #138496;
        }

        .action-btn-view {
            background: var(--primary);
            color: white;
        }

        .action-btn-view:hover {
            background: var(--primary-dark);
        }

        .action-btn-delete {
            background: var(--danger);
            color: white;
        }

        .action-btn-delete:hover {
            background: #c82333;
        }

        .action-btn-approve {
            background: var(--success);
            color: white;
        }

        .action-btn-approve:hover {
            background: #218838;
        }

        .action-btn-warning {
            background: var(--warning);
            color: #333;
        }

        .action-btn-warning:hover {
            background: #e0a800;
        }

        .action-btn-success {
            background: var(--success);
            color: white;
        }

        .action-btn-success:hover {
            background: #218838;
        }

        .action-btn-reject {
            background: var(--danger);
            color: white;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.3rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
        }

        .badge-danger {
            background: rgba(220, 53, 69, 0.15);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(23, 162, 184, 0.15);
            color: var(--info);
        }

        .badge-primary {
            background: rgba(44, 95, 45, 0.15);
            color: var(--primary);
        }

        .badge-secondary {
            background: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }

        /* Search and Filter */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem 1rem;
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        .search-box i {
            color: var(--text-muted);
            margin-right: 0.75rem;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.95rem;
        }

        .filter-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Generic filter toggle button (used on mobile) */
        .filter-toggle {
            display: none;
        }

        .filter-select {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Alert */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
        }

        .alert.show {
            display: flex;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid var(--warning);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            padding: 2rem;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-dark);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        /* Stock History Modal - center in screen and center title */
        #stock-history-modal {
            align-items: center;
            justify-content: center;
        }

        #stock-history-modal .modal-content {
            max-width: 900px;
            width: 90%;
            margin: 0;
            position: relative;
            left: 50%;
            transform: translateX(-50%);
        }

        #stock-history-modal .modal-header {
            position: relative;
            justify-content: center;
        }

        #stock-history-modal .modal-header h2 {
            flex: 1;
            text-align: center;
        }

        #stock-history-modal .modal-header .modal-close {
            position: absolute;
            right: 0;
            top: 0;
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--bg);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f7f0;
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .upload-area p {
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .upload-area .hint {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-action-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quick-action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .quick-action-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .quick-action-card h4 {
            color: var(--text-dark);
            font-size: 1rem;
        }

        .quick-action-card p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Mobile Menu Toggle */
        #menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
            padding: 0.5rem;
        }

        /* Utility class for hiding text labels on very small screens */
        .hide-mobile {
            display: inline;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .navbar {
                padding: 1rem;
            }

            .admin-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .admin-sidebar.mobile-open {
                transform: translateX(0);
            }

            #menu-toggle {
                display: block;
            }

            .admin-main {
                width: 100%;
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .admin-header {
                padding: 1rem;
            }

            .admin-header h1 {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }

            .navbar-brand span:not(.logo-icon) {
                display: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 1.25rem;
            }

            .stat-card-value {
                font-size: 1.5rem;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .data-table-container {
                overflow-x: auto;
            }

            /* Slightly smaller base table width so it fits better on tablets */
            .data-table {
                font-size: 0.85rem;
                min-width: 520px;
            }

            .data-table thead th,
            .data-table tbody td {
                padding: 0.75rem 0.5rem;
            }

            .table-actions {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }

            .modal {
                padding: 1rem;
            }

            .modal-content {
                padding: 1.5rem;
            }

            .admin-header {
                flex-direction: column;
                align-items: flex-start;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            /* On mobile, hide filter rows by default and show a toggle button */
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls .search-box {
                max-width: 100%;
            }

            .controls .filter-group,
            .admin-controls .filters {
                display: none;
                width: 100%;
            }

            .controls .filter-group.filters-open,
            .admin-controls .filters.filters-open {
                display: flex;
                flex-wrap: wrap;
                margin-top: 0.75rem;
            }

            .filter-toggle {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                margin-left: 0.75rem;
                margin-top: 0.75rem;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 0.75rem;
            }

            .admin-main {
                padding: 0.75rem;
            }

            /* Make the slide-in sidebar narrower on very small devices */
            .admin-sidebar {
                width: 230px;
                max-width: 80vw;
            }

            .admin-header h1 {
                font-size: 1.2rem;
            }

            .stat-card-icon {
                font-size: 1.8rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            .table-header {
                padding: 1rem;
            }

            .table-header h3 {
                font-size: 1rem;
            }

            .quick-action-card {
                padding: 1rem;
            }

            .quick-action-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .form-input, .form-textarea, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Hide long text labels beside icons where space is tight */
            .hide-mobile {
                display: none;
            }
        }

        /* Activity Timeline */
        .activity-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .activity-item {
            position: relative;
            padding-bottom: 1.5rem;
        }

        .activity-item:last-child {
            padding-bottom: 0;
        }

        .activity-icon {
            position: absolute;
            left: -2rem;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
        }

        .activity-icon.order { background: var(--info); }
        .activity-icon.register { background: var(--success); }
        .activity-icon.login { background: var(--primary); }

        .activity-content {
            background: white;
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .activity-content strong {
            color: var(--text-dark);
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <nav class="navbar">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button id="menu-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a href="/" class="navbar-brand">
                <span class="logo-icon">üèîÔ∏è</span>
                <span>Mountain Made 2.0 Admin</span>
            </a>
        </div>
        <div class="navbar-actions">
            <span id="user-name" style="color: var(--text-muted); display: none;"></span>
            <button id="logout-btn" class="btn btn-sm btn-secondary" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i> <span class="hide-mobile">Logout</span>
            </button>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-mountain"></i>
                <span>Admin Menu</span>
            </div>

            <div class="admin-nav-item" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>

            <div class="sidebar-section-title">Products</div>
            <div class="admin-nav-item" onclick="showSection('manage-products')">
                <i class="fas fa-box"></i> Manage Products
            </div>
            <div class="admin-nav-item" onclick="showSection('upload-products')">
                <i class="fas fa-upload"></i> Upload Products
            </div>
            <div class="admin-nav-item" onclick="showSection('categories')">
                <i class="fas fa-tags"></i> Categories
            </div>
            <div class="admin-nav-item" onclick="showSection('homepage-sections')">
                <i class="fas fa-star"></i> Homepage Sections
            </div>
            <div class="admin-nav-item" onclick="showSection('stock-reports')">
                <i class="fas fa-warehouse"></i> Stock Reports
            </div>

            <div class="sidebar-section-title">Orders</div>
            <div class="admin-nav-item" onclick="showSection('order-history')">
                <i class="fas fa-history"></i> Order History
            </div>
            <div class="admin-nav-item" onclick="showSection('customers-orders')">
                <i class="fas fa-shopping-bag"></i> Customers Orders
            </div>

            <div class="sidebar-section-title">Customers</div>
            <div class="admin-nav-item" onclick="showSection('customers')">
                <i class="fas fa-users"></i> Manage Customers
            </div>
            <div class="admin-nav-item" onclick="showSection('activities')">
                <i class="fas fa-clock"></i> User Activities
            </div>

            <div class="sidebar-section-title">Users</div>
            <div class="admin-nav-item" onclick="showSection('users')">
                <i class="fas fa-user-cog"></i> Manage Users
            </div>
            <div class="admin-nav-item" onclick="showSection('wholesale')">
                <i class="fas fa-building"></i> Wholesale Requests
                <span id="wholesale-badge" class="badge-count" style="display: none;">0</span>
            </div>

            <div class="sidebar-section-title">Settings</div>
            <div class="admin-nav-item" onclick="showSection('site-settings')">
                <i class="fas fa-cog"></i> Site Settings
            </div>
        </div>

        <div class="admin-main">
            <div id="alert" class="alert"></div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="admin-header">
                    <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
                    <span id="current-date" style="color: var(--text-muted); font-size: 0.9rem;"></span>
                </div>

                <div class="stats-grid" id="stats-container">
                    <div class="stat-card primary">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="quick-action-card" onclick="showSection('manage-products')">
                        <div class="quick-action-icon" style="background: var(--primary);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div>
                            <h4>Add Product</h4>
                            <p>Create new product</p>
                        </div>
                    </div>
                    <div class="quick-action-card" onclick="showSection('upload-products')">
                        <div class="quick-action-icon" style="background: var(--info);">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div>
                            <h4>Bulk Upload</h4>
                            <p>Upload multiple products</p>
                        </div>
                    </div>
                    <div class="quick-action-card" onclick="showSection('order-history')">
                        <div class="quick-action-icon" style="background: var(--warning);">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div>
                            <h4>View Orders</h4>
                            <p>Manage orders</p>
                        </div>
                    </div>
                    <div class="quick-action-card" onclick="showSection('customers')">
                        <div class="quick-action-icon" style="background: var(--success);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h4>Customers</h4>
                            <p>Manage customers</p>
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-clock"></i> Recent Orders</h3>
                        <button class="btn btn-primary btn-sm" onclick="showSection('order-history')">View All</button>
                    </div>
                    <div id="recent-orders-container">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> Low Stock Products</h3>
                        <button class="btn btn-primary btn-sm" onclick="showSection('manage-products')">View All</button>
                    </div>
                    <div id="low-stock-container">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Manage Products Section -->
            <div id="manage-products" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-box"></i> Manage Products</h1>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="product-search" placeholder="Search products..." onkeyup="filterProducts()">
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                        <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                    </button>
                    <div class="filter-group">
                        <select class="filter-select" id="category-filter" onchange="filterProducts()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>

                <div id="products-list"></div>
            </div>

            <!-- Upload Products Section -->
            <div id="upload-products" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-upload"></i> Upload Products</h1>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-file-csv"></i> Bulk Product Upload</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <h4 style="margin-bottom: 1rem;">Upload CSV File</h4>
                                <div class="upload-area" id="upload-area" onclick="document.getElementById('file-input').click()">
                                    <i class="fas fa-file-csv"></i>
                                    <p>Click to upload CSV</p>
                                    <span class="hint">Format: name, description, price, wholesale_price, stock_quantity</span>
                                </div>
                                <input type="file" id="file-input" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem;">Upload Product Images</h4>
                                <div class="upload-area" onclick="document.getElementById('image-input').click()">
                                    <i class="fas fa-image"></i>
                                    <p>Click to upload images</p>
                                    <span class="hint">Formats: JPG, PNG (Max 5MB each)</span>
                                </div>
                                <input type="file" id="image-input" accept=".jpg,.jpeg,.png" multiple style="display: none;" onchange="handleImageUpload(event)">
                            </div>
                        </div>
                        
                        <div id="upload-preview" style="margin-top: 2rem; display: none;">
                            <h4 style="margin-bottom: 1rem;">Preview Products</h4>
                            <div id="upload-preview-table"></div>
                            <button class="btn btn-success" style="margin-top: 1rem;" onclick="confirmBulkUpload()">
                                <i class="fas fa-check"></i> Confirm Upload
                            </button>
                        </div>

                        <div style="margin-top: 2rem;">
                            <h4 style="margin-bottom: 1rem;">Or enter products manually:</h4>
                            <button class="btn btn-primary" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i> Add Single Product
                            </button>
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-info-circle"></i> CSV Format Guide</h3>
                    </div>
                    <div style="padding: 2rem; overflow-x: auto;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Column</th>
                                    <th>Required</th>
                                    <th>Description</th>
                                    <th>Example</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>name</td>
                                    <td><span class="badge badge-danger">Yes</span></td>
                                    <td>Product name</td>
                                    <td>Organic Honey</td>
                                </tr>
                                <tr>
                                    <td>description</td>
                                    <td><span class="badge badge-success">No</span></td>
                                    <td>Product description</td>
                                    <td>Fresh organic honey</td>
                                </tr>
                                <tr>
                                    <td>category_id</td>
                                    <td><span class="badge badge-success">No</span></td>
                                    <td>Category ID (default: 1)</td>
                                    <td>1</td>
                                </tr>
                                <tr>
                                    <td>price</td>
                                    <td><span class="badge badge-danger">Yes</span></td>
                                    <td>Regular price</td>
                                    <td>25.99</td>
                                </tr>
                                <tr>
                                    <td>wholesale_price</td>
                                    <td><span class="badge badge-success">No</span></td>
                                    <td>Wholesale price</td>
                                    <td>18.00</td>
                                </tr>
                                <tr>
                                    <td>stock_quantity</td>
                                    <td><span class="badge badge-danger">Yes</span></td>
                                    <td>Stock quantity</td>
                                    <td>100</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categories" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-tags"></i> Categories</h1>
                    <button class="btn btn-primary" onclick="showAddCategoryModal()">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                </div>
                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="category-search" placeholder="Search categories..." onkeyup="filterCategories()">
                    </div>
                </div>
                <div id="categories-list"></div>
            </div>

            <!-- Homepage Sections -->
            <div id="homepage-sections" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-star"></i> Homepage Sections</h1>
                    <button class="btn btn-primary" onclick="showAddSectionModal()">
                        <i class="fas fa-plus"></i> Add Section
                    </button>
                </div>
                <div class="controls">
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Create custom sections like "Featured Products", "New Arrivals", etc. to display on the homepage. Assign products to these sections when adding/editing products.</p>
                </div>
                <div id="homepage-sections-list"></div>
            </div>

            <!-- Stock Reports Section -->
            <div id="stock-reports" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-warehouse"></i> Stock Reports</h1>
                    <button class="btn btn-primary" onclick="exportStockReport()">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="stock-search" placeholder="Search products..." onkeyup="filterStockReports()">
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                        <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                    </button>
                    <div class="filter-group">
                        <select class="filter-select" id="stock-status-filter" onchange="filterStockReports()">
                            <option value="">All Status</option>
                            <option value="in-stock">In Stock</option>
                            <option value="low-stock">Low Stock</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                        <select class="filter-select" id="stock-category-filter" onchange="filterStockReports()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>

                <div class="stats-grid" id="stock-stats" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-value" id="total-products-count">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-value" id="in-stock-count">0</div>
                        <div class="stat-label">In Stock</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning);">
                        <div class="stat-value" id="low-stock-count">0</div>
                        <div class="stat-label">Low Stock (‚â§10)</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger);">
                        <div class="stat-value" id="out-stock-count">0</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                </div>

                <div id="stock-reports-list"></div>
            </div>

            <!-- Order History Section -->
            <div id="order-history" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-history"></i> Order History</h1>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="order-search" placeholder="Search orders..." onkeyup="filterOrders()">
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                        <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                    </button>
                    <div class="filter-group">
                        <select class="filter-select" id="order-status-filter" onchange="filterOrders()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div id="orders-list"></div>
            </div>

            <!-- Customers Orders Section -->
            <div id="customers-orders" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-shopping-bag"></i> Customer Orders</h1>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="customer-order-search" placeholder="Search by customer..." onkeyup="filterCustomerOrders()">
                    </div>
                </div>

                <div id="customer-orders-list"></div>
            </div>

            <!-- Customers Section -->
            <div id="customers" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-users"></i> Customers</h1>
                </div>
                <div id="customers-list"></div>
            </div>

            <!-- User Activities Section -->
            <div id="activities" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-clock"></i> User Activities</h1>
                    <div class="admin-controls">
                        <div class="search-box">
                            <input type="text" id="activities-search" placeholder="Search activities..." onkeyup="filterActivities()">
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                            <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                        </button>
                        <div class="filters">
                            <select class="filter-select" id="activities-type-filter" onchange="filterActivities()">
                                <option value="">All Types</option>
                                <option value="order">Orders</option>
                                <option value="user_registered">User Registered</option>
                            </select>
                            <input type="date" class="filter-select" id="activities-date-from" onchange="filterActivities()" title="From date">
                            <input type="date" class="filter-select" id="activities-date-to" onchange="filterActivities()" title="To date">
                        </div>
                    </div>
                </div>
                <div id="activities-list"></div>
            </div>

            <!-- Manage Users Section -->
            <div id="users" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-user-cog"></i> Manage Users</h1>
                    <div class="admin-controls">
                        <div class="search-box">
                            <input type="text" id="user-search" placeholder="Search users..." onkeyup="filterUsers()">
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                            <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                        </button>
                        <div class="filters">
                            <select class="filter-select" id="user-role-filter" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="customer">Customer</option>
                                <option value="wholesale">Wholesale</option>
                            </select>
                            <select class="filter-select" id="user-status-filter" onchange="filterUsers()">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="blocked">Blocked</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="users-list"></div>
            </div>

            <!-- Wholesale Requests Section -->
            <div id="wholesale" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-building"></i> Wholesale Requests</h1>
                </div>
                <div id="wholesale-list"></div>
            </div>

            <!-- Site Settings Section -->
            <div id="site-settings" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-cog"></i> Site Settings</h1>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Site Logo</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Upload your custom logo to replace the default Mountain Made branding across all pages.</p>
                        
                        <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px;">
                                <label class="form-label">Upload Logo (JPG or PNG)</label>
                                <input type="file" id="logo-upload" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewLogo(event)">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Recommended size: 200x50px or similar aspect ratio. Max 2MB.</small>
                                
                                <button class="btn btn-primary" onclick="uploadLogo()" style="margin-top: 1rem;">
                                    <i class="fas fa-upload"></i> Upload & Save Logo
                                </button>
                                <button class="btn btn-secondary" onclick="resetLogoToDefault()" style="margin-top: 1rem; margin-left: 0.5rem;">
                                    <i class="fas fa-undo"></i> Reset to Default
                                </button>
                                <button class="btn btn-info" onclick="openEditLogoModal()" style="margin-top: 1rem; margin-left: 0.5rem;">
                                    <i class="fas fa-edit"></i> Edit Logo
                                </button>
                            </div>
                            
                            <div style="text-align: center;">
                                <label class="form-label">Preview</label>
                                <div id="logo-preview-container" style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); min-width: 250px;">
                                    <img id="logo-preview" src="" alt="Logo Preview" style="max-width: 200px; max-height: 80px; display: none;">
                                    <div id="logo-preview-placeholder" style="color: var(--text-muted); padding: 2rem;">
                                        <i class="fas fa-image" style="font-size: 3rem; opacity: 0.3;"></i>
                                        <p style="margin-top: 1rem;">No logo selected</p>
                                    </div>
                                </div>
                                <!-- Edit Logo Modal -->
                                <div id="edit-logo-modal" class="modal" style="display:none;">
                                    <div class="modal-content" style="background:white; padding:2rem; border-radius:8px; max-width:400px; margin:auto;">
                                        <h4>Edit Logo</h4>
                                        <div id="edit-logo-crop-container" style="margin-bottom:1rem;">
                                            <img id="edit-logo-crop-img" src="" style="max-width:100%; max-height:150px;">
                                        </div>
                                        <button class="btn btn-success" onclick="saveEditedLogo()"><i class="fas fa-save"></i> Save Changes</button>
                                        <button class="btn btn-secondary" onclick="closeEditLogoModal()" style="margin-left:0.5rem;"><i class="fas fa-times"></i> Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="current-logo-display" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <label class="form-label">Current Active Logo</label>
                            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); display: inline-block; margin-top: 0.5rem;">
                                <img id="current-logo-img" src="" alt="Current Logo" style="max-width: 200px; max-height: 80px;">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="data-table-container" style="margin-top: 1.5rem;">
                    <div class="table-header">
                        <h3>Homepage Headings</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                            Configure the main heading and subtitle text shown in the homepage hero section.
                            These values are stored in the database and will persist across code updates and restarts.
                        </p>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" for="homepage-hero-title">Homepage Hero Title</label>
                            <input type="text" id="homepage-hero-title" class="form-input" placeholder="e.g., Fresh from the Mountains">
                        </div>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" for="homepage-hero-subtitle">Homepage Hero Subtitle</label>
                            <textarea id="homepage-hero-subtitle" class="form-input" rows="3" placeholder="Short description text under the main heading"></textarea>
                        </div>

                        <button class="btn btn-primary" onclick="saveHomepageHeadings()">
                            <i class="fas fa-save"></i> Save Homepage Headings
                        </button>
                    </div>
                </div>

                <div class="data-table-container" style="margin-top: 1.5rem;">
                    <div class="table-header">
                        <h3>Delivery Settings</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                            Configure the Fast Delivery option that appears during checkout. The charge is added on top of the cart subtotal when customers choose Fast Delivery.
                        </p>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="fast-delivery-enabled" style="width: auto;">
                                Enable Fast Delivery at checkout
                            </label>
                        </div>

                        <div class="form-group" style="margin-bottom: 1rem; max-width: 260px;">
                            <label class="form-label" for="fast-delivery-charge">Fast Delivery Charge (‚Çπ)</label>
                            <input type="text" id="fast-delivery-charge" class="form-input" placeholder="e.g., 50">
                            <small style="color: var(--text-muted); display: block; margin-top: 0.35rem;">
                                This amount will be applied per order when Fast Delivery is selected.
                            </small>
                        </div>

                        <button class="btn btn-primary" onclick="saveDeliverySettings()">
                            <i class="fas fa-shipping-fast"></i> Save Delivery Settings
                        </button>
                    </div>
                </div>
            </div>

            <!-- Add Product Modal -->
            <div id="add-product-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Add New Product</h2>
                        <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
                    </div>
                    <form id="add-product-form" onsubmit="handleAddProduct(event)">
                        <div style="padding: 2rem; max-height: 70vh; overflow-y: auto;">
                            <div class="form-row">
                                <div>
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" id="product-name" class="form-input" placeholder="e.g., Organic Honey" required>
                                </div>
                                <div>
                                    <label class="form-label">Price (‚Çπ) *</label>
                                    <input type="number" id="product-price" class="form-input" placeholder="0.00" step="0.01" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Discount Price (‚Çπ) <small style="color: var(--text-muted); font-weight: normal;">Optional</small></label>
                                    <input type="number" id="product-discount-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Wholesale Price (‚Çπ)</label>
                                    <input type="number" id="product-wholesale-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Stock Quantity *</label>
                                    <input type="number" id="product-stock" class="form-input" placeholder="0" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Discount Price (‚Çπ, optional)</label>
                                    <input type="number" id="product-discount-price" class="form-input" placeholder="e.g., 200.00" step="0.01">
                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">Shown as sale price. Leave blank for no discount.</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Category</label>
                                    <select id="product-category" class="form-select">
                                        <option value="1">Select Category</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Min Wholesale Quantity</label>
                                    <input type="number" id="product-min-wholesale" class="form-input" placeholder="10">
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Homepage Section (Optional)</label>
                                    <select id="product-homepage-section" class="form-select">
                                        <option value="">None - Show only in Products page</option>
                                    </select>
                                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Select a section to feature this product on homepage</small>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">Description</label>
                                <textarea id="product-description" class="form-textarea" placeholder="Product description..."></textarea>
                            </div>

                            <div>
                                <label class="form-label">Product Image (JPG or PNG)</label>
                                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <input type="file" id="product-image" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewProductImage(event)">
                                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Accepted formats: JPG, PNG (Max 5MB)</small>
                                    </div>
                                    <div id="image-preview" style="display: none; text-align: center;">
                                        <img id="preview-img" src="" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearProductImage()" style="margin-top: 0.5rem;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Product</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Category Modal -->
            <div id="add-category-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Add New Category</h2>
                        <button class="modal-close" onclick="closeAddCategoryModal()">&times;</button>
                    </div>
                    <form id="add-category-form" onsubmit="handleAddCategory(event)">
                        <div style="padding: 2rem;">
                            <div>
                                <label class="form-label">Category Name *</label>
                                <input type="text" id="category-name" class="form-input" placeholder="e.g., Honey Products" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="category-description" class="form-textarea" placeholder="Category description..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Category Image (JPG or PNG)</label>
                                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <input type="file" id="category-image" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewCategoryImage(event)">
                                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Accepted formats: JPG, PNG (Max 5MB)</small>
                                    </div>
                                    <div id="category-image-preview" style="display: none; text-align: center;">
                                        <img id="category-preview-img" src="" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearCategoryImage()" style="margin-top: 0.5rem;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddCategoryModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Category</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Category Modal -->
            <div id="edit-category-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Category</h2>
                        <button class="modal-close" onclick="closeEditCategoryModal()">&times;</button>
                    </div>
                    <form id="edit-category-form" onsubmit="handleEditCategory(event)">
                        <input type="hidden" id="edit-category-id">
                        <div style="padding: 2rem; max-height: 70vh; overflow-y: auto;">
                            <div>
                                <label class="form-label">Category Name *</label>
                                <input type="text" id="edit-category-name" class="form-input" placeholder="e.g., Honey Products" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="edit-category-description" class="form-textarea" placeholder="Category description..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Category Image (JPG or PNG)</label>
                                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <input type="file" id="edit-category-image" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewEditCategoryImage(event)">
                                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Accepted formats: JPG, PNG (Max 5MB)</small>
                                    </div>
                                    <div id="edit-category-image-preview" style="display: none; text-align: center;">
                                        <img id="edit-category-preview-img" src="" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearEditCategoryImage()" style="margin-top: 0.5rem;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditCategoryModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Product Modal -->
            <div id="edit-product-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Product</h2>
                        <button class="modal-close" onclick="closeEditProductModal()">&times;</button>
                    </div>
                    <form id="edit-product-form" onsubmit="handleEditProduct(event)">
                        <input type="hidden" id="edit-product-id">
                        <div style="padding: 2rem; max-height: 70vh; overflow-y: auto;">
                            <div class="form-row">
                                <div>
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" id="edit-product-name" class="form-input" placeholder="e.g., Organic Honey" required>
                                </div>
                                <div>
                                    <label class="form-label">Price (‚Çπ) *</label>
                                    <input type="number" id="edit-product-price" class="form-input" placeholder="0.00" step="0.01" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Discount Price (‚Çπ) <small style="color: var(--text-muted); font-weight: normal;">Optional</small></label>
                                    <input type="number" id="edit-product-discount-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Wholesale Price (‚Çπ)</label>
                                    <input type="number" id="edit-product-wholesale-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Stock Quantity *</label>
                                    <input type="number" id="edit-product-stock" class="form-input" placeholder="0" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Discount Price (‚Çπ, optional)</label>
                                    <input type="number" id="edit-product-discount-price" class="form-input" placeholder="e.g., 200.00" step="0.01">
                                    <small style="color: var(--text-muted); display: block; margin-top: 0.25rem;">Shown as sale price. Leave blank for no discount.</small>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Category</label>
                                    <select id="edit-product-category" class="form-select">
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Min Wholesale Quantity</label>
                                    <input type="number" id="edit-product-min-wholesale" class="form-input" placeholder="10">
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Homepage Section (Optional)</label>
                                    <select id="edit-product-homepage-section" class="form-select">
                                        <option value="">None - Show only in Products page</option>
                                    </select>
                                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Select a section to feature this product on homepage</small>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">Description</label>
                                <textarea id="edit-product-description" class="form-textarea" placeholder="Product description..."></textarea>
                            </div>

                            <div>
                                <label class="form-label">Product Image (JPG or PNG)</label>
                                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <input type="file" id="edit-product-image" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewEditProductImage(event)">
                                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Leave empty to keep current image. Accepted formats: JPG, PNG (Max 5MB)</small>
                                    </div>
                                    <div id="edit-image-preview" style="text-align: center;">
                                        <img id="edit-preview-img" src="" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearEditProductImage()" style="margin-top: 0.5rem; display: none;" id="edit-clear-image-btn">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditProductModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Product</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Homepage Section Modal -->
            <div id="add-section-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Add Homepage Section</h2>
                        <button class="modal-close" onclick="closeAddSectionModal()">&times;</button>
                    </div>
                    <form id="add-section-form" onsubmit="handleAddSection(event)">
                        <div style="padding: 2rem;">
                            <div>
                                <label class="form-label">Section Name *</label>
                                <input type="text" id="section-name" class="form-input" placeholder="e.g., Featured Products, New Arrivals" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="section-description" class="form-textarea" placeholder="Section description (shown on homepage)..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Sort Order</label>
                                <input type="number" id="section-sort-order" class="form-input" placeholder="0" value="0">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Lower numbers appear first on homepage</small>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddSectionModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Section</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Homepage Section Modal -->
            <div id="edit-section-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Homepage Section</h2>
                        <button class="modal-close" onclick="closeEditSectionModal()">&times;</button>
                    </div>
                    <form id="edit-section-form" onsubmit="handleEditSection(event)">
                        <input type="hidden" id="edit-section-id">
                        <div style="padding: 2rem;">
                            <div>
                                <label class="form-label">Section Name *</label>
                                <input type="text" id="edit-section-name" class="form-input" placeholder="e.g., Featured Products, New Arrivals" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="edit-section-description" class="form-textarea" placeholder="Section description (shown on homepage)..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Sort Order</label>
                                <input type="number" id="edit-section-sort-order" class="form-input" placeholder="0">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Lower numbers appear first on homepage</small>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Status</label>
                                <select id="edit-section-active" class="form-select">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditSectionModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Section</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Stock Transaction History Modal -->
            <div id="stock-history-modal" class="modal">
                <div class="modal-content" style="max-width: 900px;">
                    <div class="modal-header">
                        <h2 id="stock-history-title">Transaction History</h2>
                        <button class="modal-close" onclick="closeStockHistoryModal()">&times;</button>
                    </div>
                    <div id="stock-history-body" style="padding-top: 0.5rem;"></div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
    // Admin dashboard with improved mobile handling
    (function(){
        const sectionIds = [
            'dashboard','manage-products','upload-products','categories','homepage-sections','stock-reports','order-history','customers-orders',
            'customers','activities','users','wholesale','site-settings'
        ];

        // Caches
        window._productsCache = [];
        window._categoriesCache = [];
        window._homepageSectionsCache = [];
        window._bulkUploadData = [];
        window._ordersCache = [];
        window._customersCache = [];
        window._usersCache = [];
        window._activitiesCache = [];
        window._wholesaleCache = [];

        // Toggle visibility of filter panels on mobile
        window.toggleFilters = function(button) {
            if (!button) return;

            // Prefer the nearest controls/admin-controls container
            const container = button.closest('.controls, .admin-controls');
            if (!container) return;

            const panel = container.querySelector('.filter-group, .filters');
            if (!panel) return;

            panel.classList.toggle('filters-open');
        };

        // Sidebar management
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        };

        window.closeSidebar = function() {
            const sidebar = document.getElementById('admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        };

        // Show section and load data
        window.showSection = function(id) {
            // Close sidebar on mobile
            if (window.innerWidth <= 1024) {
                closeSidebar();
            }

            sectionIds.forEach(sid => {
                const el = document.getElementById(sid);
                if (el) el.classList.remove('active');
            });
            document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
            const section = document.getElementById(id);
            if (section) section.classList.add('active');
            
            // highlight sidebar item
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                if (item.textContent.trim().toLowerCase().includes((id || '').replace(/-/g, ' '))) {
                    item.classList.add('active');
                }
            });

            // Scroll to top
            window.scrollTo(0, 0);

            // Track current section
            window._currentSection = id;

            // call loader
            switch(id) {
                case 'dashboard': loadDashboard(); break;
                case 'manage-products': loadProducts(); break;
                case 'upload-products': loadCategoriesForUpload(); break;
                case 'categories': loadCategories(); break;
                case 'homepage-sections': loadHomepageSections(); break;
                case 'stock-reports': loadStockReports(); break;
                case 'order-history': loadOrders(); break;
                case 'customers-orders': loadCustomerOrders(); break;
                case 'customers': loadCustomers(); break;
                case 'activities': loadActivities(); break;
                case 'users': loadUsers(); break;
                case 'wholesale': loadWholesaleRequests(); break;
                case 'site-settings': loadSiteSettings(); break;
            }
        };

        // Helper functions
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) container.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';
        }

        function formatCurrency(amount) {
            return '‚Çπ' + parseFloat(amount || 0).toFixed(2);
        }

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString();
        }

        window.showAlert = function(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        };

        // Loaders (simplified - add your actual API calls)
        async function loadDashboard() {
            try {
                showLoading('stats-container');
                const data = await api.get('/admin/dashboard/stats');
                
                const stats = data.stats || {
                    total_orders: 0,
                    total_revenue: 0,
                    total_customers: 0,
                    total_products: 0
                };
                
                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-card primary">
                        <div class="stat-card-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-card-label">Orders</div>
                        <div class="stat-card-value">${parseInt(stats.total_orders) || 0}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-card-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-card-label">Revenue</div>
                        <div class="stat-card-value">‚Çπ${parseFloat(stats.total_revenue || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-card-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-card-label">Customers</div>
                        <div class="stat-card-value">${parseInt(stats.total_customers) || 0}</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-card-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-card-label">Products</div>
                        <div class="stat-card-value">${parseInt(stats.total_products) || 0}</div>
                    </div>
                `;
                document.getElementById('recent-orders-container').innerHTML = '<div class="empty-state"><p>No recent orders</p></div>';
                document.getElementById('low-stock-container').innerHTML = '<div class="empty-state"><p>No low stock products</p></div>';
            } catch (error) {
                console.error('Load dashboard error:', error);
                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-card primary">
                        <div class="stat-card-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-card-label">Orders</div>
                        <div class="stat-card-value">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-card-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-card-label">Revenue</div>
                        <div class="stat-card-value">‚Çπ0.00</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-card-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-card-label">Customers</div>
                        <div class="stat-card-value">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-card-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-card-label">Products</div>
                        <div class="stat-card-value">0</div>
                    </div>
                `;
            }
        }

        async function loadProducts() {
            try {
                showLoading('products-list');
                const response = await api.get('/admin/products');
                const products = response.products || [];
                window._productsCache = products;

                // Load and cache categories for filter if not already loaded
                if (!window._categoriesCache || window._categoriesCache.length === 0) {
                    try {
                        const catResponse = await api.get('/admin/categories');
                        window._categoriesCache = catResponse.categories || [];
                    } catch (e) {
                        console.error('Error loading categories:', e);
                        window._categoriesCache = [];
                    }
                }

                // Populate category filter dropdown
                const catFilter = document.getElementById('category-filter');
                if (catFilter && window._categoriesCache) {
                    catFilter.innerHTML = '<option value="">All Categories</option>' + 
                        window._categoriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }

                // Use filterProducts to render (ensures consistency with search/filter behavior)
                filterProducts();
            } catch (error) {
                console.error('Load products error:', error);
                document.getElementById('products-list').innerHTML = '<div class="empty-state"><p>Error loading products</p></div>';
            }
        }

        async function loadCategories() {
            try {
                showLoading('categories-list');
                const response = await api.get('/admin/categories');
                const categories = response.categories || [];
                window._categoriesCache = categories;

                // Use filterCategories to render so that search applies immediately
                if (typeof window.filterCategories === 'function') {
                    window.filterCategories();
                    return;
                }

                if (categories.length === 0) {
                    document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>No categories</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                categories.forEach(c => {
                    html += `
                        <tr>
                            <td>#${c.id}</td>
                            <td>${c.name}</td>
                            <td>${c.description || '-'}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn action-btn-edit" onclick="editCategory(${c.id})"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="action-btn action-btn-delete" onclick="deleteCategory(${c.id})"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('categories-list').innerHTML = html;
            } catch (error) {
                console.error('Load categories error:', error);
                document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>Error loading categories</p></div>';
            }
        }

        async function loadHomepageSections() {
            try {
                showLoading('homepage-sections-list');
                const response = await api.get('/admin/homepage-sections');
                const sections = response.sections || [];
                window._homepageSectionsCache = sections;

                if (sections.length === 0) {
                    document.getElementById('homepage-sections-list').innerHTML = '<div class="empty-state"><p>No homepage sections. Click "Add Section" to create one.</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Sort Order</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                sections.forEach(s => {
                    html += `
                        <tr>
                            <td>#${s.id}</td>
                            <td><strong>${s.name}</strong></td>
                            <td>${s.description || '-'}</td>
                            <td>${s.sort_order}</td>
                            <td><span class="badge ${s.is_active ? 'badge-success' : 'badge-secondary'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn action-btn-edit" onclick="editSection(${s.id})"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="action-btn action-btn-delete" onclick="deleteSection(${s.id})"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('homepage-sections-list').innerHTML = html;
            } catch (error) {
                console.error('Load homepage sections error:', error);
                document.getElementById('homepage-sections-list').innerHTML = '<div class="empty-state"><p>Error loading homepage sections</p></div>';
            }
        }

        async function loadStockReports() {
            try {
                showLoading('stock-reports-list');
                const response = await api.get('/admin/stock-reports');
                const stockReports = response.stockReports || [];
                window._stockReportsCache = stockReports;

                // Load categories for filter if not already loaded
                if (!window._categoriesCache || window._categoriesCache.length === 0) {
                    try {
                        const catResponse = await api.get('/admin/categories');
                        window._categoriesCache = catResponse.categories || [];
                    } catch (e) {
                        console.error('Error loading categories:', e);
                        window._categoriesCache = [];
                    }
                }

                // Populate category filter dropdown
                const catFilter = document.getElementById('stock-category-filter');
                if (catFilter && window._categoriesCache) {
                    catFilter.innerHTML = '<option value="">All Categories</option>' + 
                        window._categoriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }

                // Update stock statistics based on full dataset
                updateStockStatistics(stockReports);

                // Use filterStockReports to render (ensures consistency with search/filter behavior)
                filterStockReports();
            } catch (error) {
                console.error('Load stock reports error:', error);
                document.getElementById('stock-reports-list').innerHTML = '<div class="empty-state"><p>Error loading stock reports</p></div>';
            }
        }

        function updateStockStatistics(stockReports) {
            const totalProducts = stockReports.length;
            const inStock = stockReports.filter(p => p.current_stock > 10).length;
            const lowStock = stockReports.filter(p => p.current_stock > 0 && p.current_stock <= 10).length;
            const outOfStock = stockReports.filter(p => p.current_stock <= 0).length;

            // Update stats cards
            document.getElementById('total-products-count').textContent = totalProducts;
            document.getElementById('in-stock-count').textContent = inStock;
            document.getElementById('low-stock-count').textContent = lowStock;
            document.getElementById('out-stock-count').textContent = outOfStock;
        }

        function renderStockReportsTable(stockReports) {
            if (stockReports.length === 0) {
                document.getElementById('stock-reports-list').innerHTML = '<div class="empty-state"><p>No products found</p></div>';
                return;
            }

            let html = '<div class="data-table-container">';
            html += '<div class="table-header"><h3>Product Stock Overview</h3></div>';
            html += '<table class="data-table"><thead><tr>' +
                '<th>Product</th>' +
                '<th>Category</th>' +
                '<th>Price</th>' +
                '<th>Initial Stock</th>' +
                '<th>Total Sold</th>' +
                '<th>Remaining Stock</th>' +
                '<th>Stock Value</th>' +
                '<th>Status</th>' +
                '<th>Actions</th>' +
                '</tr></thead><tbody>';

            stockReports.forEach(product => {
                const currentStock = parseInt(product.current_stock) || 0;
                const initialStock = parseInt(product.initial_stock) || 0;
                const totalSold = parseInt(product.total_sold) || 0;
                const price = parseFloat(product.price) || 0;
                const stockValue = currentStock * price;

                const statusClass = currentStock > 10 ? 'success' : currentStock > 0 ? 'warning' : 'danger';
                const statusText = currentStock > 10 ? 'In Stock' : currentStock > 0 ? 'Low Stock' : 'Out of Stock';

                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                ${product.images && product.images[0] ? `<img src="${product.images[0]}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border);">` : ''}
                                <div>
                                    <div style="font-weight: 600; color: var(--text-dark);">${product.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">ID: #${product.id}</div>
                                </div>
                            </div>
                        </td>
                        <td>${product.category_name || 'N/A'}</td>
                        <td>${formatCurrency(price)}</td>
                        <td>${initialStock}</td>
                        <td>${totalSold}</td>
                        <td>${currentStock}</td>
                        <td>${formatCurrency(stockValue)}</td>
                        <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn action-btn-view" onclick="viewStockHistory(${product.id})">
                                <i class="fas fa-history"></i> View History
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('stock-reports-list').innerHTML = html;
        }

        function filterStockReports() {
            if (!window._stockReportsCache) return;

            const searchTerm = (document.getElementById('stock-search')?.value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('stock-status-filter')?.value || '';
            const categoryFilter = document.getElementById('stock-category-filter')?.value || '';

            let filtered = window._stockReportsCache.filter(p => {
                // Search across multiple fields: ID, product name, category name
                // Handle ID search with or without "#" prefix
                const cleanSearch = searchTerm.replace('#', '');
                const matchesSearch = !searchTerm ||
                    String(p.id).includes(cleanSearch) ||
                    (p.name || '').toLowerCase().includes(searchTerm) ||
                    (p.category_name || '').toLowerCase().includes(searchTerm);

                // Category filter
                const matchesCategory = !categoryFilter || p.category_id == categoryFilter;

                // Status filter
                let matchesStatus = true;
                if (statusFilter) {
                    const stockQty = parseInt(p.current_stock) || 0;
                    if (statusFilter === 'in-stock' && stockQty <= 10) matchesStatus = false;
                    if (statusFilter === 'low-stock' && (stockQty <= 0 || stockQty > 10)) matchesStatus = false;
                    if (statusFilter === 'out-of-stock' && stockQty > 0) matchesStatus = false;
                }

                return matchesSearch && matchesCategory && matchesStatus;
            });

            renderStockReportsTable(filtered);
        }

        // View stock transaction history for a single product
        window.viewStockHistory = function(productId) {
            const product = (window._stockReportsCache || []).find(p => p.id === productId || p.id == productId);
            const titleEl = document.getElementById('stock-history-title');
            const bodyEl = document.getElementById('stock-history-body');
            const modal = document.getElementById('stock-history-modal');

            if (!bodyEl || !modal || !titleEl) return;

            if (!product) {
                titleEl.textContent = 'Transaction History';
                bodyEl.innerHTML = '<div class="empty-state"><p>Product not found</p></div>';
                modal.classList.add('show');
                return;
            }

            titleEl.textContent = `${product.name} - Transaction History`;

            if (product.transactions && product.transactions.length > 0) {
                // Order transactions chronologically so we can calculate stock before/after each sale
                const ordered = [...product.transactions].sort((a, b) => {
                    return new Date(a.order_date) - new Date(b.order_date);
                });

                const initialStock = parseInt(product.initial_stock) || 0;
                let runningStock = initialStock;

                let rowsHtml = '';
                ordered.forEach(t => {
                    const qty = parseInt(t.quantity) || 0;
                    const affectsStock = t.status !== 'cancelled';
                    const stockBefore = runningStock;
                    const stockAfter = affectsStock ? (runningStock - qty) : runningStock;
                    runningStock = stockAfter;

                    rowsHtml += `
                        <tr>
                            <td>${formatDate(t.order_date)}</td>
                            <td><strong>${t.order_number}</strong></td>
                            <td>
                                <div>${t.customer_name || 'Guest'}</div>
                                ${t.customer_email ? `<div style="font-size: 0.85rem; color: var(--text-muted);">${t.customer_email}</div>` : ''}
                            </td>
                            <td><strong style="color: var(--danger);">${qty}</strong></td>
                            <td>${stockBefore}</td>
                            <td>${stockAfter}</td>
                            <td>${formatCurrency(t.price)}</td>
                            <td><strong>${formatCurrency(t.subtotal)}</strong></td>
                            <td><span class="badge badge-${t.status === 'delivered' ? 'success' : t.status === 'cancelled' ? 'danger' : 'warning'}">${t.status}</span></td>
                        </tr>
                    `;
                });

                let html = '<div style="margin-bottom: 1rem; color: var(--text-muted); font-size: 0.9rem;">';
                html += `Category: <strong>${product.category_name || 'N/A'}</strong> | ID: <strong>#${product.id}</strong> | Initial Stock: <strong>${initialStock}</strong>`;
                html += '</div>';
                html += `
                    <div class="data-table-container" style="box-shadow: none;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Quantity</th>
                                    <th>Stock Before</th>
                                    <th>Stock After</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${rowsHtml}
                            </tbody>
                        </table>
                    </div>
                `;
                bodyEl.innerHTML = html;
            } else {
                bodyEl.innerHTML = '<div class="empty-state"><p>No transactions yet for this product</p></div>';
            }

            modal.classList.add('show');
        };

        window.closeStockHistoryModal = function() {
            const modal = document.getElementById('stock-history-modal');
            if (modal) modal.classList.remove('show');
        };

        function exportStockReport() {
            if (!window._stockReportsCache || window._stockReportsCache.length === 0) {
                showAlert('No stock data to export', 'warning');
                return;
            }

            // Create CSV content with detailed transaction history
            let csv = 'STOCK REPORT - ' + new Date().toLocaleDateString() + '\n\n';
            
            window._stockReportsCache.forEach(p => {
                const initialStock = parseInt(p.initial_stock) || 0;
                const soldQty = parseInt(p.total_sold) || 0;
                const currentStock = parseInt(p.current_stock) || 0;
                const price = parseFloat(p.price) || 0;
                const stockValue = currentStock * price;
                let status;
                
                if (currentStock > 10) {
                    status = 'In Stock';
                } else if (currentStock > 0) {
                    status = 'Low Stock';
                } else {
                    status = 'Out of Stock';
                }

                // Product summary
                csv += `Product: ${p.name} (ID: #${p.id})\n`;
                csv += `Category: ${p.category_name || 'N/A'}\n`;
                csv += `Price: ‚Çπ${price.toFixed(2)}\n`;
                csv += `Initial Stock: ${initialStock}\n`;
                csv += `Total Sold: ${soldQty}\n`;
                csv += `Remaining Stock: ${currentStock}\n`;
                csv += `Stock Value: ‚Çπ${stockValue.toFixed(2)}\n`;
                csv += `Status: ${status}\n\n`;

                // Transaction history
                if (p.transactions && p.transactions.length > 0) {
                    csv += 'Transaction History:\n';
                    csv += 'Date,Order Number,Customer,Email,Quantity,Price,Total,Status\n';
                    p.transactions.forEach(t => {
                        csv += `${formatDate(t.order_date)},"${t.order_number}","${t.customer_name || 'Guest'}","${t.customer_email || '-'}",${t.quantity},‚Çπ${parseFloat(t.price).toFixed(2)},‚Çπ${parseFloat(t.subtotal).toFixed(2)},${t.status}\n`;
                    });
                    csv += '\n';
                } else {
                    csv += 'No transactions yet\n\n';
                }
                
                csv += '---\n\n';
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `stock-report-detailed-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Detailed stock report exported successfully', 'success');
        }

        async function loadOrders() {
            try {
                showLoading('orders-list');
                // Fetch ALL orders without status filter to enable dynamic client-side filtering
                const resp = await api.get('/admin/orders');
                const orders = resp.orders || [];
                window._ordersCache = orders;

                // Use filterOrders to render (ensures consistency with search/filter behavior)
                filterOrders();
            } catch (error) {
                console.error('Load orders error:', error);
                document.getElementById('orders-list').innerHTML = '<div class="empty-state"><p>Error loading orders</p></div>';
            }
        }

        async function loadCustomerOrders() {
            try {
                showLoading('customer-orders-list');

                // Show only pending customer orders here so admin can confirm/reject them
                const resp = await api.get('/admin/orders?status=pending');
                const orders = resp.orders || [];
                window._customerOrdersCache = orders;

                if (!orders.length) {
                    document.getElementById('customer-orders-list').innerHTML = '<div class="empty-state"><p>No pending customer orders</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>#</th><th>Order</th><th>Customer</th><th>Total</th><th>Delivery</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
                orders.forEach(o => {
                    const statusBadgeClass = o.status === 'delivered' ? 'badge-success' : o.status === 'cancelled' ? 'badge-danger' : 'badge-warning';
                    const statusLabel = o.status || 'pending';

                    const deliverySpeed = (o.delivery_speed || 'standard').toLowerCase();
                    const deliveryCharge = o.delivery_charge != null ? parseFloat(o.delivery_charge) : 0;
                    const hasCharge = !Number.isNaN(deliveryCharge) && deliveryCharge > 0;

                    let deliveryLabel;
                    if (deliverySpeed === 'fast') {
                        deliveryLabel = hasCharge
                            ? `Fast (${formatCurrency(deliveryCharge)})`
                            : 'Fast (Free)';
                    } else {
                        deliveryLabel = hasCharge
                            ? `Standard (+${formatCurrency(deliveryCharge)})`
                            : 'Standard (Free)';
                    }

                    const actionsHtml = o.status === 'pending'
                        ? `
                            <button class="action-btn action-btn-success" onclick="updateOrderStatus(${o.id}, 'processing')">
                                <i class="fas fa-check"></i> Confirm
                            </button>
                            <button class="action-btn action-btn-reject" onclick="updateOrderStatus(${o.id}, 'cancelled')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                          `
                        : '<span class="badge badge-secondary">No actions</span>';

                    html += `
                        <tr>
                            <td>#${o.id}</td>
                            <td>${o.order_number || '-'}</td>
                            <td>${o.full_name || 'Guest'}<br><small>${o.email || ''}</small></td>
                            <td>${formatCurrency(o.total_amount)}</td>
                            <td>${deliveryLabel}</td>
                            <td><span class="badge ${statusBadgeClass}">${statusLabel}</span></td>
                            <td>${formatDate(o.created_at)}</td>
                            <td>
                                <div class="table-actions">
                                    ${actionsHtml}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                document.getElementById('customer-orders-list').innerHTML = html;
            } catch (error) {
                console.error('Load customer orders error:', error);
                document.getElementById('customer-orders-list').innerHTML = '<div class="empty-state"><p>Error loading customer orders</p></div>';
            }
        }

        async function loadCustomers() {
            try {
                showLoading('customers-list');
                const resp = await api.get('/admin/customers');
                const customers = resp.customers || [];
                window._customersCache = customers;

                if (!customers.length) {
                    document.getElementById('customers-list').innerHTML = '<div class="empty-state"><p>No customers found</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Orders</th><th>Total Spent</th><th>Joined</th></tr></thead><tbody>';
                customers.forEach(c => {
                    html += `
                        <tr>
                            <td>${c.full_name}</td>
                            <td>${c.email}</td>
                            <td>${c.phone || '-'}</td>
                            <td>${c.role}</td>
                            <td>${c.total_orders}</td>
                            <td>${formatCurrency(c.total_spent)}</td>
                            <td>${formatDate(c.created_at)}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                document.getElementById('customers-list').innerHTML = html;
            } catch (error) {
                console.error('Load customers error:', error);
                document.getElementById('customers-list').innerHTML = '<div class="empty-state"><p>Error loading customers</p></div>';
            }
        }

        async function loadUsers() {
            try {
                showLoading('users-list');
                const resp = await api.get('/admin/users');
                const users = resp.users || [];
                window._usersCache = users;

                // Use filterUsers to render so that search/filters apply immediately
                if (typeof window.filterUsers === 'function') {
                    window.filterUsers();
                } else {
                    // Fallback to simple render if filterUsers is not defined
                    if (!users.length) {
                        document.getElementById('users-list').innerHTML = '<div class="empty-state"><p>No users found</p></div>';
                        return;
                    }

                    let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Phone</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
                    users.forEach(u => {
                        const isBlocked = u.is_blocked || false;
                        const isAdmin = u.role === 'admin';
                        const statusBadge = isBlocked 
                            ? '<span class="badge badge-danger">Blocked</span>' 
                            : '<span class="badge badge-success">Active</span>';
                        
                        html += `
                            <tr>
                                <td>${u.full_name}</td>
                                <td>${u.email}</td>
                                <td><span class="badge badge-${u.role === 'admin' ? 'info' : u.role === 'wholesale' ? 'warning' : 'secondary'}">${u.role}</span></td>
                                <td>${u.phone || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>${formatDate(u.created_at)}</td>
                                <td>
                                    <div class="table-actions">
                                        ${!isAdmin ? `
                                            <button class="action-btn ${isBlocked ? 'action-btn-success' : 'action-btn-warning'}" 
                                                    onclick="toggleBlockUser(${u.id}, ${!isBlocked})">
                                                <i class="fas fa-${isBlocked ? 'unlock' : 'ban'}"></i> ${isBlocked ? 'Unblock' : 'Block'}
                                            </button>
                                        ` : '<span class="text-muted">Protected</span>'}
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                    document.getElementById('users-list').innerHTML = html;
                }
            } catch (error) {
                console.error('Load users error:', error);
                document.getElementById('users-list').innerHTML = '<div class="empty-state"><p>Error loading users</p></div>';
            }
        }

        window.toggleBlockUser = async function(userId, blockStatus) {
            if (!confirm(`Are you sure you want to ${blockStatus ? 'block' : 'unblock'} this user?`)) {
                return;
            }

            try {
                const response = await api.put(`/admin/users/${userId}/block`, { isBlocked: blockStatus });
                showAlert(response.message || `User ${blockStatus ? 'blocked' : 'unblocked'} successfully`, 'success');
                loadUsers(); // Reload the users list
            } catch (error) {
                console.error('Block user error:', error);
                showAlert(error.error || 'Failed to update user status', 'error');
            }
        };

        async function loadActivities() {
            try {
                showLoading('activities-list');

                if (!window.api || typeof window.api.get !== 'function') {
                    console.warn('Admin API not initialized; cannot load activities');
                    document.getElementById('activities-list').innerHTML = '<div class="empty-state"><p>API not initialized. Please reload the page.</p></div>';
                    return;
                }

                const resp = await window.api.get('/admin/activities');
                
                if (!resp || typeof resp !== 'object') {
                    throw new Error('Invalid response from server');
                }

                const activities = resp.activities || [];
                window._activitiesCache = activities;

                // Use filterActivities to render so that search/filters apply immediately
                if (typeof window.filterActivities === 'function') {
                    window.filterActivities();
                } else {
                    if (!activities.length) {
                        document.getElementById('activities-list').innerHTML = '<div class="empty-state"><p>No recent activities found</p></div>';
                        return;
                    }

                    let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Type</th><th>User</th><th>Details</th><th>Date</th></tr></thead><tbody>';
                    activities.forEach(a => {
                        const activityType = a.activity_type || 'unknown';
                        const userName = a.full_name || 'Unknown User';
                        const userEmail = a.email || '';
                        const createdAt = a.created_at || '';
                        
                        let label = 'Unknown activity';
                        if (activityType === 'order') {
                            const amount = parseFloat(a.total_amount || 0).toFixed(2);
                            const status = a.status || 'pending';
                            label = `Order #${a.reference_id} - ‚Çπ${amount} (${status})`;
                        } else if (activityType === 'user_registered') {
                            label = 'New user registered';
                        }
                        
                        html += `
                            <tr>
                                <td>${activityType}</td>
                                <td>${userName}${userEmail ? '<br><small>' + userEmail + '</small>' : ''}</td>
                                <td>${label}</td>
                                <td>${formatDate(createdAt)}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                    document.getElementById('activities-list').innerHTML = html;
                }
            } catch (error) {
                console.error('Load activities error:', error);
                const errorMsg = error.message || 'Unknown error occurred';
                document.getElementById('activities-list').innerHTML = `<div class="empty-state"><p>Error loading activities: ${errorMsg}</p><p style=\"margin-top:1rem;\"><button class=\"btn btn-primary\" onclick=\"loadActivities()\">Retry</button></p></div>`;
            }
        }

        async function loadWholesaleRequests() {
            try {
                showLoading('wholesale-list');
                const resp = await api.get('/admin/users/wholesale');
                const users = resp.users || [];
                window._wholesaleCache = users;

                const pending = users.filter(u => !u.is_approved).length;
                const badge = document.getElementById('wholesale-badge');
                if (badge) {
                    badge.textContent = pending;
                    badge.style.display = pending > 0 ? 'inline-flex' : 'none';
                }

                if (!users.length) {
                    document.getElementById('wholesale-list').innerHTML = '<div class="empty-state"><p>No wholesale requests</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Business</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                users.forEach(u => {
                    html += `
                        <tr>
                            <td>${u.full_name}</td>
                            <td>${u.email}</td>
                            <td>${u.business_name || '-'}</td>
                            <td><span class="badge ${u.is_approved ? 'badge-success' : 'badge-warning'}">${u.is_approved ? 'Approved' : 'Pending'}</span></td>
                            <td>
                                <div class="table-actions">
                                    ${u.is_approved ? '' : `<button class="action-btn action-btn-edit" onclick="approveWholesale(${u.id}, true)"><i class="fas fa-check"></i> Approve</button>`}
                                    ${u.is_approved ? `<button class="action-btn action-btn-delete" onclick="approveWholesale(${u.id}, false)"><i class="fas fa-times"></i> Revoke</button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                document.getElementById('wholesale-list').innerHTML = html;
            } catch (error) {
                console.error('Load wholesale requests error:', error);
                document.getElementById('wholesale-list').innerHTML = '<div class="empty-state"><p>Error loading wholesale requests</p></div>';
            }
        }

        // Site Settings - Logo Management
        async function loadSiteSettings() {
            try {
                const response = await api.get('/admin/settings');
                const settings = response.settings || {};
                
                // Display current logo
                const currentLogoImg = document.getElementById('current-logo-img');
                if (settings.logo_url && settings.logo_url !== 'default') {
                    currentLogoImg.src = settings.logo_url;
                    currentLogoImg.style.display = 'block';
                } else {
                    currentLogoImg.src = '';
                    currentLogoImg.style.display = 'none';
                    document.getElementById('current-logo-display').querySelector('.form-label').textContent = 'Current Active Logo: Using default (üèîÔ∏è Mountain Made)';
                }

                // Populate homepage hero headings
                const heroTitleInput = document.getElementById('homepage-hero-title');
                const heroSubtitleInput = document.getElementById('homepage-hero-subtitle');
                if (heroTitleInput) {
                    heroTitleInput.value = settings.homepage_hero_title || '';
                }
                if (heroSubtitleInput) {
                    heroSubtitleInput.value = settings.homepage_hero_subtitle || '';
                }

                // Populate delivery settings
                const fastEnabledInput = document.getElementById('fast-delivery-enabled');
                const fastChargeInput = document.getElementById('fast-delivery-charge');
                if (fastEnabledInput) {
                    const rawEnabled = (settings.fast_delivery_enabled ?? 'false').toString().toLowerCase();
                    fastEnabledInput.checked = rawEnabled === 'true';
                }
                if (fastChargeInput) {
                    const rawCharge = settings.fast_delivery_charge;
                    const parsed = rawCharge != null ? parseFloat(rawCharge) : 0;
                    fastChargeInput.value = !Number.isNaN(parsed) && parsed >= 0 ? parsed : '';
                }
            } catch (error) {
                console.error('Load site settings error:', error);
                showAlert('Failed to load site settings', 'error');
            }
        }

        window.previewLogo = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Check size (2MB for logo)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('Logo file size must be less than 2MB', 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('logo-preview');
                const placeholder = document.getElementById('logo-preview-placeholder');
                preview.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        };

            // Edit Logo Modal Logic
            window.openEditLogoModal = function() {
                const fileInput = document.getElementById('logo-upload');
                const file = fileInput.files[0];
                if (!file) {
                    showAlert('Please select a logo file first', 'warning');
                    return;
                }
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-logo-crop-img').src = e.target.result;
                    document.getElementById('edit-logo-modal').style.display = 'flex';
                };
                reader.readAsDataURL(file);
            };

            window.closeEditLogoModal = function() {
                document.getElementById('edit-logo-modal').style.display = 'none';
            };

            window.saveEditedLogo = function() {
                // For simplicity, just use the cropped image as preview (cropping logic can be added with a library)
                const img = document.getElementById('edit-logo-crop-img');
                if (!img.src) {
                    showAlert('No image to save.', 'error');
                    return;
                }
                document.getElementById('logo-preview').src = img.src;
                document.getElementById('logo-preview').style.display = 'block';
                document.getElementById('logo-preview-placeholder').style.display = 'none';
                window.closeEditLogoModal();
                showAlert('Logo edited successfully. Click Upload to save.', 'success');
            };

        window.uploadLogo = async function() {
            try {
                const fileInput = document.getElementById('logo-upload');
                const file = fileInput.files[0];

                if (!file) {
                    showAlert('Please select a logo file first', 'warning');
                    return;
                }

                // Validate
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    return;
                }

                if (file.size > 2 * 1024 * 1024) {
                    showAlert('Logo file size must be less than 2MB', 'error');
                    return;
                }

                // Upload image
                showAlert('Uploading logo...', 'info');
                const imageUrl = await uploadProductImage(fileInput);

                if (!imageUrl) {
                    throw new Error('Failed to upload logo image');
                }

                // Save logo URL to settings
                showAlert('Saving logo...', 'info');
                const response = await api.post('/admin/settings', {
                    logo_url: imageUrl
                });

                if (response && (response.success || response.message)) {
                    showAlert('Logo uploaded and saved successfully! Refresh the page to see it in the navbar.', 'success');
                    fileInput.value = '';
                    document.getElementById('logo-preview').style.display = 'none';
                    document.getElementById('logo-preview-placeholder').style.display = 'block';
                    loadSiteSettings(); // Reload to show current logo
                } else {
                    throw new Error(response.error || 'Failed to save logo');
                }
            } catch (error) {
                console.error('Upload logo error:', error);
                showAlert(error.message || 'Failed to upload logo', 'error');
            }
        };

        window.resetLogoToDefault = async function() {
            if (!confirm('Are you sure you want to reset to the default logo? This will remove your custom logo.')) {
                return;
            }

            try {
                showAlert('Resetting logo...', 'info');
                const response = await api.post('/admin/settings', {
                    logo_url: 'default'
                });

                if (response && (response.success || response.message)) {
                    showAlert('Logo reset to default! Refresh the page to see the change.', 'success');
                    document.getElementById('logo-upload').value = '';
                    document.getElementById('logo-preview').style.display = 'none';
                    document.getElementById('logo-preview-placeholder').style.display = 'block';
                    loadSiteSettings(); // Reload to show default
                } else {
                    throw new Error(response.error || 'Failed to reset logo');
                }
            } catch (error) {
                console.error('Reset logo error:', error);
                showAlert(error.message || 'Failed to reset logo', 'error');
            }
        };

        window.saveHomepageHeadings = async function() {
            try {
                const titleEl = document.getElementById('homepage-hero-title');
                const subtitleEl = document.getElementById('homepage-hero-subtitle');

                const homepage_hero_title = titleEl ? titleEl.value.trim() : '';
                const homepage_hero_subtitle = subtitleEl ? subtitleEl.value.trim() : '';

                showAlert('Saving homepage headings...', 'info');

                const response = await api.post('/admin/settings', {
                    homepage_hero_title,
                    homepage_hero_subtitle
                });

                if (response && (response.success || response.message)) {
                    showAlert('Homepage headings saved successfully!', 'success');
                } else {
                    throw new Error(response.error || 'Failed to save homepage headings');
                }
            } catch (error) {
                console.error('Save homepage headings error:', error);
                showAlert(error.message || 'Failed to save homepage headings', 'error');
            }
        };

        window.saveDeliverySettings = async function() {
            try {
                const enabledEl = document.getElementById('fast-delivery-enabled');
                const chargeEl = document.getElementById('fast-delivery-charge');

                const fast_delivery_enabled = !!(enabledEl && enabledEl.checked);
                const rawCharge = chargeEl ? (chargeEl.value || '').trim() : '';

                // Allow flexible typing (e.g. "50 ‚Çπ" or spaces), keep only digits and dot
                const normalizedCharge = rawCharge === ''
                    ? ''
                    : rawCharge.replace(/[^0-9.]/g, '');

                const fast_delivery_charge = normalizedCharge === '' ? 0 : parseFloat(normalizedCharge);

                if (Number.isNaN(fast_delivery_charge) || fast_delivery_charge < 0) {
                    showAlert('Please enter a valid non-negative fast delivery charge.', 'error');
                    if (chargeEl) chargeEl.focus();
                    return;
                }

                showAlert('Saving fast delivery settings...', 'info');
                const response = await api.post('/admin/settings', {
                    fast_delivery_enabled,
                    fast_delivery_charge
                });

                if (response && (response.success || response.message)) {
                    showAlert('Fast delivery settings updated successfully!', 'success');
                    await loadSiteSettings();
                } else {
                    showAlert(response.error || 'Failed to save delivery settings', 'error');
                }
            } catch (error) {
                console.error('Save delivery settings error:', error);
                showAlert(error.message || 'Failed to save delivery settings', 'error');
            }
        };

        async function loadCategoriesForUpload() {
            try {
                const response = await api.get('/admin/categories');
                const categories = response.categories || [];
                window._categoriesCache = categories;
                
                const select = document.getElementById('product-category');
                if (select && categories.length > 0) {
                    select.innerHTML = '<option value="">Select Category</option>' + 
                        categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Load categories error:', error);
            }
        }

        // Dynamic Categories Filter
        window.filterCategories = function() {
            const search = (document.getElementById('category-search')?.value || '').toLowerCase().trim();
            const categories = window._categoriesCache || [];

            if (!categories.length) {
                document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>No categories</p></div>';
                return;
            }

            const filtered = categories.filter(c => {
                const searchTerm = search.replace('#', '');

                if (!search) return true;

                return String(c.id || '').includes(searchTerm) ||
                    (c.name || '').toLowerCase().includes(search) ||
                    (c.description || '').toLowerCase().includes(search);
            });

            if (!filtered.length) {
                document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>No categories found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead><tbody>';

            filtered.forEach(c => {
                html += `
                        <tr>
                            <td>#${c.id}</td>
                            <td>${c.name}</td>
                            <td>${c.description || '-'}</td>
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn action-btn-edit" onclick="editCategory(${c.id})"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="action-btn action-btn-delete" onclick="deleteCategory(${c.id})"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
            });

            html += '</tbody></table></div>';
            document.getElementById('categories-list').innerHTML = html;
        };

        // Dynamic Activities Filter
        window.filterActivities = function() {
            const search = (document.getElementById('activities-search')?.value || '').toLowerCase().trim();
            const typeFilter = document.getElementById('activities-type-filter')?.value || '';
            const fromValue = document.getElementById('activities-date-from')?.value || '';
            const toValue = document.getElementById('activities-date-to')?.value || '';
            const activities = window._activitiesCache || [];

            const fromDate = fromValue ? new Date(fromValue) : null;
            const toDate = toValue ? new Date(toValue) : null;
            if (toDate) {
                toDate.setHours(23, 59, 59, 999);
            }

            const filtered = activities.filter(a => {
                const searchTerm = search.replace('#', '');
                const activityType = a.activity_type || 'unknown';
                const userName = a.full_name || 'Unknown User';
                const userEmail = a.email || '';
                const createdAt = a.created_at || '';
                const createdDate = createdAt ? new Date(createdAt) : null;

                let label = 'Unknown activity';
                if (activityType === 'order') {
                    const amount = parseFloat(a.total_amount || 0).toFixed(2);
                    const status = a.status || 'pending';
                    label = `Order #${a.reference_id} - ‚Çπ${amount} (${status})`;
                } else if (activityType === 'user_registered') {
                    label = 'New user registered';
                }

                const matchesSearch = !search ||
                    String(a.id || '').includes(searchTerm) ||
                    (activityType || '').toLowerCase().includes(search) ||
                    userName.toLowerCase().includes(search) ||
                    userEmail.toLowerCase().includes(search) ||
                    label.toLowerCase().includes(search) ||
                    (String(a.reference_id || '')).toLowerCase().includes(searchTerm);

                const matchesType = !typeFilter || activityType === typeFilter;

                let matchesDate = true;
                if (fromDate && createdDate && createdDate < fromDate) {
                    matchesDate = false;
                }
                if (toDate && createdDate && createdDate > toDate) {
                    matchesDate = false;
                }

                return matchesSearch && matchesType && matchesDate;
            });

            if (!filtered.length) {
                document.getElementById('activities-list').innerHTML = '<div class="empty-state"><p>No activities found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Type</th><th>User</th><th>Details</th><th>Date</th></tr></thead><tbody>';
            filtered.forEach(a => {
                const activityType = a.activity_type || 'unknown';
                const userName = a.full_name || 'Unknown User';
                const userEmail = a.email || '';
                const createdAt = a.created_at || '';

                let label = 'Unknown activity';
                if (activityType === 'order') {
                    const amount = parseFloat(a.total_amount || 0).toFixed(2);
                    const status = a.status || 'pending';
                    label = `Order #${a.reference_id} - ‚Çπ${amount} (${status})`;
                } else if (activityType === 'user_registered') {
                    label = 'New user registered';
                }

                html += `
                    <tr>
                        <td>${activityType}</td>
                        <td>${userName}${userEmail ? '<br><small>' + userEmail + '</small>' : ''}</td>
                        <td>${label}</td>
                        <td>${formatDate(createdAt)}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('activities-list').innerHTML = html;
        };

        // Dynamic Users Filter
        window.filterUsers = function() {
            const search = (document.getElementById('user-search')?.value || '').toLowerCase().trim();
            const roleFilter = document.getElementById('user-role-filter')?.value || '';
            const statusFilter = document.getElementById('user-status-filter')?.value || '';
            const users = window._usersCache || [];

            const filtered = users.filter(u => {
                const searchTerm = search.replace('#', '');

                const matchesSearch = !search ||
                    String(u.id || '').includes(searchTerm) ||
                    (u.full_name || '').toLowerCase().includes(search) ||
                    (u.email || '').toLowerCase().includes(search) ||
                    (u.phone || '').toLowerCase().includes(search);

                const matchesRole = !roleFilter || (u.role === roleFilter);

                const isBlocked = !!(u.is_blocked);
                const statusValue = isBlocked ? 'blocked' : 'active';
                const matchesStatus = !statusFilter || statusFilter === statusValue;

                return matchesSearch && matchesRole && matchesStatus;
            });

            if (!filtered.length) {
                document.getElementById('users-list').innerHTML = '<div class="empty-state"><p>No users found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Phone</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
            filtered.forEach(u => {
                const isBlocked = u.is_blocked || false;
                const isAdmin = u.role === 'admin';
                const statusBadge = isBlocked 
                    ? '<span class="badge badge-danger">Blocked</span>' 
                    : '<span class="badge badge-success">Active</span>';

                html += `
                    <tr>
                        <td>#${u.id}</td>
                        <td>${u.full_name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge badge-${u.role === 'admin' ? 'info' : u.role === 'wholesale' ? 'warning' : 'secondary'}">${u.role}</span></td>
                        <td>${u.phone || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>
                            <div class="table-actions">
                                ${!isAdmin ? `
                                    <button class="action-btn ${isBlocked ? 'action-btn-success' : 'action-btn-warning'}" 
                                            onclick="toggleBlockUser(${u.id}, ${!isBlocked})">
                                        <i class="fas fa-${isBlocked ? 'unlock' : 'ban'}"></i> ${isBlocked ? 'Unblock' : 'Block'}
                                    </button>
                                ` : '<span class="text-muted">Protected</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('users-list').innerHTML = html;
        };

        window.filterProducts = function() {
            const search = (document.getElementById('product-search')?.value || '').toLowerCase().trim();
            const category = document.getElementById('category-filter')?.value || '';
            const products = window._productsCache || [];
            
            const filtered = products.filter(p => {
                // Search across multiple fields: ID, name, description, category name
                // Handle ID search with or without "#" prefix
                const searchTerm = search.replace('#', '');
                const matchesSearch = !search || 
                    String(p.id).includes(searchTerm) ||
                    (p.name || '').toLowerCase().includes(search) || 
                    (p.description || '').toLowerCase().includes(search) ||
                    (p.category_name || '').toLowerCase().includes(search);
                
                const matchesCategory = !category || p.category_id == category;
                return matchesSearch && matchesCategory;
            });

            if (filtered.length === 0) {
                document.getElementById('products-list').innerHTML = '<div class="empty-state"><p>No products found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody>';
            
            filtered.forEach(p => {
                html += `
                    <tr>
                        <td>#${p.id}</td>
                        <td>${p.name}</td>
                            <td>${p.category_name || 'N/A'}</td>
                            <td>
                                ${p.discount_price && parseFloat(p.discount_price) < parseFloat(p.price || 0)
                                    ? `<span class="price-original">‚Çπ${parseFloat(p.price || 0).toFixed(2)}</span> <strong class="price-discount">‚Çπ${parseFloat(p.discount_price).toFixed(2)}</strong>`
                                    : `<strong>‚Çπ${parseFloat(p.price || 0).toFixed(2)}</strong>`}
                            </td>
                        <td><span class="badge ${p.stock_quantity > 10 ? 'badge-success' : p.stock_quantity > 0 ? 'badge-warning' : 'badge-danger'}">${p.stock_quantity}</span></td>
                        <td>
                            <div class="table-actions">
                                <button class="action-btn action-btn-edit" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i> Edit</button>
                                <button class="action-btn action-btn-delete" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('products-list').innerHTML = html;
        };
        window.filterOrders = function() {
            const search = (document.getElementById('order-search')?.value || '').toLowerCase().trim();
            const status = document.getElementById('order-status-filter')?.value || '';
            const orders = window._ordersCache || [];

            const filtered = orders.filter(o => {
                // Search across multiple fields: ID, order number, customer name, email
                // Handle ID search with or without "#" prefix
                const searchTerm = search.replace('#', '');
                const matchSearch = !search || 
                    String(o.id).includes(searchTerm) ||
                    (o.order_number || '').toLowerCase().includes(search) || 
                    (o.full_name || '').toLowerCase().includes(search) || 
                    (o.email || '').toLowerCase().includes(search);
                
                const matchStatus = !status || o.status === status;
                return matchSearch && matchStatus;
            });

            if (!filtered.length) {
                document.getElementById('orders-list').innerHTML = '<div class="empty-state"><p>No matching orders</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>#</th><th>Order</th><th>Customer</th><th>Total</th><th>Delivery</th><th>Status</th><th>Date</th></tr></thead><tbody>';
            filtered.forEach(o => {
                const deliverySpeed = (o.delivery_speed || 'standard').toLowerCase();
                const deliveryCharge = o.delivery_charge != null ? parseFloat(o.delivery_charge) : 0;
                const hasCharge = !Number.isNaN(deliveryCharge) && deliveryCharge > 0;

                let deliveryLabel;
                if (deliverySpeed === 'fast') {
                    deliveryLabel = hasCharge
                        ? `Fast (${formatCurrency(deliveryCharge)})`
                        : 'Fast (Free)';
                } else {
                    deliveryLabel = hasCharge
                        ? `Standard (+${formatCurrency(deliveryCharge)})`
                        : 'Standard (Free)';
                }

                html += `
                    <tr>
                        <td>#${o.id}</td>
                        <td>${o.order_number || '-'}</td>
                        <td>${o.full_name || 'Guest'}<br><small>${o.email || ''}</small></td>
                        <td>${formatCurrency(o.total_amount)}</td>
                        <td>${deliveryLabel}</td>
                        <td><span class="badge badge-${o.status === 'delivered' ? 'success' : o.status === 'cancelled' ? 'danger' : 'warning'}">${o.status}</span></td>
                        <td>${formatDate(o.created_at)}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('orders-list').innerHTML = html;
        };

        window.filterCustomerOrders = function() {
            const search = (document.getElementById('customer-order-search')?.value || '').toLowerCase().trim();
            const orders = window._customerOrdersCache || [];

            const filtered = orders.filter(o => {
                // Search across multiple fields: ID, order number, customer name, email
                // Handle ID search with or without "#" prefix
                const searchTerm = search.replace('#', '');
                const matchesSearch = !search ||
                    String(o.id).includes(searchTerm) ||
                    (o.full_name || '').toLowerCase().includes(search) ||
                    (o.email || '').toLowerCase().includes(search) ||
                    (o.order_number || '').toLowerCase().includes(search);
                return matchesSearch;
            });

            if (!filtered.length) {
                document.getElementById('customer-orders-list').innerHTML = '<div class="empty-state"><p>No matching orders</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>#</th><th>Order</th><th>Customer</th><th>Total</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
            filtered.forEach(o => {
                const statusBadgeClass = o.status === 'delivered' ? 'badge-success' : o.status === 'cancelled' ? 'badge-danger' : 'badge-warning';
                const statusLabel = o.status || 'pending';

                const actionsHtml = o.status === 'pending'
                    ? `
                        <button class="action-btn action-btn-success" onclick="updateOrderStatus(${o.id}, 'processing')">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                        <button class="action-btn action-btn-reject" onclick="updateOrderStatus(${o.id}, 'cancelled')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                      `
                    : '<span class="badge badge-secondary">No actions</span>';

                html += `
                    <tr>
                        <td>#${o.id}</td>
                        <td>${o.order_number || '-'}</td>
                        <td>${o.full_name || 'Guest'}<br><small>${o.email || ''}</small></td>
                        <td>${formatCurrency(o.total_amount)}</td>
                        <td><span class="badge ${statusBadgeClass}">${statusLabel}</span></td>
                        <td>${formatDate(o.created_at)}</td>
                        <td>
                            <div class="table-actions">
                                ${actionsHtml}
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('customer-orders-list').innerHTML = html;
        };

        window.updateOrderStatus = async function(orderId, status) {
            const verb = status === 'processing' ? 'confirm' : status === 'cancelled' ? 'reject' : 'update';
            if (!confirm(`Are you sure you want to ${verb} this order?`)) {
                return;
            }

            try {
                const resp = await api.put(`/admin/orders/${orderId}/status`, { status });
                const msg = resp.message || `Order ${verb}ed successfully`;
                showAlert(msg, 'success');

                // Reload both pending customer orders view and full order history cache if open
                if (window._currentSection === 'customers-orders') {
                    await loadCustomerOrders();
                }
                if (window._currentSection === 'order-history') {
                    await loadOrders();
                }

                // Also refresh product stock and stock reports so restored
                // quantities are reflected immediately in admin views
                if (typeof loadProducts === 'function') {
                    await loadProducts();
                }
                if (typeof loadStockReports === 'function') {
                    await loadStockReports();
                }
            } catch (error) {
                console.error('Update order status error:', error);
                const errMsg = error?.error || 'Failed to update order status';
                showAlert(errMsg, 'error');
            }
        };

        window.approveWholesale = async function(userId, isApproved) {
            try {
                await api.put(`/admin/users/${userId}/approve`, { isApproved });
                showAlert(isApproved ? 'User approved successfully' : 'Wholesale access revoked', 'success');
                loadWholesaleRequests();
            } catch (error) {
                console.error('Approve wholesale error:', error);
                showAlert('Failed to update wholesale status', 'error');
            }
        };
        window.showAddProductModal = function() { 
            const modal = document.getElementById('add-product-modal');
            if (modal) {
                modal.classList.add('show');
                // Load categories and homepage sections into dropdowns
                loadCategoriesForUpload();
                loadHomepageSectionsForForms();
            }
        };

        window.closeAddProductModal = function() {
            const modal = document.getElementById('add-product-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('add-product-form').reset();
                document.getElementById('product-discount-price').value = '';
                clearProductImage();
            }
        };

        window.previewProductImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('image-preview');
                document.getElementById('preview-img').src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearProductImage = function() {
            document.getElementById('product-image').value = '';
            document.getElementById('image-preview').style.display = 'none';
        };

        window.handleAddProduct = async function(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('product-name').value;
                const price = document.getElementById('product-price').value;
                const discount_price = document.getElementById('product-discount-price').value || null;
                const stock = document.getElementById('product-stock').value;
                const category_id = document.getElementById('product-category').value;
                const homepage_section_id = document.getElementById('product-homepage-section').value || null;
                const description = document.getElementById('product-description').value;
                const wholesale_price = document.getElementById('product-wholesale-price').value || null;
                const min_wholesale_qty = document.getElementById('product-min-wholesale').value || 10;
                const imageFile = document.getElementById('product-image').files[0];

                // Validate required fields
                if (!name || !price || !stock) {
                    showAlert('Please fill in all required fields', 'error');
                    return;
                }

                if (!category_id) {
                    showAlert('Please select a category', 'error');
                    return;
                }

                if (discount_price && parseFloat(discount_price) >= parseFloat(price)) {
                    showAlert('Discount price should be less than the main price.', 'error');
                    return;
                }

                let image_url = '/images/placeholder.jpg';

                // Upload image if provided
                if (imageFile) {
                    const validation = validateImageFile(imageFile);
                    if (!validation.valid) {
                        showAlert(validation.error, 'error');
                        return;
                    }

                    showAlert('Uploading image...', 'info');
                    image_url = await uploadProductImage(document.getElementById('product-image')) || image_url;
                }

                // Create product
                showAlert('Creating product...', 'info');
                const response = await api.post('/admin/products', {
                    name,
                    description,
                    category_id: parseInt(category_id),
                    homepage_section_id: homepage_section_id ? parseInt(homepage_section_id) : null,
                    price: parseFloat(price),
                    wholesale_price: wholesale_price ? parseFloat(wholesale_price) : null,
                    discount_price: discount_price ? parseFloat(discount_price) : null,
                    stock_quantity: parseInt(stock),
                    min_wholesale_qty: parseInt(min_wholesale_qty),
                    image_url
                });

                if (response && (response.success || response.product || response.message)) {
                    showAlert('Product added successfully!', 'success');
                    closeAddProductModal();
                    // Refresh the products list
                    if (window._currentSection === 'manage-products') {
                        loadProducts();
                    }
                } else {
                    showAlert(response.error || 'Failed to add product', 'error');
                }
            } catch (error) {
                console.error('Error adding product:', error);
                showAlert(error.message || 'Failed to add product', 'error');
            }
        };
        window.showAddCategoryModal = function() { 
            const modal = document.getElementById('add-category-modal');
            if (modal) {
                modal.classList.add('show');
                document.getElementById('add-category-form').reset();
                clearCategoryImage();
            }
        };

        window.closeAddCategoryModal = function() {
            const modal = document.getElementById('add-category-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('add-category-form').reset();
                clearCategoryImage();
            }
        };

        window.previewCategoryImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('category-image-preview');
                document.getElementById('category-preview-img').src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearCategoryImage = function() {
            document.getElementById('category-image').value = '';
            document.getElementById('category-image-preview').style.display = 'none';
        };

        window.handleAddCategory = async function(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('category-name').value;
                const description = document.getElementById('category-description').value;
                const imageFile = document.getElementById('category-image').files[0];

                // Validate required fields
                if (!name) {
                    showAlert('Please enter category name', 'error');
                    return;
                }

                let image_url = '/images/placeholder.jpg';

                // Upload image if provided
                if (imageFile) {
                    const validation = validateImageFile(imageFile);
                    if (!validation.valid) {
                        showAlert(validation.error, 'error');
                        return;
                    }

                    showAlert('Uploading image...', 'info');
                    image_url = await uploadProductImage(document.getElementById('category-image')) || image_url;
                }

                // Create category
                showAlert('Creating category...', 'info');
                const response = await api.post('/admin/categories', {
                    name,
                    description,
                    image_url
                });

                if (response && (response.success || response.category || response.message)) {
                    showAlert('Category added successfully!', 'success');
                    closeAddCategoryModal();
                    // Refresh the categories list
                    if (window._currentSection === 'categories') {
                        loadCategories();
                    }
                    // Also refresh the cache for products form
                    loadCategoriesForUpload();
                } else {
                    showAlert(response.error || 'Failed to add category', 'error');
                }
            } catch (error) {
                console.error('Error adding category:', error);
                showAlert(error.message || 'Failed to add category', 'error');
            }
        };
        
        window.editProduct = async function(id) {
            const product = (window._productsCache || []).find(p => p.id == id);
            if (!product) {
                showAlert('Product not found', 'error');
                return;
            }
            
            // Show modal
            const modal = document.getElementById('edit-product-modal');
            if (!modal) {
                showAlert('Edit modal not found', 'error');
                return;
            }
            
            // Load categories into dropdown
            await loadCategoriesForEdit();
            await loadHomepageSectionsForForms();
            
            // Populate form with product data
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name || '';
            document.getElementById('edit-product-price').value = product.price || '';
            document.getElementById('edit-product-discount-price').value = product.discount_price || '';
            document.getElementById('edit-product-wholesale-price').value = product.wholesale_price || '';
            document.getElementById('edit-product-discount-price').value = product.discount_price || '';
            document.getElementById('edit-product-stock').value = product.stock_quantity || 0;
            document.getElementById('edit-product-category').value = product.category_id || '';
            document.getElementById('edit-product-homepage-section').value = product.homepage_section_id || '';
            document.getElementById('edit-product-min-wholesale').value = product.min_wholesale_qty || 10;
            document.getElementById('edit-product-description').value = product.description || '';
            
            // Show current product image
            const previewImg = document.getElementById('edit-preview-img');
            if (product.image_url) {
                previewImg.src = product.image_url;
                previewImg.style.display = 'block';
            } else {
                previewImg.src = '/images/placeholder.jpg';
                previewImg.style.display = 'block';
            }
            
            // Clear file input
            document.getElementById('edit-product-image').value = '';
            document.getElementById('edit-clear-image-btn').style.display = 'none';
            
            modal.classList.add('show');
        };
        
        window.closeEditProductModal = function() {
            const modal = document.getElementById('edit-product-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('edit-product-form').reset();
            }
        };

        window.previewEditProductImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('edit-preview-img');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.getElementById('edit-clear-image-btn').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearEditProductImage = function() {
            document.getElementById('edit-product-image').value = '';
            document.getElementById('edit-clear-image-btn').style.display = 'none';
            // Restore original image
            const productId = document.getElementById('edit-product-id').value;
            const product = (window._productsCache || []).find(p => p.id == productId);
            if (product && product.image_url) {
                document.getElementById('edit-preview-img').src = product.image_url;
            } else {
                document.getElementById('edit-preview-img').src = '/images/placeholder.jpg';
            }
        };

        async function loadCategoriesForEdit() {
            try {
                if (!window._categoriesCache || window._categoriesCache.length === 0) {
                    const response = await api.get('/admin/categories');
                    window._categoriesCache = response.categories || [];
                }
                
                const select = document.getElementById('edit-product-category');
                if (select) {
                    select.innerHTML = '<option value="">Select Category</option>' + 
                        window._categoriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        window.handleEditProduct = async function(event) {
            event.preventDefault();
            
            try {
                const productId = document.getElementById('edit-product-id').value;
                const name = document.getElementById('edit-product-name').value;
                const price = document.getElementById('edit-product-price').value;
                const stock = document.getElementById('edit-product-stock').value;
                const category_id = document.getElementById('edit-product-category').value;
                const homepage_section_id = document.getElementById('edit-product-homepage-section').value || null;
                const description = document.getElementById('edit-product-description').value;
                const wholesale_price = document.getElementById('edit-product-wholesale-price').value || null;
                const discount_price = document.getElementById('edit-product-discount-price').value || null;
                const min_wholesale_qty = document.getElementById('edit-product-min-wholesale').value || 10;
                const imageFile = document.getElementById('edit-product-image').files[0];

                // Validate required fields
                if (!name || !price || stock === '') {
                    showAlert('Please fill in all required fields', 'error');
                    return;
                }

                if (!category_id) {
                    showAlert('Please select a category', 'error');
                    return;
                }

                if (discount_price && parseFloat(discount_price) >= parseFloat(price)) {
                    showAlert('Discount price should be less than the main price.', 'error');
                    return;
                }

                let updateData = {
                    name,
                    description,
                    category_id: parseInt(category_id),
                    homepage_section_id: homepage_section_id ? parseInt(homepage_section_id) : null,
                    price: parseFloat(price),
                    wholesale_price: wholesale_price ? parseFloat(wholesale_price) : null,
                    discount_price: discount_price ? parseFloat(discount_price) : null,
                    stock_quantity: parseInt(stock),
                    min_wholesale_qty: parseInt(min_wholesale_qty)
                };

                // Upload new image if provided
                if (imageFile) {
                    const validation = validateImageFile(imageFile);
                    if (!validation.valid) {
                        showAlert(validation.error, 'error');
                        return;
                    }

                    showAlert('Uploading new image...', 'info');
                    const image_url = await uploadProductImage(document.getElementById('edit-product-image'));
                    if (image_url) {
                        updateData.image_url = image_url;
                    }
                }

                showAlert('Updating product...', 'info');
                const response = await api.put(`/admin/products/${productId}`, updateData);

                if (response && (response.success || response.product || response.message)) {
                    showAlert('Product updated successfully!', 'success');
                    closeEditProductModal();
                    // Refresh the products list
                    if (window._currentSection === 'manage-products') {
                        loadProducts();
                    }
                } else {
                    showAlert(response.error || 'Failed to update product', 'error');
                }
            } catch (error) {
                console.error('Error updating product:', error);
                showAlert(error.message || 'Failed to update product', 'error');
            }
        };
        
        window.deleteProduct = async function(id) {
            if (!confirm('Are you sure you want to delete this product?')) return;
            try {
                await api.delete(`/admin/products/${id}`);
                showAlert('Product deleted successfully', 'success');
                loadProducts();
            } catch (error) {
                showAlert('Failed to delete product', 'error');
            }
        };
        
        window.editCategory = async function(id) {
            const category = (window._categoriesCache || []).find(c => c.id == id);
            if (!category) {
                showAlert('Category not found', 'error');
                return;
            }

            const modal = document.getElementById('edit-category-modal');
            if (!modal) {
                showAlert('Edit category modal not found', 'error');
                return;
            }

            document.getElementById('edit-category-id').value = category.id;
            document.getElementById('edit-category-name').value = category.name || '';
            document.getElementById('edit-category-description').value = category.description || '';

            const previewWrapper = document.getElementById('edit-category-image-preview');
            const previewImg = document.getElementById('edit-category-preview-img');
            if (category.image_url) {
                previewImg.src = category.image_url;
                previewWrapper.style.display = 'block';
            } else {
                previewImg.src = '';
                previewWrapper.style.display = 'none';
            }

            document.getElementById('edit-category-image').value = '';

            modal.classList.add('show');
        };

        window.closeEditCategoryModal = function() {
            const modal = document.getElementById('edit-category-modal');
            if (modal) {
                modal.classList.remove('show');
                const form = document.getElementById('edit-category-form');
                if (form) form.reset();
                const previewWrapper = document.getElementById('edit-category-image-preview');
                if (previewWrapper) previewWrapper.style.display = 'none';
            }
        };

        window.previewEditCategoryImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewWrapper = document.getElementById('edit-category-image-preview');
                const previewImg = document.getElementById('edit-category-preview-img');
                previewImg.src = e.target.result;
                previewWrapper.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearEditCategoryImage = function() {
            const input = document.getElementById('edit-category-image');
            if (input) input.value = '';
            const previewWrapper = document.getElementById('edit-category-image-preview');
            if (previewWrapper) previewWrapper.style.display = 'none';
        };

        window.handleEditCategory = async function(event) {
            event.preventDefault();

            try {
                const id = document.getElementById('edit-category-id').value;
                const name = document.getElementById('edit-category-name').value;
                const description = document.getElementById('edit-category-description').value;
                const imageFile = document.getElementById('edit-category-image').files[0];

                if (!name) {
                    showAlert('Please enter category name', 'error');
                    return;
                }

                let updateData = {
                    name,
                    description
                };

                if (imageFile) {
                    const validation = validateImageFile(imageFile);
                    if (!validation.valid) {
                        showAlert(validation.error, 'error');
                        return;
                    }

                    showAlert('Uploading category image...', 'info');
                    const image_url = await uploadProductImage(document.getElementById('edit-category-image'));
                    if (image_url) {
                        updateData.image_url = image_url;
                    }
                }

                showAlert('Updating category...', 'info');
                const response = await api.put(`/admin/categories/${id}`, updateData);

                if (response && (response.success || response.category || response.message)) {
                    showAlert('Category updated successfully!', 'success');
                    closeEditCategoryModal();
                    if (window._currentSection === 'categories') {
                        await loadCategories();
                    } else {
                        // Still refresh cache for forms
                        await loadCategories();
                    }
                    loadCategoriesForUpload();
                } else {
                    showAlert(response.error || 'Failed to update category', 'error');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                showAlert(error.message || 'Failed to update category', 'error');
            }
        };
        
        window.deleteCategory = async function(id) {
            if (!confirm('Are you sure you want to delete this category?')) return;
            try {
                await api.delete(`/admin/categories/${id}`);
                showAlert('Category deleted successfully', 'success');
                loadCategories();
            } catch (error) {
                showAlert('Failed to delete category', 'error');
            }
        };

        // Homepage Sections Management
        window.showAddSectionModal = function() {
            const modal = document.getElementById('add-section-modal');
            if (modal) {
                modal.classList.add('show');
                document.getElementById('add-section-form').reset();
            }
        };

        window.closeAddSectionModal = function() {
            const modal = document.getElementById('add-section-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('add-section-form').reset();
            }
        };

        window.handleAddSection = async function(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('section-name').value;
                const description = document.getElementById('section-description').value;
                const sort_order = document.getElementById('section-sort-order').value;

                if (!name) {
                    showAlert('Please enter section name', 'error');
                    return;
                }

                showAlert('Creating section...', 'info');
                const response = await api.post('/admin/homepage-sections', {
                    name,
                    description,
                    sort_order: parseInt(sort_order) || 0
                });

                if (response && (response.success || response.section || response.message)) {
                    showAlert('Homepage section added successfully!', 'success');
                    closeAddSectionModal();
                    if (window._currentSection === 'homepage-sections') {
                        loadHomepageSections();
                    }
                    // Refresh cache for product forms
                    loadHomepageSectionsForForms();
                } else {
                    showAlert(response.error || 'Failed to add section', 'error');
                }
            } catch (error) {
                console.error('Error adding section:', error);
                showAlert(error.message || 'Failed to add section', 'error');
            }
        };

        window.editSection = async function(id) {
            const section = (window._homepageSectionsCache || []).find(s => s.id == id);
            if (!section) {
                showAlert('Section not found', 'error');
                return;
            }

            const modal = document.getElementById('edit-section-modal');
            if (!modal) {
                showAlert('Edit modal not found', 'error');
                return;
            }

            document.getElementById('edit-section-id').value = section.id;
            document.getElementById('edit-section-name').value = section.name || '';
            document.getElementById('edit-section-description').value = section.description || '';
            document.getElementById('edit-section-sort-order').value = section.sort_order || 0;
            document.getElementById('edit-section-active').value = section.is_active ? 'true' : 'false';

            modal.classList.add('show');
        };

        window.closeEditSectionModal = function() {
            const modal = document.getElementById('edit-section-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('edit-section-form').reset();
            }
        };

        window.handleEditSection = async function(event) {
            event.preventDefault();
            
            try {
                const sectionId = document.getElementById('edit-section-id').value;
                const name = document.getElementById('edit-section-name').value;
                const description = document.getElementById('edit-section-description').value;
                const sort_order = document.getElementById('edit-section-sort-order').value;
                const is_active = document.getElementById('edit-section-active').value === 'true';

                if (!name) {
                    showAlert('Please enter section name', 'error');
                    return;
                }

                showAlert('Updating section...', 'info');
                const response = await api.put(`/admin/homepage-sections/${sectionId}`, {
                    name,
                    description,
                    sort_order: parseInt(sort_order) || 0,
                    is_active
                });

                if (response && (response.success || response.section || response.message)) {
                    showAlert('Homepage section updated successfully!', 'success');
                    closeEditSectionModal();
                    if (window._currentSection === 'homepage-sections') {
                        loadHomepageSections();
                    }
                    loadHomepageSectionsForForms();
                } else {
                    showAlert(response.error || 'Failed to update section', 'error');
                }
            } catch (error) {
                console.error('Error updating section:', error);
                showAlert(error.message || 'Failed to update section', 'error');
            }
        };

        window.deleteSection = async function(id) {
            if (!confirm('Are you sure you want to delete this section? Products assigned to it will be unassigned.')) return;
            try {
                await api.delete(`/admin/homepage-sections/${id}`);
                showAlert('Homepage section deleted successfully', 'success');
                loadHomepageSections();
                loadHomepageSectionsForForms();
            } catch (error) {
                showAlert('Failed to delete section', 'error');
            }
        };

        async function loadHomepageSectionsForForms() {
            try {
                const response = await api.get('/admin/homepage-sections');
                window._homepageSectionsCache = response.sections || [];
                
                // Update both add and edit product form dropdowns
                const addSelect = document.getElementById('product-homepage-section');
                const editSelect = document.getElementById('edit-product-homepage-section');
                
                const optionsHtml = '<option value="">None - Show only in Products page</option>' + 
                    window._homepageSectionsCache
                        .filter(s => s.is_active)
                        .map(s => `<option value="${s.id}">${s.name}</option>`)
                        .join('');
                
                if (addSelect) addSelect.innerHTML = optionsHtml;
                if (editSelect) editSelect.innerHTML = optionsHtml;
            } catch (error) {
                console.error('Error loading homepage sections for forms:', error);
            }
        }

        window.handleFileUpload = function(event) { 
            const file = event.target.files[0];
            if (!file) return;
            showAlert('CSV upload feature - implement CSV parsing', 'info');
        };
        
        window.handleImageUpload = async function(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            showAlert(`Uploading ${files.length} image(s)...`, 'info');
            let uploaded = 0;
            
            for (let file of files) {
                try {
                    const validation = validateImageFile(file);
                    if (!validation.valid) {
                        showAlert(`${file.name}: ${validation.error}`, 'error');
                        continue;
                    }
                    
                    const fileInput = document.getElementById('image-input');
                    const imageUrl = await uploadProductImage(fileInput);
                    if (imageUrl) {
                        uploaded++;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                }
            }
            
            if (uploaded > 0) {
                showAlert(`Successfully uploaded ${uploaded} image(s)`, 'success');
                event.target.value = '';
            }
        };
        
        window.confirmBulkUpload = function() { showAlert('Bulk upload confirmed', 'success'); };
        window.logout = async function() { 
            try {
                await auth.logout?.();
            } catch (err) {
                console.warn('Logout error:', err);
            } finally {
                window.location.href = '/login?admin=true';
            }
        };

        async function initializeAdmin() {
            try {
                const dateEl = document.getElementById('current-date');
                if (dateEl) {
                    dateEl.textContent = new Date().toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                if (!window.auth || typeof auth.checkAuth !== 'function') {
                    showAlert('Authentication is not available. Please reload.', 'error');
                    return;
                }

                await auth.checkAuth();

                if (!auth.isAuthenticated() || auth.currentUser?.role !== 'admin') {
                    showAlert('Please login with an admin account to continue.', 'error');
                    setTimeout(() => window.location.href = '/login?admin=true', 1500);
                    return;
                }

                const userMenu = document.getElementById('user-menu');
                const authButtons = document.getElementById('auth-buttons');
                if (authButtons) authButtons.classList.add('hidden');
                if (userMenu) userMenu.classList.remove('hidden');

                const userName = document.getElementById('user-name');
                if (userName) {
                    userName.textContent = auth.currentUser.full_name || 'Admin';
                }

                showSection('dashboard');
            } catch (error) {
                console.error('Admin initialization error:', error);
                showAlert('Session expired. Please login again.', 'error');
                setTimeout(() => window.location.href = '/login?admin=true', 1500);
            }
        }

        document.addEventListener('DOMContentLoaded', initializeAdmin);
    })();
    </script>
</body>
</html>