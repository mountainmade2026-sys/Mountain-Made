        
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Mountain Made 2.0</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-enhancements.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #2c5f2d;
            --primary-dark: #1e4420;
            --primary-light: #4a8f4a;
            --secondary: #97bc62;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --info: #17a2b8;
            --text-dark: #333;
            --text: #555;
            --text-muted: #888;
            --bg: #f5f5f5;
            --border: #ddd;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 8px;
            --radius-lg: 12px;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: var(--bg); color: var(--text); }
        
        /* Navbar */
        .navbar { 
            background: white; 
            box-shadow: var(--shadow); 
            padding: 1rem 2rem; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        .navbar-brand { 
            color: var(--primary); 
            font-size: 1.5rem; 
            font-weight: 700; 
            text-decoration: none; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        .navbar-actions { display: flex; align-items: center; gap: 1rem; }
        
        /* Admin Layout */
        .admin-container { 
            display: flex; 
            min-height: calc(100vh - 70px); 
            position: relative;
        }
        
        /* Sidebar */
        .admin-sidebar { 
            background: linear-gradient(180deg, var(--primary) 0%, var(--primary-dark) 100%); 
            width: 260px; 
            height: calc(100vh - 70px);
            overflow-y: auto; 
            flex-shrink: 0;
            position: sticky;
            top: 70px;
            transition: all 0.3s ease;
        }
        
        .sidebar-brand { 
            padding: 1.5rem 1.5rem; 
            font-size: 1.2rem; 
            font-weight: 700; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
            color: white; 
            display: flex; 
            align-items: center; 
            gap: 0.5rem; 
        }
        
        .sidebar-section-title {
            padding: 1.5rem 1.5rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            color: rgba(255,255,255,0.5);
            letter-spacing: 1px;
            margin-top: 0.5rem;
        }

        .sidebar-section-title:first-of-type {
            margin-top: 0;
        }

        .admin-nav-item {
            padding: 1rem 1.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            color: rgba(255,255,255,0.8);
            font-size: 0.95rem;
        }

        .admin-nav-item:hover {
            background: rgba(255,255,255,0.1);
            color: white;
        }

        .admin-nav-item.active {
            background: rgba(255,255,255,0.15);
            border-left-color: var(--secondary);
            color: white;
            font-weight: 600;
        }

        .admin-nav-item i {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .admin-nav-item .badge-count {
            margin-left: auto;
            background: var(--danger);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-count {
            background: var(--danger);
            color: white;
            padding: 0.2rem 0.6rem;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .dot-indicator {
            width: 10px;
            height: 10px;
            border-radius: 999px;
            background: var(--danger);
            box-shadow: 0 0 0 2px rgba(239, 68, 68, 0.25);
            flex: 0 0 auto;
        }

        .dot-indicator.hidden {
            display: none;
        }

        /* Main Content */
        .admin-main {
            flex: 1;
            padding: 2rem;
            background: var(--bg);
            overflow-x: auto;
            min-width: 0;
            max-width: 100%;
        }

        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
            padding: 1.5rem 2rem;
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .admin-header h1 {
            font-size: 1.8rem;
            color: var(--text-dark);
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .admin-header h1 i {
            color: var(--primary);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Stats Grid */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: white;
            padding: 1.75rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            border-left: 4px solid;
            transition: transform 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-3px);
        }

        .stat-card.primary { border-left-color: var(--primary); }
        .stat-card.success { border-left-color: var(--success); }
        .stat-card.info { border-left-color: var(--info); }
        .stat-card.warning { border-left-color: var(--warning); }
        .stat-card.danger { border-left-color: var(--danger); }

        .stat-card-icon {
            font-size: 2.2rem;
            margin-bottom: 0.75rem;
        }

        .stat-card.primary .stat-card-icon { color: var(--primary); }
        .stat-card.success .stat-card-icon { color: var(--success); }
        .stat-card.info .stat-card-icon { color: var(--info); }
        .stat-card.warning .stat-card-icon { color: var(--warning); }
        .stat-card.danger .stat-card-icon { color: var(--danger); }

        .stat-card-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-dark);
            margin: 0.5rem 0;
        }

        .stat-card-label {
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Data Table */
        .data-table-container {
            background: white;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow-x: auto;
            overflow-y: hidden;
            margin-bottom: 1.5rem;
        }

        .table-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.5rem;
            border-bottom: 1px solid var(--border);
            flex-wrap: wrap;
            gap: 1rem;
        }

        .table-header h3 {
            color: var(--text-dark);
            font-size: 1.2rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            overflow-x: auto;
        }

        .data-table thead {
            background: var(--bg);
            border-bottom: 2px solid var(--border);
        }

        .data-table thead th {
            padding: 1rem 1.25rem;
            text-align: left;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            white-space: nowrap;
        }

        .data-table tbody td {
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border);
            color: var(--text);
            font-size: 0.95rem;
        }

        .data-table tbody tr:hover {
            background: #fafafa;
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        /* Buttons */
        .btn {
            padding: 0.6rem 1.2rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.9rem;
            font-weight: 500;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: var(--primary-dark);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-warning {
            background: var(--warning);
            color: #333;
        }

        .btn-warning:hover {
            background: #e0a800;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-info {
            background: var(--info);
            color: white;
        }

        .btn-info:hover {
            background: #138496;
        }

        .btn-sm {
            padding: 0.4rem 0.8rem;
            font-size: 0.8rem;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        /* Table Actions */
        .table-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 0.9rem;
            font-size: 0.8rem;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            white-space: nowrap;
        }

        .action-btn-edit {
            background: var(--info);
            color: white;
        }

        .action-btn-edit:hover {
            background: #138496;
        }

        .action-btn-view {
            background: var(--primary);
            color: white;
        }

        .action-btn-view:hover {
            background: var(--primary-dark);
        }

        .action-btn-delete {
            background: var(--danger);
            color: white;
        }

        .action-btn-delete:hover {
            background: #c82333;
        }

        .action-btn-approve {
            background: var(--success);
            color: white;
        }

        .action-btn-approve:hover {
            background: #218838;
        }

        .action-btn-warning {
            background: var(--warning);
            color: #333;
        }

        .action-btn-warning:hover {
            background: #e0a800;
        }

        .action-btn-success {
            background: var(--success);
            color: white;
        }

        .action-btn-success:hover {
            background: #218838;
        }

        .action-btn-reject {
            background: var(--danger);
            color: white;
        }

        /* Badges */
        .badge {
            display: inline-block;
            padding: 0.3rem 0.75rem;
            border-radius: 1rem;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .badge-success {
            background: rgba(40, 167, 69, 0.15);
            color: var(--success);
        }

        .badge-warning {
            background: rgba(255, 193, 7, 0.2);
            color: #856404;
        }

        .badge-danger {
            background: rgba(220, 53, 69, 0.15);
            color: var(--danger);
        }

        .badge-error {
            background: rgba(220, 53, 69, 0.15);
            color: var(--danger);
        }

        .badge-info {
            background: rgba(23, 162, 184, 0.15);
            color: var(--info);
        }

        .badge-primary {
            background: rgba(44, 95, 45, 0.15);
            color: var(--primary);
        }

        .badge-secondary {
            background: rgba(108, 117, 125, 0.15);
            color: #6c757d;
        }

        /* Search and Filter */
        .controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .search-box {
            display: flex;
            align-items: center;
            background: white;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 0.5rem 1rem;
            flex: 1;
            min-width: 250px;
            max-width: 400px;
        }

        .search-box i {
            color: var(--text-muted);
            margin-right: 0.75rem;
        }

        .search-box input {
            border: none;
            outline: none;
            width: 100%;
            font-size: 0.95rem;
        }

        .filter-group {
            display: flex;
            gap: 0.75rem;
            flex-wrap: wrap;
        }

        /* Generic filter toggle button (used on mobile) */
        .filter-toggle {
            display: none;
        }

        .filter-select {
            padding: 0.6rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            background: white;
            font-size: 0.9rem;
            cursor: pointer;
        }

        /* Alert */
        .alert {
            padding: 1rem 1.5rem;
            border-radius: var(--radius);
            margin-bottom: 1.5rem;
            display: none;
            align-items: center;
            gap: 0.75rem;
        }

        .alert.show {
            display: flex;
        }

        .alert-success {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success);
            border: 1px solid var(--success);
        }

        .alert-error {
            background: rgba(220, 53, 69, 0.1);
            color: var(--danger);
            border: 1px solid var(--danger);
        }

        .alert-warning {
            background: rgba(255, 193, 7, 0.1);
            color: #856404;
            border: 1px solid var(--warning);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .empty-state i {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .empty-state p {
            font-size: 1.1rem;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 4000;
            align-items: center;
            justify-content: center;
            padding: 1.25rem;
            width: 100vw;
            max-width: none;
            max-height: none;
            overflow-x: hidden;
            overflow-y: auto;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: var(--radius-lg);
            width: min(100%, 980px);
            max-width: min(100%, 980px);
            max-height: calc(100vh - 2.5rem);
            height: calc(100vh - 2.5rem);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease;
        }

        .modal-content > form {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
        }

        .modal-content.modal-content-xl {
            max-width: min(1100px, 100%);
            width: min(1100px, 100%);
        }

        .modal-content.modal-content-md {
            max-width: min(760px, 100%);
            width: min(760px, 100%);
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .modal-header {
            font-size: 1.4rem;
            font-weight: 700;
            display: flex;
            justify-content: space-between;
            align-items: center;
            color: var(--text-dark);
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border);
            background: #ffffff;
            flex: 0 0 auto;
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
            min-height: 0;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--text-muted);
            transition: color 0.3s ease;
        }

        .modal-close:hover {
            color: var(--danger);
        }

        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
            flex-wrap: wrap;
            padding: 1rem 1.5rem 1.25rem;
            border-top: 1px solid var(--border);
            background: #ffffff;
            flex: 0 0 auto;
        }

        /* Stock History Modal - center in screen and center title */
        #stock-history-modal {
            align-items: center;
            justify-content: center;
        }

        #stock-history-modal .modal-content {
            width: min(100%, 1100px);
            max-width: min(100%, 1100px);
            height: auto;
            max-height: calc(100vh - 2.5rem);
            position: relative;
        }

        #stock-history-modal .modal-header {
            position: relative;
            justify-content: center;
            padding: 1rem 1.25rem;
        }

        #stock-history-modal .modal-header h2 {
            flex: 1;
            text-align: center;
            padding: 0 2.5rem;
            font-size: 1.1rem;
            line-height: 1.2;
        }

        #stock-history-modal .modal-header .modal-close {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
        }

        /* Compact Contact Message Modal */
        #contact-message-modal {
            align-items: center;
            justify-content: center;
        }

        #contact-message-modal .modal-content {
            width: min(100%, 680px);
            max-width: min(100%, 680px);
            height: auto;
            max-height: calc(100vh - 3rem);
        }

        #contact-message-modal .modal-header {
            padding: 0.9rem 1rem;
        }

        #contact-message-modal .modal-body {
            padding: 1rem;
            display: grid;
            gap: 0.65rem;
        }

        #contact-message-modal .modal-footer {
            padding: 0.85rem 1rem 1rem;
            justify-content: space-between;
        }

        #stock-history-modal .modal-body {
            padding: 1rem 1.25rem 1.25rem;
            overflow: auto;
        }

        #stock-history-modal .data-table thead th {
            padding: 0.75rem 0.9rem;
        }

        #stock-history-modal .data-table tbody td {
            padding: 0.75rem 0.9rem;
        }

        @media (max-width: 640px) {
            #stock-history-modal {
                padding: 0.75rem;
            }

            #stock-history-modal .modal-header {
                padding: 0.9rem 1rem;
            }

            #stock-history-modal .modal-header h2 {
                font-size: 1rem;
            }

            #stock-history-modal .modal-body {
                padding: 0.75rem;
            }

            #stock-history-modal .data-table thead th {
                padding: 0.6rem 0.7rem;
                font-size: 0.8rem;
            }

            #stock-history-modal .data-table tbody td {
                padding: 0.6rem 0.7rem;
                font-size: 0.85rem;
            }
        }

        /* Form */
        .form-group {
            margin-bottom: 1.25rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
            font-size: 0.9rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            font-size: 0.95rem;
            transition: border-color 0.3s ease;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-textarea {
            min-height: 180px;
            resize: vertical;
            line-height: 1.4;
        }

        /* Product modals: make description fields feel properly sized */
        #add-product-modal .form-textarea,
        #add-wholesale-product-modal .form-textarea,
        #edit-product-modal .form-textarea {
            display: block;
            min-height: 140px;
            height: 170px;
        }

        #edit-product-description {
            height: 170px;
        }

        .description-cell {
            max-width: 420px;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: 1.45;
        }

        .description-text {
            display: inline;
        }

        .description-text.hidden {
            display: none;
        }

        .description-toggle {
            margin-left: 0.4rem;
            border: none;
            background: transparent;
            color: var(--primary);
            font-size: 0.82rem;
            font-weight: 600;
            cursor: pointer;
            padding: 0;
            text-decoration: underline;
        }

        .description-toggle:hover {
            color: var(--primary-dark);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        /* Spinner */
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid var(--bg);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Upload Area */
        .upload-area {
            border: 2px dashed var(--border);
            border-radius: var(--radius-lg);
            padding: 3rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #fafafa;
        }

        .upload-area:hover {
            border-color: var(--primary);
            background: #f0f7f0;
        }

        .upload-area i {
            font-size: 3rem;
            color: var(--primary);
            margin-bottom: 1rem;
        }

        .upload-area p {
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .upload-area .hint {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Quick Actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .quick-action-card {
            background: white;
            padding: 1.5rem;
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .quick-action-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

        .quick-action-icon {
            width: 50px;
            height: 50px;
            border-radius: var(--radius);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: white;
            flex-shrink: 0;
        }

        .quick-action-card h4 {
            color: var(--text-dark);
            font-size: 1rem;
        }

        .quick-action-card p {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Mobile Menu Toggle */
        #menu-toggle {
            display: none;
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--primary);
            padding: 0.5rem;
        }

        /* Utility class for hiding text labels on very small screens */
        .hide-mobile {
            display: inline;
        }

        /* Mobile Overlay */
        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        /* Responsive */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 1024px) {
            .navbar {
                padding: 1rem;
            }

            .admin-sidebar {
                position: fixed;
                left: 0;
                top: 0;
                height: 100vh;
                z-index: 1000;
                transform: translateX(-100%);
            }

            .admin-sidebar.mobile-open {
                transform: translateX(0);
            }

            #menu-toggle {
                display: block;
            }

            .admin-main {
                width: 100%;
                padding: 1.5rem;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .quick-actions {
                grid-template-columns: repeat(2, 1fr);
            }

            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .search-box {
                max-width: 100%;
            }

            .admin-header {
                padding: 1rem;
            }

            .admin-header h1 {
                font-size: 1.4rem;
            }
        }

        @media (max-width: 768px) {
            .navbar-brand {
                font-size: 1.2rem;
            }

            .navbar-brand span:not(.logo-icon) {
                display: none;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .stat-card {
                padding: 1.25rem;
            }

            .stat-card-value {
                font-size: 1.5rem;
            }

            .quick-actions {
                grid-template-columns: 1fr;
            }

            .data-table-container {
                overflow-x: auto;
            }

            /* Slightly smaller base table width so it fits better on tablets */
            .data-table {
                font-size: 0.85rem;
                min-width: 0;
                width: 100%;
            }

            .data-table thead th,
            .data-table tbody td {
                padding: 0.75rem 0.5rem;
            }

            .table-actions {
                flex-direction: column;
            }

            .action-btn {
                width: 100%;
                justify-content: center;
            }

            .modal {
                padding: 1rem;
            }

            .modal-content {
                max-height: calc(100vh - 2rem);
                height: calc(100vh - 2rem);
            }

            .modal-header {
                padding: 1rem 1rem;
            }

            .modal-body {
                padding: 1rem;
            }

            .modal-footer {
                padding: 0.85rem 1rem 1rem;
                gap: 0.75rem;
            }

            .admin-header {
                flex-direction: column;
                align-items: flex-start;
            }

            /* Keep horizontal scrolling scoped to tables, not the whole page */
            .admin-main {
                overflow-x: hidden;
            }

            .upload-area {
                padding: 2rem 1rem;
            }

            /* On mobile, hide filter rows by default and show a toggle button */
            .controls {
                flex-direction: column;
                align-items: stretch;
            }

            .controls .search-box {
                max-width: 100%;
            }

            .controls .filter-group,
            .admin-controls .filters {
                display: none;
                width: 100%;
            }

            .controls .filter-group.filters-open,
            .admin-controls .filters.filters-open {
                display: flex;
                flex-wrap: wrap;
                margin-top: 0.75rem;
            }

            .filter-toggle {
                display: inline-flex;
                align-items: center;
                justify-content: center;
                margin-left: 0.75rem;
                margin-top: 0.75rem;
            }
        }

        @media (max-width: 767px) {
            .admin-main table {
                display: table;
                width: 100%;
            }

            .admin-main table thead {
                display: table-header-group;
            }

            .admin-main table tbody {
                display: table-row-group;
            }

            .admin-main table tr {
                display: table-row;
                margin: 0;
                border: none;
                padding: 0;
            }

            .admin-main table th,
            .admin-main table td {
                display: table-cell;
                text-align: left;
                padding: 0.75rem 0.5rem;
                border-bottom: 1px solid var(--border);
            }

            .admin-main table td:before {
                content: none;
            }
        }

        @media (max-width: 480px) {
            .navbar {
                padding: 0.75rem;
            }

            .admin-main {
                padding: 0.75rem;
            }

            .modal-content {
                border-radius: 10px;
            }

            .modal-header h2 {
                font-size: 1.2rem;
            }

            .modal-footer {
                justify-content: stretch;
            }

            .modal-footer .btn {
                width: 100%;
            }

            /* Make the slide-in sidebar narrower on very small devices */
            .admin-sidebar {
                width: 230px;
                max-width: 80vw;
            }

            .admin-header h1 {
                font-size: 1.2rem;
            }

            .stat-card-icon {
                font-size: 1.8rem;
            }

            .btn {
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            .table-header {
                padding: 1rem;
            }

            .table-header h3 {
                font-size: 1rem;
            }

            .quick-action-card {
                padding: 1rem;
            }

            .quick-action-icon {
                width: 40px;
                height: 40px;
                font-size: 1.2rem;
            }

            .form-input, .form-textarea, .form-select {
                font-size: 16px; /* Prevents zoom on iOS */
            }

            /* Hide long text labels beside icons where space is tight */
            .hide-mobile {
                display: none;
            }
        }

        /* Activity Timeline */
        .activity-timeline {
            position: relative;
            padding-left: 2rem;
        }

        .activity-timeline::before {
            content: '';
            position: absolute;
            left: 7px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border);
        }

        .activity-item {
            position: relative;
            padding-bottom: 1.5rem;
        }

        .activity-item:last-child {
            padding-bottom: 0;
        }

        .activity-icon {
            position: absolute;
            left: -2rem;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: var(--primary);
            border: 2px solid white;
        }

        .activity-icon.order { background: var(--info); }
        .activity-icon.register { background: var(--success); }
        .activity-icon.login { background: var(--primary); }

        .activity-content {
            background: white;
            padding: 1rem;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .activity-content strong {
            color: var(--text-dark);
        }

        .activity-time {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>
    <div class="sidebar-overlay" id="sidebar-overlay" onclick="closeSidebar()"></div>

    <nav class="navbar">
        <div style="display: flex; align-items: center; gap: 1rem;">
            <button id="menu-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </button>
            <a href="/" class="navbar-brand">
                <span class="logo-icon">üèîÔ∏è</span>
                <span>Mountain Made 2.0 Admin</span>
            </a>
        </div>
        <!-- Success Modal -->
        <div id="success-modal" class="modal" style="display:none; position:fixed; z-index:9999; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.25); align-items:center; justify-content:center;">
            <div style="background:white; border-radius:12px; max-width:90vw; width:400px; margin:auto; box-shadow:0 4px 32px rgba(0,0,0,0.18); padding:2.5rem 2rem; text-align:center; position:relative;">
                <i class="fas fa-check-circle" style="color:#28a745; font-size:2.5rem; margin-bottom:1rem;"></i>
                <div id="success-modal-message" style="font-size:1.1rem; color:#222; margin-bottom:1.5rem;"></div>
                <button class="btn btn-success" onclick="closeSuccessModal()">OK</button>
            </div>
        </div>
        <div class="navbar-actions">
            <span id="user-name" style="color: var(--text-muted); display: none;"></span>
            <button id="logout-btn" type="button" class="btn btn-sm btn-secondary">
                <i class="fas fa-sign-out-alt"></i> <span class="hide-mobile">Logout</span>
            </button>
        </div>
    </nav>

    <div class="admin-container">
        <div class="admin-sidebar" id="admin-sidebar">
            <div class="sidebar-brand">
                <i class="fas fa-mountain"></i>
                <span>Admin Menu</span>
            </div>

            <div class="admin-nav-item" onclick="showSection('dashboard')">
                <i class="fas fa-tachometer-alt"></i> Dashboard
            </div>

            <div class="sidebar-section-title">Products</div>
            <div class="admin-nav-item" onclick="showSection('manage-products')">
                <i class="fas fa-box"></i> Manage Products
            </div>
            <div class="admin-nav-item" onclick="showSection('upload-products')">
                <i class="fas fa-upload"></i> Upload Products
            </div>
            <div class="admin-nav-item" onclick="showSection('categories')">
                <i class="fas fa-tags"></i> Categories
            </div>
            <div class="admin-nav-item" onclick="showSection('homepage-sections')">
                <i class="fas fa-star"></i> Homepage Sections
            </div>
            <div class="admin-nav-item" onclick="showSection('stock-reports')">
                <i class="fas fa-warehouse"></i> Stock Reports
            </div>

            <div class="sidebar-section-title">Orders</div>
            <div class="admin-nav-item" onclick="showSection('order-history')">
                <i class="fas fa-history"></i> Order History
            </div>
            <div class="admin-nav-item" onclick="showSection('customers-orders')">
                <i class="fas fa-shopping-bag"></i> Customers Orders
                <span id="customer-orders-dot" class="dot-indicator hidden" title="New orders"></span>
                <span id="customer-orders-badge" class="badge-count" style="display: none;">0</span>
            </div>

            <div class="sidebar-section-title">Customers</div>
            <div class="admin-nav-item" onclick="showSection('customers')">
                <i class="fas fa-users"></i> Manage Customers
            </div>
            <div class="admin-nav-item" onclick="showSection('activities')">
                <i class="fas fa-clock"></i> User Activities
            </div>

            <div class="sidebar-section-title">Support</div>
            <div class="admin-nav-item" onclick="showSection('messages')">
                <i class="fas fa-envelope"></i> Messages
                <span id="messages-badge" class="badge-count" style="display: none;">0</span>
            </div>

            <div class="sidebar-section-title">Users</div>
            <div class="admin-nav-item" onclick="showSection('users')">
                <i class="fas fa-user-cog"></i> Manage Users
            </div>
            <div class="admin-nav-item" onclick="showSection('wholesale')">
                <i class="fas fa-building"></i> Wholesale Requests
                <span id="wholesale-badge" class="badge-count" style="display: none;">0</span>
            </div>

            <div class="sidebar-section-title">Settings</div>
            <div class="admin-nav-item" onclick="showSection('admin-license')">
                <i class="fas fa-key"></i> Admin License
            </div>
            <div class="admin-nav-item" onclick="showSection('site-settings')">
                <i class="fas fa-cog"></i> Site Settings
            </div>
            <div class="admin-nav-item" onclick="showSection('database-backup')">
                <i class="fas fa-database"></i> Database Backup
            </div>
        </div>

        <div class="admin-main">
            <div id="alert" class="alert"></div>

            <!-- Dashboard Section -->
            <div id="dashboard" class="section active">
                <div class="admin-header">
                    <h1><i class="fas fa-chart-line"></i> Dashboard</h1>
                    <div style="display:flex; align-items:center; gap:0.75rem; flex-wrap:wrap; justify-content:flex-end;">
                        <span style="color: var(--text-muted); font-size: 0.9rem;">Pending Orders</span>
                        <span id="dashboard-header-customer-orders-dot" class="dot-indicator hidden" title="New orders"></span>
                        <span id="dashboard-header-customer-orders-badge" class="badge-count" style="display: none;" title="Pending customer orders">0</span>
                        <span id="current-date" style="color: var(--text-muted); font-size: 0.9rem;"></span>
                    </div>
                </div>

                <div class="stats-grid" id="stats-container">
                    <div class="stat-card primary">
                        <div class="spinner"></div>
                    </div>
                </div>

                <div class="quick-actions">
                    <div class="quick-action-card" onclick="showSection('manage-products')">
                        <div class="quick-action-icon" style="background: var(--primary);">
                            <i class="fas fa-plus"></i>
                        </div>
                        <div>
                            <h4>Add Product</h4>
                            <p>Create new product</p>
                        </div>
                    </div>
                    <div class="quick-action-card" onclick="showSection('upload-products')">
                        <div class="quick-action-icon" style="background: var(--info);">
                            <i class="fas fa-upload"></i>
                        </div>
                        <div>
                            <h4>Product Upload</h4>
                            <p>Single and wholesale upload</p>
                        </div>
                    </div>
                    <div class="quick-action-card" onclick="showSection('order-history')">
                        <div class="quick-action-icon" style="background: var(--warning);">
                            <i class="fas fa-shopping-bag"></i>
                        </div>
                        <div>
                            <h4>View Orders</h4>
                            <p>Manage orders</p>
                        </div>
                    </div>
                    <div class="quick-action-card" onclick="showSection('customers')">
                        <div class="quick-action-icon" style="background: var(--success);">
                            <i class="fas fa-users"></i>
                        </div>
                        <div>
                            <h4>Customers</h4>
                            <p>Manage customers</p>
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3 style="display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap;">
                            <span style="display:flex; align-items:center; gap:0.6rem;">
                                <i class="fas fa-clock"></i>
                                <span>Recent Orders</span>
                            </span>
                            <span id="dashboard-customer-orders-dot" class="dot-indicator hidden" title="New orders"></span>
                            <span id="dashboard-customer-orders-badge" class="badge-count" style="display: none;" title="Pending customer orders">0</span>
                        </h3>
                        <button class="btn btn-primary btn-sm" onclick="showSection('order-history')">View All</button>
                    </div>
                    <div id="recent-orders-container">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-exclamation-triangle"></i> Low Stock Products</h3>
                        <button class="btn btn-primary btn-sm" onclick="showSection('manage-products')">View All</button>
                    </div>
                    <div id="low-stock-container">
                        <div class="empty-state"><div class="spinner"></div></div>
                    </div>
                </div>
            </div>

            <!-- Messages Section -->
            <div id="messages" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-envelope"></i> Messages</h1>
                    <button class="btn btn-secondary" type="button" onclick="loadContactInbox('message', { force: true })">
                        <i class="fas fa-rotate"></i> Refresh
                    </button>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Send Message</h3>
                    </div>
                    <div style="padding: 1.25rem 1.5rem;">
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap: 1rem; align-items:end;">
                            <div>
                                <label class="form-label" for="admin-message-audience">Send To</label>
                                <select id="admin-message-audience" class="form-input">
                                    <option value="all">All Users (Customers + Wholesale)</option>
                                    <option value="customers">All Customers</option>
                                    <option value="wholesale">All Wholesale Users</option>
                                    <option value="single">Single User</option>
                                </select>
                            </div>

                            <div id="admin-message-single-wrap" style="display:none;">
                                <div style="display:flex; gap:0.5rem; align-items:end;">
                                    <div style="min-width: 140px;">
                                        <label class="form-label" for="admin-message-identifier-type">Find By</label>
                                        <select id="admin-message-identifier-type" class="form-input">
                                            <option value="email">Email</option>
                                            <option value="id">User ID</option>
                                        </select>
                                    </div>
                                    <div style="flex:1; min-width: 220px;">
                                        <label class="form-label" for="admin-message-identifier">Customer Email / ID</label>
                                        <input id="admin-message-identifier" class="form-input" placeholder="Type email or id" list="admin-user-suggestions" autocomplete="off">
                                        <datalist id="admin-user-suggestions"></datalist>
                                    </div>
                                </div>
                                <div style="margin-top:0.35rem; color: var(--text-muted); font-size: 0.85rem;">Search includes wholesale users too.</div>
                            </div>
                        </div>

                        <div style="display:flex; gap:1rem; align-items:center; flex-wrap:wrap; margin-top: 0.9rem;">
                            <label style="display:flex; align-items:center; gap:0.5rem; color: var(--text-muted); font-size: 0.95rem;">
                                <input type="checkbox" id="admin-message-channel-email" checked> Send to Email
                            </label>
                            <label style="display:flex; align-items:center; gap:0.5rem; color: var(--text-muted); font-size: 0.95rem;">
                                <input type="checkbox" id="admin-message-channel-sms"> Send to Phone (SMS)
                            </label>
                            <label style="display:flex; align-items:center; gap:0.5rem; color: var(--text-muted); font-size: 0.95rem;">
                                <input type="checkbox" id="admin-message-channel-whatsapp"> Send to WhatsApp
                            </label>
                        </div>

                        <div style="display:grid; grid-template-columns: 1fr; gap: 0.85rem; margin-top: 0.9rem;">
                            <div>
                                <label class="form-label" for="admin-message-subject">Subject (Email)</label>
                                <input type="text" id="admin-message-subject" class="form-input" placeholder="Subject">
                            </div>
                            <div>
                                <label class="form-label" for="admin-message-body">Message</label>
                                <textarea id="admin-message-body" class="form-input" rows="5" placeholder="Write your message..."></textarea>
                            </div>
                        </div>

                        <div style="display:flex; gap:0.75rem; align-items:center; margin-top: 1rem; flex-wrap:wrap;">
                            <button class="btn btn-primary" id="admin-message-send-btn" type="button" onclick="sendAdminBroadcastMessage()">
                                <i class="fas fa-paper-plane"></i> Send
                            </button>
                            <div id="admin-message-send-result" style="color: var(--text-muted); font-size: 0.9rem;"></div>
                        </div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Sent Message History</h3>
                        <button class="btn btn-secondary btn-sm" type="button" onclick="loadAdminSentMessageHistory({ force: true })">
                            <i class="fas fa-rotate"></i> Refresh
                        </button>
                    </div>
                    <div id="admin-sent-history-wrap">
                        <div class="empty-state"><p>Loading history...</p></div>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Customer Messages</h3>
                        <div style="display:flex; gap:0.5rem; align-items:center; flex-wrap:wrap;">
                            <label style="display:flex; align-items:center; gap:0.5rem; color: var(--text-muted); font-size: 0.9rem;">
                                <input type="checkbox" id="messages-unread-only" onchange="loadContactInbox('message', { force: true })"> Unread only
                            </label>
                        </div>
                    </div>
                    <div id="messages-table-wrap">
                        <div class="empty-state"><p>Loading records...</p></div>
                    </div>
                </div>
            </div>

            <!-- Manage Products Section -->
            <div id="manage-products" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-box"></i> Manage Products</h1>
                    <button class="btn btn-primary" onclick="showAddProductModal()">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="product-search" placeholder="Search products..." onkeyup="filterProducts()">
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                        <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                    </button>
                    <div class="filter-group">
                        <select class="filter-select" id="category-filter" onchange="filterProducts()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>

                <div id="products-list"></div>
            </div>

            <!-- Upload Products Section -->
            <div id="upload-products" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-upload"></i> Upload Products</h1>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-box-open"></i> Product Upload Options</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-bottom: 2rem;">
                            <div>
                                <h4 style="margin-bottom: 1rem;">Single Product Upload</h4>
                                <div class="upload-area" onclick="showAddSingleProductModal()">
                                    <i class="fas fa-plus-circle"></i>
                                    <p>Add Single Product</p>
                                    <span class="hint">Create customer-facing product with dynamic multi-image upload</span>
                                </div>
                                <button class="btn btn-primary" style="margin-top: 0.75rem; width: 100%;" onclick="showAddSingleProductModal()">
                                    <i class="fas fa-plus"></i> Open Single Product Form
                                </button>
                            </div>
                            <div>
                                <h4 style="margin-bottom: 1rem;">Wholesale Product Upload</h4>
                                <div class="upload-area" onclick="document.getElementById('wholesale-image-input').click()">
                                    <i class="fas fa-image"></i>
                                    <p>Click to select wholesale images</p>
                                    <span class="hint">Formats: JPG, PNG (Max 5MB each, up to 5)</span>
                                </div>
                                <input type="file" id="wholesale-image-input" accept=".jpg,.jpeg,.png" multiple style="display: none;" onchange="handleWholesaleImageUpload(event)">
                                <button class="btn btn-secondary" style="margin-top: 0.75rem; width: 100%;" onclick="showAddWholesaleProductModal()">
                                    <i class="fas fa-building"></i> Open Wholesale Product Form
                                </button>
                            </div>
                        </div>
                        
                        <div id="wholesale-upload-preview" style="margin-top: 2rem; display: none;">
                            <h4 style="margin-bottom: 1rem;">Wholesale Image Selection</h4>
                            <div id="wholesale-upload-preview-table"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Categories Section -->
            <div id="categories" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-tags"></i> Categories</h1>
                    <button class="btn btn-primary" onclick="showAddCategoryModal()">
                        <i class="fas fa-plus"></i> Add Category
                    </button>
                </div>
                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="category-search" placeholder="Search categories..." onkeyup="filterCategories()">
                    </div>
                </div>
                <div id="categories-list"></div>
            </div>

            <!-- Homepage Sections -->
            <div id="homepage-sections" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-star"></i> Homepage Sections</h1>
                    <button class="btn btn-primary" onclick="showAddSectionModal()">
                        <i class="fas fa-plus"></i> Add Section
                    </button>
                </div>
                <div class="controls">
                    <p style="color: var(--text-muted); font-size: 0.9rem;">Create custom sections like "Featured Products", "New Arrivals", etc. to display on the homepage. Assign products to these sections when adding/editing products.</p>
                </div>

                <div id="homepage-sections-list"></div>
            </div>

            <!-- Stock Reports Section -->
            <div id="stock-reports" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-warehouse"></i> Stock Reports</h1>
                    <button class="btn btn-primary" onclick="exportStockReport()">
                        <i class="fas fa-download"></i> Export Report
                    </button>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="stock-search" placeholder="Search products..." onkeyup="filterStockReports()">
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                        <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                    </button>
                    <div class="filter-group">
                        <select class="filter-select" id="stock-status-filter" onchange="filterStockReports()">
                            <option value="">All Status</option>
                            <option value="in-stock">In Stock</option>
                            <option value="low-stock">Low Stock</option>
                            <option value="out-of-stock">Out of Stock</option>
                        </select>
                        <select class="filter-select" id="stock-category-filter" onchange="filterStockReports()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                </div>

                <div class="stats-grid" id="stock-stats" style="margin-bottom: 2rem;">
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-value" id="total-products-count">0</div>
                        <div class="stat-label">Total Products</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--success);">
                        <div class="stat-value" id="in-stock-count">0</div>
                        <div class="stat-label">In Stock</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--warning);">
                        <div class="stat-value" id="low-stock-count">0</div>
                        <div class="stat-label">Low Stock (‚â§10)</div>
                    </div>
                    <div class="stat-card" style="border-left-color: var(--danger);">
                        <div class="stat-value" id="out-stock-count">0</div>
                        <div class="stat-label">Out of Stock</div>
                    </div>
                </div>

                <div id="stock-reports-list"></div>
            </div>

            <!-- Order History Section -->
            <div id="order-history" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-history"></i> Order History</h1>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="order-search" placeholder="Search orders..." onkeyup="filterOrders()">
                    </div>
                    <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                        <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                    </button>
                    <div class="filter-group">
                        <select class="filter-select" id="order-status-filter" onchange="filterOrders()">
                            <option value="">All Status</option>
                            <option value="pending">Pending</option>
                            <option value="processing">Processing</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                </div>

                <div id="orders-list"></div>
            </div>

            <!-- Customers Orders Section -->
            <div id="customers-orders" class="section">
                <div class="admin-header">
                    <h1 style="display:flex; align-items:center; gap:0.6rem; flex-wrap:wrap;">
                        <span style="display:flex; align-items:center; gap:0.6rem;">
                            <i class="fas fa-shopping-bag"></i>
                            <span>Customer Orders</span>
                        </span>
                        <span id="customer-orders-header-dot" class="dot-indicator hidden" title="New orders"></span>
                    </h1>
                </div>

                <div class="controls">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" id="customer-order-search" placeholder="Search by customer..." onkeyup="filterCustomerOrders()">
                    </div>
                </div>

                <div id="customer-orders-list"></div>
            </div>

            <!-- Customers Section -->
            <div id="customers" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-users"></i> Customers</h1>
                </div>
                <div id="customers-list"></div>
            </div>

            <!-- User Activities Section -->
            <div id="activities" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-clock"></i> User Activities</h1>
                    <div class="admin-controls">
                        <div class="search-box">
                            <input type="text" id="activities-search" placeholder="Search activities..." onkeyup="filterActivities()">
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                            <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                        </button>
                        <div class="filters">
                            <select class="filter-select" id="activities-type-filter" onchange="filterActivities()">
                                <option value="">All Types</option>
                                <option value="order">Orders</option>
                                <option value="user_registered">User Registered</option>
                            </select>
                            <input type="date" class="filter-select" id="activities-date-from" onchange="filterActivities()" title="From date">
                            <input type="date" class="filter-select" id="activities-date-to" onchange="filterActivities()" title="To date">
                        </div>
                    </div>
                </div>
                <div id="activities-list"></div>
            </div>

            <!-- Manage Users Section -->
            <div id="users" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-user-cog"></i> Manage Users</h1>
                    <div class="admin-controls">
                        <div class="search-box">
                            <input type="text" id="user-search" placeholder="Search users..." onkeyup="filterUsers()">
                        </div>
                        <button type="button" class="btn btn-secondary btn-sm filter-toggle" onclick="toggleFilters(this)">
                            <i class="fas fa-filter"></i> <span class="hide-mobile">Filters</span>
                        </button>
                        <div class="filters">
                            <select class="filter-select" id="user-role-filter" onchange="filterUsers()">
                                <option value="">All Roles</option>
                                <option value="admin">Admin</option>
                                <option value="customer">Customer</option>
                                <option value="wholesale">Wholesale</option>
                            </select>
                            <select class="filter-select" id="user-status-filter" onchange="filterUsers()">
                                <option value="">All Statuses</option>
                                <option value="active">Active</option>
                                <option value="blocked">Blocked</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div id="users-list"></div>
            </div>

            <!-- Wholesale Requests Section -->
            <div id="wholesale" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-building"></i> Wholesale Requests</h1>
                </div>
                <div id="wholesale-list"></div>
            </div>

            <!-- Site Settings Section -->
            <div id="site-settings" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-cog"></i> Site Settings</h1>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>Site Logo</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">Upload your custom logo to replace the default Mountain Made branding across all pages.</p>
                        
                        <div style="display: flex; gap: 2rem; align-items: flex-start; flex-wrap: wrap;">
                            <div style="flex: 1; min-width: 300px;">
                                <label class="form-label">Upload Logo (JPG or PNG)</label>
                                <input type="file" id="logo-upload" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewLogo(event)">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Recommended size: 200x50px or similar aspect ratio. Max 2MB.</small>
                                
                                <button class="btn btn-primary" onclick="uploadLogo()" style="margin-top: 1rem;">
                                    <i class="fas fa-upload"></i> Upload & Save Logo
                                </button>
                                <button class="btn btn-secondary" onclick="resetLogoToDefault()" style="margin-top: 1rem; margin-left: 0.5rem;">
                                    <i class="fas fa-undo"></i> Reset to Default
                                </button>
                                <button class="btn btn-info" onclick="openEditLogoModal()" style="margin-top: 1rem; margin-left: 0.5rem;">
                                    <i class="fas fa-edit"></i> Edit Logo
                                </button>
                            </div>
                            
                            <div style="text-align: center;">
                                <label class="form-label">Preview</label>
                                <div id="logo-preview-container" style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); min-width: 250px;">
                                    <img id="logo-preview" src="" alt="Logo Preview" style="max-width: 200px; max-height: 80px; display: none;">
                                    <div id="logo-preview-placeholder" style="color: var(--text-muted); padding: 2rem;">
                                        <i class="fas fa-image" style="font-size: 3rem; opacity: 0.3;"></i>
                                        <p style="margin-top: 1rem;">No logo selected</p>
                                    </div>
                                </div>
                                <!-- Edit Logo Modal -->
                                <div id="edit-logo-modal" class="modal" style="display:none;">
                                    <div class="modal-content" style="background:white; padding:2rem; border-radius:8px; max-width:400px; margin:auto;">
                                        <h4>Edit Logo</h4>
                                        <div id="edit-logo-crop-container" style="margin-bottom:1rem;">
                                            <img id="edit-logo-crop-img" src="" style="max-width:100%; max-height:150px;">
                                        </div>
                                        <button class="btn btn-success" onclick="saveEditedLogo()"><i class="fas fa-save"></i> Save Changes</button>
                                        <button class="btn btn-secondary" onclick="closeEditLogoModal()" style="margin-left:0.5rem;"><i class="fas fa-times"></i> Cancel</button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div id="current-logo-display" style="margin-top: 2rem; padding-top: 2rem; border-top: 1px solid var(--border);">
                            <label class="form-label">Current Active Logo</label>
                            <div style="background: white; padding: 1.5rem; border-radius: 8px; border: 1px solid var(--border); display: inline-block; margin-top: 0.5rem;">
                                <img id="current-logo-img" src="" alt="Current Logo" style="max-width: 200px; max-height: 80px;">
                            </div>
                        </div>

                    </div>
                </div>

                <div class="data-table-container" style="margin-top: 1.5rem;">
                    <div class="table-header">
                        <h3>Homepage Headings</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                            Configure the main heading and subtitle text shown in the homepage hero section.
                            These values are stored in the database and will persist across code updates and restarts.
                        </p>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" for="homepage-hero-title">Homepage Hero Title</label>
                            <input type="text" id="homepage-hero-title" class="form-input" placeholder="e.g., Fresh from the Mountains">
                        </div>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" for="homepage-hero-subtitle">Homepage Hero Subtitle</label>
                            <textarea id="homepage-hero-subtitle" class="form-input" rows="3" placeholder="Short description text under the main heading"></textarea>
                        </div>

                        <button class="btn btn-primary" onclick="saveHomepageHeadings()">
                            <i class="fas fa-save"></i> Save Homepage Headings
                        </button>
                    </div>
                </div>

                <div class="data-table-container" style="margin-top: 1.5rem;">
                    <div class="table-header">
                        <h3>Delivery Settings</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1.5rem;">
                            Configure the Fast Delivery option that appears during checkout. The charge is added on top of the cart subtotal when customers choose Fast Delivery.
                        </p>

                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" style="display: flex; align-items: center; gap: 0.5rem;">
                                <input type="checkbox" id="fast-delivery-enabled" style="width: auto;">
                                Enable Fast Delivery at checkout
                            </label>
                        </div>

                        <div class="form-group" style="margin-bottom: 1rem; max-width: 260px;">
                            <label class="form-label" for="fast-delivery-charge">Fast Delivery Charge (‚Çπ)</label>
                            <input type="text" id="fast-delivery-charge" class="form-input" placeholder="e.g., 50">
                            <small style="color: var(--text-muted); display: block; margin-top: 0.35rem;">
                                This amount will be applied per order when Fast Delivery is selected.
                            </small>
                        </div>

                        <button class="btn btn-primary" onclick="saveDeliverySettings()">
                            <i class="fas fa-shipping-fast"></i> Save Delivery Settings
                        </button>
                    </div>
                </div>

                <div class="data-table-container" style="margin-top: 1.5rem;">
                    <div class="table-header">
                        <h3>Business Email Integration</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <p style="color: var(--text-muted); margin-bottom: 1rem;">
                            Contact Us messages are auto-forwarded to this email. If empty, default is hello@mountain-made.com.
                        </p>

                        <div class="form-group" style="margin-bottom: 1rem; max-width: 520px;">
                            <label class="form-label" for="business-support-email">Business Support Email</label>
                            <input type="email" id="business-support-email" class="form-input" placeholder="hello@mountain-made.com">
                            <small style="color: var(--text-muted); display: block; margin-top: 0.35rem;">
                                Example: support@yourdomain.com
                            </small>
                        </div>

                        <button class="btn btn-primary" onclick="saveBusinessEmailSettings()">
                            <i class="fas fa-envelope"></i> Save Business Email
                        </button>
                    </div>
                </div>
            </div>

            <!-- Admin License Section -->
            <div id="admin-license" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-key"></i> Admin License</h1>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3>License Status</h3>
                    </div>
                    <div style="padding: 1.5rem; display: grid; gap: 1rem;">
                        <div id="admin-license-status-banner" style="padding: 1rem; border-radius: 8px; border: 1px solid var(--border); background: var(--bg-secondary); color: var(--text-primary);">
                            Loading license status...
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 0.75rem;">
                            <div style="padding: 0.9rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary);">
                                <strong style="display:block; margin-bottom:0.25rem;">Server Time</strong>
                                <span id="admin-license-server-time">-</span>
                            </div>
                            <div style="padding: 0.9rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary);">
                                <strong style="display:block; margin-bottom:0.25rem;">Expiry Time</strong>
                                <span id="admin-license-expiry-time">Not set</span>
                            </div>
                            <div style="padding: 0.9rem; border: 1px solid var(--border); border-radius: 8px; background: var(--bg-secondary);">
                                <strong style="display:block; margin-bottom:0.25rem;">Countdown</strong>
                                <span id="admin-license-countdown">-</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="super-admin-license-manage" class="data-table-container hidden" style="margin-top: 1.5rem;">
                    <div class="table-header">
                        <h3>Manage Admin License (Super Admin)</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div class="form-group" style="margin-bottom: 1rem;">
                            <label class="form-label" style="display:flex; align-items:center; gap:0.5rem;">
                                <input type="checkbox" id="license-manual-block" style="width:auto;">
                                Manually block admin features now
                            </label>
                        </div>

                        <div class="form-group" style="margin-bottom: 1rem; max-width: 360px;">
                            <label class="form-label" for="license-expires-at">Auto block at (date & time)</label>
                            <input type="datetime-local" id="license-expires-at" class="form-input">
                            <small style="color: var(--text-muted); display:block; margin-top:0.4rem;">When reached, admin features are automatically blocked.</small>
                        </div>

                        <div style="display:flex; gap:0.6rem; flex-wrap:wrap;">
                            <button class="btn btn-primary" onclick="saveAdminLicenseSettings()">
                                <i class="fas fa-save"></i> Save License Settings
                            </button>
                            <button class="btn btn-danger" onclick="blockAdminLicenseNow()">
                                <i class="fas fa-ban"></i> Block License Now
                            </button>
                            <button class="btn btn-secondary" onclick="unblockAdminLicenseNow()">
                                <i class="fas fa-unlock"></i> Unblock License
                            </button>
                            <button class="btn btn-secondary" onclick="clearAdminLicenseExpiry()">
                                <i class="fas fa-eraser"></i> Clear Expiry
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Database Backup Section -->
            <div id="database-backup" class="section">
                <div class="admin-header">
                    <h1><i class="fas fa-database"></i> Database Backup</h1>
                    <p>Create and manage backups of your PostgreSQL database</p>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h3><i class="fas fa-plus-circle"></i> Create New Backup</h3>
                    </div>
                    <div style="padding: 2rem;">
                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label">Select Drive</label>
                            <select id="backup-drive-select" class="form-input" style="max-width: 300px;" onchange="updateDriveInfo()">
                                <option value="">Loading drives...</option>
                            </select>
                            <div id="drive-info" style="margin-top: 0.75rem; padding: 1rem; background: #f8f9fa; border-radius: 6px; display: none;">
                                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                                    <div>
                                        <strong style="color: var(--text-muted); font-size: 0.875rem;">Total Space</strong>
                                        <p id="drive-total" style="margin: 0.25rem 0 0; font-size: 1.1rem; color: var(--text-primary);">-</p>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-muted); font-size: 0.875rem;">Free Space</strong>
                                        <p id="drive-free" style="margin: 0.25rem 0 0; font-size: 1.1rem; color: #10b981;">-</p>
                                    </div>
                                    <div>
                                        <strong style="color: var(--text-muted); font-size: 0.875rem;">Used Space</strong>
                                        <p id="drive-used" style="margin: 0.25rem 0 0; font-size: 1.1rem; color: #f59e0b;">-</p>
                                    </div>
                                </div>
                                <div style="margin-top: 1rem;">
                                    <div style="background: #e5e7eb; border-radius: 9999px; height: 8px; overflow: hidden;">
                                        <div id="drive-usage-bar" style="background: linear-gradient(90deg, #10b981, #f59e0b); height: 100%; transition: width 0.3s; width: 0%;"></div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="form-group" style="margin-bottom: 1.5rem;">
                            <label class="form-label">Backup Folder</label>
                            <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center; max-width: 500px;">
                                <input type="text" id="backup-folder-path" class="form-input" placeholder="Choose a folder or enter a name" style="flex: 1 1 220px; min-width: 0;">
                                <button type="button" class="btn btn-secondary" onclick="openBackupFolderPicker()">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                                <!-- Hidden folder picker: we only use the folder name, not the full path -->
                                <input type="file" id="backup-folder-picker" webkitdirectory directory style="display: none;" />
                            </div>
                            <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">
                                Select a folder from your computer to reuse its name, or type a custom name. This does <strong>not</strong> write to your local PC path directly; backups are created on server storage under the selected drive/path.
                                Leave empty to use the default <strong>mountain_made_backups</strong> folder.
                            </small>
                        </div>

                        <div style="padding: 1rem; background: #eff6ff; border: 1px solid #3b82f6; border-radius: 6px; margin-bottom: 1.5rem;">
                            <div style="display: flex; gap: 0.75rem; align-items: start;">
                                <i class="fas fa-info-circle" style="color: #3b82f6; margin-top: 0.25rem;"></i>
                                <div style="flex: 1;">
                                    <strong style="color: #1e40af;">Full Backup Path Preview:</strong>
                                    <p id="full-backup-path-preview" style="margin: 0.5rem 0 0; font-family: monospace; color: #374151;">
                                        Select a drive first
                                    </p>
                                </div>
                            </div>
                        </div>

                        <button class="btn btn-primary" onclick="createDatabaseBackup()" id="create-backup-btn">
                            <i class="fas fa-database"></i> Create Backup Now
                        </button>
                    </div>
                </div>

                <div class="data-table-container" style="margin-top: 2rem;">
                    <div class="table-header" style="background: #f8fafc; border-bottom: 1px solid #dbeafe;">
                        <h3><i class="fas fa-clock"></i> Automatic Backup Schedule</h3>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label class="form-label" for="auto-backup-enabled">Enable Automatic Backup</label>
                                <select id="auto-backup-enabled" class="form-input">
                                    <option value="true">Enabled</option>
                                    <option value="false">Disabled</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label" for="auto-backup-frequency">Frequency</label>
                                <select id="auto-backup-frequency" class="form-input" onchange="toggleAutoBackupFrequencyFields()">
                                    <option value="daily">Daily</option>
                                    <option value="monthly">Monthly</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label" for="auto-backup-time">Backup Time</label>
                                <input id="auto-backup-time" type="time" class="form-input" value="02:00">
                            </div>
                            <div id="auto-backup-day-wrap" style="display:none;">
                                <label class="form-label" for="auto-backup-day">Day of Month</label>
                                <input id="auto-backup-day" type="number" min="1" max="31" class="form-input" value="1">
                            </div>
                        </div>

                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1rem;">
                            <div>
                                <label class="form-label" for="auto-backup-keep-months">Keep Backups For (Months)</label>
                                <input id="auto-backup-keep-months" type="number" min="1" max="36" class="form-input" value="3">
                            </div>
                            <div>
                                <label class="form-label" for="auto-backup-drive">Auto Backup Drive</label>
                                <select id="auto-backup-drive" class="form-input">
                                    <option value="/">/</option>
                                </select>
                            </div>
                            <div>
                                <label class="form-label" for="auto-backup-folder">Auto Backup Folder</label>
                                <input id="auto-backup-folder" type="text" class="form-input" placeholder="mountain_made_backups" value="mountain_made_backups">
                            </div>
                        </div>

                        <div style="display: flex; flex-wrap: wrap; gap: 0.75rem; align-items: center;">
                            <button class="btn btn-primary" onclick="saveAutoBackupSettings()" id="save-auto-backup-btn">
                                <i class="fas fa-save"></i> Save Auto Backup Settings
                            </button>
                            <button class="btn btn-secondary" onclick="loadAutoBackupSettings()">
                                <i class="fas fa-sync-alt"></i> Reload Settings
                            </button>
                            <small id="auto-backup-status" style="color: var(--text-muted);">Configure daily/monthly automatic backups.</small>
                        </div>
                    </div>
                </div>

                <div class="data-table-container" style="margin-top: 2rem;">
                    <div class="table-header">
                        <h3><i class="fas fa-history"></i> Backup History</h3>
                        <button class="btn btn-secondary btn-sm" onclick="loadBackupHistory()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Filename</th>
                                    <th>Location</th>
                                    <th>Size</th>
                                    <th>Status</th>
                                    <th>Created By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="backup-history-table">
                                <tr>
                                    <td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">
                                        <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 0.5rem;"></i>
                                        <p>Loading backup history...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Super Admin Only: Restore + Danger Zone -->
                <div id="super-admin-tools" class="hidden">
                    <!-- Restore Database Section -->
                    <div class="data-table-container" style="margin-top: 2rem; border-top: 3px solid #3b82f6;">
                        <div class="table-header" style="background: #eff6ff; border-bottom-color: #3b82f6;">
                            <h3 style="color: #2563eb;"><i class="fas fa-undo"></i> Restore Database</h3>
                        </div>
                        <div style="padding: 1.5rem; background: #eff6ff;">
                            <form id="restore-form" enctype="multipart/form-data" onsubmit="handleRestoreDatabase(event)">
                                <label class="form-label">Select .sql Backup File</label>
                                <input type="file" id="restore-sqlfile" name="sqlfile" accept=".sql" class="form-input" required style="max-width: 350px;">
                                <button type="submit" class="btn btn-primary" style="margin-left: 1rem;">
                                    <i class="fas fa-upload"></i> Restore
                                </button>
                            </form>
                            <div id="restore-status" style="margin-top: 0.75rem; font-size: 0.95rem; color: #2563eb;"></div>
                            <small style="color: #2563eb; display: block; margin-top: 0.75rem;">Restores the entire database from a backup file. <b>This will overwrite all current data.</b></small>
                        </div>
                    </div>

                    <div class="data-table-container" style="margin-top: 2rem; border-top: 3px solid #dc3545;">
                        <div class="table-header" style="background: #fef2f2; border-bottom-color: rgba(220, 53, 69, 0.2);">
                            <h3 style="color: #b91c1c;"><i class="fas fa-exclamation-triangle"></i> Delete All Data (Danger Zone)</h3>
                        </div>
                        <div style="padding: 1.5rem; background: #fef2f2;">
                            <p style="color: #7f1d1d; margin-bottom: 0.75rem; font-weight: 600;">This will permanently delete:</p>
                            <ul style="color: #991b1b; margin-left: 1.25rem; margin-bottom: 1rem; font-size: 0.9rem;">
                                <li>All customers and wholesale users</li>
                                <li>All orders, carts, and addresses</li>
                                <li>All products, categories, homepage sections, and site settings</li>
                                <li>All uploads and backup records</li>
                            </ul>
                            <p style="color: #7f1d1d; margin-bottom: 1rem; font-size: 0.9rem;">
                                Admin and Super Admin accounts will be kept so that you can still log in.
                            </p>
                            <button class="btn btn-danger" onclick="confirmDeleteAllData()">
                                <i class="fas fa-trash-alt"></i> Delete All Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Add Product Modal -->
            <div id="add-product-modal" class="modal">
                <div class="modal-content modal-content-xl">
                    <div class="modal-header">
                        <h2>Add New Product</h2>
                        <button class="modal-close" onclick="closeAddProductModal()">&times;</button>
                    </div>
                    <form id="add-product-form" onsubmit="handleAddProduct(event)">
                        <div class="modal-body">
                            <div class="form-row">
                                <div>
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" id="product-name" class="form-input" placeholder="e.g., Organic Honey" required>
                                </div>
                                <div>
                                    <label class="form-label">Price (‚Çπ) *</label>
                                    <input type="number" id="product-price" class="form-input" placeholder="0.00" step="0.01" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Discount Price (‚Çπ) <small style="color: var(--text-muted); font-weight: normal;">Optional</small></label>
                                    <input type="number" id="product-discount-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Wholesale Price (‚Çπ)</label>
                                    <input type="number" id="product-wholesale-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Stock Quantity *</label>
                                    <input type="number" id="product-stock" class="form-input" placeholder="0" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Category</label>
                                    <select id="product-category" class="form-select">
                                        <option value="1">Select Category</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Min Wholesale Quantity</label>
                                    <input type="number" id="product-min-wholesale" class="form-input" placeholder="10">
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Homepage Section (Optional)</label>
                                    <select id="product-homepage-section" class="form-select">
                                        <option value="">None - Show only in Products page</option>
                                    </select>
                                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Select a section to feature this product on homepage</small>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">Description</label>
                                <textarea id="product-description" class="form-textarea" rows="6" placeholder="Product description..."></textarea>
                            </div>

                            <div>
                                <label class="form-label">Product Images (JPG or PNG)</label>
                                <div style="flex: 1;">
                                    <input type="file" id="product-images" class="form-input" accept=".jpg,.jpeg,.png" multiple onchange="previewProductImages(event)" style="margin-bottom: 0.5rem;">
                                    <small style="color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Upload up to 5 images. First image will be the main product image. Accepted formats: JPG, PNG (Max 5MB each)</small>
                                    <div id="images-preview" style="margin-top: 1rem;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Product</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Wholesale Product Modal -->
            <div id="add-wholesale-product-modal" class="modal">
                <div class="modal-content modal-content-xl">
                    <div class="modal-header">
                        <h2>Add Wholesale Product</h2>
                        <button class="modal-close" onclick="closeAddWholesaleProductModal()">&times;</button>
                    </div>
                    <form id="add-wholesale-product-form" onsubmit="handleAddWholesaleProduct(event)">
                        <div class="modal-body">
                            <div class="form-row">
                                <div>
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" id="wholesale-product-name" class="form-input" placeholder="e.g., Organic Honey (Wholesale Pack)" required>
                                </div>
                                <div>
                                    <label class="form-label">Wholesale Price (‚Çπ) *</label>
                                    <input type="number" id="wholesale-product-price" class="form-input" placeholder="0.00" step="0.01" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Display Price (‚Çπ) <small style="color: var(--text-muted); font-weight: normal;">Optional</small></label>
                                    <input type="number" id="wholesale-product-display-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Stock Quantity *</label>
                                    <input type="number" id="wholesale-product-stock" class="form-input" placeholder="0" required>
                                </div>
                                <div>
                                    <label class="form-label">Min Wholesale Quantity *</label>
                                    <input type="number" id="wholesale-product-min-qty" class="form-input" placeholder="10" value="10" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Category *</label>
                                    <select id="wholesale-product-category" class="form-select" required>
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Homepage Section (Optional)</label>
                                    <select id="wholesale-product-homepage-section" class="form-select">
                                        <option value="">None - Show only in Products page</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">Description</label>
                                <textarea id="wholesale-product-description" class="form-textarea" rows="6" placeholder="Wholesale product description..."></textarea>
                            </div>

                            <div>
                                <label class="form-label">Wholesale Product Images (JPG or PNG)</label>
                                <div style="flex: 1;">
                                    <input type="file" id="wholesale-product-images" class="form-input" accept=".jpg,.jpeg,.png" multiple onchange="previewWholesaleProductImages(event)" style="margin-bottom: 0.5rem;">
                                    <small style="color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Upload up to 5 images. First image will be main wholesale image.</small>
                                    <div id="wholesale-product-images-preview" style="margin-top: 1rem;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddWholesaleProductModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Wholesale Product</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Category Modal -->
            <div id="add-category-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Add New Category</h2>
                        <button class="modal-close" onclick="closeAddCategoryModal()">&times;</button>
                    </div>
                    <form id="add-category-form" onsubmit="handleAddCategory(event)">
                        <div style="padding: 2rem;">
                            <div>
                                <label class="form-label">Category Name *</label>
                                <input type="text" id="category-name" class="form-input" placeholder="e.g., Honey Products" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="category-description" class="form-textarea" placeholder="Category description..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Category Image (JPG or PNG)</label>
                                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <input type="file" id="category-image" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewCategoryImage(event)">
                                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Accepted formats: JPG, PNG (Max 5MB)</small>
                                    </div>
                                    <div id="category-image-preview" style="display: none; text-align: center;">
                                        <img id="category-preview-img" src="" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearCategoryImage()" style="margin-top: 0.5rem;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddCategoryModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Category</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Category Modal -->
            <div id="edit-category-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Category</h2>
                        <button class="modal-close" onclick="closeEditCategoryModal()">&times;</button>
                    </div>
                    <form id="edit-category-form" onsubmit="handleEditCategory(event)">
                        <input type="hidden" id="edit-category-id">
                        <div style="padding: 2rem; max-height: 70vh; overflow-y: auto;">
                            <div>
                                <label class="form-label">Category Name *</label>
                                <input type="text" id="edit-category-name" class="form-input" placeholder="e.g., Honey Products" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="edit-category-description" class="form-textarea" placeholder="Category description..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Category Image (JPG or PNG)</label>
                                <div style="display: flex; gap: 1rem; align-items: flex-start;">
                                    <div style="flex: 1;">
                                        <input type="file" id="edit-category-image" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewEditCategoryImage(event)">
                                        <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Accepted formats: JPG, PNG (Max 5MB)</small>
                                    </div>
                                    <div id="edit-category-image-preview" style="display: none; text-align: center;">
                                        <img id="edit-category-preview-img" src="" alt="Preview" style="width: 100px; height: 100px; object-fit: cover; border-radius: 8px;">
                                        <button type="button" class="btn btn-sm btn-danger" onclick="clearEditCategoryImage()" style="margin-top: 0.5rem;">Remove</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditCategoryModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Changes</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Product Modal -->
            <div id="edit-product-modal" class="modal">
                <div class="modal-content modal-content-xl">
                    <div class="modal-header">
                        <h2>Edit Product</h2>
                        <button class="modal-close" onclick="closeEditProductModal()">&times;</button>
                    </div>
                    <form id="edit-product-form" onsubmit="handleEditProduct(event)">
                        <input type="hidden" id="edit-product-id">
                        <div class="modal-body">
                            <div class="form-row">
                                <div>
                                    <label class="form-label">Product Name *</label>
                                    <input type="text" id="edit-product-name" class="form-input" placeholder="e.g., Organic Honey" required>
                                </div>
                                <div>
                                    <label class="form-label">Price (‚Çπ) *</label>
                                    <input type="number" id="edit-product-price" class="form-input" placeholder="0.00" step="0.01" required>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Discount Price (‚Çπ) <small style="color: var(--text-muted); font-weight: normal;">Optional</small></label>
                                    <input type="number" id="edit-product-discount-price" class="form-input" placeholder="0.00" step="0.01">
                                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.5rem; align-items:center;">
                                        <input type="number" id="edit-product-discount-adjust" class="form-input" placeholder="Adjust (e.g. 5)" step="0.01" style="max-width: 160px;">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="applyAdminDelta('edit-product-discount-price', 'edit-product-discount-adjust', -1, { decimals: 2, min: 0 })">-</button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="applyAdminDelta('edit-product-discount-price', 'edit-product-discount-adjust', 1, { decimals: 2, min: 0 })">+</button>
                                    </div>
                                </div>
                                <div>
                                    <label class="form-label">Wholesale Price (‚Çπ)</label>
                                    <input type="number" id="edit-product-wholesale-price" class="form-input" placeholder="0.00" step="0.01">
                                </div>
                                <div>
                                    <label class="form-label">Stock Quantity *</label>
                                    <input type="number" id="edit-product-stock" class="form-input" placeholder="0" required>
                                    <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-top:0.5rem; align-items:center;">
                                        <input type="number" id="edit-product-stock-adjust" class="form-input" placeholder="Adjust (e.g. 10)" step="1" style="max-width: 160px;">
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="applyAdminDelta('edit-product-stock', 'edit-product-stock-adjust', -1, { integer: true, min: 0 })">-</button>
                                        <button type="button" class="btn btn-secondary btn-sm" onclick="applyAdminDelta('edit-product-stock', 'edit-product-stock-adjust', 1, { integer: true, min: 0 })">+</button>
                                    </div>
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Category</label>
                                    <select id="edit-product-category" class="form-select">
                                        <option value="">Select Category</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="form-label">Min Wholesale Quantity</label>
                                    <input type="number" id="edit-product-min-wholesale" class="form-input" placeholder="10">
                                </div>
                            </div>

                            <div class="form-row">
                                <div>
                                    <label class="form-label">Homepage Section (Optional)</label>
                                    <select id="edit-product-homepage-section" class="form-select">
                                        <option value="">None - Show only in Products page</option>
                                    </select>
                                    <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Select a section to feature this product on homepage</small>
                                </div>
                            </div>

                            <div>
                                <label class="form-label">Description</label>
                                <textarea id="edit-product-description" class="form-textarea" rows="6" placeholder="Product description..."></textarea>
                            </div>

                            <div>
                                <label class="form-label">Product Images (JPG or PNG)</label>
                                <div style="flex: 1;">
                                    <input type="file" id="edit-product-images" class="form-input" accept=".jpg,.jpeg,.png" multiple onchange="previewEditProductImages(event)" style="margin-bottom: 0.5rem;">
                                    <small style="color: var(--text-muted); display: block; margin-bottom: 0.5rem;">Upload up to 5 images to replace all existing images. Leave empty to keep current images. Accepted formats: JPG, PNG (Max 5MB each)</small>
                                    <div id="edit-current-images" style="display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem;"></div>
                                    <div id="edit-images-preview" style="margin-top: 0.5rem;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditProductModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Product</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Add Homepage Section Modal -->
            <div id="add-section-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Add Homepage Section</h2>
                        <button class="modal-close" onclick="closeAddSectionModal()">&times;</button>
                    </div>
                    <form id="add-section-form" onsubmit="handleAddSection(event)">
                        <div class="modal-body" style="padding: 2rem;">
                            <div>
                                <label class="form-label">Section Name *</label>
                                <input type="text" id="section-name" class="form-input" placeholder="e.g., Featured Products, New Arrivals" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="section-description" class="form-textarea" placeholder="Section description (shown on homepage)..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Sort Order</label>
                                <input type="number" id="section-sort-order" class="form-input" placeholder="0" value="0">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Lower numbers appear first on homepage</small>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label" for="homepage-hero-image-upload">Heading Rectangle Image (JPG or PNG)</label>
                                <input type="file" id="homepage-hero-image-upload" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewHomepageHeroImage(event)">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Recommended ratio: 16:9 (e.g., 1200x675). Optional.</small>
                                <input type="hidden" id="homepage-hero-image-current" value="">
                            </div>

                            <div style="margin-top: 1rem; max-width: 560px;">
                                <label class="form-label">Cropped Banner Preview (20:8)</label>
                                <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem;">
                                    <img id="homepage-hero-image-preview" src="" alt="Homepage heading image preview" style="display:none; width:100%; aspect-ratio: 20 / 8; max-height: 220px; object-fit: cover; border-radius: 6px;">
                                    <div id="homepage-hero-image-placeholder" style="color: var(--text-muted); text-align: center; padding: 2rem 1rem;">Select image to auto-crop and preview</div>
                                </div>
                            </div>

                            <div style="margin-top: 1rem; max-width: 560px; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div>
                                    <label class="form-label" for="add-heading-crop-x">Crop Horizontal</label>
                                    <input type="range" id="add-heading-crop-x" min="0" max="100" value="50" class="form-input" oninput="updateAddHeadingCropPreview()">
                                </div>
                                <div>
                                    <label class="form-label" for="add-heading-crop-y">Crop Vertical</label>
                                    <input type="range" id="add-heading-crop-y" min="0" max="100" value="50" class="form-input" oninput="updateAddHeadingCropPreview()">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeAddSectionModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Save Section</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Edit Homepage Section Modal -->
            <div id="edit-section-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2>Edit Homepage Section</h2>
                        <button class="modal-close" onclick="closeEditSectionModal()">&times;</button>
                    </div>
                    <form id="edit-section-form" onsubmit="handleEditSection(event)">
                        <input type="hidden" id="edit-section-id">
                        <div class="modal-body" style="padding: 2rem;">
                            <div>
                                <label class="form-label">Section Name *</label>
                                <input type="text" id="edit-section-name" class="form-input" placeholder="e.g., Featured Products, New Arrivals" required>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Description</label>
                                <textarea id="edit-section-description" class="form-textarea" placeholder="Section description (shown on homepage)..."></textarea>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Sort Order</label>
                                <input type="number" id="edit-section-sort-order" class="form-input" placeholder="0">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Lower numbers appear first on homepage</small>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label">Status</label>
                                <select id="edit-section-active" class="form-select">
                                    <option value="true">Active</option>
                                    <option value="false">Inactive</option>
                                </select>
                            </div>

                            <div style="margin-top: 1.5rem;">
                                <label class="form-label" for="edit-homepage-hero-image-upload">Heading Rectangle Image (JPG or PNG)</label>
                                <input type="file" id="edit-homepage-hero-image-upload" class="form-input" accept=".jpg,.jpeg,.png" onchange="previewEditHomepageHeroImage(event)">
                                <small style="color: var(--text-muted); display: block; margin-top: 0.5rem;">Optional: upload to replace heading image for this section.</small>
                                <input type="hidden" id="edit-homepage-hero-image-current" value="">
                            </div>

                            <div style="margin-top: 1rem; max-width: 560px;">
                                <label class="form-label">Cropped Banner Preview (20:8)</label>
                                <div style="background: white; border: 1px solid var(--border); border-radius: 8px; padding: 0.75rem;">
                                    <img id="edit-homepage-hero-image-preview" src="" alt="Homepage heading image preview" style="display:none; width:100%; aspect-ratio: 20 / 8; max-height: 220px; object-fit: cover; border-radius: 6px;">
                                    <div id="edit-homepage-hero-image-placeholder" style="color: var(--text-muted); text-align: center; padding: 2rem 1rem;">Select image to auto-crop and preview</div>
                                </div>
                            </div>

                            <div style="margin-top: 1rem; max-width: 560px; display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div>
                                    <label class="form-label" for="edit-heading-crop-x">Crop Horizontal</label>
                                    <input type="range" id="edit-heading-crop-x" min="0" max="100" value="50" class="form-input" oninput="updateEditHeadingCropPreview()">
                                </div>
                                <div>
                                    <label class="form-label" for="edit-heading-crop-y">Crop Vertical</label>
                                    <input type="range" id="edit-heading-crop-y" min="0" max="100" value="50" class="form-input" oninput="updateEditHeadingCropPreview()">
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" onclick="closeEditSectionModal()">Cancel</button>
                            <button type="submit" class="btn btn-primary">Update Section</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Stock Transaction History Modal -->
            <div id="stock-history-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2 id="stock-history-title">Transaction History</h2>
                        <button class="modal-close" onclick="closeStockHistoryModal()">&times;</button>
                    </div>
                    <div id="stock-history-body" class="modal-body"></div>
                </div>
            </div>

            <!-- Contact Message View Modal -->
            <div id="contact-message-modal" class="modal">
                <div class="modal-content">
                    <div class="modal-header">
                        <h2><i class="fas fa-envelope-open-text"></i> Message Details</h2>
                        <button class="modal-close" onclick="closeContactMessageModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <div><strong>Date:</strong> <span id="contact-modal-date"></span></div>
                        <div><strong>From:</strong> <span id="contact-modal-from"></span></div>
                        <div><strong>Email:</strong> <span id="contact-modal-email"></span></div>
                        <div><strong>Phone:</strong> <span id="contact-modal-phone"></span></div>
                        <div><strong>Subject:</strong> <span id="contact-modal-subject"></span></div>
                        <div>
                            <strong>Message:</strong>
                            <div id="contact-modal-message" style="margin-top: 0.5rem; background: var(--bg); border: 1px solid var(--border); border-radius: 8px; padding: 0.9rem; white-space: normal; line-height: 1.5;"></div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button id="send-business-email-btn" type="button" class="btn btn-primary" onclick="sendActiveMessageToBusinessEmail()">
                            <i class="fas fa-paper-plane"></i> Send to Business Email
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeContactMessageModal()">Close</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="/js/main.js"></script>
    <script>
        window.adjustAdminNumber = function(inputId, delta, options = {}) {
            const input = document.getElementById(inputId);
            if (!input) return;

            const integer = !!options.integer;
            const min = (options.min !== undefined && options.min !== null) ? Number(options.min) : null;
            const max = (options.max !== undefined && options.max !== null) ? Number(options.max) : null;
            const decimals = (options.decimals !== undefined && options.decimals !== null) ? Number(options.decimals) : 2;

            const raw = String(input.value || '').trim();
            const current = integer ? parseInt(raw, 10) : parseFloat(raw);
            const safeCurrent = Number.isFinite(current) ? current : 0;

            let next = safeCurrent + Number(delta || 0);
            if (!Number.isFinite(next)) next = 0;
            if (integer) next = Math.round(next);
            if (min !== null && Number.isFinite(min)) next = Math.max(min, next);
            if (max !== null && Number.isFinite(max)) next = Math.min(max, next);

            input.value = integer ? String(next) : String(Number(next).toFixed(decimals));
            try {
                input.dispatchEvent(new Event('input', { bubbles: true }));
                input.dispatchEvent(new Event('change', { bubbles: true }));
            } catch (_) {
                // ignore
            }
        };

        window.applyAdminDelta = function(targetInputId, deltaInputId, sign, options = {}) {
            const deltaInput = document.getElementById(deltaInputId);
            if (!deltaInput) return;

            const raw = String(deltaInput.value || '').trim();
            const delta = parseFloat(raw);
            if (!Number.isFinite(delta) || delta === 0) return;

            const direction = Number(sign) < 0 ? -1 : 1;
            window.adjustAdminNumber(targetInputId, direction * delta, options);
        };
    // Admin dashboard with improved mobile handling
    (function(){
        const sectionIds = [
                'dashboard','manage-products','upload-products','categories','homepage-sections','stock-reports','order-history','customers-orders',
            'customers','activities','messages','users','wholesale','admin-license','site-settings','database-backup'
            ];

        // Caches
        window._productsCache = [];
        window._categoriesCache = [];
        window._homepageSectionsCache = [];
        window._bulkUploadData = [];
        window._ordersCache = [];
        window._customersCache = [];
        window._usersCache = [];
        window._activitiesCache = [];
        window._wholesaleCache = [];
        window._addSectionHeadingCroppedFile = null;
        window._editSectionHeadingCroppedFile = null;
        window._addSectionHeadingSourceFile = null;
        window._editSectionHeadingSourceFile = null;
        window._adminLicenseStatus = null;
        window._adminLicenseCountdownTimer = null;
        window._adminLicenseBlocked = false;

        // Toggle visibility of filter panels on mobile
        window.toggleFilters = function(button) {
            if (!button) return;

            // Prefer the nearest controls/admin-controls container
            const container = button.closest('.controls, .admin-controls');
            if (!container) return;

            const panel = container.querySelector('.filter-group, .filters');
            if (!panel) return;

            panel.classList.toggle('filters-open');
        };

        // Sidebar management
        window.toggleSidebar = function() {
            const sidebar = document.getElementById('admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.toggle('mobile-open');
            overlay.classList.toggle('active');
        };

        window.closeSidebar = function() {
            const sidebar = document.getElementById('admin-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            sidebar.classList.remove('mobile-open');
            overlay.classList.remove('active');
        };

        // Show section and load data
        window.showSection = function(id) {
            if (window._adminLicenseBlocked && id !== 'admin-license') {
                showAlert('Your License is expired Please Contact ur developer.', 'error');
                id = 'admin-license';
            }

            if (id === 'customers-orders') {
                try {
                    setPendingOrdersUnread(false);
                } catch (e) {
                    // ignore
                }
            }

            // Close sidebar on mobile
            if (window.innerWidth <= 1024) {
                closeSidebar();
            }

            sectionIds.forEach(sid => {
                const el = document.getElementById(sid);
                if (el) el.classList.remove('active');
            });
            document.querySelectorAll('.admin-nav-item').forEach(item => item.classList.remove('active'));
            const section = document.getElementById(id);
            if (section) section.classList.add('active');
            
            // highlight sidebar item
            document.querySelectorAll('.admin-nav-item').forEach(item => {
                if (item.textContent.trim().toLowerCase().includes((id || '').replace(/-/g, ' '))) {
                    item.classList.add('active');
                }
            });

            // Scroll to top
            window.scrollTo(0, 0);

            // Track current section
            window._currentSection = id;

            if (id !== 'messages') {
                try { stopContactAutoRefresh(); } catch (e) { /* ignore */ }
            }

            // call loader
            switch(id) {
                case 'dashboard': loadDashboard(); break;
                case 'manage-products': loadProducts(); break;
                case 'upload-products': loadCategoriesForUpload(); break;
                case 'categories': loadCategories(); break;
                case 'homepage-sections': loadHomepageSections(); loadSiteSettings(); break;
                case 'stock-reports': loadStockReports(); break;
                case 'order-history': loadOrders(); break;
                case 'customers-orders': loadCustomerOrders(); break;
                case 'customers': loadCustomers(); break;
                case 'activities': loadActivities(); break;
                case 'messages':
                    initAdminMessageSender();
                    loadAdminSentMessageHistory({ force: true });
                    loadContactInbox('message', { force: true });
                    break;
                case 'users': loadUsers(); break;
                case 'wholesale': loadWholesaleRequests(); break;
                case 'admin-license': loadAdminLicenseStatus({ silent: true }); break;
                case 'site-settings': loadSiteSettings(); break;
            }
        };

        function formatContactDate(value) {
            if (!value) return '';
            const d = new Date(value);
            if (Number.isNaN(d.getTime())) return '';
            return d.toLocaleString();
        }

        function escapeHtml(str) {
            return String(str || '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function stopContactAutoRefresh() {
            if (window._contactRefreshTimer) {
                clearInterval(window._contactRefreshTimer);
                window._contactRefreshTimer = null;
            }
        }

        function setContactBadgeCount(el, count) {
            if (!el) return;
            const safeCount = Number.isFinite(Number(count)) ? Number(count) : 0;
            if (safeCount > 0) {
                el.textContent = String(safeCount);
                el.style.display = '';
            } else {
                el.textContent = '0';
                el.style.display = 'none';
            }
        }

        function stopContactUnreadBadgesWatcher() {
            if (window._contactUnreadBadgeTimer) {
                clearInterval(window._contactUnreadBadgeTimer);
                window._contactUnreadBadgeTimer = null;
            }
        }

        async function refreshContactUnreadBadges(options = {}) {
            const silent = !!options.silent;
            try {
                const data = await api.get('/admin/contact/unread-counts');
                const counts = data?.counts || {};

                setContactBadgeCount(document.getElementById('messages-badge'), counts.message);
            } catch (err) {
                if (!silent) {
                    console.warn('Refresh contact unread badges failed:', err);
                }
            }
        }

        function startContactUnreadBadgesWatcher() {
            stopContactUnreadBadgesWatcher();
            refreshContactUnreadBadges({ silent: true });
            window._contactUnreadBadgeTimer = setInterval(() => {
                refreshContactUnreadBadges({ silent: true });
            }, 30000);
        }

        async function setContactRead(id, isRead) {
            try {
                await api.put(`/admin/contact/${id}/read`, { is_read: !!isRead });
                const current = window._currentSection;
                if (current === 'messages') {
                    await loadContactInbox('message', { force: true });
                }

                refreshContactUnreadBadges({ silent: true });
            } catch (err) {
                console.error('Set contact read error:', err);
                showAlert(err.message || 'Failed to update message', 'error');
            }
        }

        async function loadContactInbox(type, options = {}) {
            const messageType = 'message';
            const currentSection = 'messages';
            const noAutoRefresh = !!options.noAutoRefresh;

            // only run if this is the active section unless forced
            if (!options.force && window._currentSection && window._currentSection !== currentSection) return;

            const unreadOnlyEl = document.getElementById('messages-unread-only');
            const unreadOnly = !!unreadOnlyEl?.checked;
            const wrapId = 'messages-table-wrap';
            const wrap = document.getElementById(wrapId);
            if (!wrap) return;

            // stop/start auto-refresh when section changes
            if (!noAutoRefresh) {
                stopContactAutoRefresh();
                const interval = (window.performanceTuning?.getAdaptiveInterval || ((x) => x))(20000, { max: 60000, min: 10000 });
                window._contactRefreshTimer = setInterval(() => {
                    if (window._currentSection === currentSection) {
                        loadContactInbox(messageType, { force: false });
                    }
                }, interval);
            }

            try {
                wrap.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';
                const data = await api.get(`/admin/contact?type=${encodeURIComponent(messageType)}&unread=${unreadOnly ? 'true' : 'false'}&limit=200`);
                const rows = data?.messages || [];
                window._contactInboxRowsById = Object.fromEntries((rows || []).map((row) => [String(row.id), row]));

                refreshContactUnreadBadges({ silent: true });

                if (!rows.length) {
                    wrap.innerHTML = '<div class="empty-state"><p>No records found.</p></div>';
                    return;
                }

                wrap.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>From</th>
                                <th>Email / Phone</th>
                                <th>Subject</th>
                                <th>Message</th>
                                <th>Email</th>
                                <th>Status</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(r => {
                                const from = escapeHtml(r.full_name);
                                const email = escapeHtml(r.email);
                                const phone = escapeHtml(r.phone || '');
                                const subject = escapeHtml(r.subject || '');
                                const msg = escapeHtml(r.message || '');
                                const forwardedTo = escapeHtml(r.forwarded_to || '');
                                const forwardStatus = r.email_forwarded
                                    ? `<span style="color: var(--success); font-weight: 700;">Forwarded</span>${forwardedTo ? `<div style=\"color: var(--text-muted); font-size: 0.82rem;\">${forwardedTo}</div>` : ''}`
                                    : (r.email_forward_error
                                        ? `<span style="color: var(--danger); font-weight: 700;">Failed</span><div style=\"color: var(--text-muted); font-size: 0.82rem;\">${escapeHtml(r.email_forward_error || '')}</div>`
                                        : '<span style="color: var(--warning); font-weight: 700;">Pending</span>');
                                const status = r.is_read ? '<span style="color: var(--success); font-weight: 600;">Read</span>' : '<span style="color: var(--danger); font-weight: 700;">Unread</span>';
                                const readButton = r.is_read
                                    ? `<button class="btn btn-sm btn-secondary" type="button" onclick="setContactRead(${r.id}, false)"><i class=\"fas fa-rotate-left\"></i> Mark Unread</button>`
                                    : `<button class="btn btn-sm btn-success" type="button" onclick="setContactRead(${r.id}, true)"><i class=\"fas fa-check\"></i> Mark Read</button>`;
                                const action = `<div style=\"display:flex; gap:0.5rem; flex-wrap:wrap;\"><button class=\"btn btn-sm btn-primary\" type=\"button\" onclick=\"openContactMessageModal(${r.id})\"><i class=\"fas fa-eye\"></i> View</button>${readButton}</div>`;
                                return `
                                    <tr>
                                        <td>${escapeHtml(formatContactDate(r.created_at))}</td>
                                        <td>${from}${r.user_role ? `<div style=\"color: var(--text-muted); font-size: 0.85rem;\">User: ${escapeHtml(r.user_role)}</div>` : ''}</td>
                                        <td>${email}${phone ? `<div style=\"color: var(--text-muted); font-size: 0.85rem;\">${phone}</div>` : ''}</td>
                                        <td>${subject}</td>
                                        <td style="max-width: 520px; white-space: normal;">${msg}</td>
                                        <td>${forwardStatus}</td>
                                        <td>${status}</td>
                                        <td>${action}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                console.error('Load contact inbox error:', err);
                wrap.innerHTML = `<div class="empty-state"><p>Failed to load records: ${escapeHtml(err?.message || 'Unknown error')}</p></div>`;
                showAlert(err.message || 'Failed to load records', 'error');
            }
        }

        function openContactMessageModal(messageId) {
            const id = String(messageId || '');
            const record = window._contactInboxRowsById?.[id];
            if (!record) {
                showAlert('Message record not found.', 'error');
                return;
            }

            const dateEl = document.getElementById('contact-modal-date');
            const fromEl = document.getElementById('contact-modal-from');
            const emailEl = document.getElementById('contact-modal-email');
            const phoneEl = document.getElementById('contact-modal-phone');
            const subjectEl = document.getElementById('contact-modal-subject');
            const messageEl = document.getElementById('contact-modal-message');
            const modalEl = document.getElementById('contact-message-modal');

            if (!dateEl || !fromEl || !emailEl || !phoneEl || !subjectEl || !messageEl || !modalEl) {
                showAlert('Unable to open message viewer.', 'error');
                return;
            }

            dateEl.textContent = formatContactDate(record.created_at) || '-';
            fromEl.textContent = record.full_name || '-';
            emailEl.textContent = record.email || '-';
            phoneEl.textContent = record.phone || '-';
            subjectEl.textContent = record.subject || '-';
            messageEl.innerHTML = escapeHtml(record.message || '-').replace(/\n/g, '<br>');

            window._activeContactMessageId = record.id;
            const sendBtn = document.getElementById('send-business-email-btn');
            if (sendBtn) {
                sendBtn.disabled = false;
                sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send to Business Email';
            }

            modalEl.style.display = 'flex';
        }

        async function sendActiveMessageToBusinessEmail() {
            const activeId = window._activeContactMessageId;
            if (!activeId) {
                showAlert('No message selected.', 'error');
                return;
            }

            const sendBtn = document.getElementById('send-business-email-btn');
            try {
                if (sendBtn) {
                    sendBtn.disabled = true;
                    sendBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                }

                const response = await api.post(`/admin/contact/${activeId}/business-email`, {});
                showAlert(response?.message || 'Sent to business email.', 'success');
            } catch (err) {
                showAlert(err.message || 'Failed to send to business email.', 'error');
            } finally {
                if (sendBtn) {
                    sendBtn.disabled = false;
                    sendBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Send to Business Email';
                }
            }
        }

        function closeContactMessageModal() {
            const modalEl = document.getElementById('contact-message-modal');
            if (modalEl) {
                modalEl.style.display = 'none';
            }
            window._activeContactMessageId = null;
        }

        // Make available for inline onclick handlers
        window.loadContactInbox = loadContactInbox;
        window.setContactRead = setContactRead;
        window.openContactMessageModal = openContactMessageModal;
        window.closeContactMessageModal = closeContactMessageModal;
        window.sendActiveMessageToBusinessEmail = sendActiveMessageToBusinessEmail;

        function initAdminMessageSender() {
            if (window._adminMessageSenderInitialized) return;

            const audienceEl = document.getElementById('admin-message-audience');
            const singleWrap = document.getElementById('admin-message-single-wrap');
            const identifierTypeEl = document.getElementById('admin-message-identifier-type');
            const identifierEl = document.getElementById('admin-message-identifier');
            const suggestionsEl = document.getElementById('admin-user-suggestions');

            if (!audienceEl || !singleWrap || !identifierTypeEl || !identifierEl || !suggestionsEl) {
                return;
            }

            window._adminMessageSenderInitialized = true;

            function syncSingleVisibility() {
                const mode = String(audienceEl.value || 'all');
                singleWrap.style.display = mode === 'single' ? '' : 'none';
            }

            audienceEl.addEventListener('change', syncSingleVisibility);
            syncSingleVisibility();

            identifierTypeEl.addEventListener('change', () => {
                identifierEl.value = '';
                suggestionsEl.innerHTML = '';
            });

            let searchTimer = null;
            identifierEl.addEventListener('input', () => {
                const mode = String(audienceEl.value || 'all');
                if (mode !== 'single') return;

                const q = String(identifierEl.value || '').trim();
                if (searchTimer) clearTimeout(searchTimer);
                searchTimer = setTimeout(async () => {
                    try {
                        if (q.length < 2) {
                            suggestionsEl.innerHTML = '';
                            return;
                        }

                        const data = await api.get(`/admin/users/search?query=${encodeURIComponent(q)}&limit=10`);
                        const users = data?.users || [];
                        const type = String(identifierTypeEl.value || 'email');

                        suggestionsEl.innerHTML = users.map(u => {
                            const value = type === 'id' ? String(u.id) : String(u.email || '');
                            const label = `${u.full_name || ''} (${u.role || ''})`;
                            return `<option value="${escapeHtml(value)}">${escapeHtml(label)}</option>`;
                        }).join('');
                    } catch (e) {
                        // Silent; do not spam alerts while typing
                        suggestionsEl.innerHTML = '';
                    }
                }, 250);
            });
        }

        window.initAdminMessageSender = initAdminMessageSender;

        async function loadAdminSentMessageHistory(options = {}) {
            const wrap = document.getElementById('admin-sent-history-wrap');
            if (!wrap) return;

            if (options.force) {
                wrap.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';
            }

            try {
                const resp = await api.get('/admin/messages/history?limit=60');
                const rows = resp?.history || [];

                if (!rows.length) {
                    wrap.innerHTML = '<div class="empty-state"><p>No sent messages yet.</p></div>';
                    return;
                }

                wrap.innerHTML = `
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Admin</th>
                                <th>Audience</th>
                                <th>Channels</th>
                                <th>Result</th>
                                <th>Subject</th>
                                <th>Message</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${rows.map(row => {
                                const channels = row.channels || {};
                                const summary = row.summary || {};
                                const channelTags = [
                                    channels.email ? '<span class="badge badge-info">Email</span>' : '',
                                    channels.sms ? '<span class="badge badge-warning">SMS</span>' : '',
                                    channels.whatsapp ? '<span class="badge badge-success">WhatsApp</span>' : ''
                                ].filter(Boolean).join(' ');

                                const resultText = [
                                    summary?.email ? `E:${summary.email.sent || 0}/${summary.email.attempted || 0}` : '',
                                    summary?.sms ? `S:${summary.sms.sent || 0}/${summary.sms.attempted || 0}` : '',
                                    summary?.whatsapp ? `W:${summary.whatsapp.sent || 0}/${summary.whatsapp.attempted || 0}` : ''
                                ].filter(Boolean).join(' | ');

                                return `
                                    <tr>
                                        <td>${escapeHtml(formatContactDate(row.created_at))}</td>
                                        <td>${escapeHtml(row.admin_name || row.admin_email || 'Admin')}</td>
                                        <td>${escapeHtml(row.audience || '-')}</td>
                                        <td>${channelTags || '-'}</td>
                                        <td>${escapeHtml(resultText || '-')}</td>
                                        <td>${escapeHtml(row.subject || '-')}</td>
                                        <td style="max-width: 420px; white-space: normal;">${escapeHtml(row.message_body || '-')}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                `;
            } catch (err) {
                console.error('Load sent history error:', err);
                wrap.innerHTML = `<div class="empty-state"><p>Failed to load history: ${escapeHtml(err?.message || 'Unknown error')}</p></div>`;
            }
        }

        window.loadAdminSentMessageHistory = loadAdminSentMessageHistory;

        window.sendAdminBroadcastMessage = async function() {
            const audienceEl = document.getElementById('admin-message-audience');
            const identifierTypeEl = document.getElementById('admin-message-identifier-type');
            const identifierEl = document.getElementById('admin-message-identifier');
            const subjectEl = document.getElementById('admin-message-subject');
            const bodyEl = document.getElementById('admin-message-body');
            const emailEl = document.getElementById('admin-message-channel-email');
            const smsEl = document.getElementById('admin-message-channel-sms');
            const whatsappEl = document.getElementById('admin-message-channel-whatsapp');
            const btn = document.getElementById('admin-message-send-btn');
            const resultEl = document.getElementById('admin-message-send-result');

            if (!audienceEl || !subjectEl || !bodyEl || !emailEl || !smsEl || !whatsappEl || !btn) return;

            const audience = String(audienceEl.value || 'all');
            const identifierType = String(identifierTypeEl?.value || 'email');
            const identifier = String(identifierEl?.value || '').trim();
            const subject = String(subjectEl.value || '').trim();
            const message = String(bodyEl.value || '').trim();
            const channels = { email: !!emailEl.checked, sms: !!smsEl.checked, whatsapp: !!whatsappEl.checked };

            if (!channels.email && !channels.sms && !channels.whatsapp) {
                showAlert('Please select Email, SMS, and/or WhatsApp.', 'error');
                return;
            }

            if (!message) {
                showAlert('Message is required.', 'error');
                return;
            }

            if (audience === 'single' && !identifier) {
                showAlert('Please select a customer email or id.', 'error');
                return;
            }

            const payload = { audience, identifierType, identifier, subject, message, channels };

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sending...';
                if (resultEl) resultEl.textContent = 'Sending in progress...';

                const resp = await Promise.race([
                    api.post('/admin/messages/send', payload),
                    new Promise((_, reject) => {
                        setTimeout(() => reject(new Error('Sending is taking longer than expected. Please try a smaller audience or retry.')), 180000);
                    })
                ]);
                const summary = resp?.summary;
                showAlert(resp?.message || 'Message sent.', 'success');

                if (resultEl && summary) {
                    const emailText = channels.email
                        ? `Email: ${summary.email?.sent || 0} sent, ${summary.email?.failed || 0} failed`
                        : '';
                    const smsText = channels.sms
                        ? `SMS: ${summary.sms?.sent || 0} sent, ${summary.sms?.failed || 0} failed`
                        : '';
                    const whatsappText = channels.whatsapp
                        ? `WhatsApp: ${summary.whatsapp?.sent || 0} sent, ${summary.whatsapp?.failed || 0} failed`
                        : '';
                    const totalText = `Recipients: ${summary.totalRecipients || 0}`;
                    resultEl.textContent = [totalText, emailText, smsText, whatsappText].filter(Boolean).join(' ‚Ä¢ ');
                }

                loadAdminSentMessageHistory({ force: true });

                // keep subject/body; admin may want to send again
            } catch (err) {
                console.error('Send admin message error:', err);
                const msg = err?.error || err?.message || 'Failed to send message.';
                showAlert(msg, 'error');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-paper-plane"></i> Send';
            }
        };

        // Helper functions
        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            if (container) container.innerHTML = '<div class="empty-state"><div class="spinner"></div></div>';
        }

        function formatCurrency(amount) {
            return '‚Çπ' + parseFloat(amount || 0).toFixed(2);
        }

        function formatDateTimeDisplay(value) {
            if (!value) return 'Not set';
            const date = new Date(value);
            if (Number.isNaN(date.getTime())) return 'Invalid date';
            return date.toLocaleString();
        }

        function formatDuration(ms) {
            if (ms == null) return 'No expiry configured';
            if (ms <= 0) return 'Expired';

            let remaining = Math.floor(ms / 1000);
            const years = Math.floor(remaining / (365 * 24 * 3600));
            remaining -= years * 365 * 24 * 3600;
            const months = Math.floor(remaining / (30 * 24 * 3600));
            remaining -= months * 30 * 24 * 3600;
            const days = Math.floor(remaining / (24 * 3600));
            remaining -= days * 24 * 3600;
            const hours = Math.floor(remaining / 3600);
            remaining -= hours * 3600;
            const minutes = Math.floor(remaining / 60);
            const seconds = remaining - minutes * 60;

            const parts = [];
            if (years) parts.push(`${years}y`);
            if (months) parts.push(`${months}mo`);
            if (days) parts.push(`${days}d`);
            parts.push(`${hours}h`, `${minutes}m`, `${seconds}s`);
            return parts.join(' ');
        }

        function stopAdminLicenseCountdown() {
            if (window._adminLicenseCountdownTimer) {
                clearInterval(window._adminLicenseCountdownTimer);
                window._adminLicenseCountdownTimer = null;
            }
        }

        function renderAdminLicenseStatus(status) {
            window._adminLicenseStatus = status || null;
            const license = status || {};

            const banner = document.getElementById('admin-license-status-banner');
            const serverTimeEl = document.getElementById('admin-license-server-time');
            const expiryEl = document.getElementById('admin-license-expiry-time');
            const countdownEl = document.getElementById('admin-license-countdown');

            if (serverTimeEl) {
                serverTimeEl.textContent = formatDateTimeDisplay(license.serverTime);
            }
            if (expiryEl) {
                expiryEl.textContent = formatDateTimeDisplay(license.expiresAt);
            }

            if (banner) {
                const blocked = !!license.isBlocked;
                banner.style.background = blocked ? '#fef2f2' : '#ecfdf5';
                banner.style.borderColor = blocked ? '#fca5a5' : '#86efac';
                banner.style.color = blocked ? '#7f1d1d' : '#065f46';
                banner.textContent = license.message || (blocked ? 'Your License is expired Please Contact ur developer.' : 'License is active.');
            }

            const updateCountdown = () => {
                if (!countdownEl) return;
                if (license.manualBlocked) {
                    countdownEl.textContent = 'Manually blocked';
                    return;
                }
                const expiresAtMs = license.expiresAt ? new Date(license.expiresAt).getTime() : null;
                const remainingMs = expiresAtMs ? Math.max(0, expiresAtMs - Date.now()) : null;
                countdownEl.textContent = formatDuration(remainingMs);
            };

            stopAdminLicenseCountdown();
            updateCountdown();
            window._adminLicenseCountdownTimer = setInterval(updateCountdown, 1000);

            const role = auth?.currentUser?.role;
            const superAdminPanel = document.getElementById('super-admin-license-manage');
            if (superAdminPanel) {
                superAdminPanel.classList.toggle('hidden', role !== 'super_admin');
            }

            if (role === 'super_admin') {
                const manualBlockInput = document.getElementById('license-manual-block');
                const expiresAtInput = document.getElementById('license-expires-at');

                if (manualBlockInput) {
                    manualBlockInput.checked = !!license.manualBlocked;
                }

                if (expiresAtInput) {
                    if (license.expiresAt) {
                        const localDate = new Date(license.expiresAt);
                        if (!Number.isNaN(localDate.getTime())) {
                            const pad = (number) => String(number).padStart(2, '0');
                            expiresAtInput.value = `${localDate.getFullYear()}-${pad(localDate.getMonth() + 1)}-${pad(localDate.getDate())}T${pad(localDate.getHours())}:${pad(localDate.getMinutes())}`;
                        } else {
                            expiresAtInput.value = '';
                        }
                    } else {
                        expiresAtInput.value = '';
                    }
                }
            }
        }

        function applyAdminLicenseUiRestrictions() {
            if (!window._adminLicenseBlocked) return;

            document.querySelectorAll('.admin-nav-item').forEach((item) => {
                const text = (item.textContent || '').toLowerCase();
                const keepVisible = text.includes('admin license');
                if (!keepVisible) {
                    item.classList.add('hidden');
                }
            });
        }

        function isAdminLicenseExpiredError(error) {
            const message = String(error?.message || error || '').toLowerCase();
            return message.includes('your license is expired please contact ur developer');
        }

        function triggerAdminLicenseLockdown() {
            window._adminLicenseBlocked = true;
            renderAdminLicenseStatus({
                serverTime: new Date().toISOString(),
                expiresAt: null,
                manualBlocked: true,
                isExpired: true,
                isBlocked: true,
                message: 'Your License is expired Please Contact ur developer.'
            });
            applyAdminLicenseUiRestrictions();
            if (window._currentSection !== 'admin-license') {
                showSection('admin-license');
            }
        }

        async function loadAdminLicenseStatus(options = {}) {
            const { silent = false } = options;
            try {
                const response = await api.get('/products/settings');
                const settings = response?.settings || {};
                const serverTime = new Date().toISOString();
                const manualBlocked = String(settings.admin_license_blocked || '').toLowerCase() === 'true';
                const expiresAt = (settings.admin_license_expires_at || '').trim() || null;
                const expiresAtMs = expiresAt ? new Date(expiresAt).getTime() : null;
                const isExpired = !!(expiresAtMs && Date.now() >= expiresAtMs);
                const isBlocked = manualBlocked || isExpired;

                const license = {
                    serverTime,
                    expiresAt,
                    manualBlocked,
                    isExpired,
                    isBlocked,
                    message: isBlocked
                        ? 'Your License is expired Please Contact ur developer.'
                        : 'License is active.'
                };

                renderAdminLicenseStatus(license);

                const role = auth?.currentUser?.role;
                window._adminLicenseBlocked = role === 'admin' && !!license?.isBlocked;
                return license;
            } catch (error) {
                if (isAdminLicenseExpiredError(error)) {
                    triggerAdminLicenseLockdown();
                    return {
                        serverTime: new Date().toISOString(),
                        expiresAt: null,
                        manualBlocked: true,
                        isExpired: true,
                        isBlocked: true,
                        message: 'Your License is expired Please Contact ur developer.'
                    };
                }
                if (!silent) {
                    showAlert(error.message || 'Failed to load admin license status', 'error');
                }
                return null;
            }
        }

        const originalApiRequest = api.request.bind(api);
        api.request = async function(endpoint, options = {}) {
            try {
                if (
                    auth?.currentUser?.role === 'admin' &&
                    window._adminLicenseBlocked &&
                    typeof endpoint === 'string' &&
                    endpoint.startsWith('/admin')
                ) {
                    throw new Error('Your License is expired Please Contact ur developer.');
                }

                return await originalApiRequest(endpoint, options);
            } catch (error) {
                if (typeof isAuthExpiredError === 'function' && isAuthExpiredError(error)) {
                    if (!window.__adminAuthRedirecting) {
                        window.__adminAuthRedirecting = true;
                        if (typeof handleAdminSessionExpired === 'function') {
                            handleAdminSessionExpired();
                        }
                    }
                }

                if (auth?.currentUser?.role === 'admin' && isAdminLicenseExpiredError(error)) {
                    triggerAdminLicenseLockdown();
                }
                throw error;
            }
        };

        window.saveAdminLicenseSettings = async function() {
            try {
                const manualBlocked = !!document.getElementById('license-manual-block')?.checked;
                const expiresAtValue = document.getElementById('license-expires-at')?.value || '';
                const payload = { admin_license_blocked: manualBlocked };

                if (expiresAtValue) {
                    payload.admin_license_expires_at = new Date(expiresAtValue).toISOString();
                }

                await api.post('/admin/settings', payload);
                showAlert('License settings saved.', 'success');
                await loadAdminLicenseStatus();
            } catch (error) {
                console.error('Save admin license settings error:', error);
                showAlert(error.message || 'Failed to save license settings', 'error');
            }
        };

        window.blockAdminLicenseNow = async function() {
            try {
                await api.post('/admin/settings', { admin_license_blocked: true });
                showAlert('Admin license blocked.', 'success');
                await loadAdminLicenseStatus();
            } catch (error) {
                showAlert(error.message || 'Failed to block license', 'error');
            }
        };

        window.unblockAdminLicenseNow = async function() {
            try {
                await api.post('/admin/settings', { admin_license_blocked: false });
                showAlert('Admin license unblocked.', 'success');
                await loadAdminLicenseStatus();
            } catch (error) {
                showAlert(error.message || 'Failed to unblock license', 'error');
            }
        };

        window.clearAdminLicenseExpiry = async function() {
            try {
                await api.post('/admin/settings', { admin_license_expires_at: '' });
                showAlert('License expiry cleared.', 'success');
                await loadAdminLicenseStatus();
            } catch (error) {
                showAlert(error.message || 'Failed to clear expiry', 'error');
            }
        };

        function readFileAsDataUrl(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(new Error('Failed to read image file'));
                reader.readAsDataURL(file);
            });
        }

        function loadImageFromDataUrl(dataUrl) {
            return new Promise((resolve, reject) => {
                const image = new Image();
                image.onload = () => resolve(image);
                image.onerror = () => reject(new Error('Failed to load image for cropping'));
                image.src = dataUrl;
            });
        }

        async function cropImageToBannerFile(file, ratioWidth = 20, ratioHeight = 8, focusX = 50, focusY = 50) {
            const targetRatio = ratioWidth / ratioHeight;
            const dataUrl = await readFileAsDataUrl(file);
            const image = await loadImageFromDataUrl(dataUrl);

            const sourceWidth = image.naturalWidth || image.width;
            const sourceHeight = image.naturalHeight || image.height;
            if (!sourceWidth || !sourceHeight) {
                throw new Error('Invalid image dimensions');
            }

            const sourceRatio = sourceWidth / sourceHeight;
            let cropX = 0;
            let cropY = 0;
            let cropWidth = sourceWidth;
            let cropHeight = sourceHeight;

            if (sourceRatio > targetRatio) {
                cropWidth = Math.round(sourceHeight * targetRatio);
                const maxOffsetX = Math.max(0, sourceWidth - cropWidth);
                const normalizedX = Math.max(0, Math.min(100, Number(focusX) || 50));
                cropX = Math.round((normalizedX / 100) * maxOffsetX);
            } else if (sourceRatio < targetRatio) {
                cropHeight = Math.round(sourceWidth / targetRatio);
                const maxOffsetY = Math.max(0, sourceHeight - cropHeight);
                const normalizedY = Math.max(0, Math.min(100, Number(focusY) || 50));
                cropY = Math.round((normalizedY / 100) * maxOffsetY);
            }

            const maxOutputWidth = 1600;
            const outputWidth = Math.min(maxOutputWidth, cropWidth);
            const outputHeight = Math.max(1, Math.round(outputWidth / targetRatio));

            const canvas = document.createElement('canvas');
            canvas.width = outputWidth;
            canvas.height = outputHeight;
            const context = canvas.getContext('2d');
            if (!context) {
                throw new Error('Failed to process image');
            }

            context.drawImage(
                image,
                cropX,
                cropY,
                cropWidth,
                cropHeight,
                0,
                0,
                outputWidth,
                outputHeight
            );

            const outputMime = file.type === 'image/png' ? 'image/png' : 'image/jpeg';
            const blob = await new Promise((resolve) => {
                canvas.toBlob(resolve, outputMime, 0.92);
            });

            if (!blob) {
                throw new Error('Failed to generate cropped image');
            }

            const baseName = (file.name || 'banner-image').replace(/\.[^/.]+$/, '');
            const extension = outputMime === 'image/png' ? 'png' : 'jpg';
            return new File([blob], `${baseName}-banner.${extension}`, {
                type: outputMime,
                lastModified: Date.now()
            });
        }

        async function setImagePreviewFromFile(file, previewId, placeholderId) {
            const preview = document.getElementById(previewId);
            const placeholder = document.getElementById(placeholderId);
            if (!preview || !placeholder) return;

            const previewDataUrl = await readFileAsDataUrl(file);
            preview.src = previewDataUrl;
            preview.style.display = 'block';
            placeholder.style.display = 'none';
        }

        async function buildAndPreviewAddSectionCrop() {
            const file = window._addSectionHeadingSourceFile;
            if (!file) return null;

            const xControl = document.getElementById('add-heading-crop-x');
            const yControl = document.getElementById('add-heading-crop-y');
            const focusX = xControl ? Number(xControl.value) : 50;
            const focusY = yControl ? Number(yControl.value) : 50;

            const croppedFile = await cropImageToBannerFile(file, 20, 8, focusX, focusY);
            window._addSectionHeadingCroppedFile = croppedFile;
            await setImagePreviewFromFile(croppedFile, 'homepage-hero-image-preview', 'homepage-hero-image-placeholder');
            return croppedFile;
        }

        async function buildAndPreviewEditSectionCrop() {
            const file = window._editSectionHeadingSourceFile;
            if (!file) return null;

            const xControl = document.getElementById('edit-heading-crop-x');
            const yControl = document.getElementById('edit-heading-crop-y');
            const focusX = xControl ? Number(xControl.value) : 50;
            const focusY = yControl ? Number(yControl.value) : 50;

            const croppedFile = await cropImageToBannerFile(file, 20, 8, focusX, focusY);
            window._editSectionHeadingCroppedFile = croppedFile;
            await setImagePreviewFromFile(croppedFile, 'edit-homepage-hero-image-preview', 'edit-homepage-hero-image-placeholder');
            return croppedFile;
        }

        window.updateAddHeadingCropPreview = function() {
            if (!window._addSectionHeadingSourceFile) return;
            buildAndPreviewAddSectionCrop().catch((error) => {
                console.error('Update add crop preview error:', error);
            });
        };

        window.updateEditHeadingCropPreview = function() {
            if (!window._editSectionHeadingSourceFile) return;
            buildAndPreviewEditSectionCrop().catch((error) => {
                console.error('Update edit crop preview error:', error);
            });
        };

        function formatDate(dateStr) {
            if (!dateStr) return 'N/A';
            return new Date(dateStr).toLocaleDateString();
        }

        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function renderDescriptionCell(description, maxLength = 120) {
            const raw = String(description || '').trim();
            if (!raw) {
                return '<td class="description-cell">-</td>';
            }

            const safeTitle = escapeHtml(raw);
            const safeFull = escapeHtml(raw);

            if (raw.length <= maxLength) {
                return `<td class="description-cell" title="${safeTitle}"><span class="description-text">${safeFull}</span></td>`;
            }

            const safeShort = escapeHtml(`${raw.slice(0, maxLength)}...`);

            return `
                <td class="description-cell" title="${safeTitle}">
                    <span class="description-text description-short">${safeShort}</span>
                    <span class="description-text description-full hidden">${safeFull}</span>
                    <button type="button" class="description-toggle" onclick="toggleDescription(this)">Show more</button>
                </td>
            `;
        }

        window.toggleDescription = function(button) {
            const cell = button.closest('.description-cell');
            if (!cell) return;

            const shortText = cell.querySelector('.description-short');
            const fullText = cell.querySelector('.description-full');
            if (!shortText || !fullText) return;

            const showingFull = !fullText.classList.contains('hidden');
            if (showingFull) {
                fullText.classList.add('hidden');
                shortText.classList.remove('hidden');
                button.textContent = 'Show more';
            } else {
                shortText.classList.add('hidden');
                fullText.classList.remove('hidden');
                button.textContent = 'Show less';
            }
        }

        window.showAlert = function(message, type = 'info') {
            const alert = document.getElementById('alert');
            alert.className = `alert alert-${type} show`;
            alert.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i> ${message}`;
            setTimeout(() => alert.classList.remove('show'), 5000);
        };

        // Loaders (simplified - add your actual API calls)
        async function loadDashboard() {
            try {
                showLoading('stats-container');
                const data = await api.get('/admin/dashboard/stats');
                
                const stats = data.stats || {
                    total_orders: 0,
                    total_revenue: 0,
                    total_profit: 0,
                    total_spent: 0,
                    total_customers: 0,
                    total_products: 0,
                    stock_units: 0,
                    stock_value: 0,
                    stock_profit: 0
                };
                
                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-card primary">
                        <div class="stat-card-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-card-label">Orders</div>
                        <div class="stat-card-value">${parseInt(stats.total_orders) || 0}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-card-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-card-label">Revenue</div>
                        <div class="stat-card-value">‚Çπ${parseFloat(stats.total_revenue || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-card-icon"><i class="fas fa-chart-line"></i></div>
                        <div class="stat-card-label">Profit</div>
                        <div class="stat-card-value">‚Çπ${parseFloat(stats.total_profit || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-card-icon"><i class="fas fa-receipt"></i></div>
                        <div class="stat-card-label">Loss</div>
                        <div class="stat-card-value">‚Çπ${parseFloat(stats.total_spent || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-card-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-card-label">Customers</div>
                        <div class="stat-card-value">${parseInt(stats.total_customers) || 0}</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-card-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-card-label">Products</div>
                        <div class="stat-card-value">${parseInt(stats.total_products) || 0}</div>
                    </div>
                    <div class="stat-card primary">
                        <div class="stat-card-icon"><i class="fas fa-boxes"></i></div>
                        <div class="stat-card-label">Stock Units</div>
                        <div class="stat-card-value">${parseInt(stats.stock_units) || 0}</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-card-icon"><i class="fas fa-warehouse"></i></div>
                        <div class="stat-card-label">Stock Value</div>
                        <div class="stat-card-value">‚Çπ${parseFloat(stats.stock_value || 0).toFixed(2)}</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-card-icon"><i class="fas fa-chart-pie"></i></div>
                        <div class="stat-card-label">Stock Profit</div>
                        <div class="stat-card-value">‚Çπ${parseFloat(stats.stock_profit || 0).toFixed(2)}</div>
                    </div>
                `;

                // Recent Orders (dynamic)
                try {
                    const resp = await api.get('/admin/orders');
                    const orders = (resp && resp.orders) ? resp.orders : [];
                    const sorted = orders
                        .slice()
                        .sort((a, b) => new Date(b.created_at).getTime() - new Date(a.created_at).getTime());
                    const recent = sorted.slice(0, 6);

                    if (!recent.length) {
                        document.getElementById('recent-orders-container').innerHTML = '<div class="empty-state"><p>No recent orders</p></div>';
                    } else {
                        let html = '<div class="data-table-container" style="box-shadow:none; border-radius:0; margin:0;">';
                        html += '<table class="data-table"><thead><tr>' +
                            '<th>Order</th>' +
                            '<th>Customer</th>' +
                            '<th>Total</th>' +
                            '<th>Status</th>' +
                            '<th>Date</th>' +
                            '</tr></thead><tbody>';

                        recent.forEach(o => {
                            const status = (o.status || '').toLowerCase();
                            const statusClass = status === 'completed'
                                ? 'badge-success'
                                : status === 'processing'
                                    ? 'badge-info'
                                    : status === 'cancelled'
                                        ? 'badge-danger'
                                        : 'badge-warning';
                            html += `
                                <tr>
                                    <td>#${o.id}</td>
                                    <td>${o.full_name || 'No account'}</td>
                                    <td>${formatCurrency(o.total_amount)}</td>
                                    <td><span class="badge ${statusClass}">${o.status || 'pending'}</span></td>
                                    <td>${formatDate(o.created_at)}</td>
                                </tr>
                            `;
                        });

                        html += '</tbody></table></div>';
                        document.getElementById('recent-orders-container').innerHTML = html;
                    }
                } catch (e) {
                    console.warn('Dashboard recent orders failed:', e);
                    document.getElementById('recent-orders-container').innerHTML = '<div class="empty-state"><p>No recent orders</p></div>';
                }

                // Low Stock Products (dynamic)
                try {
                    const LOW_STOCK_THRESHOLD = 10;
                    const presp = await api.get('/admin/products');
                    const products = (presp && presp.products) ? presp.products : [];
                    const lowStock = products
                        .map(p => ({
                            ...p,
                            stock_quantity: parseInt(p.stock_quantity, 10) || 0,
                            price: parseFloat(p.price) || 0
                        }))
                        .filter(p => p.stock_quantity <= LOW_STOCK_THRESHOLD)
                        .sort((a, b) => a.stock_quantity - b.stock_quantity)
                        .slice(0, 8);

                    if (!lowStock.length) {
                        document.getElementById('low-stock-container').innerHTML = '<div class="empty-state"><p>No low stock products</p></div>';
                    } else {
                        let html = '<div class="data-table-container" style="box-shadow:none; border-radius:0; margin:0;">';
                        html += '<table class="data-table"><thead><tr>' +
                            '<th>Product</th>' +
                            '<th>Stock</th>' +
                            '<th>Price</th>' +
                            '</tr></thead><tbody>';

                        lowStock.forEach(p => {
                            const statusClass = p.stock_quantity > 0 ? 'badge-warning' : 'badge-danger';
                            const img = (p.images && p.images[0]) ? p.images[0] : (p.image_url || '');
                            html += `
                                <tr>
                                    <td>
                                        <div style="display:flex; align-items:center; gap:0.75rem;">
                                            ${img ? `<img src="${img}" style="width:40px; height:40px; object-fit:cover; border-radius:6px; border:1px solid var(--border);"/>` : ''}
                                            <div>
                                                <div style="font-weight:600; color:var(--text-dark);">${p.name || 'Unnamed'}</div>
                                                <div style="font-size:0.8rem; color:var(--text-muted);">ID: #${p.id}</div>
                                            </div>
                                        </div>
                                    </td>
                                    <td><span class="badge ${statusClass}">${p.stock_quantity}</span></td>
                                    <td>${formatCurrency(p.price)}</td>
                                </tr>
                            `;
                        });

                        html += '</tbody></table></div>';
                        document.getElementById('low-stock-container').innerHTML = html;
                    }
                } catch (e) {
                    console.warn('Dashboard low stock failed:', e);
                    document.getElementById('low-stock-container').innerHTML = '<div class="empty-state"><p>No low stock products</p></div>';
                }
            } catch (error) {
                console.error('Load dashboard error:', error);
                document.getElementById('stats-container').innerHTML = `
                    <div class="stat-card primary">
                        <div class="stat-card-icon"><i class="fas fa-shopping-cart"></i></div>
                        <div class="stat-card-label">Orders</div>
                        <div class="stat-card-value">0</div>
                    </div>
                    <div class="stat-card success">
                        <div class="stat-card-icon"><i class="fas fa-dollar-sign"></i></div>
                        <div class="stat-card-label">Revenue</div>
                        <div class="stat-card-value">‚Çπ0.00</div>
                    </div>
                    <div class="stat-card info">
                        <div class="stat-card-icon"><i class="fas fa-users"></i></div>
                        <div class="stat-card-label">Customers</div>
                        <div class="stat-card-value">0</div>
                    </div>
                    <div class="stat-card warning">
                        <div class="stat-card-icon"><i class="fas fa-box"></i></div>
                        <div class="stat-card-label">Products</div>
                        <div class="stat-card-value">0</div>
                    </div>
                `;
            }
        }

        async function loadProducts() {
            try {
                showLoading('products-list');
                const response = await api.get('/admin/products');
                const products = response.products || [];
                window._productsCache = products;

                // Load and cache categories for filter if not already loaded
                if (!window._categoriesCache || window._categoriesCache.length === 0) {
                    try {
                        const catResponse = await api.get('/admin/categories');
                        window._categoriesCache = catResponse.categories || [];
                    } catch (e) {
                        console.error('Error loading categories:', e);
                        window._categoriesCache = [];
                    }
                }

                // Populate category filter dropdown
                const catFilter = document.getElementById('category-filter');
                if (catFilter && window._categoriesCache) {
                    catFilter.innerHTML = '<option value="">All Categories</option>' + 
                        window._categoriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }

                // Use filterProducts to render (ensures consistency with search/filter behavior)
                filterProducts();
            } catch (error) {
                console.error('Load products error:', error);
                document.getElementById('products-list').innerHTML = '<div class="empty-state"><p>Error loading products</p></div>';
            }
        }

        async function loadCategories() {
            try {
                showLoading('categories-list');
                const response = await api.get('/admin/categories');
                const categories = response.categories || [];
                window._categoriesCache = categories;

                // Use filterCategories to render so that search applies immediately
                if (typeof window.filterCategories === 'function') {
                    window.filterCategories();
                    return;
                }

                if (categories.length === 0) {
                    document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>No categories</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead><tbody>';
                
                categories.forEach(c => {
                    html += `
                        <tr>
                            <td>#${c.id}</td>
                            <td>${c.name}</td>
                            ${renderDescriptionCell(c.description)}
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn action-btn-edit" onclick="editCategory(${c.id})"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="action-btn action-btn-delete" onclick="deleteCategory(${c.id})"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('categories-list').innerHTML = html;
            } catch (error) {
                console.error('Load categories error:', error);
                document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>Error loading categories</p></div>';
            }
        }

        async function loadHomepageSections() {
            try {
                showLoading('homepage-sections-list');
                const response = await api.get('/admin/homepage-sections');
                const sections = response.sections || [];
                window._homepageSectionsCache = sections;

                if (sections.length === 0) {
                    document.getElementById('homepage-sections-list').innerHTML = '<div class="empty-state"><p>No homepage sections. Click "Add Section" to create one.</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Sort Order</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                
                sections.forEach(s => {
                    html += `
                        <tr>
                            <td>#${s.id}</td>
                            <td><strong>${s.name}</strong></td>
                            ${renderDescriptionCell(s.description)}
                            <td>${s.sort_order}</td>
                            <td><span class="badge ${s.is_active ? 'badge-success' : 'badge-secondary'}">${s.is_active ? 'Active' : 'Inactive'}</span></td>
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn action-btn-edit" onclick="editSection(${s.id})"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="action-btn action-btn-delete" onclick="deleteSection(${s.id})"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table></div>';
                document.getElementById('homepage-sections-list').innerHTML = html;
            } catch (error) {
                console.error('Load homepage sections error:', error);
                document.getElementById('homepage-sections-list').innerHTML = '<div class="empty-state"><p>Error loading homepage sections</p></div>';
            }
        }

        async function loadStockReports() {
            try {
                showLoading('stock-reports-list');
                const response = await api.get('/admin/stock-reports');
                const stockReports = response.stockReports || [];
                window._stockReportsCache = stockReports;

                // Load categories for filter if not already loaded
                if (!window._categoriesCache || window._categoriesCache.length === 0) {
                    try {
                        const catResponse = await api.get('/admin/categories');
                        window._categoriesCache = catResponse.categories || [];
                    } catch (e) {
                        console.error('Error loading categories:', e);
                        window._categoriesCache = [];
                    }
                }

                // Populate category filter dropdown
                const catFilter = document.getElementById('stock-category-filter');
                if (catFilter && window._categoriesCache) {
                    catFilter.innerHTML = '<option value="">All Categories</option>' + 
                        window._categoriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }

                // Update stock statistics based on full dataset
                updateStockStatistics(stockReports);

                // Use filterStockReports to render (ensures consistency with search/filter behavior)
                filterStockReports();
            } catch (error) {
                console.error('Load stock reports error:', error);
                document.getElementById('stock-reports-list').innerHTML = '<div class="empty-state"><p>Error loading stock reports</p></div>';
            }
        }

        function updateStockStatistics(stockReports) {
            const totalProducts = stockReports.length;
            const inStock = stockReports.filter(p => p.current_stock > 10).length;
            const lowStock = stockReports.filter(p => p.current_stock > 0 && p.current_stock <= 10).length;
            const outOfStock = stockReports.filter(p => p.current_stock <= 0).length;

            // Update stats cards
            document.getElementById('total-products-count').textContent = totalProducts;
            document.getElementById('in-stock-count').textContent = inStock;
            document.getElementById('low-stock-count').textContent = lowStock;
            document.getElementById('out-stock-count').textContent = outOfStock;
        }

        function renderStockReportsTable(stockReports) {
            if (stockReports.length === 0) {
                document.getElementById('stock-reports-list').innerHTML = '<div class="empty-state"><p>No products found</p></div>';
                return;
            }

            let html = '<div class="data-table-container">';
            html += '<div class="table-header"><h3>Product Stock Overview</h3></div>';
            html += '<table class="data-table"><thead><tr>' +
                '<th>Product</th>' +
                '<th>Category</th>' +
                '<th>Price</th>' +
                '<th>Initial Stock</th>' +
                '<th>Total Sold</th>' +
                '<th>Remaining Stock</th>' +
                '<th>Stock Value</th>' +
                '<th>Status</th>' +
                '<th>Actions</th>' +
                '</tr></thead><tbody>';

            stockReports.forEach(product => {
                const currentStock = parseInt(product.current_stock) || 0;
                const initialStock = parseInt(product.initial_stock) || 0;
                const totalSold = parseInt(product.total_sold) || 0;
                const price = parseFloat(product.price) || 0;
                const stockValue = currentStock * price;

                const statusClass = currentStock > 10 ? 'success' : currentStock > 0 ? 'warning' : 'danger';
                const statusText = currentStock > 10 ? 'In Stock' : currentStock > 0 ? 'Low Stock' : 'Out of Stock';

                html += `
                    <tr>
                        <td>
                            <div style="display: flex; align-items: center; gap: 0.75rem;">
                                ${product.images && product.images[0] ? `<img src="${product.images[0]}" style="width: 40px; height: 40px; object-fit: cover; border-radius: 6px; border: 1px solid var(--border);">` : ''}
                                <div>
                                    <div style="font-weight: 600; color: var(--text-dark);">${product.name}</div>
                                    <div style="font-size: 0.8rem; color: var(--text-muted);">ID: #${product.id}</div>
                                </div>
                            </div>
                        </td>
                        <td>${product.category_name || 'N/A'}</td>
                        <td>${formatCurrency(price)}</td>
                        <td>${initialStock}</td>
                        <td>${totalSold}</td>
                        <td>${currentStock}</td>
                        <td>${formatCurrency(stockValue)}</td>
                        <td><span class="badge badge-${statusClass}">${statusText}</span></td>
                        <td>
                            <button class="action-btn action-btn-view" onclick="viewStockHistory(${product.id})">
                                <i class="fas fa-history"></i> View History
                            </button>
                        </td>
                    </tr>
                `;
            });

            html += '</tbody></table></div>';
            document.getElementById('stock-reports-list').innerHTML = html;
        }

        function filterStockReports() {
            if (!window._stockReportsCache) return;

            const searchTerm = (document.getElementById('stock-search')?.value || '').toLowerCase().trim();
            const statusFilter = document.getElementById('stock-status-filter')?.value || '';
            const categoryFilter = document.getElementById('stock-category-filter')?.value || '';

            let filtered = window._stockReportsCache.filter(p => {
                // Search across multiple fields: ID, product name, category name
                // Handle ID search with or without "#" prefix
                const cleanSearch = searchTerm.replace('#', '');
                const matchesSearch = !searchTerm ||
                    String(p.id).includes(cleanSearch) ||
                    (p.name || '').toLowerCase().includes(searchTerm) ||
                    (p.category_name || '').toLowerCase().includes(searchTerm);

                // Category filter
                const matchesCategory = !categoryFilter || p.category_id == categoryFilter;

                // Status filter
                let matchesStatus = true;
                if (statusFilter) {
                    const stockQty = parseInt(p.current_stock) || 0;
                    if (statusFilter === 'in-stock' && stockQty <= 10) matchesStatus = false;
                    if (statusFilter === 'low-stock' && (stockQty <= 0 || stockQty > 10)) matchesStatus = false;
                    if (statusFilter === 'out-of-stock' && stockQty > 0) matchesStatus = false;
                }

                return matchesSearch && matchesCategory && matchesStatus;
            });

            renderStockReportsTable(filtered);
        }

        // View stock transaction history for a single product
        window.viewStockHistory = function(productId) {
            const product = (window._stockReportsCache || []).find(p => p.id === productId || p.id == productId);
            const titleEl = document.getElementById('stock-history-title');
            const bodyEl = document.getElementById('stock-history-body');
            const modal = document.getElementById('stock-history-modal');

            if (!bodyEl || !modal || !titleEl) return;

            if (!product) {
                titleEl.textContent = 'Transaction History';
                bodyEl.innerHTML = '<div class="empty-state"><p>Product not found</p></div>';
                modal.classList.add('show');
                return;
            }

            titleEl.textContent = `${product.name} - Transaction History`;

            if (product.transactions && product.transactions.length > 0) {
                // Order transactions chronologically so we can calculate stock before/after each sale
                const ordered = [...product.transactions].sort((a, b) => {
                    return new Date(a.order_date) - new Date(b.order_date);
                });

                const initialStock = parseInt(product.initial_stock) || 0;
                let runningStock = initialStock;

                // Pre-compute stock before/after for every row (so filtering doesn't break the math)
                const computedRows = ordered.map(t => {
                    const qty = parseInt(t.quantity) || 0;
                    const affectsStock = t.status !== 'cancelled';
                    const stockBefore = runningStock;
                    const stockAfter = affectsStock ? (runningStock - qty) : runningStock;
                    runningStock = stockAfter;
                    return { t, qty, stockBefore, stockAfter };
                });

                let html = '<div style="margin-bottom: 0.75rem; color: var(--text-muted); font-size: 0.9rem;">';
                html += `Category: <strong>${product.category_name || 'N/A'}</strong> | ID: <strong>#${product.id}</strong> | Initial Stock: <strong>${initialStock}</strong>`;
                html += '</div>';

                html += `
                    <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: flex-end; margin-bottom: 0.75rem;">
                        <div style="flex: 1; min-width: 220px;">
                            <label class="form-label" for="stock-history-order-search">Search by Order ID</label>
                            <input id="stock-history-order-search" class="form-input" type="text" placeholder="Type order id (example: 1023)" autocomplete="off">
                        </div>
                        <div style="flex: 0 0 auto;">
                            <button type="button" class="btn btn-primary" onclick="exportStockHistoryCsv()">
                                <i class="fas fa-download"></i> Export Transactions
                            </button>
                        </div>
                    </div>
                    <div class="data-table-container" style="box-shadow: none;">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Order #</th>
                                    <th>Customer</th>
                                    <th>Quantity</th>
                                    <th>Stock Before</th>
                                    <th>Stock After</th>
                                    <th>Price</th>
                                    <th>Total</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody id="stock-history-rows"></tbody>
                        </table>
                    </div>
                `;

                bodyEl.innerHTML = html;

                const rowsTbody = document.getElementById('stock-history-rows');
                const searchInput = document.getElementById('stock-history-order-search');

                const renderRows = (rows) => {
                    if (!rowsTbody) return;
                    window._stockHistoryFilteredRows = Array.isArray(rows) ? rows : [];
                    if (!rows || rows.length === 0) {
                        rowsTbody.innerHTML = `
                            <tr>
                                <td colspan="9" style="padding: 1rem; color: var(--text-muted);">No matching orders found</td>
                            </tr>
                        `;
                        return;
                    }

                    let rowsHtml = '';
                    rows.forEach(({ t, qty, stockBefore, stockAfter }) => {
                        rowsHtml += `
                            <tr>
                                <td>${formatDate(t.order_date)}</td>
                                <td><strong>${t.order_number}</strong></td>
                                <td>
                                    <div>${t.customer_name || 'No account'}</div>
                                    ${t.customer_email ? `<div style="font-size: 0.85rem; color: var(--text-muted);">${t.customer_email}</div>` : ''}
                                </td>
                                <td><strong style="color: var(--danger);">${qty}</strong></td>
                                <td>${stockBefore}</td>
                                <td>${stockAfter}</td>
                                <td>${formatCurrency(t.price)}</td>
                                <td><strong>${formatCurrency(t.subtotal)}</strong></td>
                                <td><span class="badge badge-${t.status === 'delivered' ? 'success' : t.status === 'cancelled' ? 'danger' : 'warning'}">${t.status}</span></td>
                            </tr>
                        `;
                    });
                    rowsTbody.innerHTML = rowsHtml;
                };

                const filterRowsByOrderId = () => {
                    const raw = (searchInput?.value || '').trim().toLowerCase();
                    const term = raw.replace('#', '');
                    if (!term) {
                        renderRows(computedRows);
                        return;
                    }

                    const filtered = computedRows.filter(({ t }) => {
                        const orderStr = String(t.order_number || '').toLowerCase();
                        const orderClean = orderStr.replace('#', '');
                        return orderStr.includes(term) || orderClean.includes(term);
                    });

                    renderRows(filtered);
                };

                renderRows(computedRows);
                window._stockHistoryMeta = {
                    productId: product.id,
                    productName: product.name,
                    categoryName: product.category_name || 'N/A',
                    initialStock,
                    openedAt: new Date().toISOString()
                };
                if (searchInput) {
                    searchInput.addEventListener('input', filterRowsByOrderId);
                    // Helps on mobile/desktop immediately
                    setTimeout(() => { try { searchInput.focus(); } catch (e) {} }, 0);
                }
            } else {
                bodyEl.innerHTML = '<div class="empty-state"><p>No transactions yet for this product</p></div>';
            }

            modal.classList.add('show');
        };

        window.closeStockHistoryModal = function() {
            const modal = document.getElementById('stock-history-modal');
            if (modal) modal.classList.remove('show');
        };

        window.exportStockHistoryCsv = function() {
            try {
                const rows = window._stockHistoryFilteredRows;
                const meta = window._stockHistoryMeta;

                if (!Array.isArray(rows) || rows.length === 0) {
                    showAlert('No transactions to export', 'warning');
                    return;
                }

                const safe = (value) => {
                    const str = value == null ? '' : String(value);
                    // CSV escaping: wrap in quotes and double any quotes
                    return '"' + str.replace(/\r?\n/g, ' ').replace(/"/g, '""') + '"';
                };

                let csv = 'TRANSACTION HISTORY\n';
                if (meta) {
                    csv += `Product: ${meta.productName} (ID: #${meta.productId})\n`;
                    csv += `Category: ${meta.categoryName}\n`;
                    csv += `Initial Stock: ${meta.initialStock}\n`;
                    csv += `Exported At: ${new Date().toLocaleString()}\n`;
                }
                csv += '\n';
                csv += 'Date,Order Number,Customer,Email,Quantity,Stock Before,Stock After,Price,Total,Status\n';

                rows.forEach(({ t, qty, stockBefore, stockAfter }) => {
                    const dateStr = formatDate(t.order_date);
                    const orderNo = t.order_number || '';
                    const customerName = t.customer_name || 'No account';
                    const customerEmail = t.customer_email || '';
                    const price = t.price != null ? t.price : '';
                    const subtotal = t.subtotal != null ? t.subtotal : '';
                    const status = t.status || '';

                    csv += [
                        safe(dateStr),
                        safe(orderNo),
                        safe(customerName),
                        safe(customerEmail),
                        safe(qty),
                        safe(stockBefore),
                        safe(stockAfter),
                        safe(price),
                        safe(subtotal),
                        safe(status)
                    ].join(',') + '\n';
                });

                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                const timestamp = new Date().toISOString().split('T')[0];
                const pid = meta?.productId != null ? meta.productId : 'product';

                link.setAttribute('href', url);
                link.setAttribute('download', `transaction-history-${pid}-${timestamp}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);

                showAlert('Transaction history exported successfully', 'success');
            } catch (e) {
                console.error('Export transaction history error:', e);
                showAlert('Export failed', 'error');
            }
        };

        window.exportStockReport = function() {
            if (!window._stockReportsCache || window._stockReportsCache.length === 0) {
                showAlert('No stock data to export', 'warning');
                return;
            }

            // Create CSV content with detailed transaction history
            let csv = 'STOCK REPORT - ' + new Date().toLocaleDateString() + '\n\n';
            
            window._stockReportsCache.forEach(p => {
                const initialStock = parseInt(p.initial_stock) || 0;
                const soldQty = parseInt(p.total_sold) || 0;
                const currentStock = parseInt(p.current_stock) || 0;
                const price = parseFloat(p.price) || 0;
                const stockValue = currentStock * price;
                let status;
                
                if (currentStock > 10) {
                    status = 'In Stock';
                } else if (currentStock > 0) {
                    status = 'Low Stock';
                } else {
                    status = 'Out of Stock';
                }

                // Product summary
                csv += `Product: ${p.name} (ID: #${p.id})\n`;
                csv += `Category: ${p.category_name || 'N/A'}\n`;
                csv += `Price: ‚Çπ${price.toFixed(2)}\n`;
                csv += `Initial Stock: ${initialStock}\n`;
                csv += `Total Sold: ${soldQty}\n`;
                csv += `Remaining Stock: ${currentStock}\n`;
                csv += `Stock Value: ‚Çπ${stockValue.toFixed(2)}\n`;
                csv += `Status: ${status}\n\n`;

                // Transaction history
                if (p.transactions && p.transactions.length > 0) {
                    csv += 'Transaction History:\n';
                    csv += 'Date,Order Number,Customer,Email,Quantity,Price,Total,Status\n';
                    p.transactions.forEach(t => {
                        csv += `${formatDate(t.order_date)},"${t.order_number}","${t.customer_name || 'No account'}","${t.customer_email || '-'}",${t.quantity},‚Çπ${parseFloat(t.price).toFixed(2)},‚Çπ${parseFloat(t.subtotal).toFixed(2)},${t.status}\n`;
                    });
                    csv += '\n';
                } else {
                    csv += 'No transactions yet\n\n';
                }
                
                csv += '---\n\n';
            });

            // Create download link
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            const timestamp = new Date().toISOString().split('T')[0];
            
            link.setAttribute('href', url);
            link.setAttribute('download', `stock-report-detailed-${timestamp}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showAlert('Detailed stock report exported successfully', 'success');
        };

        async function loadOrders() {
            try {
                showLoading('orders-list');
                // Fetch ALL orders without status filter to enable dynamic client-side filtering
                const resp = await api.get('/admin/orders');
                const orders = resp.orders || [];
                window._ordersCache = orders;

                // Use filterOrders to render (ensures consistency with search/filter behavior)
                filterOrders();
            } catch (error) {
                console.error('Load orders error:', error);
                document.getElementById('orders-list').innerHTML = '<div class="empty-state"><p>Error loading orders</p></div>';
            }
        }

        async function loadCustomerOrders() {
            try {
                showLoading('customer-orders-list');

                // Show only pending customer orders here so admin can confirm/reject them
                const resp = await api.get('/admin/orders?status=pending');
                const orders = resp.orders || [];
                window._customerOrdersCache = orders;

                updateCustomerOrdersBadge(orders.length);

                if (!orders.length) {
                    document.getElementById('customer-orders-list').innerHTML = '<div class="empty-state"><p>No pending customer orders</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>#</th><th>Order</th><th>Customer</th><th>Total</th><th>Delivery</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
                orders.forEach(o => {
                    const statusBadgeClass = o.status === 'delivered' ? 'badge-success' : o.status === 'cancelled' ? 'badge-danger' : 'badge-warning';
                    const statusLabel = o.status || 'pending';

                    const deliverySpeed = (o.delivery_speed || 'standard').toLowerCase();
                    const deliveryCharge = o.delivery_charge != null ? parseFloat(o.delivery_charge) : 0;
                    const hasCharge = !Number.isNaN(deliveryCharge) && deliveryCharge > 0;

                    let deliveryLabel;
                    if (deliverySpeed === 'fast') {
                        deliveryLabel = hasCharge
                            ? `Fast (${formatCurrency(deliveryCharge)})`
                            : 'Fast (Free)';
                    } else {
                        deliveryLabel = hasCharge
                            ? `Standard (+${formatCurrency(deliveryCharge)})`
                            : 'Standard (Free)';
                    }

                    const actionsHtml = o.status === 'pending'
                        ? `
                            <button class="action-btn action-btn-success" onclick="updateOrderStatus(${o.id}, 'processing')">
                                <i class="fas fa-check"></i> Confirm
                            </button>
                            <button class="action-btn action-btn-reject" onclick="updateOrderStatus(${o.id}, 'cancelled')">
                                <i class="fas fa-times"></i> Reject
                            </button>
                          `
                        : '<span class="badge badge-secondary">No actions</span>';

                    html += `
                        <tr>
                            <td>#${o.id}</td>
                            <td>${o.order_number || '-'}</td>
                            <td>${o.full_name || 'No account'}<br><small>${o.email || ''}</small></td>
                            <td>${formatCurrency(o.total_amount)}</td>
                            <td>${deliveryLabel}</td>
                            <td><span class="badge ${statusBadgeClass}">${statusLabel}</span></td>
                            <td>${formatDate(o.created_at)}</td>
                            <td>
                                <div class="table-actions">
                                    ${actionsHtml}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                document.getElementById('customer-orders-list').innerHTML = html;
            } catch (error) {
                console.error('Load customer orders error:', error);
                document.getElementById('customer-orders-list').innerHTML = '<div class="empty-state"><p>Error loading customer orders</p></div>';
            }
        }

        function updateCustomerOrdersBadge(count) {
            const badge = document.getElementById('customer-orders-badge');
            const dashBadge = document.getElementById('dashboard-customer-orders-badge');
            const dashHeaderBadge = document.getElementById('dashboard-header-customer-orders-badge');
            const safeCount = parseInt(count, 10) || 0;

            const applyBadge = (el) => {
                if (!el) return;
                if (safeCount > 0) {
                    el.textContent = String(safeCount);
                    el.style.display = '';
                } else {
                    el.textContent = '0';
                    el.style.display = 'none';
                }
            };

            applyBadge(badge);
            applyBadge(dashBadge);
            applyBadge(dashHeaderBadge);
        }

        // ==================== PENDING ORDERS UNREAD DOT ====================
        const MM_LS_KEY_PENDING_UNREAD = 'mm_admin_pending_unread';

        function getPendingOrdersUnread() {
            return localStorage.getItem(MM_LS_KEY_PENDING_UNREAD) === '1';
        }

        function renderPendingOrdersUnread() {
            const isUnread = getPendingOrdersUnread();
            const sidebarDot = document.getElementById('customer-orders-dot');
            const headerDot = document.getElementById('customer-orders-header-dot');
            const dashDot = document.getElementById('dashboard-customer-orders-dot');
            const dashHeaderDot = document.getElementById('dashboard-header-customer-orders-dot');
            [sidebarDot, headerDot, dashDot, dashHeaderDot].forEach(el => {
                if (!el) return;
                el.classList.toggle('hidden', !isUnread);
            });
        }

        function setPendingOrdersUnread(isUnread) {
            localStorage.setItem(MM_LS_KEY_PENDING_UNREAD, isUnread ? '1' : '0');
            renderPendingOrdersUnread();
        }

        // ==================== NEW ORDER NOTIFICATIONS ====================
        // Plays a loud notification sound, then speaks a message.
        // Note: Most browsers require a user gesture before audio/voice can play.
        let __pendingOrdersWatcherTimer = null;
        let __adminAudioCtx = null;
        let __adminAudioArmed = false;
        let __adminWarnedAudio = false;

        function armAdminAudioOnce() {
            if (__adminAudioArmed) return;
            __adminAudioArmed = true;

            try {
                const AudioContextClass = window.AudioContext || window.webkitAudioContext;
                if (AudioContextClass) {
                    __adminAudioCtx = new AudioContextClass();
                    if (typeof __adminAudioCtx.resume === 'function') {
                        __adminAudioCtx.resume().catch(() => {});
                    }
                }
            } catch (e) {
                // ignore
            }
        }

        document.addEventListener('pointerdown', () => {
            // One user interaction to enable future sound/voice
            armAdminAudioOnce();
        }, { once: true, passive: true });

        function playLoudOrderSound() {
            try {
                if (!__adminAudioCtx) {
                    armAdminAudioOnce();
                }
                if (!__adminAudioCtx) {
                    if (!__adminWarnedAudio) {
                        __adminWarnedAudio = true;
                        console.warn('AudioContext not available; cannot play notification sound');
                    }
                    return;
                }

                const ctx = __adminAudioCtx;
                if (ctx.state === 'suspended' && typeof ctx.resume === 'function') {
                    ctx.resume().catch(() => {});
                }

                const now = ctx.currentTime;
                const gain = ctx.createGain();
                gain.gain.setValueAtTime(0.0001, now);
                gain.connect(ctx.destination);

                // Three sharp beeps (loud)
                const beep = (t0) => {
                    const osc = ctx.createOscillator();
                    osc.type = 'square';
                    osc.frequency.setValueAtTime(880, t0);
                    osc.connect(gain);

                    gain.gain.setValueAtTime(0.0001, t0);
                    gain.gain.exponentialRampToValueAtTime(0.6, t0 + 0.01);
                    gain.gain.exponentialRampToValueAtTime(0.0001, t0 + 0.18);

                    osc.start(t0);
                    osc.stop(t0 + 0.2);
                };

                beep(now);
                beep(now + 0.25);
                beep(now + 0.5);
            } catch (e) {
                console.warn('Failed to play order sound:', e);
            }
        }

        function speakNewOrderMessage() {
            try {
                if (!('speechSynthesis' in window) || typeof SpeechSynthesisUtterance === 'undefined') {
                    return;
                }
                const message = 'You have an orders from the customers';
                window.speechSynthesis.cancel();
                const utter = new SpeechSynthesisUtterance(message);
                utter.rate = 1;
                utter.pitch = 1;
                utter.volume = 1;
                window.speechSynthesis.speak(utter);
            } catch (e) {
                console.warn('Failed to speak message:', e);
            }
        }

        function notifyNewPendingOrder() {
            playLoudOrderSound();
            setTimeout(() => {
                speakNewOrderMessage();
            }, 900);
        }

        async function fetchPendingOrders() {
            const resp = await api.get('/admin/orders?status=pending');
            return (resp && resp.orders) ? resp.orders : [];
        }

        function isAuthExpiredError(error) {
            const message = String(error?.message || '').toLowerCase();
            return (
                message.includes('invalid or expired token') ||
                message.includes('unauthorized') ||
                message.includes('user account no longer exists') ||
                message.includes('forbidden')
            );
        }

        function handleAdminSessionExpired() {
            if (window.__adminAuthRedirecting) {
                return;
            }
            window.__adminAuthRedirecting = true;

            try {
                localStorage.removeItem('token');
            } catch (_) {}

            if (__pendingOrdersWatcherTimer) {
                clearInterval(__pendingOrdersWatcherTimer);
                __pendingOrdersWatcherTimer = null;
            }

            showAlert('Admin session expired. Please login again.', 'error');
            setTimeout(() => {
                window.location.replace('/login?admin=true');
            }, 400);
        }

        function startPendingOrdersWatcher() {
            if (__pendingOrdersWatcherTimer) return;

            // Restore unread dot state on load
            renderPendingOrdersUnread();

            const LS_KEY_LAST_MS = 'mm_admin_pending_last_ms';

            const tick = async (isFirstRun) => {
                try {
                    if (window._adminLicenseBlocked) return;

                    const orders = await fetchPendingOrders();
                    updateCustomerOrdersBadge(orders.length);

                    const newest = orders && orders.length ? orders[0] : null;
                    const newestMs = newest && newest.created_at ? new Date(newest.created_at).getTime() : 0;
                    const lastMs = parseInt(localStorage.getItem(LS_KEY_LAST_MS) || '0', 10) || 0;

                    if (newestMs && (isFirstRun || !lastMs)) {
                        // Prime without making noise on first load
                        localStorage.setItem(LS_KEY_LAST_MS, String(newestMs));
                        return;
                    }

                    if (newestMs && newestMs > lastMs) {
                        localStorage.setItem(LS_KEY_LAST_MS, String(newestMs));
                        if (window._currentSection !== 'customers-orders') {
                            setPendingOrdersUnread(true);
                        }
                        notifyNewPendingOrder();
                    }
                } catch (e) {
                    if (isAuthExpiredError(e)) {
                        if (!window.__adminAuthRedirecting) {
                            handleAdminSessionExpired();
                        }
                        return;
                    }

                    // Silent failure (network/auth)
                    console.warn('Pending order watcher error:', e);
                }
            };

            // First run primes the last-seen value
            tick(true);
            __pendingOrdersWatcherTimer = setInterval(() => tick(false), 15000);
        }

        async function loadCustomers() {
            try {
                showLoading('customers-list');
                const resp = await api.get('/admin/customers');
                const customers = resp.customers || [];
                window._customersCache = customers;

                if (!customers.length) {
                    document.getElementById('customers-list').innerHTML = '<div class="empty-state"><p>No customers found</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Orders</th><th>Total Spent</th><th>Joined</th></tr></thead><tbody>';
                customers.forEach(c => {
                    html += `
                        <tr>
                            <td>${c.full_name}</td>
                            <td>${c.email}</td>
                            <td>${c.phone || '-'}</td>
                            <td>${c.role}</td>
                            <td>${c.total_orders}</td>
                            <td>${formatCurrency(c.total_spent)}</td>
                            <td>${formatDate(c.created_at)}</td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                document.getElementById('customers-list').innerHTML = html;
            } catch (error) {
                console.error('Load customers error:', error);
                document.getElementById('customers-list').innerHTML = '<div class="empty-state"><p>Error loading customers</p></div>';
            }
        }

        async function loadUsers() {
            try {
                showLoading('users-list');
                const resp = await api.get('/admin/users');
                const canSeeSuperAdminUsers = auth?.currentUser?.role === 'super_admin';
                const users = canSeeSuperAdminUsers
                    ? (resp.users || [])
                    : (resp.users || []).filter(u => u.role !== 'super_admin');
                window._usersCache = users;

                // Use filterUsers to render so that search/filters apply immediately
                if (typeof window.filterUsers === 'function') {
                    window.filterUsers();
                } else {
                    // Fallback to simple render if filterUsers is not defined
                    if (!users.length) {
                        document.getElementById('users-list').innerHTML = '<div class="empty-state"><p>No users found</p></div>';
                        return;
                    }

                    let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Phone</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
                    users.forEach(u => {
                        const isBlocked = u.is_blocked || false;
                        const isProtected = u.role === 'admin' || u.role === 'super_admin';
                        const statusBadge = isBlocked 
                            ? '<span class="badge badge-danger">Blocked</span>' 
                            : '<span class="badge badge-success">Active</span>';
                        
                        html += `
                            <tr>
                                <td>${u.full_name}</td>
                                <td>${u.email}</td>
                                <td><span class="badge badge-${(u.role === 'admin' || u.role === 'super_admin') ? 'info' : u.role === 'wholesale' ? 'warning' : 'secondary'}">${u.role}</span></td>
                                <td>${u.phone || '-'}</td>
                                <td>${statusBadge}</td>
                                <td>${formatDate(u.created_at)}</td>
                                <td>
                                    <div class="table-actions">
                                        ${!isProtected ? `
                                            <button class="action-btn ${isBlocked ? 'action-btn-success' : 'action-btn-warning'}" 
                                                    onclick="toggleBlockUser(${u.id}, ${!isBlocked})">
                                                <i class="fas fa-${isBlocked ? 'unlock' : 'ban'}"></i> ${isBlocked ? 'Unblock' : 'Block'}
                                            </button>
                                        ` : '<span class="text-muted">Protected</span>'}
                                    </div>
                                </td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                    document.getElementById('users-list').innerHTML = html;
                }
            } catch (error) {
                console.error('Load users error:', error);
                document.getElementById('users-list').innerHTML = '<div class="empty-state"><p>Error loading users</p></div>';
            }
        }

        window.toggleBlockUser = async function(userId, blockStatus) {
            if (!(await showConfirmDialog(`Are you sure you want to ${blockStatus ? 'block' : 'unblock'} this user?`, {
                title: `${blockStatus ? 'Block' : 'Unblock'} User`,
                confirmText: blockStatus ? 'Block User' : 'Unblock User',
                danger: !!blockStatus
            }))) {
                return;
            }

            try {
                const response = await api.put(`/admin/users/${userId}/block`, { isBlocked: blockStatus });
                showAlert(response.message || `User ${blockStatus ? 'blocked' : 'unblocked'} successfully`, 'success');
                loadUsers(); // Reload the users list
            } catch (error) {
                console.error('Block user error:', error);
                showAlert(error.error || 'Failed to update user status', 'error');
            }
        };

        async function loadActivities() {
            try {
                showLoading('activities-list');

                if (!window.api || typeof window.api.get !== 'function') {
                    console.warn('Admin API not initialized; cannot load activities');
                    document.getElementById('activities-list').innerHTML = '<div class="empty-state"><p>API not initialized. Please reload the page.</p></div>';
                    return;
                }

                const resp = await window.api.get('/admin/activities');
                
                if (!resp || typeof resp !== 'object') {
                    throw new Error('Invalid response from server');
                }

                const activities = resp.activities || [];
                window._activitiesCache = activities;

                // Use filterActivities to render so that search/filters apply immediately
                if (typeof window.filterActivities === 'function') {
                    window.filterActivities();
                } else {
                    if (!activities.length) {
                        document.getElementById('activities-list').innerHTML = '<div class="empty-state"><p>No recent activities found</p></div>';
                        return;
                    }

                    let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Type</th><th>User</th><th>Details</th><th>Date</th></tr></thead><tbody>';
                    activities.forEach(a => {
                        const activityType = a.activity_type || 'unknown';
                        const userName = a.full_name || 'Unknown User';
                        const userEmail = a.email || '';
                        const createdAt = a.created_at || '';
                        
                        let label = 'Unknown activity';
                        if (activityType === 'order') {
                            const amount = parseFloat(a.total_amount || 0).toFixed(2);
                            const status = a.status || 'pending';
                            label = `Order #${a.reference_id} - ‚Çπ${amount} (${status})`;
                        } else if (activityType === 'user_registered') {
                            label = 'New user registered';
                        }
                        
                        html += `
                            <tr>
                                <td>${activityType}</td>
                                <td>${userName}${userEmail ? '<br><small>' + userEmail + '</small>' : ''}</td>
                                <td>${label}</td>
                                <td>${formatDate(createdAt)}</td>
                            </tr>
                        `;
                    });
                    html += '</tbody></table></div>';
                    document.getElementById('activities-list').innerHTML = html;
                }
            } catch (error) {
                console.error('Load activities error:', error);
                const errorMsg = error.message || 'Unknown error occurred';
                document.getElementById('activities-list').innerHTML = `<div class="empty-state"><p>Error loading activities: ${errorMsg}</p><p style=\"margin-top:1rem;\"><button class=\"btn btn-primary\" onclick=\"loadActivities()\">Retry</button></p></div>`;
            }
        }

        async function loadWholesaleRequests() {
            try {
                showLoading('wholesale-list');
                const resp = await api.get('/admin/users/wholesale');
                const users = resp.users || [];
                window._wholesaleCache = users;

                const pending = users.filter(u => !u.is_approved).length;
                const badge = document.getElementById('wholesale-badge');
                if (badge) {
                    badge.textContent = pending;
                    badge.style.display = pending > 0 ? 'inline-flex' : 'none';
                }

                if (!users.length) {
                    document.getElementById('wholesale-list').innerHTML = '<div class="empty-state"><p>No wholesale requests</p></div>';
                    return;
                }

                let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Name</th><th>Email</th><th>Business</th><th>Status</th><th>Actions</th></tr></thead><tbody>';
                users.forEach(u => {
                    html += `
                        <tr>
                            <td>${u.full_name}</td>
                            <td>${u.email}</td>
                            <td>${u.business_name || '-'}</td>
                            <td><span class="badge ${u.is_approved ? 'badge-success' : 'badge-warning'}">${u.is_approved ? 'Approved' : 'Pending'}</span></td>
                            <td>
                                <div class="table-actions">
                                    ${u.is_approved ? '' : `<button class="action-btn action-btn-edit" onclick="approveWholesale(${u.id}, true)"><i class="fas fa-check"></i> Approve</button>`}
                                    ${u.is_approved ? `<button class="action-btn action-btn-delete" onclick="approveWholesale(${u.id}, false)"><i class="fas fa-times"></i> Revoke</button>` : ''}
                                </div>
                            </td>
                        </tr>
                    `;
                });
                html += '</tbody></table></div>';
                document.getElementById('wholesale-list').innerHTML = html;
            } catch (error) {
                console.error('Load wholesale requests error:', error);
                document.getElementById('wholesale-list').innerHTML = '<div class="empty-state"><p>Error loading wholesale requests</p></div>';
            }
        }

        // Site Settings - Logo Management
        async function loadSiteSettings() {
            try {
                const response = await api.get('/admin/settings');
                const settings = response.settings || {};
                
                // Display current logo
                const currentLogoImg = document.getElementById('current-logo-img');
                if (settings.logo_url && settings.logo_url !== 'default') {
                    currentLogoImg.src = settings.logo_url;
                    currentLogoImg.style.display = 'block';
                } else {
                    currentLogoImg.src = '';
                    currentLogoImg.style.display = 'none';
                    document.getElementById('current-logo-display').querySelector('.form-label').textContent = 'Current Active Logo: Using default (üèîÔ∏è Mountain Made)';
                }

                // Populate homepage hero headings
                const heroTitleInput = document.getElementById('homepage-hero-title');
                const heroSubtitleInput = document.getElementById('homepage-hero-subtitle');
                if (heroTitleInput) {
                    heroTitleInput.value = settings.homepage_hero_title || '';
                }
                if (heroSubtitleInput) {
                    heroSubtitleInput.value = settings.homepage_hero_subtitle || '';
                }

                const heroImagePreview = document.getElementById('homepage-hero-image-preview');
                const heroImagePlaceholder = document.getElementById('homepage-hero-image-placeholder');
                const heroImageCurrent = document.getElementById('homepage-hero-image-current');
                const currentHeroImage = settings.homepage_hero_image_url || '';

                if (heroImageCurrent) {
                    heroImageCurrent.value = currentHeroImage;
                }
                if (heroImagePreview && heroImagePlaceholder) {
                    if (currentHeroImage) {
                        heroImagePreview.src = currentHeroImage;
                        heroImagePreview.style.display = 'block';
                        heroImagePlaceholder.style.display = 'none';
                    } else {
                        heroImagePreview.src = '';
                        heroImagePreview.style.display = 'none';
                        heroImagePlaceholder.style.display = 'block';
                    }
                }

                // Populate delivery settings
                const fastEnabledInput = document.getElementById('fast-delivery-enabled');
                const fastChargeInput = document.getElementById('fast-delivery-charge');
                if (fastEnabledInput) {
                    const rawEnabled = (settings.fast_delivery_enabled ?? 'false').toString().toLowerCase();
                    fastEnabledInput.checked = rawEnabled === 'true';
                }
                if (fastChargeInput) {
                    const rawCharge = settings.fast_delivery_charge;
                    const parsed = rawCharge != null ? parseFloat(rawCharge) : 0;
                    fastChargeInput.value = !Number.isNaN(parsed) && parsed >= 0 ? parsed : '';
                }

                const businessEmailInput = document.getElementById('business-support-email');
                if (businessEmailInput) {
                    businessEmailInput.value = settings.business_support_email || 'hello@mountain-made.com';
                }
            } catch (error) {
                console.error('Load site settings error:', error);
                showAlert('Failed to load site settings', 'error');
            }
        }

        window.previewLogo = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Check size (2MB for logo)
            if (file.size > 2 * 1024 * 1024) {
                showAlert('Logo file size must be less than 2MB', 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('logo-preview');
                const placeholder = document.getElementById('logo-preview-placeholder');
                preview.src = e.target.result;
                preview.style.display = 'block';
                placeholder.style.display = 'none';
            };
            reader.readAsDataURL(file);
        };

            // Edit Logo Modal Logic
            window.openEditLogoModal = function() {
                const fileInput = document.getElementById('logo-upload');
                const file = fileInput.files[0];
                if (!file) {
                    showAlert('Please select a logo file first', 'warning');
                    return;
                }
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    return;
                }
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('edit-logo-crop-img').src = e.target.result;
                    document.getElementById('edit-logo-modal').style.display = 'flex';
                };
                reader.readAsDataURL(file);
            };

            window.closeEditLogoModal = function() {
                document.getElementById('edit-logo-modal').style.display = 'none';
            };

            window.saveEditedLogo = function() {
                // For simplicity, just use the cropped image as preview (cropping logic can be added with a library)
                const img = document.getElementById('edit-logo-crop-img');
                if (!img.src) {
                    showAlert('No image to save.', 'error');
                    return;
                }
                document.getElementById('logo-preview').src = img.src;
                document.getElementById('logo-preview').style.display = 'block';
                document.getElementById('logo-preview-placeholder').style.display = 'none';
                window.closeEditLogoModal();
                showAlert('Logo edited successfully. Click Upload to save.', 'success');
            };

        window.uploadLogo = async function() {
            try {
                const fileInput = document.getElementById('logo-upload');
                const file = fileInput.files[0];

                if (!file) {
                    showAlert('Please select a logo file first', 'warning');
                    return;
                }

                // Validate
                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    return;
                }

                if (file.size > 2 * 1024 * 1024) {
                    showAlert('Logo file size must be less than 2MB', 'error');
                    return;
                }

                // Upload image
                showAlert('Uploading logo...', 'info');
                const imageUrl = await uploadProductImage(fileInput);

                if (!imageUrl) {
                    throw new Error('Failed to upload logo image');
                }

                // Save logo URL to settings
                showAlert('Saving logo...', 'info');
                const response = await api.post('/admin/settings', {
                    logo_url: imageUrl
                });

                if (response && (response.success || response.message)) {
                    showAlert('Logo uploaded and saved successfully!', 'success');
                    fileInput.value = '';
                    document.getElementById('logo-preview').style.display = 'none';
                    document.getElementById('logo-preview-placeholder').style.display = 'block';
                    loadSiteSettings(); // Reload to show current logo
                    if (window.loadSiteLogo) {
                        window.loadSiteLogo();
                    }
                } else {
                    throw new Error(response.error || 'Failed to save logo');
                }
            } catch (error) {
                console.error('Upload logo error:', error);
                showAlert(error.message || 'Failed to upload logo', 'error');
            }
        };

        window.resetLogoToDefault = async function() {
            if (!(await showConfirmDialog('Are you sure you want to reset to the default logo? This will remove your custom logo.', {
                title: 'Reset Logo',
                confirmText: 'Reset to Default',
                danger: true
            }))) {
                return;
            }

            try {
                showAlert('Resetting logo...', 'info');
                const response = await api.post('/admin/settings', {
                    logo_url: 'default'
                });

                if (response && (response.success || response.message)) {
                    showAlert('Logo reset to default!', 'success');
                    document.getElementById('logo-upload').value = '';
                    document.getElementById('logo-preview').style.display = 'none';
                    document.getElementById('logo-preview-placeholder').style.display = 'block';
                    loadSiteSettings(); // Reload to show default
                    if (window.loadSiteLogo) {
                        window.loadSiteLogo();
                    }
                } else {
                    throw new Error(response.error || 'Failed to reset logo');
                }
            } catch (error) {
                console.error('Reset logo error:', error);
                showAlert(error.message || 'Failed to reset logo', 'error');
            }
        };

        window.saveHomepageHeadings = async function() {
            try {
                const titleEl = document.getElementById('homepage-hero-title');
                const subtitleEl = document.getElementById('homepage-hero-subtitle');

                const homepage_hero_title = titleEl ? titleEl.value.trim() : '';
                const homepage_hero_subtitle = subtitleEl ? subtitleEl.value.trim() : '';

                showAlert('Saving homepage headings...', 'info');

                const response = await api.post('/admin/settings', {
                    homepage_hero_title,
                    homepage_hero_subtitle
                });

                if (response && (response.success || response.message)) {
                    showAlert('Homepage headings saved successfully!', 'success');
                    await loadSiteSettings();
                } else {
                    throw new Error(response.error || 'Failed to save homepage headings');
                }
            } catch (error) {
                console.error('Save homepage headings error:', error);
                showAlert(error.message || 'Failed to save homepage headings', 'error');
            }
        };

        window.previewHomepageHeroImage = function(event) {
            const file = event?.target?.files?.[0];
            if (!file) return;

            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            (async () => {
                try {
                    window._addSectionHeadingSourceFile = file;

                    const addCropX = document.getElementById('add-heading-crop-x');
                    const addCropY = document.getElementById('add-heading-crop-y');
                    if (addCropX) addCropX.value = 50;
                    if (addCropY) addCropY.value = 50;

                    await buildAndPreviewAddSectionCrop();
                    showAlert('Image cropped. Adjust sliders for manual crop.', 'success');
                } catch (error) {
                    console.error('Add heading image crop error:', error);
                    window._addSectionHeadingSourceFile = null;
                    window._addSectionHeadingCroppedFile = null;
                    showAlert(error.message || 'Failed to crop image', 'error');
                    event.target.value = '';
                }
            })();
        };

        window.saveDeliverySettings = async function() {
            try {
                const enabledEl = document.getElementById('fast-delivery-enabled');
                const chargeEl = document.getElementById('fast-delivery-charge');

                const fast_delivery_enabled = !!(enabledEl && enabledEl.checked);
                const rawCharge = chargeEl ? (chargeEl.value || '').trim() : '';

                // Allow flexible typing (e.g. "50 ‚Çπ" or spaces), keep only digits and dot
                const normalizedCharge = rawCharge === ''
                    ? ''
                    : rawCharge.replace(/[^0-9.]/g, '');

                const fast_delivery_charge = normalizedCharge === '' ? 0 : parseFloat(normalizedCharge);

                if (Number.isNaN(fast_delivery_charge) || fast_delivery_charge < 0) {
                    showAlert('Please enter a valid non-negative fast delivery charge.', 'error');
                    if (chargeEl) chargeEl.focus();
                    return;
                }

                showAlert('Saving fast delivery settings...', 'info');
                const response = await api.post('/admin/settings', {
                    fast_delivery_enabled,
                    fast_delivery_charge
                });

                if (response && (response.success || response.message)) {
                    showAlert('Fast delivery settings updated successfully!', 'success');
                    await loadSiteSettings();
                } else {
                    showAlert(response.error || 'Failed to save delivery settings', 'error');
                }
            } catch (error) {
                console.error('Save delivery settings error:', error);
                showAlert(error.message || 'Failed to save delivery settings', 'error');
            }
        };

        window.saveBusinessEmailSettings = async function() {
            try {
                const businessEmailEl = document.getElementById('business-support-email');
                const business_support_email = (businessEmailEl?.value || '').trim();

                if (business_support_email && !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(business_support_email)) {
                    showAlert('Please enter a valid business support email address.', 'error');
                    businessEmailEl?.focus();
                    return;
                }

                showAlert('Saving business email settings...', 'info');
                const response = await api.post('/admin/settings', { business_support_email });

                if (response && (response.success || response.message)) {
                    showAlert('Business email integration saved successfully!', 'success');
                    await loadSiteSettings();
                } else {
                    throw new Error(response?.error || 'Failed to save business email settings');
                }
            } catch (error) {
                console.error('Save business email settings error:', error);
                showAlert(error.message || 'Failed to save business email settings', 'error');
            }
        };

        async function loadCategoriesForUpload() {
            try {
                const response = await api.get('/admin/categories');
                const categories = response.categories || [];
                window._categoriesCache = categories;
                
                const optionsHtml = '<option value="">Select Category</option>' + 
                    categories.map(c => `<option value="${c.id}">${c.name}</option>`).join('');

                const select = document.getElementById('product-category');
                const wholesaleSelect = document.getElementById('wholesale-product-category');
                if (select) {
                    select.innerHTML = optionsHtml;
                }
                if (wholesaleSelect) {
                    wholesaleSelect.innerHTML = optionsHtml;
                }
            } catch (error) {
                console.error('Load categories error:', error);
            }
        }

        // Dynamic Categories Filter
        window.filterCategories = function() {
            const search = (document.getElementById('category-search')?.value || '').toLowerCase().trim();
            const categories = window._categoriesCache || [];

            if (!categories.length) {
                document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>No categories</p></div>';
                return;
            }

            const filtered = categories.filter(c => {
                const searchTerm = search.replace('#', '');

                if (!search) return true;

                return String(c.id || '').includes(searchTerm) ||
                    (c.name || '').toLowerCase().includes(search) ||
                    (c.description || '').toLowerCase().includes(search);
            });

            if (!filtered.length) {
                document.getElementById('categories-list').innerHTML = '<div class="empty-state"><p>No categories found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Description</th><th>Actions</th></tr></thead><tbody>';

            filtered.forEach(c => {
                html += `
                        <tr>
                            <td>#${c.id}</td>
                            <td>${c.name}</td>
                            ${renderDescriptionCell(c.description)}
                            <td>
                                <div class="table-actions">
                                    <button class="action-btn action-btn-edit" onclick="editCategory(${c.id})"><i class="fas fa-edit"></i> Edit</button>
                                    <button class="action-btn action-btn-delete" onclick="deleteCategory(${c.id})"><i class="fas fa-trash"></i> Delete</button>
                                </div>
                            </td>
                        </tr>
                    `;
            });

            html += '</tbody></table></div>';
            document.getElementById('categories-list').innerHTML = html;
        };

        // Dynamic Activities Filter
        window.filterActivities = function() {
            const search = (document.getElementById('activities-search')?.value || '').toLowerCase().trim();
            const typeFilter = document.getElementById('activities-type-filter')?.value || '';
            const fromValue = document.getElementById('activities-date-from')?.value || '';
            const toValue = document.getElementById('activities-date-to')?.value || '';
            const activities = window._activitiesCache || [];

            const fromDate = fromValue ? new Date(fromValue) : null;
            const toDate = toValue ? new Date(toValue) : null;
            if (toDate) {
                toDate.setHours(23, 59, 59, 999);
            }

            const filtered = activities.filter(a => {
                const searchTerm = search.replace('#', '');
                const activityType = a.activity_type || 'unknown';
                const userName = a.full_name || 'Unknown User';
                const userEmail = a.email || '';
                const createdAt = a.created_at || '';
                const createdDate = createdAt ? new Date(createdAt) : null;

                let label = 'Unknown activity';
                if (activityType === 'order') {
                    const amount = parseFloat(a.total_amount || 0).toFixed(2);
                    const status = a.status || 'pending';
                    label = `Order #${a.reference_id} - ‚Çπ${amount} (${status})`;
                } else if (activityType === 'user_registered') {
                    label = 'New user registered';
                }

                const matchesSearch = !search ||
                    String(a.id || '').includes(searchTerm) ||
                    (activityType || '').toLowerCase().includes(search) ||
                    userName.toLowerCase().includes(search) ||
                    userEmail.toLowerCase().includes(search) ||
                    label.toLowerCase().includes(search) ||
                    (String(a.reference_id || '')).toLowerCase().includes(searchTerm);

                const matchesType = !typeFilter || activityType === typeFilter;

                let matchesDate = true;
                if (fromDate && createdDate && createdDate < fromDate) {
                    matchesDate = false;
                }
                if (toDate && createdDate && createdDate > toDate) {
                    matchesDate = false;
                }

                return matchesSearch && matchesType && matchesDate;
            });

            if (!filtered.length) {
                document.getElementById('activities-list').innerHTML = '<div class="empty-state"><p>No activities found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>Type</th><th>User</th><th>Details</th><th>Date</th></tr></thead><tbody>';
            filtered.forEach(a => {
                const activityType = a.activity_type || 'unknown';
                const userName = a.full_name || 'Unknown User';
                const userEmail = a.email || '';
                const createdAt = a.created_at || '';

                let label = 'Unknown activity';
                if (activityType === 'order') {
                    const amount = parseFloat(a.total_amount || 0).toFixed(2);
                    const status = a.status || 'pending';
                    label = `Order #${a.reference_id} - ‚Çπ${amount} (${status})`;
                } else if (activityType === 'user_registered') {
                    label = 'New user registered';
                }

                html += `
                    <tr>
                        <td>${activityType}</td>
                        <td>${userName}${userEmail ? '<br><small>' + userEmail + '</small>' : ''}</td>
                        <td>${label}</td>
                        <td>${formatDate(createdAt)}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('activities-list').innerHTML = html;
        };

        // Dynamic Users Filter
        window.filterUsers = function() {
            const search = (document.getElementById('user-search')?.value || '').toLowerCase().trim();
            const roleFilter = document.getElementById('user-role-filter')?.value || '';
            const statusFilter = document.getElementById('user-status-filter')?.value || '';
            const canSeeSuperAdminUsers = auth?.currentUser?.role === 'super_admin';
            const users = canSeeSuperAdminUsers
                ? (window._usersCache || [])
                : (window._usersCache || []).filter(u => u.role !== 'super_admin');

            const filtered = users.filter(u => {
                const searchTerm = search.replace('#', '');

                const matchesSearch = !search ||
                    String(u.id || '').includes(searchTerm) ||
                    (u.full_name || '').toLowerCase().includes(search) ||
                    (u.email || '').toLowerCase().includes(search) ||
                    (u.phone || '').toLowerCase().includes(search);

                const matchesRole = !roleFilter || (u.role === roleFilter);

                const isBlocked = !!(u.is_blocked);
                const statusValue = isBlocked ? 'blocked' : 'active';
                const matchesStatus = !statusFilter || statusFilter === statusValue;

                return matchesSearch && matchesRole && matchesStatus;
            });

            if (!filtered.length) {
                document.getElementById('users-list').innerHTML = '<div class="empty-state"><p>No users found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Email</th><th>Role</th><th>Phone</th><th>Status</th><th>Joined</th><th>Actions</th></tr></thead><tbody>';
            filtered.forEach(u => {
                const isBlocked = u.is_blocked || false;
                const isProtected = u.role === 'admin' || u.role === 'super_admin';
                const statusBadge = isBlocked 
                    ? '<span class="badge badge-danger">Blocked</span>' 
                    : '<span class="badge badge-success">Active</span>';

                html += `
                    <tr>
                        <td>#${u.id}</td>
                        <td>${u.full_name}</td>
                        <td>${u.email}</td>
                        <td><span class="badge badge-${(u.role === 'admin' || u.role === 'super_admin') ? 'info' : u.role === 'wholesale' ? 'warning' : 'secondary'}">${u.role}</span></td>
                        <td>${u.phone || '-'}</td>
                        <td>${statusBadge}</td>
                        <td>${formatDate(u.created_at)}</td>
                        <td>
                            <div class="table-actions">
                                ${!isProtected ? `
                                    <button class="action-btn ${isBlocked ? 'action-btn-success' : 'action-btn-warning'}" 
                                            onclick="toggleBlockUser(${u.id}, ${!isBlocked})">
                                        <i class="fas fa-${isBlocked ? 'unlock' : 'ban'}"></i> ${isBlocked ? 'Unblock' : 'Block'}
                                    </button>
                                ` : '<span class="text-muted">Protected</span>'}
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('users-list').innerHTML = html;
        };

        window.filterProducts = function() {
            const search = (document.getElementById('product-search')?.value || '').toLowerCase().trim();
            const category = document.getElementById('category-filter')?.value || '';
            const products = window._productsCache || [];
            
            const filtered = products.filter(p => {
                // Search across multiple fields: ID, name, description, category name
                // Handle ID search with or without "#" prefix
                const searchTerm = search.replace('#', '');
                const matchesSearch = !search || 
                    String(p.id).includes(searchTerm) ||
                    (p.name || '').toLowerCase().includes(search) || 
                    (p.description || '').toLowerCase().includes(search) ||
                    (p.category_name || '').toLowerCase().includes(search);
                
                const matchesCategory = !category || p.category_id == category;
                return matchesSearch && matchesCategory;
            });

            if (filtered.length === 0) {
                document.getElementById('products-list').innerHTML = '<div class="empty-state"><p>No products found</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>ID</th><th>Name</th><th>Category</th><th>Price</th><th>Stock</th><th>Actions</th></tr></thead><tbody>';
            
            filtered.forEach(p => {
                html += `
                    <tr>
                        <td>#${p.id}</td>
                        <td>${p.name}</td>
                            <td>${p.category_name || 'N/A'}</td>
                            <td>
                                ${p.discount_price && parseFloat(p.discount_price) < parseFloat(p.price || 0)
                                    ? `<span class="price-original">‚Çπ${parseFloat(p.price || 0).toFixed(2)}</span> <strong class="price-discount">‚Çπ${parseFloat(p.discount_price).toFixed(2)}</strong>`
                                    : `<strong>‚Çπ${parseFloat(p.price || 0).toFixed(2)}</strong>`}
                            </td>
                        <td><span class="badge ${p.stock_quantity > 10 ? 'badge-success' : p.stock_quantity > 0 ? 'badge-warning' : 'badge-danger'}">${p.stock_quantity}</span></td>
                        <td>
                            <div class="table-actions">
                                <button class="action-btn action-btn-edit" onclick="editProduct(${p.id})"><i class="fas fa-edit"></i> Edit</button>
                                <button class="action-btn action-btn-delete" onclick="deleteProduct(${p.id})"><i class="fas fa-trash"></i> Delete</button>
                            </div>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table></div>';
            document.getElementById('products-list').innerHTML = html;
        };
        window.filterOrders = function() {
            const search = (document.getElementById('order-search')?.value || '').toLowerCase().trim();
            const status = document.getElementById('order-status-filter')?.value || '';
            const orders = window._ordersCache || [];

            const filtered = orders.filter(o => {
                // Search across multiple fields: ID, order number, customer name, email
                // Handle ID search with or without "#" prefix
                const searchTerm = search.replace('#', '');
                const matchSearch = !search || 
                    String(o.id).includes(searchTerm) ||
                    (o.order_number || '').toLowerCase().includes(search) || 
                    (o.full_name || '').toLowerCase().includes(search) || 
                    (o.email || '').toLowerCase().includes(search);
                
                const matchStatus = !status || o.status === status;
                return matchSearch && matchStatus;
            });

            if (!filtered.length) {
                document.getElementById('orders-list').innerHTML = '<div class="empty-state"><p>No matching orders</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>#</th><th>Order</th><th>Customer</th><th>Total</th><th>Delivery</th><th>Status</th><th>Date</th></tr></thead><tbody>';
            filtered.forEach(o => {
                const deliverySpeed = (o.delivery_speed || 'standard').toLowerCase();
                const deliveryCharge = o.delivery_charge != null ? parseFloat(o.delivery_charge) : 0;
                const hasCharge = !Number.isNaN(deliveryCharge) && deliveryCharge > 0;

                let deliveryLabel;
                if (deliverySpeed === 'fast') {
                    deliveryLabel = hasCharge
                        ? `Fast (${formatCurrency(deliveryCharge)})`
                        : 'Fast (Free)';
                } else {
                    deliveryLabel = hasCharge
                        ? `Standard (+${formatCurrency(deliveryCharge)})`
                        : 'Standard (Free)';
                }

                html += `
                    <tr>
                        <td>#${o.id}</td>
                        <td>${o.order_number || '-'}</td>
                        <td>${o.full_name || 'No account'}<br><small>${o.email || ''}</small></td>
                        <td>${formatCurrency(o.total_amount)}</td>
                        <td>${deliveryLabel}</td>
                        <td><span class="badge badge-${o.status === 'delivered' ? 'success' : o.status === 'cancelled' ? 'danger' : 'warning'}">${o.status}</span></td>
                        <td>${formatDate(o.created_at)}</td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('orders-list').innerHTML = html;
        };

        window.filterCustomerOrders = function() {
            const search = (document.getElementById('customer-order-search')?.value || '').toLowerCase().trim();
            const orders = window._customerOrdersCache || [];

            const filtered = orders.filter(o => {
                // Search across multiple fields: ID, order number, customer name, email
                // Handle ID search with or without "#" prefix
                const searchTerm = search.replace('#', '');
                const matchesSearch = !search ||
                    String(o.id).includes(searchTerm) ||
                    (o.full_name || '').toLowerCase().includes(search) ||
                    (o.email || '').toLowerCase().includes(search) ||
                    (o.order_number || '').toLowerCase().includes(search);
                return matchesSearch;
            });

            if (!filtered.length) {
                document.getElementById('customer-orders-list').innerHTML = '<div class="empty-state"><p>No matching orders</p></div>';
                return;
            }

            let html = '<div class="data-table-container"><table class="data-table"><thead><tr><th>#</th><th>Order</th><th>Customer</th><th>Total</th><th>Status</th><th>Date</th><th>Actions</th></tr></thead><tbody>';
            filtered.forEach(o => {
                const statusBadgeClass = o.status === 'delivered' ? 'badge-success' : o.status === 'cancelled' ? 'badge-danger' : 'badge-warning';
                const statusLabel = o.status || 'pending';

                const actionsHtml = o.status === 'pending'
                    ? `
                        <button class="action-btn action-btn-success" onclick="updateOrderStatus(${o.id}, 'processing')">
                            <i class="fas fa-check"></i> Confirm
                        </button>
                        <button class="action-btn action-btn-reject" onclick="updateOrderStatus(${o.id}, 'cancelled')">
                            <i class="fas fa-times"></i> Reject
                        </button>
                      `
                    : '<span class="badge badge-secondary">No actions</span>';

                html += `
                    <tr>
                        <td>#${o.id}</td>
                        <td>${o.order_number || '-'}</td>
                        <td>${o.full_name || 'No account'}<br><small>${o.email || ''}</small></td>
                        <td>${formatCurrency(o.total_amount)}</td>
                        <td><span class="badge ${statusBadgeClass}">${statusLabel}</span></td>
                        <td>${formatDate(o.created_at)}</td>
                        <td>
                            <div class="table-actions">
                                ${actionsHtml}
                            </div>
                        </td>
                    </tr>
                `;
            });
            html += '</tbody></table></div>';
            document.getElementById('customer-orders-list').innerHTML = html;
        };

        window.updateOrderStatus = async function(orderId, status) {
            const verb = status === 'processing' ? 'confirm' : status === 'cancelled' ? 'reject' : 'update';
            if (!(await showConfirmDialog(`Are you sure you want to ${verb} this order?`, {
                title: 'Update Order Status',
                confirmText: 'Yes, Continue',
                danger: status === 'cancelled'
            }))) {
                return;
            }

            try {
                const resp = await api.put(`/admin/orders/${orderId}/status`, { status });
                const msg = resp.message || `Order ${verb}ed successfully`;
                showAlert(msg, 'success');

                // Reload both pending customer orders view and full order history cache if open
                if (window._currentSection === 'customers-orders') {
                    await loadCustomerOrders();
                }
                if (window._currentSection === 'order-history') {
                    await loadOrders();
                }

                // Also refresh product stock and stock reports so restored
                // quantities are reflected immediately in admin views
                if (typeof loadProducts === 'function') {
                    await loadProducts();
                }
                if (typeof loadStockReports === 'function') {
                    await loadStockReports();
                }
            } catch (error) {
                console.error('Update order status error:', error);
                const errMsg = error?.error || 'Failed to update order status';
                showAlert(errMsg, 'error');
            }
        };

        window.approveWholesale = async function(userId, isApproved) {
            try {
                await api.put(`/admin/users/${userId}/approve`, { isApproved });
                showAlert(isApproved ? 'User approved successfully' : 'Wholesale access revoked', 'success');
                loadWholesaleRequests();
            } catch (error) {
                console.error('Approve wholesale error:', error);
                showAlert('Failed to update wholesale status', 'error');
            }
        };

        window.showAddSingleProductModal = function() {
            showAddProductModal();
        };

        window.showAddProductModal = function() { 
            const modal = document.getElementById('add-product-modal');
            if (modal) {
                modal.classList.add('show');
                // Load categories and homepage sections into dropdowns
                loadCategoriesForUpload();
                loadHomepageSectionsForForms();
            }
        };

        window.closeAddProductModal = function() {
            const modal = document.getElementById('add-product-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('add-product-form').reset();
                document.getElementById('product-discount-price').value = '';
                // Clear images preview
                const imagesInput = document.getElementById('product-images');
                if (imagesInput) {
                    imagesInput.value = '';
                    document.getElementById('images-preview').innerHTML = '';
                }
                clearProductImage();
            }
        };

        let wholesaleSectionSelectedImages = [];
        let wholesaleProductSelectedImages = [];

        function renderWholesaleSectionImagesPreview() {
            const preview = document.getElementById('wholesale-upload-preview');
            const table = document.getElementById('wholesale-upload-preview-table');
            if (!preview || !table) return;

            if (!wholesaleSectionSelectedImages.length) {
                preview.style.display = 'none';
                table.innerHTML = '';
                return;
            }

            preview.style.display = 'block';
            table.innerHTML = `
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 0.75rem;">
                    <div style="font-weight:600; color: var(--text-primary);">${wholesaleSectionSelectedImages.length} image(s) selected for wholesale upload</div>
                    <button type="button" class="btn btn-outline" onclick="clearWholesaleSectionImages()">Clear All</button>
                </div>
                <div style="display:grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem;">
                    ${wholesaleSectionSelectedImages.map((file, index) => `
                        <div style="border:1px solid var(--border); border-radius:10px; padding:8px; background: var(--bg-secondary);">
                            <img src="${URL.createObjectURL(file)}" alt="${file.name}" style="width:100%; height:110px; object-fit:cover; border-radius:8px; display:block; margin-bottom:6px;">
                            <div style="font-size:12px; color: var(--text-secondary); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; margin-bottom:6px;" title="${file.name}">${file.name}</div>
                            <button type="button" class="btn btn-danger" style="width:100%; padding:6px 8px; font-size:12px;" onclick="removeWholesaleSectionImage(${index})">Remove</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        window.handleWholesaleImageUpload = function(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;

            for (const file of files) {
                if (wholesaleSectionSelectedImages.length >= 5) {
                    showAlert('Maximum 5 images allowed.', 'error');
                    break;
                }

                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    continue;
                }

                const exists = wholesaleSectionSelectedImages.some(existing =>
                    existing.name === file.name &&
                    existing.size === file.size &&
                    existing.lastModified === file.lastModified
                );
                if (!exists) {
                    wholesaleSectionSelectedImages.push(file);
                }
            }

            event.target.value = '';
            renderWholesaleSectionImagesPreview();
        };

        window.removeWholesaleSectionImage = function(index) {
            wholesaleSectionSelectedImages.splice(index, 1);
            renderWholesaleSectionImagesPreview();
        };

        window.clearWholesaleSectionImages = function() {
            wholesaleSectionSelectedImages = [];
            const input = document.getElementById('wholesale-image-input');
            if (input) input.value = '';
            renderWholesaleSectionImagesPreview();
        };

        window.showAddWholesaleProductModal = function() {
            const modal = document.getElementById('add-wholesale-product-modal');
            if (!modal) return;

            modal.classList.add('show');
            loadCategoriesForUpload();
            loadHomepageSectionsForForms();

            const form = document.getElementById('add-wholesale-product-form');
            if (form) form.reset();

            wholesaleProductSelectedImages = [...wholesaleSectionSelectedImages];
            renderWholesaleProductImagesPreview();
        };

        window.closeAddWholesaleProductModal = function() {
            const modal = document.getElementById('add-wholesale-product-modal');
            if (!modal) return;

            modal.classList.remove('show');
            const form = document.getElementById('add-wholesale-product-form');
            if (form) form.reset();

            const input = document.getElementById('wholesale-product-images');
            if (input) input.value = '';
            wholesaleProductSelectedImages = [];
            renderWholesaleProductImagesPreview();
        };

        function renderWholesaleProductImagesPreview() {
            const previewContainer = document.getElementById('wholesale-product-images-preview');
            if (!previewContainer) return;

            previewContainer.innerHTML = '';
            if (!wholesaleProductSelectedImages.length) return;

            const countDiv = document.createElement('div');
            countDiv.style.cssText = 'width: 100%; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500;';
            countDiv.textContent = `${wholesaleProductSelectedImages.length} image${wholesaleProductSelectedImages.length > 1 ? 's' : ''} selected (max 5)`;
            previewContainer.appendChild(countDiv);

            const imagesRow = document.createElement('div');
            imagesRow.style.cssText = 'display: flex; gap: 0.5rem; flex-wrap: wrap;';
            previewContainer.appendChild(imagesRow);

            wholesaleProductSelectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = 'position: relative; display: inline-block;';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border);';

                    if (index === 0) {
                        const badge = document.createElement('span');
                        badge.textContent = 'Main';
                        badge.style.cssText = 'position: absolute; top: 4px; left: 4px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;';
                        imgWrapper.appendChild(badge);
                    }

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '√ó';
                    removeBtn.type = 'button';
                    removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center;';
                    removeBtn.onclick = () => removeWholesaleProductImage(index);

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(removeBtn);
                    imagesRow.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        window.previewWholesaleProductImages = function(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;

            for (const file of files) {
                if (wholesaleProductSelectedImages.length >= 5) {
                    showAlert('Maximum 5 images allowed.', 'error');
                    break;
                }

                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    continue;
                }

                const exists = wholesaleProductSelectedImages.some(existing =>
                    existing.name === file.name &&
                    existing.size === file.size &&
                    existing.lastModified === file.lastModified
                );
                if (!exists) {
                    wholesaleProductSelectedImages.push(file);
                }
            }

            event.target.value = '';
            renderWholesaleProductImagesPreview();
        };

        function removeWholesaleProductImage(index) {
            wholesaleProductSelectedImages.splice(index, 1);
            renderWholesaleProductImagesPreview();
        }

        window.previewProductImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('image-preview');
                document.getElementById('preview-img').src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        // Add-product image queue (supports repeated picks up to 5 images)
        let addProductSelectedImages = [];

        function renderProductImagesPreview() {
            const previewContainer = document.getElementById('images-preview');
            if (!previewContainer) return;

            previewContainer.innerHTML = '';
            if (addProductSelectedImages.length === 0) return;

            const countDiv = document.createElement('div');
            countDiv.style.cssText = 'width: 100%; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500;';
            countDiv.textContent = `${addProductSelectedImages.length} image${addProductSelectedImages.length > 1 ? 's' : ''} selected (max 5)`;
            previewContainer.appendChild(countDiv);

            const imagesRow = document.createElement('div');
            imagesRow.style.cssText = 'display: flex; gap: 0.5rem; flex-wrap: wrap;';
            previewContainer.appendChild(imagesRow);

            addProductSelectedImages.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = 'position: relative; display: inline-block;';

                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border);';

                    if (index === 0) {
                        const badge = document.createElement('span');
                        badge.textContent = 'Main';
                        badge.style.cssText = 'position: absolute; top: 4px; left: 4px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;';
                        imgWrapper.appendChild(badge);
                    }

                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '√ó';
                    removeBtn.type = 'button';
                    removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center;';
                    removeBtn.onclick = () => removePreviewImage(index);

                    imgWrapper.appendChild(img);
                    imgWrapper.appendChild(removeBtn);
                    imagesRow.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        }

        window.previewProductImages = function(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;

            for (const file of files) {
                if (addProductSelectedImages.length >= 5) {
                    showAlert('Maximum 5 images allowed.', 'error');
                    break;
                }

                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    continue;
                }

                const exists = addProductSelectedImages.some(existing =>
                    existing.name === file.name &&
                    existing.size === file.size &&
                    existing.lastModified === file.lastModified
                );
                if (!exists) {
                    addProductSelectedImages.push(file);
                }
            }

            event.target.value = '';
            renderProductImagesPreview();
        };

        function removePreviewImage(index) {
            addProductSelectedImages.splice(index, 1);
            renderProductImagesPreview();
        }

        window.clearProductImage = function() {
            // Clear multiple images (new system)
            const imagesInput = document.getElementById('product-images');
            if (imagesInput) {
                imagesInput.value = '';
                const previewContainer = document.getElementById('images-preview');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                }
            }
            addProductSelectedImages = [];
            
            // Also clear old single image elements if they exist (for backward compatibility)
            const oldImageInput = document.getElementById('product-image');
            if (oldImageInput) {
                oldImageInput.value = '';
            }
            const oldImagePreview = document.getElementById('image-preview');
            if (oldImagePreview) {
                oldImagePreview.style.display = 'none';
            }
        };

        window.handleAddProduct = async function(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('product-name').value;
                const price = document.getElementById('product-price').value;
                const discount_price = document.getElementById('product-discount-price').value || null;
                const stock = document.getElementById('product-stock').value;
                const category_id = document.getElementById('product-category').value;
                let homepage_section_id = document.getElementById('product-homepage-section').value || null;
                if (!homepage_section_id) {
                    const fallbackSectionId = await getDefaultHomepageSectionId();
                    homepage_section_id = fallbackSectionId || null;
                }
                const description = document.getElementById('product-description').value;
                const wholesale_price = document.getElementById('product-wholesale-price').value || null;
                const min_wholesale_qty = document.getElementById('product-min-wholesale').value || 10;
                const imageFiles = addProductSelectedImages;

                // Validate required fields
                if (!name || !price || !stock) {
                    showAlert('Please fill in all required fields', 'error');
                    return;
                }

                if (!category_id) {
                    showAlert('Please select a category', 'error');
                    return;
                }

                if (discount_price && parseFloat(discount_price) >= parseFloat(price)) {
                    showAlert('Discount price should be less than the main price.', 'error');
                    return;
                }

                let image_url = '/images/placeholder.jpg';
                let images = [];

                // Upload images if provided
                if (imageFiles && imageFiles.length > 0) {
                    showAlert(`Uploading ${imageFiles.length} image(s)...`, 'info');
                    
                    for (let i = 0; i < imageFiles.length; i++) {
                        const validation = validateImageFile(imageFiles[i]);
                        if (!validation.valid) {
                            showAlert(`Image ${i + 1}: ${validation.error}`, 'error');
                            return;
                        }

                        try {
                            const uploadedImageUrl = await uploadProductImage(imageFiles[i]);
                            if (uploadedImageUrl) {
                                images.push(uploadedImageUrl);
                                if (i === 0) {
                                    image_url = uploadedImageUrl;
                                }
                            }
                        } catch (error) {
                            console.error(`Error uploading image ${i + 1}:`, error);
                        }
                    }
                }

                // Create product
                showAlert('Creating product...', 'info');
                const response = await api.post('/admin/products', {
                    name,
                    description,
                    category_id: parseInt(category_id),
                    homepage_section_id: homepage_section_id ? parseInt(homepage_section_id) : null,
                    price: parseFloat(price),
                    wholesale_price: wholesale_price ? parseFloat(wholesale_price) : null,
                    discount_price: discount_price ? parseFloat(discount_price) : null,
                    stock_quantity: parseInt(stock),
                    min_wholesale_qty: parseInt(min_wholesale_qty),
                    image_url,
                    images
                });

                if (response && (response.success || response.product || response.message)) {
                    showAlert('Product added successfully!', 'success');
                    closeAddProductModal();
                    // Refresh the products list
                    if (window._currentSection === 'manage-products') {
                        loadProducts();
                    }
                } else {
                    showAlert(response.error || 'Failed to add product', 'error');
                }
            } catch (error) {
                console.error('Error adding product:', error);
                showAlert(error.message || 'Failed to add product', 'error');
            }
        };

        window.handleAddWholesaleProduct = async function(event) {
            event.preventDefault();

            try {
                const name = document.getElementById('wholesale-product-name').value;
                const wholesale_price = document.getElementById('wholesale-product-price').value;
                const displayPrice = document.getElementById('wholesale-product-display-price').value;
                const stock = document.getElementById('wholesale-product-stock').value;
                const category_id = document.getElementById('wholesale-product-category').value;
                let homepage_section_id = document.getElementById('wholesale-product-homepage-section').value || null;
                if (!homepage_section_id) {
                    const fallbackSectionId = await getDefaultHomepageSectionId();
                    homepage_section_id = fallbackSectionId || null;
                }
                const description = document.getElementById('wholesale-product-description').value;
                const min_wholesale_qty = document.getElementById('wholesale-product-min-qty').value || 10;
                const imageFiles = wholesaleProductSelectedImages;

                if (!name || !wholesale_price || !stock || !category_id) {
                    showAlert('Please fill in all required wholesale fields', 'error');
                    return;
                }

                let image_url = '/images/placeholder.jpg';
                let images = [];

                if (imageFiles && imageFiles.length > 0) {
                    showAlert(`Uploading ${imageFiles.length} wholesale image(s)...`, 'info');

                    for (let i = 0; i < imageFiles.length; i++) {
                        const validation = validateImageFile(imageFiles[i]);
                        if (!validation.valid) {
                            showAlert(`Image ${i + 1}: ${validation.error}`, 'error');
                            return;
                        }

                        try {
                            const uploadedImageUrl = await uploadProductImage(imageFiles[i]);
                            if (uploadedImageUrl) {
                                images.push(uploadedImageUrl);
                                if (i === 0) {
                                    image_url = uploadedImageUrl;
                                }
                            }
                        } catch (error) {
                            console.error(`Error uploading wholesale image ${i + 1}:`, error);
                        }
                    }
                }

                showAlert('Creating wholesale product...', 'info');
                const basePrice = displayPrice ? parseFloat(displayPrice) : parseFloat(wholesale_price);
                const response = await api.post('/admin/products', {
                    name,
                    description,
                    category_id: parseInt(category_id),
                    homepage_section_id: homepage_section_id ? parseInt(homepage_section_id) : null,
                    price: basePrice,
                    wholesale_price: parseFloat(wholesale_price),
                    discount_price: null,
                    stock_quantity: parseInt(stock),
                    min_wholesale_qty: parseInt(min_wholesale_qty),
                    image_url,
                    images
                });

                if (response && (response.success || response.product || response.message)) {
                    showAlert('Wholesale product added successfully!', 'success');
                    closeAddWholesaleProductModal();
                    clearWholesaleSectionImages();
                    if (window._currentSection === 'manage-products') {
                        loadProducts();
                    }
                } else {
                    showAlert(response.error || 'Failed to add wholesale product', 'error');
                }
            } catch (error) {
                console.error('Error adding wholesale product:', error);
                showAlert(error.message || 'Failed to add wholesale product', 'error');
            }
        };
        window.showAddCategoryModal = function() { 
            const modal = document.getElementById('add-category-modal');
            if (modal) {
                modal.classList.add('show');
                document.getElementById('add-category-form').reset();
                clearCategoryImage();
            }
        };

        window.closeAddCategoryModal = function() {
            const modal = document.getElementById('add-category-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('add-category-form').reset();
                clearCategoryImage();
            }
        };

        window.previewCategoryImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('category-image-preview');
                document.getElementById('category-preview-img').src = e.target.result;
                preview.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearCategoryImage = function() {
            document.getElementById('category-image').value = '';
            document.getElementById('category-image-preview').style.display = 'none';
        };

        window.handleAddCategory = async function(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('category-name').value;
                const description = document.getElementById('category-description').value;
                const imageFile = document.getElementById('category-image').files[0];

                // Validate required fields
                if (!name) {
                    showAlert('Please enter category name', 'error');
                    return;
                }

                let image_url = '/images/placeholder.jpg';

                // Upload image if provided
                if (imageFile) {
                    const validation = validateImageFile(imageFile);
                    if (!validation.valid) {
                        showAlert(validation.error, 'error');
                        return;
                    }

                    showAlert('Uploading image...', 'info');
                    image_url = await uploadProductImage(document.getElementById('category-image')) || image_url;
                }

                // Create category
                showAlert('Creating category...', 'info');
                const response = await api.post('/admin/categories', {
                    name,
                    description,
                    image_url
                });

                if (response && (response.success || response.category || response.message)) {
                    showAlert('Category added successfully!', 'success');
                    closeAddCategoryModal();
                    // Refresh the categories list
                    if (window._currentSection === 'categories') {
                        loadCategories();
                    }
                    // Also refresh the cache for products form
                    loadCategoriesForUpload();
                } else {
                    showAlert(response.error || 'Failed to add category', 'error');
                }
            } catch (error) {
                console.error('Error adding category:', error);
                showAlert(error.message || 'Failed to add category', 'error');
            }
        };
        
        window.editProduct = async function(id) {
            const cachedProduct = (window._productsCache || []).find(p => p.id == id);
            if (!cachedProduct) {
                showAlert('Product not found', 'error');
                return;
            }

            let product = cachedProduct;
            try {
                const freshResponse = await api.get(`/products/${id}`);
                if (freshResponse && freshResponse.product) {
                    product = { ...cachedProduct, ...freshResponse.product };
                    const cacheList = window._productsCache || [];
                    const cacheIndex = cacheList.findIndex(p => p.id == id);
                    if (cacheIndex >= 0) {
                        cacheList[cacheIndex] = product;
                    }
                }
            } catch (refreshError) {
                console.warn('Unable to fetch latest product before edit:', refreshError);
            }
            
            // Show modal
            const modal = document.getElementById('edit-product-modal');
            if (!modal) {
                showAlert('Edit modal not found', 'error');
                return;
            }
            
            // Load categories into dropdown
            await loadCategoriesForEdit();
            await loadHomepageSectionsForForms();
            
            // Populate form with product data
            document.getElementById('edit-product-id').value = product.id;
            document.getElementById('edit-product-name').value = product.name || '';
            document.getElementById('edit-product-price').value = product.price || '';
            document.getElementById('edit-product-discount-price').value = product.discount_price || '';
            document.getElementById('edit-product-wholesale-price').value = product.wholesale_price || '';
            document.getElementById('edit-product-discount-price').value = product.discount_price || '';
            document.getElementById('edit-product-stock').value = product.stock_quantity || 0;
            document.getElementById('edit-product-category').value = product.category_id || '';
            const sectionSelect = document.getElementById('edit-product-homepage-section');
            let selectedSectionId = (product.homepage_section_id !== null && product.homepage_section_id !== undefined)
                ? String(product.homepage_section_id)
                : '';

            if (!selectedSectionId) {
                try {
                    const settingsResponse = await api.get('/admin/settings');
                    const settings = settingsResponse?.settings || {};
                    const heroSectionId = String(settings.homepage_hero_section_id || '').trim();
                    if (heroSectionId) {
                        selectedSectionId = heroSectionId;
                    }
                } catch (_) {}
            }

            if (sectionSelect) {
                sectionSelect.value = selectedSectionId;
            }
            document.getElementById('edit-product-min-wholesale').value = product.min_wholesale_qty || 10;
            document.getElementById('edit-product-description').value = product.description || '';
            
            // Show current product images
            const currentImagesContainer = document.getElementById('edit-current-images');
            currentImagesContainer.innerHTML = '';
            
            if (product.images && product.images.length > 0) {
                product.images.forEach((img, index) => {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = 'position: relative; display: inline-block;';
                    
                    const imgElem = document.createElement('img');
                    imgElem.src = img;
                    imgElem.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border);';
                    imgElem.onerror = () => imgElem.style.display = 'none';
                    
                    if (index === 0) {
                        const badge = document.createElement('span');
                        badge.textContent = 'Main';
                        badge.style.cssText = 'position: absolute; top: 4px; left: 4px; background: var(--primary); color: white; padding: 2px 4px; border-radius: 4px; font-size: 9px; font-weight: bold;';
                        imgWrapper.appendChild(badge);
                    }
                    
                    imgWrapper.appendChild(imgElem);
                    currentImagesContainer.appendChild(imgWrapper);
                });
            } else if (product.image_url) {
                // Fallback to old single image
                const imgWrapper = document.createElement('div');
                imgWrapper.style.cssText = 'position: relative; display: inline-block;';
                
                const imgElem = document.createElement('img');
                imgElem.src = product.image_url;
                imgElem.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border);';
                
                imgWrapper.appendChild(imgElem);
                currentImagesContainer.appendChild(imgWrapper);
            }
            
            // Clear file input and preview
            const editImagesInput = document.getElementById('edit-product-images');
            if (editImagesInput) {
                editImagesInput.value = '';
                document.getElementById('edit-images-preview').innerHTML = '';
            }
            editProductSelectedImages = [];
            
            modal.classList.add('show');
        };
        
        window.closeEditProductModal = function() {
            const modal = document.getElementById('edit-product-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('edit-product-form').reset();
                // Clear images
                const editImagesInput = document.getElementById('edit-product-images');
                if (editImagesInput) {
                    editImagesInput.value = '';
                    document.getElementById('edit-images-preview').innerHTML = '';
                    document.getElementById('edit-current-images').innerHTML = '';
                }
                editProductSelectedImages = [];
            }
        };

        window.previewEditProductImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validate file type
            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                const preview = document.getElementById('edit-preview-img');
                preview.src = e.target.result;
                preview.style.display = 'block';
                document.getElementById('edit-clear-image-btn').style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        // Edit-product image queue (supports repeated picks up to 5 images)
        let editProductSelectedImages = [];

        window.previewEditProductImages = function(event) {
            const files = Array.from(event.target.files || []);
            if (!files.length) return;

            for (const file of files) {
                if (editProductSelectedImages.length >= 5) {
                    showAlert('Maximum 5 images allowed.', 'error');
                    break;
                }

                const validation = validateImageFile(file);
                if (!validation.valid) {
                    showAlert(validation.error, 'error');
                    continue;
                }

                const exists = editProductSelectedImages.some(existing =>
                    existing.name === file.name &&
                    existing.size === file.size &&
                    existing.lastModified === file.lastModified
                );
                if (!exists) {
                    editProductSelectedImages.push(file);
                }
            }

            event.target.value = '';

            const filesToRender = editProductSelectedImages;

            const previewContainer = document.getElementById('edit-images-preview');
            previewContainer.innerHTML = '';
            if (!filesToRender.length) return;
            
            // Add count indicator
            const countDiv = document.createElement('div');
            countDiv.style.cssText = 'width: 100%; margin-bottom: 0.5rem; font-size: 0.9rem; color: var(--text-secondary); font-weight: 500;';
            countDiv.textContent = `${filesToRender.length} new image${filesToRender.length > 1 ? 's' : ''} selected (max 5) - will replace all existing images`;
            previewContainer.appendChild(countDiv);
            
            const imagesRow = document.createElement('div');
            imagesRow.style.cssText = 'display: flex; gap: 0.5rem; flex-wrap: wrap;';
            previewContainer.appendChild(imagesRow);

            filesToRender.forEach((file, index) => {
                // Create preview
                const reader = new FileReader();
                reader.onload = function(e) {
                    const imgWrapper = document.createElement('div');
                    imgWrapper.style.cssText = 'position: relative; display: inline-block;';
                    
                    const img = document.createElement('img');
                    img.src = e.target.result;
                    img.style.cssText = 'width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border);';
                    
                    const badge = document.createElement('span');
                    if (index === 0) {
                        badge.textContent = 'Main';
                        badge.style.cssText = 'position: absolute; top: 4px; left: 4px; background: var(--primary); color: white; padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: bold;';
                    }
                    
                    const removeBtn = document.createElement('button');
                    removeBtn.innerHTML = '√ó';
                    removeBtn.type = 'button';
                    removeBtn.style.cssText = 'position: absolute; top: 4px; right: 4px; background: rgba(239, 68, 68, 0.9); color: white; border: none; border-radius: 50%; width: 24px; height: 24px; cursor: pointer; font-size: 18px; line-height: 1; display: flex; align-items: center; justify-content: center;';
                    removeBtn.onclick = () => removeEditPreviewImage(index);
                    
                    imgWrapper.appendChild(img);
                    if (badge.textContent) imgWrapper.appendChild(badge);
                    imgWrapper.appendChild(removeBtn);
                    imagesRow.appendChild(imgWrapper);
                };
                reader.readAsDataURL(file);
            });
        };

        function removeEditPreviewImage(index) {
            editProductSelectedImages.splice(index, 1);

            const previewContainer = document.getElementById('edit-images-preview');
            if (!previewContainer) return;

            if (editProductSelectedImages.length === 0) {
                previewContainer.innerHTML = '';
                return;
            }

            previewEditProductImages({ target: { files: [] } });
        }

        window.clearEditProductImage = function() {
            // Clear multiple images (new system)
            const editImagesInput = document.getElementById('edit-product-images');
            if (editImagesInput) {
                editImagesInput.value = '';
                const previewContainer = document.getElementById('edit-images-preview');
                if (previewContainer) {
                    previewContainer.innerHTML = '';
                }
            }
            editProductSelectedImages = [];
            
            // Also clear old single image elements if they exist (for backward compatibility)
            const oldImageInput = document.getElementById('edit-product-image');
            if (oldImageInput) {
                oldImageInput.value = '';
            }
            const clearBtn = document.getElementById('edit-clear-image-btn');
            if (clearBtn) {
                clearBtn.style.display = 'none';
            }
            
            // Restore original images
            const productId = document.getElementById('edit-product-id').value;
            const product = (window._productsCache || []).find(p => p.id == productId);
            if (product) {
                const currentImagesContainer = document.getElementById('edit-current-images');
                if (currentImagesContainer) {
                    currentImagesContainer.innerHTML = '';
                    
                    if (product.images && product.images.length > 0) {
                        product.images.forEach((img, index) => {
                            const imgWrapper = document.createElement('div');
                            imgWrapper.style.cssText = 'position: relative; display: inline-block;';
                            
                            const imgElem = document.createElement('img');
                            imgElem.src = img;
                            imgElem.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border);';
                            
                            if (index === 0) {
                                const badge = document.createElement('span');
                                badge.textContent = 'Main';
                                badge.style.cssText = 'position: absolute; top: 4px; left: 4px; background: var(--primary); color: white; padding: 2px 4px; border-radius: 4px; font-size: 9px; font-weight: bold;';
                                imgWrapper.appendChild(badge);
                            }
                            
                            imgWrapper.appendChild(imgElem);
                            currentImagesContainer.appendChild(imgWrapper);
                        });
                    } else if (product.image_url) {
                        const imgWrapper = document.createElement('div');
                        imgWrapper.style.cssText = 'position: relative; display: inline-block;';
                        
                        const imgElem = document.createElement('img');
                        imgElem.src = product.image_url;
                        imgElem.style.cssText = 'width: 80px; height: 80px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border);';
                        
                        imgWrapper.appendChild(imgElem);
                        currentImagesContainer.appendChild(imgWrapper);
                    }
                }
            }
        };

        async function loadCategoriesForEdit() {
            try {
                if (!window._categoriesCache || window._categoriesCache.length === 0) {
                    const response = await api.get('/admin/categories');
                    window._categoriesCache = response.categories || [];
                }
                
                const select = document.getElementById('edit-product-category');
                if (select) {
                    select.innerHTML = '<option value="">Select Category</option>' + 
                        window._categoriesCache.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            } catch (error) {
                console.error('Error loading categories:', error);
            }
        }

        window.handleEditProduct = async function(event) {
            event.preventDefault();
            
            try {
                const productId = document.getElementById('edit-product-id').value;
                const name = document.getElementById('edit-product-name').value;
                const price = document.getElementById('edit-product-price').value;
                const stock = document.getElementById('edit-product-stock').value;
                const category_id = document.getElementById('edit-product-category').value;
                let homepage_section_id = document.getElementById('edit-product-homepage-section').value || null;
                if (!homepage_section_id) {
                    const fallbackSectionId = await getDefaultHomepageSectionId();
                    homepage_section_id = fallbackSectionId || null;
                }
                const description = document.getElementById('edit-product-description').value;
                const wholesale_price = document.getElementById('edit-product-wholesale-price').value || null;
                const discount_price = document.getElementById('edit-product-discount-price').value || null;
                const min_wholesale_qty = document.getElementById('edit-product-min-wholesale').value || 10;
                const imageFiles = editProductSelectedImages;

                // Validate required fields
                if (!name || !price || stock === '') {
                    showAlert('Please fill in all required fields', 'error');
                    return;
                }

                if (!category_id) {
                    showAlert('Please select a category', 'error');
                    return;
                }

                if (discount_price && parseFloat(discount_price) >= parseFloat(price)) {
                    showAlert('Discount price should be less than the main price.', 'error');
                    return;
                }

                let updateData = {
                    name,
                    description,
                    category_id: parseInt(category_id),
                    homepage_section_id: homepage_section_id ? parseInt(homepage_section_id) : null,
                    price: parseFloat(price),
                    wholesale_price: wholesale_price ? parseFloat(wholesale_price) : null,
                    discount_price: discount_price ? parseFloat(discount_price) : null,
                    stock_quantity: parseInt(stock),
                    min_wholesale_qty: parseInt(min_wholesale_qty)
                };

                // Upload new images if provided
                if (imageFiles && imageFiles.length > 0) {
                    showAlert(`Uploading ${imageFiles.length} image(s)...`, 'info');
                    
                    let images = [];
                    for (let i = 0; i < imageFiles.length; i++) {
                        const validation = validateImageFile(imageFiles[i]);
                        if (!validation.valid) {
                            showAlert(`Image ${i + 1}: ${validation.error}`, 'error');
                            return;
                        }

                        try {
                            const uploadedImageUrl = await uploadProductImage(imageFiles[i]);
                            if (uploadedImageUrl) {
                                images.push(uploadedImageUrl);
                                if (i === 0) {
                                    updateData.image_url = uploadedImageUrl;
                                }
                            }
                        } catch (error) {
                            console.error(`Error uploading image ${i + 1}:`, error);
                        }
                    }
                    
                    if (images.length > 0) {
                        updateData.images = images;
                    }
                }

                showAlert('Updating product...', 'info');
                const response = await api.put(`/admin/products/${productId}`, updateData);

                if (response && (response.success || response.product || response.message)) {
                    if (response.product && Array.isArray(window._productsCache)) {
                        const cacheIndex = window._productsCache.findIndex(p => p.id == productId);
                        if (cacheIndex >= 0) {
                            window._productsCache[cacheIndex] = {
                                ...window._productsCache[cacheIndex],
                                ...response.product
                            };
                        }
                    }
                    showAlert('Product updated successfully!', 'success');
                    closeEditProductModal();
                    // Refresh the products list
                    if (window._currentSection === 'manage-products') {
                        loadProducts();
                    }
                } else {
                    showAlert(response.error || 'Failed to update product', 'error');
                }
            } catch (error) {
                console.error('Error updating product:', error);
                showAlert(error.message || 'Failed to update product', 'error');
            }
        };
        
        window.deleteProduct = async function(id) {
            if (!(await showConfirmDialog('Are you sure you want to delete this product?', {
                title: 'Delete Product',
                confirmText: 'Delete Product',
                danger: true
            }))) return;
            try {
                await api.delete(`/admin/products/${id}`);
                showAlert('Product deleted successfully', 'success');
                loadProducts();
            } catch (error) {
                showAlert('Failed to delete product', 'error');
            }
        };
        
        window.editCategory = async function(id) {
            const category = (window._categoriesCache || []).find(c => c.id == id);
            if (!category) {
                showAlert('Category not found', 'error');
                return;
            }

            const modal = document.getElementById('edit-category-modal');
            if (!modal) {
                showAlert('Edit category modal not found', 'error');
                return;
            }

            document.getElementById('edit-category-id').value = category.id;
            document.getElementById('edit-category-name').value = category.name || '';
            document.getElementById('edit-category-description').value = category.description || '';

            const previewWrapper = document.getElementById('edit-category-image-preview');
            const previewImg = document.getElementById('edit-category-preview-img');
            if (category.image_url) {
                previewImg.src = category.image_url;
                previewWrapper.style.display = 'block';
            } else {
                previewImg.src = '';
                previewWrapper.style.display = 'none';
            }

            document.getElementById('edit-category-image').value = '';

            modal.classList.add('show');
        };

        window.closeEditCategoryModal = function() {
            const modal = document.getElementById('edit-category-modal');
            if (modal) {
                modal.classList.remove('show');
                const form = document.getElementById('edit-category-form');
                if (form) form.reset();
                const previewWrapper = document.getElementById('edit-category-image-preview');
                if (previewWrapper) previewWrapper.style.display = 'none';
            }
        };

        window.previewEditCategoryImage = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                const previewWrapper = document.getElementById('edit-category-image-preview');
                const previewImg = document.getElementById('edit-category-preview-img');
                previewImg.src = e.target.result;
                previewWrapper.style.display = 'block';
            };
            reader.readAsDataURL(file);
        };

        window.clearEditCategoryImage = function() {
            const input = document.getElementById('edit-category-image');
            if (input) input.value = '';
            const previewWrapper = document.getElementById('edit-category-image-preview');
            if (previewWrapper) previewWrapper.style.display = 'none';
        };

        window.handleEditCategory = async function(event) {
            event.preventDefault();

            try {
                const id = document.getElementById('edit-category-id').value;
                const name = document.getElementById('edit-category-name').value;
                const description = document.getElementById('edit-category-description').value;
                const imageFile = document.getElementById('edit-category-image').files[0];

                if (!name) {
                    showAlert('Please enter category name', 'error');
                    return;
                }

                let updateData = {
                    name,
                    description
                };

                if (imageFile) {
                    const validation = validateImageFile(imageFile);
                    if (!validation.valid) {
                        showAlert(validation.error, 'error');
                        return;
                    }

                    showAlert('Uploading category image...', 'info');
                    const image_url = await uploadProductImage(document.getElementById('edit-category-image'));
                    if (image_url) {
                        updateData.image_url = image_url;
                    }
                }

                showAlert('Updating category...', 'info');
                const response = await api.put(`/admin/categories/${id}`, updateData);

                if (response && (response.success || response.category || response.message)) {
                    showAlert('Category updated successfully!', 'success');
                    closeEditCategoryModal();
                    if (window._currentSection === 'categories') {
                        await loadCategories();
                    } else {
                        // Still refresh cache for forms
                        await loadCategories();
                    }
                    loadCategoriesForUpload();
                } else {
                    showAlert(response.error || 'Failed to update category', 'error');
                }
            } catch (error) {
                console.error('Error updating category:', error);
                showAlert(error.message || 'Failed to update category', 'error');
            }
        };
        
        window.deleteCategory = async function(id) {
            if (!(await showConfirmDialog('Are you sure you want to delete this category?', {
                title: 'Delete Category',
                confirmText: 'Delete Category',
                danger: true
            }))) return;
            try {
                await api.delete(`/admin/categories/${id}`);
                showAlert('Category deleted successfully', 'success');
                loadCategories();
            } catch (error) {
                showAlert('Failed to delete category', 'error');
            }
        };

        // Homepage Sections Management
        window.showAddSectionModal = function() {
            const modal = document.getElementById('add-section-modal');
            if (modal) {
                modal.classList.add('show');
                document.getElementById('add-section-form').reset();
                window._addSectionHeadingCroppedFile = null;
                window._addSectionHeadingSourceFile = null;

                const preview = document.getElementById('homepage-hero-image-preview');
                const placeholder = document.getElementById('homepage-hero-image-placeholder');
                const current = document.getElementById('homepage-hero-image-current');
                const input = document.getElementById('homepage-hero-image-upload');
                if (current) current.value = '';
                if (input) input.value = '';
                if (preview && placeholder) {
                    preview.src = '';
                    preview.style.display = 'none';
                    placeholder.style.display = 'block';
                }
            }
        };

        window.closeAddSectionModal = function() {
            const modal = document.getElementById('add-section-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('add-section-form').reset();
                window._addSectionHeadingCroppedFile = null;
                window._addSectionHeadingSourceFile = null;

                const preview = document.getElementById('homepage-hero-image-preview');
                const placeholder = document.getElementById('homepage-hero-image-placeholder');
                const current = document.getElementById('homepage-hero-image-current');
                const input = document.getElementById('homepage-hero-image-upload');
                if (current) current.value = '';
                if (input) input.value = '';
                if (preview && placeholder) {
                    preview.src = '';
                    preview.style.display = 'none';
                    placeholder.style.display = 'block';
                }
            }
        };

        window.handleAddSection = async function(event) {
            event.preventDefault();
            
            try {
                const name = document.getElementById('section-name').value;
                const description = document.getElementById('section-description').value;
                const sort_order = document.getElementById('section-sort-order').value;
                const heroImageInput = document.getElementById('homepage-hero-image-upload');

                if (!name) {
                    showAlert('Please enter section name', 'error');
                    return;
                }

                showAlert('Creating section...', 'info');
                const response = await api.post('/admin/homepage-sections', {
                    name,
                    description,
                    sort_order: parseInt(sort_order) || 0
                });

                if (response && (response.success || response.section || response.message)) {
                    let addSectionImageFile = window._addSectionHeadingCroppedFile || null;
                    if (!addSectionImageFile && window._addSectionHeadingSourceFile) {
                        addSectionImageFile = await buildAndPreviewAddSectionCrop();
                    }
                    if (!addSectionImageFile && heroImageInput && heroImageInput.files && heroImageInput.files[0]) {
                        window._addSectionHeadingSourceFile = heroImageInput.files[0];
                        addSectionImageFile = await buildAndPreviewAddSectionCrop();
                    }
                    if (addSectionImageFile) {
                        showAlert('Uploading heading image...', 'info');
                        const uploadedImageUrl = await uploadProductImage(addSectionImageFile);
                        if (!uploadedImageUrl) {
                            throw new Error('Section added, but heading image upload failed');
                        }

                        const createdSectionId = response?.section?.id;
                        if (!createdSectionId) {
                            throw new Error('Section added, but failed to identify section for heading image');
                        }

                        showAlert('Saving heading image...', 'info');
                        await api.put(`/admin/homepage-sections/${createdSectionId}`, {
                            heading_image_url: uploadedImageUrl
                        });
                    }

                    showAlert('Homepage section added successfully!', 'success');
                    closeAddSectionModal();
                    if (window._currentSection === 'homepage-sections') {
                        loadHomepageSections();
                    }
                    // Refresh cache for product forms
                    loadHomepageSectionsForForms();
                } else {
                    showAlert(response.error || 'Failed to add section', 'error');
                }
            } catch (error) {
                console.error('Error adding section:', error);
                showAlert(error.message || 'Failed to add section', 'error');
            }
        };

        window.editSection = async function(id) {
            const section = (window._homepageSectionsCache || []).find(s => s.id == id);
            if (!section) {
                showAlert('Section not found', 'error');
                return;
            }

            const modal = document.getElementById('edit-section-modal');
            if (!modal) {
                showAlert('Edit modal not found', 'error');
                return;
            }

            document.getElementById('edit-section-id').value = section.id;
            document.getElementById('edit-section-name').value = section.name || '';
            document.getElementById('edit-section-description').value = section.description || '';
            document.getElementById('edit-section-sort-order').value = section.sort_order || 0;
            document.getElementById('edit-section-active').value = section.is_active ? 'true' : 'false';

            const editImageInput = document.getElementById('edit-homepage-hero-image-upload');
            const editImageCurrent = document.getElementById('edit-homepage-hero-image-current');
            const editImagePreview = document.getElementById('edit-homepage-hero-image-preview');
            const editImagePlaceholder = document.getElementById('edit-homepage-hero-image-placeholder');

            if (editImageInput) {
                editImageInput.value = '';
            }
            window._editSectionHeadingCroppedFile = null;
            window._editSectionHeadingSourceFile = null;

            const editCropX = document.getElementById('edit-heading-crop-x');
            const editCropY = document.getElementById('edit-heading-crop-y');
            if (editCropX) editCropX.value = 50;
            if (editCropY) editCropY.value = 50;

            if (editImageCurrent && editImagePreview && editImagePlaceholder) {
                const currentImageUrl = (section.heading_image_url || '').trim();
                if (currentImageUrl) {
                    editImageCurrent.value = currentImageUrl;
                    editImagePreview.src = currentImageUrl;
                    editImagePreview.style.display = 'block';
                    editImagePlaceholder.style.display = 'none';
                } else {
                    editImageCurrent.value = '';
                    editImagePreview.src = '';
                    editImagePreview.style.display = 'none';
                    editImagePlaceholder.style.display = 'block';
                }
            }

            modal.classList.add('show');
        };

        window.closeEditSectionModal = function() {
            const modal = document.getElementById('edit-section-modal');
            if (modal) {
                modal.classList.remove('show');
                document.getElementById('edit-section-form').reset();

                const editImageCurrent = document.getElementById('edit-homepage-hero-image-current');
                const editImagePreview = document.getElementById('edit-homepage-hero-image-preview');
                const editImagePlaceholder = document.getElementById('edit-homepage-hero-image-placeholder');
                if (editImageCurrent) {
                    editImageCurrent.value = '';
                }
                window._editSectionHeadingCroppedFile = null;
                window._editSectionHeadingSourceFile = null;
                if (editImagePreview && editImagePlaceholder) {
                    editImagePreview.src = '';
                    editImagePreview.style.display = 'none';
                    editImagePlaceholder.style.display = 'block';
                }
            }
        };

        window.handleEditSection = async function(event) {
            event.preventDefault();
            
            try {
                const sectionId = document.getElementById('edit-section-id').value;
                const name = document.getElementById('edit-section-name').value;
                const description = document.getElementById('edit-section-description').value;
                const sort_order = document.getElementById('edit-section-sort-order').value;
                const is_active = document.getElementById('edit-section-active').value === 'true';
                const editHeroImageInput = document.getElementById('edit-homepage-hero-image-upload');
                const editImageCurrentEl = document.getElementById('edit-homepage-hero-image-current');
                const existingMappedImageUrl = (editImageCurrentEl?.value || '').trim();

                if (!name) {
                    showAlert('Please enter section name', 'error');
                    return;
                }

                showAlert('Updating section...', 'info');
                const response = await api.put(`/admin/homepage-sections/${sectionId}`, {
                    name,
                    description,
                    sort_order: parseInt(sort_order) || 0,
                    is_active
                });

                if (response && (response.success || response.section || response.message)) {
                    let editSectionImageFile = window._editSectionHeadingCroppedFile || null;
                    if (!editSectionImageFile && window._editSectionHeadingSourceFile) {
                        editSectionImageFile = await buildAndPreviewEditSectionCrop();
                    }
                    if (!editSectionImageFile && editHeroImageInput && editHeroImageInput.files && editHeroImageInput.files[0]) {
                        window._editSectionHeadingSourceFile = editHeroImageInput.files[0];
                        editSectionImageFile = await buildAndPreviewEditSectionCrop();
                    }
                    if (editSectionImageFile) {
                        showAlert('Uploading heading image...', 'info');
                        const uploadedImageUrl = await uploadProductImage(editSectionImageFile);
                        if (!uploadedImageUrl) {
                            throw new Error('Section updated, but heading image upload failed');
                        }

                        showAlert('Saving heading image...', 'info');
                        await api.put(`/admin/homepage-sections/${sectionId}`, {
                            heading_image_url: uploadedImageUrl
                        });
                    }

                    showAlert('Homepage section updated successfully!', 'success');
                    closeEditSectionModal();
                    if (window._currentSection === 'homepage-sections') {
                        loadHomepageSections();
                    }
                    loadHomepageSectionsForForms();
                } else {
                    showAlert(response.error || 'Failed to update section', 'error');
                }
            } catch (error) {
                console.error('Error updating section:', error);
                showAlert(error.message || 'Failed to update section', 'error');
            }
        };

        window.deleteSection = async function(id) {
            if (!(await showConfirmDialog('Are you sure you want to delete this section? Products assigned to it will be unassigned.', {
                title: 'Delete Homepage Section',
                confirmText: 'Delete Section',
                danger: true
            }))) return;
            try {
                await api.delete(`/admin/homepage-sections/${id}`);
                showAlert('Homepage section deleted successfully', 'success');
                loadHomepageSections();
                loadHomepageSectionsForForms();
            } catch (error) {
                showAlert('Failed to delete section', 'error');
            }
        };

        window.previewEditHomepageHeroImage = function(event) {
            const file = event?.target?.files?.[0];
            if (!file) return;

            const validation = validateImageFile(file);
            if (!validation.valid) {
                showAlert(validation.error, 'error');
                event.target.value = '';
                return;
            }

            (async () => {
                try {
                    window._editSectionHeadingSourceFile = file;
                    await buildAndPreviewEditSectionCrop();
                    showAlert('Image cropped. Adjust sliders for manual crop.', 'success');
                } catch (error) {
                    console.error('Edit heading image crop error:', error);
                    window._editSectionHeadingSourceFile = null;
                    window._editSectionHeadingCroppedFile = null;
                    showAlert(error.message || 'Failed to crop image', 'error');
                    event.target.value = '';
                }
            })();
        };

        async function loadHomepageSectionsForForms() {
            try {
                const response = await api.get('/admin/homepage-sections');
                window._homepageSectionsCache = response.sections || [];
                
                // Update both add and edit product form dropdowns
                const addSelect = document.getElementById('product-homepage-section');
                const wholesaleAddSelect = document.getElementById('wholesale-product-homepage-section');
                const editSelect = document.getElementById('edit-product-homepage-section');
                
                const optionsHtml = '<option value="">None - Show only in Products page</option>' + 
                    window._homepageSectionsCache
                        .filter(s => s.is_active)
                        .map(s => `<option value="${s.id}">${s.name}</option>`)
                        .join('');
                
                if (addSelect) addSelect.innerHTML = optionsHtml;
                if (wholesaleAddSelect) wholesaleAddSelect.innerHTML = optionsHtml;
                if (editSelect) editSelect.innerHTML = optionsHtml;
            } catch (error) {
                console.error('Error loading homepage sections for forms:', error);
            }
        }

        async function getDefaultHomepageSectionId() {
            try {
                const settingsResponse = await api.get('/admin/settings');
                const settings = settingsResponse?.settings || {};
                const heroSectionId = String(settings.homepage_hero_section_id || '').trim();
                return heroSectionId || '';
            } catch (_) {
                return '';
            }
        }

        // Deprecated CSV handlers kept as no-ops for compatibility with old cached pages.
        window.handleFileUpload = function() {
            showAlert('CSV bulk upload has been removed. Use Single Product or Wholesale Product upload.', 'info');
        };

        window.handleImageUpload = function(event) {
            handleWholesaleImageUpload(event);
        };

        window.confirmBulkUpload = function() {
            showAlert('Bulk CSV upload has been removed.', 'info');
        };
        window.logout = async function(event) { 
            if (event?.preventDefault) event.preventDefault();
            if (event?.stopPropagation) event.stopPropagation();
            if (event?.stopImmediatePropagation) event.stopImmediatePropagation();

            if (window.__adminLogoutInProgress) {
                return false;
            }

            const shouldLogout = await showConfirmDialog('Are you sure you want to logout from admin?', {
                title: 'Logout',
                confirmText: 'Logout',
                cancelText: 'Cancel'
            });

            if (!shouldLogout) {
                return false;
            }

            window.__adminLogoutInProgress = true;

            try {
                await api.post('/auth/logout');
                localStorage.removeItem('token');
                if (window.auth) {
                    auth.currentUser = null;
                    auth.updateUI?.();
                }
                window.location.replace('/login?admin=true');
                return true;
            } catch (err) {
                console.warn('Logout error:', err);
                showAlert('Logout failed. Please try again.', 'error');
                return false;
            } finally {
                window.__adminLogoutInProgress = false;
            }
        };

        async function initializeAdmin() {
            try {
                const dateEl = document.getElementById('current-date');
                if (dateEl) {
                    dateEl.textContent = new Date().toLocaleDateString('en-US', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric'
                    });
                }

                if (!window.auth || typeof auth.checkAuth !== 'function') {
                    showAlert('Authentication is not available. Please reload.', 'error');
                    return;
                }

                // Primary auth check (uses cookie + bearer via api helper).
                await auth.checkAuth();

                // Hosted/network hardening: do one explicit no-cache check to avoid stale/proxy issues.
                try {
                    const token = localStorage.getItem('token');
                    const headers = token ? { Authorization: `Bearer ${token}` } : {};

                    const resp = await fetch('/api/auth/check', {
                        method: 'GET',
                        headers,
                        credentials: 'include',
                        cache: 'no-store'
                    });

                    const contentType = resp.headers.get('content-type') || '';
                    const data = contentType.includes('application/json') ? await resp.json() : null;
                    if (data?.authenticated && data?.user) {
                        auth.currentUser = data.user;
                        if (typeof auth.updateUI === 'function') {
                            auth.updateUI();
                        }
                    }
                } catch (fallbackAuthErr) {
                    console.warn('Admin auth re-check failed:', fallbackAuthErr);
                }

                const role = auth.currentUser?.role;
                const isAdminLike = role === 'admin' || role === 'super_admin';
                const isSuperAdmin = role === 'super_admin';

                if (!auth.isAuthenticated() || !isAdminLike) {
                    showAlert('Please login with an admin account to continue.', 'error');
                    setTimeout(() => window.location.href = '/login?admin=true', 1500);
                    return;
                }

                const superAdminTools = document.getElementById('super-admin-tools');
                if (superAdminTools) {
                    superAdminTools.classList.toggle('hidden', !isSuperAdmin);
                }

                const userMenu = document.getElementById('user-menu');
                const authButtons = document.getElementById('auth-buttons');
                if (authButtons) authButtons.classList.add('hidden');
                if (userMenu) userMenu.classList.remove('hidden');

                const userName = document.getElementById('user-name');
                if (userName) {
                    userName.textContent = auth.currentUser.full_name || (isSuperAdmin ? 'Super Admin' : 'Admin');
                }

                await loadAdminLicenseStatus({ silent: true });

                if (!isSuperAdmin && window._adminLicenseBlocked) {
                    applyAdminLicenseUiRestrictions();
                    showAlert('Your License is expired Please Contact ur developer.', 'error');
                    showSection('admin-license');
                    return;
                }

                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn && !logoutBtn.dataset.boundLogout) {
                    logoutBtn.dataset.boundLogout = 'true';
                    logoutBtn.removeAttribute('onclick');
                    logoutBtn.addEventListener('click', async (event) => {
                        event.preventDefault();
                        event.stopPropagation();
                        if (event.stopImmediatePropagation) event.stopImmediatePropagation();
                        await window.logout(event);
                    }, true);
                }

                // Watch for new pending customer orders (badge + sound + AI voice)
                startPendingOrdersWatcher();

                // Watch unread support inbox badges
                startContactUnreadBadgesWatcher();

                // Preload support inbox tables so sections are never blank on first open
                try {
                    await Promise.all([
                        loadContactInbox('message', { force: true, noAutoRefresh: true })
                    ]);
                } catch (preloadErr) {
                    console.warn('Preload support inbox failed:', preloadErr);
                }

                showSection('dashboard');
            } catch (error) {
                console.error('Admin initialization error:', error);
                showAlert('Session expired. Please login again.', 'error');
                setTimeout(() => window.location.href = '/login?admin=true', 1500);
            }
        }

        // ==================== GLOBAL MODAL HELPERS ====================
        window.showSuccessModal = function(messageHtml) {
            const modal = document.getElementById('success-modal');
            const msg = document.getElementById('success-modal-message');
            if (modal && msg) {
                msg.innerHTML = messageHtml;
                modal.style.display = 'flex';
            }
        };

        window.closeSuccessModal = function() {
            const modal = document.getElementById('success-modal');
            if (modal) modal.style.display = 'none';
        };

        // ==================== DATABASE BACKUP FUNCTIONS ====================
        
        let availableDrives = [];

        function getPathSeparatorForDrive(driveName) {
            return driveName === '/' ? '/' : '\\';
        }

        function joinBackupPath(driveName, folderName) {
            const effectiveFolder = folderName || 'mountain_made_backups';
            if (driveName === '/') {
                return `/${effectiveFolder}`;
            }
            return `${driveName}\\${effectiveFolder}`;
        }

        function getBackupDownloadUrl(backupId) {
            return `/api/backup/${backupId}/download`;
        }

        function setAutoBackupStatus(message, type = 'info') {
            const statusEl = document.getElementById('auto-backup-status');
            if (!statusEl) return;

            const colors = {
                info: 'var(--text-muted)',
                success: 'var(--success)',
                error: 'var(--danger)'
            };

            statusEl.textContent = message;
            statusEl.style.color = colors[type] || colors.info;
        }

        window.toggleAutoBackupFrequencyFields = function toggleAutoBackupFrequencyFields() {
            const frequency = document.getElementById('auto-backup-frequency')?.value || 'daily';
            const dayWrap = document.getElementById('auto-backup-day-wrap');
            if (!dayWrap) return;

            dayWrap.style.display = frequency === 'monthly' ? 'block' : 'none';
        }

        function populateAutoBackupDriveOptions() {
            const driveSelect = document.getElementById('auto-backup-drive');
            if (!driveSelect) return;

            const currentValue = driveSelect.value;
            const options = (availableDrives || []).map(drive => `<option value="${drive.name}">${drive.name}</option>`);
            if (options.length === 0) {
                options.push('<option value="/">/</option>');
            }

            driveSelect.innerHTML = options.join('');
            if (currentValue && Array.from(driveSelect.options).some(opt => opt.value === currentValue)) {
                driveSelect.value = currentValue;
            }
        }

        window.loadAutoBackupSettings = async function loadAutoBackupSettings() {
            try {
                setAutoBackupStatus('Loading automatic backup settings...', 'info');
                const response = await api.get('/backup/auto-settings');
                const settings = response?.settings || {};

                const enabled = String(settings.enabled) === 'true' || settings.enabled === true;
                document.getElementById('auto-backup-enabled').value = enabled ? 'true' : 'false';
                document.getElementById('auto-backup-frequency').value = settings.frequency === 'monthly' ? 'monthly' : 'daily';
                document.getElementById('auto-backup-time').value = settings.time || '02:00';
                document.getElementById('auto-backup-day').value = Number(settings.dayOfMonth || 1);
                document.getElementById('auto-backup-keep-months').value = Number(settings.keepMonths || 3);

                populateAutoBackupDriveOptions();
                const driveSelect = document.getElementById('auto-backup-drive');
                const resolvedDrive = settings.drive || (availableDrives[0]?.name || '/');
                if (driveSelect) {
                    if (!Array.from(driveSelect.options).some(opt => opt.value === resolvedDrive)) {
                        const dynamicOption = document.createElement('option');
                        dynamicOption.value = resolvedDrive;
                        dynamicOption.textContent = resolvedDrive;
                        driveSelect.appendChild(dynamicOption);
                    }
                    driveSelect.value = resolvedDrive;
                }

                document.getElementById('auto-backup-folder').value = settings.folder || 'mountain_made_backups';
                toggleAutoBackupFrequencyFields();

                const scheduleLabel = settings.frequency === 'monthly'
                    ? `Monthly on day ${settings.dayOfMonth || 1} at ${settings.time || '02:00'}`
                    : `Daily at ${settings.time || '02:00'}`;

                setAutoBackupStatus(`Loaded. ${enabled ? 'Enabled' : 'Disabled'} ‚Ä¢ ${scheduleLabel} ‚Ä¢ Keep ${settings.keepMonths || 3} month(s).`, 'success');
            } catch (error) {
                console.error('Load auto backup settings error:', error);
                setAutoBackupStatus(error.message || 'Failed to load auto backup settings.', 'error');
            }
        }

        window.saveAutoBackupSettings = async function saveAutoBackupSettings() {
            const saveBtn = document.getElementById('save-auto-backup-btn');
            try {
                const payload = {
                    enabled: document.getElementById('auto-backup-enabled').value === 'true',
                    frequency: document.getElementById('auto-backup-frequency').value,
                    time: document.getElementById('auto-backup-time').value || '02:00',
                    dayOfMonth: Number(document.getElementById('auto-backup-day').value || 1),
                    keepMonths: Number(document.getElementById('auto-backup-keep-months').value || 3),
                    drive: document.getElementById('auto-backup-drive').value || '/',
                    folder: (document.getElementById('auto-backup-folder').value || '').trim() || 'mountain_made_backups'
                };

                if (payload.frequency !== 'monthly') {
                    payload.dayOfMonth = 1;
                }

                if (saveBtn) {
                    saveBtn.disabled = true;
                    saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
                }

                await api.post('/backup/auto-settings', payload);
                setAutoBackupStatus('Automatic backup settings saved successfully.', 'success');
                showAlert('Automatic backup settings saved.', 'success');
                await loadAutoBackupSettings();
            } catch (error) {
                console.error('Save auto backup settings error:', error);
                setAutoBackupStatus(error.message || 'Failed to save automatic backup settings.', 'error');
                showAlert(error.message || 'Failed to save automatic backup settings.', 'error');
            } finally {
                if (saveBtn) {
                    saveBtn.disabled = false;
                    saveBtn.innerHTML = '<i class="fas fa-save"></i> Save Auto Backup Settings';
                }
            }
        }

        window.loadDrives = async function loadDrives() {
            try {
                const response = await api.get('/backup/drives');
                availableDrives = response.drives || [];
                
                const select = document.getElementById('backup-drive-select');
                if (select) {
                    select.innerHTML = '<option value="">-- Select a drive --</option>' + 
                        availableDrives.map(drive => 
                            `<option value="${drive.name}">${drive.name} (${drive.freeSpaceGB} GB free of ${drive.totalSpaceGB} GB)</option>`
                        ).join('');
                }

                populateAutoBackupDriveOptions();
            } catch (error) {
                console.error('Error loading drives:', error);
                showAlert('Failed to load drives: ' + error.message, 'error');
            }
        }

        window.updateDriveInfo = function updateDriveInfo() {
            const select = document.getElementById('backup-drive-select');
            const driveInfo = document.getElementById('drive-info');
            const selectedDrive = select.value;

            if (!selectedDrive) {
                driveInfo.style.display = 'none';
                updateBackupPathPreview();
                return;
            }

            const drive = availableDrives.find(d => d.name === selectedDrive);
            if (drive) {
                document.getElementById('drive-total').textContent = drive.totalSpaceGB + ' GB';
                document.getElementById('drive-free').textContent = drive.freeSpaceGB + ' GB';
                document.getElementById('drive-used').textContent = drive.usedSpaceGB + ' GB';
                
                const usagePercent = ((drive.totalSpaceBytes - drive.freeSpaceBytes) / drive.totalSpaceBytes * 100).toFixed(1);
                document.getElementById('drive-usage-bar').style.width = usagePercent + '%';
                
                driveInfo.style.display = 'block';
            }

            updateBackupPathPreview();
        }

        window.updateBackupPathPreview = function updateBackupPathPreview() {
            const drive = document.getElementById('backup-drive-select').value;
            const folderPath = document.getElementById('backup-folder-path').value.trim();
            const preview = document.getElementById('full-backup-path-preview');

            if (!drive) {
                preview.textContent = 'Select a drive first';
                return;
            }

            const basePath = joinBackupPath(drive, folderPath);
            const sep = getPathSeparatorForDrive(drive);
            const fullPath = `${basePath}${sep}<backup-file>.sql`;
            preview.textContent = fullPath;
        }

        // Update preview when folder path or picker changes
        document.addEventListener('DOMContentLoaded', () => {
            const folderInput = document.getElementById('backup-folder-path');
            if (folderInput) {
                folderInput.addEventListener('input', updateBackupPathPreview);
            }

            const folderPicker = document.getElementById('backup-folder-picker');
            if (folderPicker) {
                folderPicker.addEventListener('change', handleBackupFolderPicked);
            }
        });

        window.createDatabaseBackup = async function createDatabaseBackup() {
            const driveSelect = document.getElementById('backup-drive-select');
            const folderInput = document.getElementById('backup-folder-path');
            const createBtn = document.getElementById('create-backup-btn');

            const drive = driveSelect.value;
            const folderPath = folderInput.value.trim() || '';

            if (!drive) {
                showAlert('Please select a drive', 'error');
                return;
            }

            const basePath = joinBackupPath(drive, folderPath);
            if (await showConfirmDialog(`Create database backup at ${basePath}?`, {
                title: 'Create Database Backup',
                confirmText: 'Create Backup'
            })) {
                try {
                    createBtn.disabled = true;
                    createBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Creating Backup...';

                    const response = await api.post('/backup/create', { drive, folderPath });

                    const backupId = response?.backup?.id;
                    const backupPath = response?.backup?.filePath || basePath;
                    const downloadAction = backupId
                        ? `<a class="btn btn-primary btn-sm" href="${getBackupDownloadUrl(backupId)}" target="_blank" rel="noopener"><i class='fas fa-download'></i> Download Backup</a>`
                        : `<span style="color: var(--text-muted);">Download link unavailable. Check backup history.</span>`;

                    window.showSuccessModal(`Backup created successfully!<br>File: <b>${response.backup.filename}</b><br>Size: <b>${response.backup.fileSizeMB} MB</b><br>Server path: <code>${backupPath}</code><br><br>${downloadAction}`);
                    // Refresh backup history
                    await loadBackupHistory();

                } catch (error) {
                    console.error('Backup error:', error);
                    showAlert('Backup failed: ' + error.message, 'error');
                } finally {
                    createBtn.disabled = false;
                    createBtn.innerHTML = '<i class="fas fa-database"></i> Create Backup Now';
                }
            }
        }

        window.loadBackupHistory = async function loadBackupHistory() {
            const tbody = document.getElementById('backup-history-table');
            
            try {
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem;"><i class="fas fa-spinner fa-spin"></i> Loading...</td></tr>';

                const response = await api.get('/backup/history');
                const backups = response.backups || [];

                if (backups.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--text-muted);">No backups found</td></tr>';
                    return;
                }

                tbody.innerHTML = backups.map(backup => {
                    const statusBadge = backup.status === 'completed' 
                        ? '<span class="badge badge-success">Completed</span>' 
                        : '<span class="badge badge-error">Failed</span>';
                    
                    const date = new Date(backup.createdAt);
                    const formattedDate = date.toLocaleString();

                    return `
                        <tr>
                            <td>${formattedDate}</td>
                            <td><code style="font-size: 0.875rem;">${backup.filename}</code></td>
                            <td><small style="color: var(--text-muted);">${backup.drive}${backup.drive === '/' ? '...' : '\\...'}</small></td>
                            <td>${backup.fileSizeMB} MB</td>
                            <td>${statusBadge}</td>
                            <td>${backup.createdBy || '-'}</td>
                            <td>
                                ${backup.canDownload ? `<a class="btn btn-secondary btn-sm" href="${getBackupDownloadUrl(backup.id)}" target="_blank" rel="noopener" title="Download Backup"><i class="fas fa-download"></i></a>` : ''}
                                <button class="btn btn-danger btn-sm" onclick="deleteBackupRecord(${backup.id})" title="Delete Record">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                }).join('');

            } catch (error) {
                console.error('Error loading backup history:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error);">Failed to load backup history</td></tr>';
            }
        }

        window.downloadBackup = async function downloadBackup(backupId) {
            try {
                const anchor = document.createElement('a');
                anchor.href = getBackupDownloadUrl(backupId);
                anchor.target = '_blank';
                anchor.rel = 'noopener';
                document.body.appendChild(anchor);
                anchor.click();
                anchor.remove();
            } catch (error) {
                showAlert(error.message || 'Download failed', 'error');
            }
        }

        // Use folder chosen from local machine to populate folder name
        window.openBackupFolderPicker = function openBackupFolderPicker() {
            const picker = document.getElementById('backup-folder-picker');
            if (picker) picker.click();
        }

        window.handleBackupFolderPicked = function handleBackupFolderPicked(event) {
            const input = event.target;
            if (!input || !input.files || input.files.length === 0) return;

            // webkitRelativePath gives path relative to chosen folder, e.g. "MyFolder/file.txt"
            const firstFile = input.files[0];
            const relPath = firstFile.webkitRelativePath || firstFile.name;
            const parts = relPath.split('/');
            const topFolder = parts.length > 1 ? parts[0] : parts[0];

            const folderInput = document.getElementById('backup-folder-path');
            if (folderInput && topFolder) {
                folderInput.value = topFolder;
                updateBackupPathPreview();
            }

            // Reset input so the same folder can be reselected later if needed
            input.value = '';
        }

        window.deleteBackupRecord = async function deleteBackupRecord(backupId) {
            if (await showConfirmDialog('Delete this backup record? (The actual backup file will NOT be deleted)', {
                title: 'Delete Backup Record',
                confirmText: 'Delete Record',
                danger: true
            })) {
                try {
                    await api.delete(`/backup/${backupId}`);
                    showAlert('Backup record deleted', 'success');
                    await loadBackupHistory();
                } catch (error) {
                    console.error('Delete backup error:', error);
                    showAlert('Failed to delete backup record', 'error');
                }
            }
        }

        // Danger Zone: Delete all data
        window.confirmDeleteAllData = async function confirmDeleteAllData() {
            const firstConfirm = await showConfirmDialog('This will permanently delete ALL data (except admin accounts). This cannot be undone. Continue?', {
                title: 'Danger Zone',
                confirmText: 'I Understand, Continue',
                danger: true
            });
            if (!firstConfirm) return;

            const phrase = await showPromptDialog('Type DELETE ALL DATA to confirm this action', {
                title: 'Final Confirmation',
                placeholder: 'DELETE ALL DATA',
                confirmText: 'Delete Data',
                danger: true
            });
            if (phrase !== 'DELETE ALL DATA') {
                showAlert('Confirmation phrase did not match. No data was deleted.', 'error');
                return;
            }

            try {
                const result = await api.post('/admin/delete-all-data', { confirmation: 'DELETE ALL DATA' });
                const verification = result && result.verification ? result.verification : null;
                if (verification) {
                    showAlert(
                        `Deleted. Admin users: ${verification.admin_users}, Non-admin users: ${verification.non_admin_users}, DB: ${verification.database_name} @ ${verification.server_addr || 'unknown'}:${verification.server_port || '?'}`,
                        'success'
                    );
                } else {
                    showAlert('All non-admin data has been deleted.', 'success');
                }

                // Optionally refresh key admin views
                if (window._currentSection === 'database-backup') {
                    loadBackupHistory();
                }
            } catch (error) {
                console.error('Delete all data error:', error);
                showAlert('Failed to delete all data: ' + (error.message || ''), 'error');
            }
        }

        // Extend section switching with backup + support inbox hooks
        const originalShowSection = window.showSection;
        window.showSection = function(sectionId) {
            if (typeof originalShowSection === 'function') {
                originalShowSection(sectionId);
            }

            if (sectionId === 'database-backup') {
                loadDrives();
                loadBackupHistory();
                loadAutoBackupSettings();
            }

            if (sectionId === 'messages') {
                loadContactInbox('message', { force: true });
            }
        };

        // ==================== END BACKUP FUNCTIONS ====================

        document.addEventListener('DOMContentLoaded', initializeAdmin);
    })();
    </script>
</body>
</html>