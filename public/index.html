<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#2c5f2d">
    <link rel="manifest" href="/manifest.json">
    <title>Mountain Made</title>
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/mobile-enhancements.css">
    <link rel="preload" as="style" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"></noscript>
    <style>
        /* Search Section Styles */
        .search-section {
            background-image: linear-gradient(180deg, rgba(15,56,35,0.72), rgba(15,56,35,0.58));
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            padding: clamp(2.5rem, 8vw, 5rem) 1rem;
            margin-bottom: 2.5rem;
        }

        @media (min-width: 769px) {
            .search-section {
                background-image: linear-gradient(180deg, rgba(15,56,35,0.72), rgba(15,56,35,0.58)), url('/images/search-bg.gif');
            }
        }

        .search-container {
            max-width: 980px;
            margin: 0 auto;
            position: relative;
        }

        .search-heading {
            max-width: 840px;
            margin: 0 auto 1.25rem;
            text-align: center;
            min-height: clamp(64px, 12vw, 108px);
        }

        .search-heading.hidden {
            display: block;
            visibility: hidden;
        }

        .search-heading h1 {
            margin: 0 0 0.5rem;
            font-size: clamp(1.8rem, 4.8vw, 3.2rem);
            line-height: 1.15;
            color: #ffffff;
            letter-spacing: -0.02em;
        }

        .search-heading p {
            margin: 0;
            color: rgba(255,255,255,0.9);
            font-size: clamp(0.98rem, 1.8vw, 1.2rem);
        }

        .homepage-section-heading-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.85rem;
            width: 100%;
            max-width: 100%;
            margin: 0;
        }

        .homepage-section-heading-text {
            text-align: center;
            width: min(100%, 980px);
            margin: 0 auto;
            padding: 0 1rem;
        }

        .homepage-section-heading-text h2 {
            margin: 0 0 0.4rem 0;
        }

        .homepage-section-heading-text p {
            margin: 0;
        }

        .homepage-section-heading-image-box {
            /* Full-bleed banner: touch left/right viewport edges */
            width: 100vw;
            max-width: 100vw;
            margin-left: calc(50% - 50vw);
            margin-right: calc(50% - 50vw);
            aspect-ratio: 20 / 8;
            max-height: clamp(140px, 22vw, 300px);
            border-radius: 0;
            overflow: hidden;
            border: 1px solid var(--border-primary);
            background: var(--bg-secondary);
            box-shadow: var(--shadow-sm);
        }

        .homepage-section-heading-image-box.hidden {
            display: none;
        }

        .homepage-section-heading-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        /* Homepage product cards - compact sizing + better image fit */
        #homepage-sections-container .product-card .card-image {
            width: 100%;
            height: auto;
            aspect-ratio: 4 / 3;
            max-height: 180px;
            object-fit: cover;
            display: block;
        }

        #homepage-sections-container .product-card .stock-info {
            margin-top: 0.15rem;
            font-size: 0.8rem;
            line-height: 1.2;
        }

        #homepage-sections-container .product-card .card-content {
            padding: 0.75rem 0.9rem 0.8rem;
        }

        #homepage-sections-container .product-card .card-description {
            margin-bottom: var(--space-2);
            -webkit-line-clamp: 1;
            line-clamp: 1;
        }

        #homepage-sections-container .product-card .product-price {
            font-size: 1.35rem;
            color: var(--primary-700);
        }

        #homepage-sections-container .product-card .card-footer {
            padding: 0 0.9rem 0.9rem;
            gap: 0.45rem;
        }

        #homepage-sections-container .product-card .card-footer .btn {
            padding: 0.45rem 0.6rem;
            font-size: 0.78rem;
        }

        #homepage-sections-container .product-card .add-cart-cta {
            font-weight: 700;
            letter-spacing: 0.01em;
        }

        #homepage-sections-container .product-card .card-footer .btn i {
            font-size: 0.8em;
        }

        @media (max-width: 768px) {
            #homepage-sections-container .product-card .card-image {
                max-height: 110px;
            }

            #homepage-sections-container .product-card .card-content {
                padding: 0.5rem 0.65rem 0.65rem;
            }

            #homepage-sections-container .product-card .card-footer {
                padding: 0 0.65rem 0.65rem;
            }
        }

        @media (max-width: 600px) {
            #homepage-sections-container .product-card .card-description {
                display: none;
            }

            #homepage-sections-container .product-card .product-qty-row {
                display: none !important;
            }

            #homepage-sections-container .product-card .card-footer {
                flex-direction: column;
                align-items: stretch;
            }

            #homepage-sections-container .product-card .card-footer .btn {
                width: 100% !important;
                margin-left: 0 !important;
            }

            #homepage-sections-container .product-card .product-action-row {
                display: grid !important;
                grid-template-columns: repeat(2, minmax(0, 1fr));
                gap: 0.25rem;
                width: 100%;
            }

            #homepage-sections-container .product-card .product-action-row .btn {
                width: 100% !important;
                min-width: 0;
                padding: 0.34rem 0.2rem;
                font-size: 0.64rem;
                gap: 0.2rem;
                line-height: 1.1;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            #homepage-sections-container .product-card .product-action-row .btn i {
                display: none;
            }
        }

        .search-input-wrapper {
            display: flex;
            gap: 0.75rem;
            box-shadow: 0 16px 36px rgba(0,0,0,0.2);
            border-radius: 14px;
            overflow: hidden;
            background: var(--bg-primary);
            border: 1px solid rgba(255,255,255,0.45);
        }

        .search-input-zone {
            position: relative;
        }

        .search-input {
            flex: 1;
            padding: 1rem 1.25rem;
            font-size: 1rem;
            border: none;
            outline: none;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .search-input:focus {
            box-shadow: inset 0 0 0 2px rgba(58,145,83,0.2);
        }

        /* Search Suggestions */
        .search-suggestions {
            position: absolute;
            left: 0;
            right: 0;
            top: calc(100% + 0.5rem);
            margin-top: 0.5rem;
            background: var(--bg-primary);
            border-radius: 8px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.15);
            max-height: 320px;
            overflow-y: auto;
            z-index: 50;
        }

        .search-suggestion-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            gap: 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid var(--border-primary);
        }

        .search-suggestion-item:last-child {
            border-bottom: none;
        }

        .search-suggestion-item:hover {
            background: var(--bg-secondary);
        }

        .search-suggestion-image {
            width: 40px;
            height: 40px;
            border-radius: 6px;
            object-fit: cover;
            background: var(--bg-secondary);
            flex-shrink: 0;
        }

        .search-suggestion-text {
            display: flex;
            flex-direction: column;
        }

        .search-suggestion-name {
            font-size: 0.95rem;
            font-weight: 500;
            color: var(--text-primary);
        }

        .search-suggestion-meta {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }

        .search-suggestions-empty {
            padding: 0.75rem;
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .search-button {
            padding: 1rem 1.5rem;
            background: var(--primary-900);
            color: white;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            white-space: nowrap;
        }

        .search-button:hover {
            background: var(--primary-800);
        }

        .home-trust-strip {
            margin-top: 1rem;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 0.5rem;
        }

        .home-trust-item {
            display: inline-flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.45rem 0.7rem;
            border-radius: 999px;
            background: rgba(255,255,255,0.14);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.24);
            font-size: 0.78rem;
            font-weight: 500;
        }

        .home-trust-item i {
            color: #facc15;
        }

        /* Carousel Styles */
        .carousel-section {
            background: var(--bg-secondary);
            padding: 2rem 0;
            margin-bottom: 2rem;
        }

        .carousel-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .carousel-title {
            font-size: 1.75rem;
            margin-bottom: 1.5rem;
            color: var(--text-primary);
        }

        .carousel-wrapper {
            position: relative;
        }

        .carousel-track-container {
            overflow: hidden;
            border-radius: 12px;
            min-height: 300px;
        }

        .carousel-track {
            display: flex;
            gap: 1rem;
            transition: transform 0.5s ease-in-out;
        }

        .carousel-item {
            min-width: 280px;
            background: var(--bg-primary);
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            flex-shrink: 0;
        }

        .carousel-item:hover {
            transform: translateY(-4px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.15);
        }

        .carousel-item-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
        }

        .carousel-item-content {
            padding: 1rem;
        }

        .carousel-item-title {
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            line-clamp: 2;
            overflow: hidden;
        }

        .carousel-item-price {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-600);
            margin-bottom: 0.75rem;
        }

        .carousel-stock-badge {
            display: inline-flex;
            align-items: center;
            padding: 0.2rem 0.55rem;
            border-radius: 999px;
            font-size: 0.72rem;
            font-weight: 600;
            margin-bottom: 0.45rem;
            background: var(--warning);
            color: #1f2937;
        }

        .carousel-stock-badge.out {
            background: var(--error);
            color: #ffffff;
        }

        .carousel-item-footer {
            display: flex;
            gap: 0.5rem;
        }

        .carousel-item-footer .btn {
            flex: 1;
            padding: 0.5rem;
            font-size: 0.875rem;
        }

        .carousel-nav {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(255, 255, 255, 0.95);
            border: 1px solid var(--border-primary);
            border-radius: 50%;
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .carousel-nav:hover {
            background: var(--bg-primary);
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .carousel-prev {
            left: -24px;
        }

        .carousel-next {
            right: -24px;
        }

        .carousel-loader {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
            width: 100%;
        }

        @media (max-width: 768px) {
            .homepage-section-heading-image-box {
                aspect-ratio: 20 / 8;
                max-height: clamp(120px, 40vw, 220px);
            }

            .search-input-wrapper {
                flex-direction: column;
                gap: 0;
            }

            .search-button {
                padding: 0.875rem;
            }

            .search-suggestions {
                max-height: 260px;
            }

            .carousel-item {
                min-width: 240px;
            }

            .carousel-track-container {
                min-height: 260px;
            }

            .carousel-nav {
                width: 40px;
                height: 40px;
            }

            .carousel-prev {
                left: 4px;
            }

            .carousel-next {
                right: 4px;
            }
        }

        @media (max-width: 480px) {
            .carousel-item {
                min-width: 200px;
            }

            .carousel-track-container {
                min-height: 240px;
            }
        }

        @media (min-width: 992px) {
            #categories #categories-grid {
                grid-template-columns: repeat(4, minmax(0, 1fr));
                gap: 0.75rem;
                max-width: 720px;
                margin: 0 auto;
            }

            #categories #categories-grid .card {
                max-width: 165px;
                margin: 0 auto;
            }

            #categories #categories-grid .category-image {
                aspect-ratio: 1 / 1;
                width: 100%;
                height: auto;
                max-height: 165px;
                object-fit: cover;
            }

            #categories #categories-grid .card-content {
                padding: 0.4rem 0.5rem 0.55rem;
            }

            #categories #categories-grid .card-title {
                font-size: 0.85rem;
                margin-bottom: 0;
            }

            #categories #categories-grid .card-description {
                display: none;
            }
        }

        /* Account Dropdown Styles */
        .account-menu {
            position: relative;
        }

        .account-dropdown {
            position: absolute;
            right: 0;
            top: calc(100% + 0.5rem);
            background: var(--bg-primary);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            min-width: 280px;
            z-index: 1000;
            border: 1px solid var(--border-primary);
        }

        .account-dropdown.hidden {
            display: none;
        }

        .account-section {
            padding: 1rem;
            border-bottom: 1px solid var(--border-primary);
        }

        .account-section:last-child {
            border-bottom: none;
        }

        .account-section strong {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-primary);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .account-link {
            width: 100%;
            padding: 0.5rem 0.75rem;
            background: var(--bg-secondary);
            border: 1px solid var(--border-primary);
            border-radius: var(--radius-md);
            cursor: pointer;
            font-size: 0.875rem;
            color: var(--text-primary);
            transition: all 0.2s;
            display: block;
            text-align: left;
            margin-top: 0.5rem;
        }

        .account-link:hover {
            background: var(--primary-100);
            border-color: var(--primary-400);
        }

        .account-link-danger {
            background: var(--error-bg);
            color: var(--error);
            border-color: var(--error);
        }

        .account-link-danger:hover {
            background: var(--error);
            color: white;
        }

        .account-text {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-top: 0.25rem;
            padding: 0.25rem 0;
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/" class="navbar-brand">
                <span class="logo-icon">üèîÔ∏è</span>
                Mountain Made
            </a>
            
            <ul class="navbar-menu">
                <li><a href="/" class="active">Home</a></li>
                <li><a href="/products">Products</a></li>
                <li><a href="#categories">Categories</a></li>
                <li><a href="#about">About</a></li>
                <li><a href="/contact">Contact Us</a></li>
                <li id="admin-link" class="hidden"><a href="/admin">Admin</a></li>
            </ul>
            
            <div class="navbar-actions">
                <div id="auth-buttons">
                    <a href="/login" class="btn btn-secondary btn-sm">Login</a>
                    <a href="/register" class="btn btn-primary btn-sm">Register</a>
                </div>
                
                <div id="user-menu" class="hidden flex gap-2" style="align-items: center;">
                    <a href="/cart" class="icon-button" title="Shopping Cart">
                        <i class="fas fa-shopping-cart"></i>
                        <span id="cart-badge" class="cart-badge hidden">0</span>
                    </a>
                    <div class="account-menu">
                        <button id="account-toggle" class="icon-button" title="Account">
                            <i class="fas fa-user-circle"></i>
                        </button>
                        <div id="account-dropdown" class="account-dropdown hidden">
                            <div class="account-section">
                                <strong>Account</strong>
                                <button class="account-link" onclick="openProfileModal()">Edit Profile</button>
                                <a href="/orders" class="account-link">My Orders</a>
                            </div>
                            <div class="account-section">
                                <strong>Account Management</strong>
                                <button class="account-link" onclick="openAccountManagementModal()">Change Password</button>
                            </div>
                            <div class="account-section">
                                <strong>Appearance</strong>
                                <button id="theme-toggle" class="account-link">Toggle Dark / Light</button>
                            </div>
                            <div class="account-section">
                                <button id="account-logout" class="account-link account-link-danger">Logout</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <button class="mobile-menu-toggle">
                    <i class="fas fa-bars"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Search Bar Section -->
    <section class="search-section">
        <div class="search-container">
            <div id="search-hero-heading" class="search-heading hidden">
                <h1 id="homepage-hero-title-text"></h1>
                <p id="homepage-hero-subtitle-text"></p>
            </div>
            <div class="search-input-zone">
                <div class="search-input-wrapper">
                    <input type="text" id="home-search-input" class="search-input" placeholder="Search for products..." />
                    <button id="home-search-btn" class="search-button">
                        <i class="fas fa-search"></i> Search
                    </button>
                </div>
                <div id="home-search-suggestions" class="search-suggestions hidden"></div>
            </div>
            <div class="home-trust-strip" aria-label="Store trust indicators">
                <span class="home-trust-item"><i class="fas fa-shield-check"></i> Secure checkout</span>
                <span class="home-trust-item"><i class="fas fa-leaf"></i> Fresh quality products</span>
                <span class="home-trust-item"><i class="fas fa-truck"></i> Fast doorstep delivery</span>
            </div>
        </div>
    </section>

    <!-- Product Carousel Slider -->
    <section class="carousel-section">
        <div class="carousel-container">
            <h2 class="carousel-title">Featured Products</h2>
            <div class="carousel-wrapper">
                <button class="carousel-nav carousel-prev" id="carousel-prev">
                    <i class="fas fa-chevron-left"></i>
                </button>
                <div class="carousel-track-container">
                    <div class="carousel-track" id="carousel-track">
                        <div class="carousel-loader">
                            <div class="spinner"></div>
                        </div>
                    </div>
                </div>
                <button class="carousel-nav carousel-next" id="carousel-next">
                    <i class="fas fa-chevron-right"></i>
                </button>
            </div>
        </div>
    </section>

    <!-- Categories Section -->
    <section id="categories" class="container">
        <div class="section-title">
            <h2>Shop by Category</h2>
            <p>Explore our wide range of premium food products</p>
        </div>
        
        <div id="categories-grid" class="grid grid-4">
            <div class="loading">
                <div class="spinner"></div>
            </div>
        </div>
    </section>

    

    <!-- Dynamic Homepage Sections -->
    <div id="homepage-sections-container"></div>

    

    <!-- Footer -->
    <footer class="footer">
        <div class="footer-trust-row">
            <div class="trust-badge"><i class="fas fa-lock"></i><span>Safe payments</span></div>
            <div class="trust-badge"><i class="fas fa-award"></i><span>Quality checked</span></div>
            <div class="trust-badge"><i class="fas fa-rotate-left"></i><span>Hassle-free support</span></div>
            <div class="trust-badge"><i class="fas fa-truck-fast"></i><span>Quick dispatch</span></div>
        </div>
        <div class="footer-content">
            <div class="footer-section">
                <h3>Mountain Made 2.0</h3>
                <p>Premium organic food products from mountain farms to your table.</p>
            </div>
            
            <div class="footer-section">
                <h3>Quick Links</h3>
                <ul>
                    <li><a href="/products">Products</a></li>
                    <li><a href="/#categories">Categories</a></li>
                    <li><a href="/#about">About Us</a></li>
                    <li><a href="/register?type=wholesale">Wholesale</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Customer Service</h3>
                <ul>
                    <li><a href="/orders">My Orders</a></li>
                    <li><a href="/cart">Shopping Cart</a></li>
                    <li><a href="/contact">Contact Us</a></li>
                    <li><a href="#">FAQs</a></li>
                </ul>
            </div>
            
            <div class="footer-section">
                <h3>Contact</h3>
                <ul>
                    <li><i class="fas fa-envelope"></i> hello@mountain-made.com</li>
                    <li><i class="fas fa-phone"></i> (555) 123-4567</li>
                    <li><i class="fas fa-map-marker-alt"></i> India, Manipur</li>
                </ul>
            </div>
        </div>
        
        <div class="footer-bottom">
            <p>&copy; 2026 Mountain Made 2.0. All rights reserved.</p>
        </div>
    </footer>

    <script src="/js/main.js"></script>
    <script>
        // In-memory data for homepage
        let homeCategories = [];
        let carouselProducts = [];
        let currentCarouselIndex = 0;

        // Load categories
        async function loadCategories() {
            try {
                const data = await api.get('/products/categories');
                homeCategories = data.categories || [];
                const grid = document.getElementById('categories-grid');
                
                if (homeCategories.length === 0) {
                    grid.innerHTML = '<p class="text-center">No categories available</p>';
                    return;
                }
                
                grid.innerHTML = homeCategories.map(category => `
                    <a href="/products?category=${category.id}" class="card">
                        <img src="${category.image_url || '/images/placeholder.jpg'}" 
                             alt="${category.name}" 
                             class="card-image category-image"
                             loading="lazy"
                             decoding="async"
                             onerror="this.src='/images/placeholder.jpg'">
                        <div class="card-content text-center">
                            <h3 class="card-title">${category.name}</h3>
                            <p class="card-description">${category.description || ''}</p>
                        </div>
                    </a>
                `).join('');
                if (window.optimizeDynamicImages) {
                    window.optimizeDynamicImages(grid);
                }
            } catch (error) {
                console.error('Failed to load categories:', error);
                document.getElementById('categories-grid').innerHTML = 
                    '<p class="text-center">Failed to load categories</p>';
            }
        }
        
        // Load dynamic homepage sections with products
        async function loadHomepageSections() {
            try {
                const [sectionsData, settingsData] = await Promise.all([
                    api.get('/products/homepage-sections'),
                    api.get('/products/settings')
                ]);

                const data = sectionsData || {};
                const settings = (settingsData && settingsData.settings) || {};
                const sections = Array.isArray(data.sections) ? data.sections : [];

                // Apply "Homepage Headings" settings to the Search Bar section
                const heroWrap = document.getElementById('search-hero-heading');
                const heroTitleEl = document.getElementById('homepage-hero-title-text');
                const heroSubtitleEl = document.getElementById('homepage-hero-subtitle-text');
                const heroTitle = (settings.homepage_hero_title || '').trim();
                const heroSubtitle = (settings.homepage_hero_subtitle || '').trim();

                if (heroWrap && heroTitleEl && heroSubtitleEl) {
                    if (heroTitle || heroSubtitle) {
                        heroTitleEl.textContent = heroTitle;
                        heroSubtitleEl.textContent = heroSubtitle;
                        heroWrap.classList.remove('hidden');
                    } else {
                        heroWrap.classList.add('hidden');
                    }
                }

                const container = document.getElementById('homepage-sections-container');
                
                if (sections.length === 0) {
                    container.innerHTML = '<section class="container"><div class="section-title"><h2>Featured Products</h2><p>No homepage sections configured yet. Add a section in the admin panel and assign products to it to feature them here.</p></div></section>';
                    return;
                }
                
                let html = '';
                
                sections.forEach((section) => {
                    const sectionProducts = Array.isArray(section.products) ? section.products : [];
                    const sectionHeadingImageUrl = (section.heading_image_url || '').trim();
                    const safeSectionHeadingImageUrl = sectionHeadingImageUrl ? encodeURI(sectionHeadingImageUrl) : '';
                    const showHeadingImage = !!sectionHeadingImageUrl;
                    html += `
                        <section class="container">
                            <div class="section-title">
                                <div class="homepage-section-heading-wrap">
                                    <div class="homepage-section-heading-image-box ${showHeadingImage ? '' : 'hidden'}">
                                        <img class="homepage-section-heading-image" src="${showHeadingImage ? safeSectionHeadingImageUrl : ''}" alt="${section.name || 'Section'} heading image" loading="lazy" decoding="async" onerror="this.parentElement.classList.add('hidden')">
                                    </div>
                                    <div class="homepage-section-heading-text">
                                        <h2>${section.name}</h2>
                                        ${section.description ? `<p>${section.description}</p>` : ''}
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-4">
                    `;

                    if (sectionProducts.length > 0) {
                        sectionProducts.forEach(product => {
                            html += `
                                <div class="card product-card">
                                    ${product.stock_quantity < 10 && product.stock_quantity > 0 ? 
                                        '<span class="product-badge">Low Stock</span>' : ''}
                                    ${product.stock_quantity === 0 ? 
                                        '<span class="product-badge" style="background: var(--error);">Out of Stock</span>' : ''}
                                    
                                    <a href="/product-details?id=${product.id}" style="text-decoration: none; color: inherit;">
                                        <img src="${product.image_url || '/images/placeholder.jpg'}" 
                                             alt="${product.name}" 
                                             class="card-image"
                                             loading="lazy"
                                             decoding="async"
                                             onerror="this.src='/images/placeholder.jpg'">
                                        
                                        <div class="card-content">
                                            <h3 class="card-title">${product.name}</h3>
                                            <p class="card-description">${product.description || ''}</p>
                                            
                                            ${(() => {
                                                const useWholesale = auth.isWholesale() && product.wholesale_price;
                                                const base = parseFloat(product.price || 0);
                                                const discount = product.discount_price != null ? parseFloat(product.discount_price) : null;
                                                const retail = discount != null && discount < base ? discount : base;
                                                const sale = useWholesale ? parseFloat(product.wholesale_price) : retail;
                                                const showDiscount = !useWholesale && discount != null && discount < base;
                                                if (useWholesale) {
                                                    return `<div class="product-price">${formatCurrency(sale)}</div><p class="stock-info">Min order: ${product.min_wholesale_qty} units</p>`;
                                                }
                                                if (showDiscount) {
                                                    return `<div class="product-price"><span class="price-original">${formatCurrency(base)}</span><span class="price-discount">${formatCurrency(retail)}</span></div>`;
                                                }
                                                return `<div class="product-price">${formatCurrency(sale)}</div>`;
                                            })()}
                                        </div>
                                    </a>
                                    
                                    <div class="card-footer" style="display:flex; flex-direction:column; align-items:stretch; gap:0.35rem;">
                                        <div class="product-qty-row" style="display:flex; align-items:center; gap:0.25rem;">
                                            <label for="home-qty-${product.id}" style="font-size:0.8rem; color:var(--text-light);">Qty</label>
                                            <input type="number"
                                                   id="home-qty-${product.id}"
                                                   class="form-input"
                                                   value="1"
                                                   min="1"
                                                   max="${product.stock_quantity || 99}"
                                                   style="width:64px; padding:0.25rem 0.35rem; font-size:0.85rem;">
                                        </div>
                                        <div class="product-action-row" style="display:flex; align-items:center; gap:0.25rem; width:100%;">
                                            <button class="btn btn-primary btn-sm add-cart-cta" 
                                                    onclick="addToCart(${product.id})"
                                                    ${product.stock_quantity === 0 ? 'disabled' : ''}
                                                    style="flex:1; min-width:0; width:auto;">
                                                <i class="fas fa-cart-plus"></i>
                                                ${product.stock_quantity === 0 ? 'Out' : 'Add'}
                                            </button>
                                            <button class="btn btn-success btn-sm" 
                                                    onclick="buyNow(${product.id})"
                                                    ${product.stock_quantity === 0 ? 'disabled' : ''}
                                                    style="flex:1; min-width:0; width:auto;">
                                                <i class="fas fa-credit-card"></i> Buy
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                    } else {
                        html += `
                            <div class="card" style="grid-column: 1 / -1; text-align: center;">
                                <div class="card-content">
                                    <p>No products in this section yet. Add products in the admin panel and assign them to "${section.name}" to show them here.</p>
                                </div>
                            </div>
                        `;
                    }

                    html += `
                            </div>
                            <div class="text-center mt-3">
                                <a href="/products" class="btn btn-primary">View All Products</a>
                            </div>
                        </section>
                    `;
                });
                
                container.innerHTML = html;
                if (window.optimizeDynamicImages) {
                    window.optimizeDynamicImages(container);
                }
            } catch (error) {
                console.error('Failed to load homepage sections:', error);
                document.getElementById('homepage-sections-container').innerHTML = '<section class="container"><div class="section-title"><h2>Featured Products</h2><p>Unable to load featured sections right now. Please try again later.</p></div></section>';
            }
        }
        
        function getHomeQuantity(productId) {
            const input = document.getElementById(`home-qty-${productId}`);
            if (!input) return 1;
            const val = parseInt(input.value, 10);
            if (isNaN(val) || val < 1) return 1;
            return val;
        }

        // Add to cart function
        async function addToCart(productId) {
            try {
                const quantity = getHomeQuantity(productId);
                await cart.add(productId, quantity);
                showAlert('Product added to cart!', 'success');
            } catch (error) {
                console.error('Add to cart error:', error);
                if (!auth.isAuthenticated()) {
                    showAlert('Please login to add items to cart', 'error');
                    setTimeout(() => window.location.href = '/login', 1500);
                } else {
                    showAlert('Failed to add product to cart', 'error');
                }
            }
        }
        
        // Buy now function - route through checkout with selected quantity
        async function buyNow(productId) {
            try {
                const user = await auth.checkAuth();

                if (!user) {
                    showAlert('Please login to buy products', 'error');
                    setTimeout(() => {
                        window.location.href = '/login?redirect=/checkout';
                    }, 1500);
                    return;
                }

                const quantity = getHomeQuantity(productId);
                
                // Mark as direct buy before cart operations
                sessionStorage.setItem('directBuy', 'true');
                
                // Clear cart and add product
                await cart.clear();
                const addSuccess = await cart.add(productId, quantity);
                
                if (!addSuccess) {
                    sessionStorage.removeItem('directBuy');
                    showAlert('Failed to add product to cart. Please try again.', 'error');
                    return;
                }
                
                // Verify cart has items before redirecting
                const cartCheck = await cart.fetch();
                if (!cartCheck || !cartCheck.cartItems || cartCheck.cartItems.length === 0) {
                    sessionStorage.removeItem('directBuy');
                    showAlert('Failed to prepare checkout. Please try again.', 'error');
                    return;
                }
                
                // Redirect to checkout
                window.location.replace('/checkout');
            } catch (error) {
                console.error('Buy now error:', error);
                sessionStorage.removeItem('directBuy');
                showAlert(error.message || 'Failed to start checkout', 'error');
            }
        }
        
        function getCategoryIcon(name) {
            const icons = {
                'Fresh Produce': 'ü•¨',
                'Dairy Products': 'üßÄ',
                'Bakery': 'ü•ñ',
                'Meat & Poultry': 'ü•©',
                'Beverages': 'ü•§',
                'Snacks': 'üçø'
            };
            return icons[name] || 'üçΩÔ∏è';
        }
        
        async function loadCarouselProducts() {
            try {
            const data = await api.get('/products/carousel?limit=8');
                carouselProducts = data.products || [];
                
                if (carouselProducts.length === 0) {
                    document.getElementById('carousel-track').innerHTML = '<div class="carousel-loader"><p>No products available</p></div>';
                    return;
                }

                renderCarousel();
                startAutoSlide();
            } catch (error) {
                console.error('Failed to load carousel products:', error);
                document.getElementById('carousel-track').innerHTML = '<div class="carousel-loader"><p>Failed to load products</p></div>';
            }
        }

        function renderCarousel() {
            const track = document.getElementById('carousel-track');
            track.innerHTML = carouselProducts.map((product, index) => `
                <div class="carousel-item" onclick="location.href='/product-details?id=${product.id}'">
                    <img src="${product.image_url || '/images/placeholder.jpg'}" 
                         alt="${product.name}" 
                         class="carousel-item-image"
                         loading="${index === 0 ? 'eager' : 'lazy'}"
                         fetchpriority="${index === 0 ? 'high' : 'auto'}"
                         decoding="async"
                         onerror="this.src='/images/placeholder.jpg'">
                    <div class="carousel-item-content">
                        <h3 class="carousel-item-title">${product.name}</h3>
                        ${product.stock_quantity === 0
                            ? '<div class="carousel-stock-badge out">Out of Stock</div>'
                            : (product.stock_quantity > 0 && product.stock_quantity < 10
                                ? `<div class="carousel-stock-badge">Low Stock (${product.stock_quantity})</div>`
                                : '')}
                        ${(() => {
                            const base = parseFloat(product.price || 0);
                            const discount = product.discount_price != null ? parseFloat(product.discount_price) : null;
                            const retail = discount != null && discount < base ? discount : base;
                            if (discount != null && discount < base) {
                                return `<div class="carousel-item-price"><span class="price-original">${formatCurrency(base)}</span> <span class="price-discount">${formatCurrency(retail)}</span></div>`;
                            }
                            return `<div class="carousel-item-price">${formatCurrency(retail)}</div>`;
                        })()}
                        <div class="carousel-item-footer">
                            <button class="btn btn-primary btn-sm" 
                                    onclick="event.stopPropagation(); addToCart(${product.id})">
                                <i class="fas fa-cart-plus"></i> Add
                            </button>
                            <button class="btn btn-success btn-sm" 
                                    onclick="event.stopPropagation(); buyNow(${product.id})">
                                <i class="fas fa-credit-card"></i> Buy
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
            if (window.optimizeDynamicImages) {
                window.optimizeDynamicImages(track);
            }
        }

        function slideCarousel(direction) {
            const track = document.getElementById('carousel-track');
            const itemWidth = 280 + 16; // item width + gap
            const visibleItems = Math.floor(track.parentElement.offsetWidth / itemWidth);
            const maxIndex = Math.max(0, carouselProducts.length - visibleItems);

            if (direction === 'next') {
                currentCarouselIndex = Math.min(currentCarouselIndex + 1, maxIndex);
            } else {
                currentCarouselIndex = Math.max(currentCarouselIndex - 1, 0);
            }

            track.style.transform = `translateX(-${currentCarouselIndex * itemWidth}px)`;
        }

        let autoSlideInterval;
        function startAutoSlide() {
            const autoSlideDelay = window.performanceTuning
                ? window.performanceTuning.getAdaptiveInterval(4000, {
                    lowMultiplier: 2,
                    highMultiplier: 0.75,
                    min: 3000,
                    max: 9000
                })
                : 4000;

            autoSlideInterval = setInterval(() => {
                const track = document.getElementById('carousel-track');
                const itemWidth = 280 + 16;
                const visibleItems = Math.floor(track.parentElement.offsetWidth / itemWidth);
                const maxIndex = Math.max(0, carouselProducts.length - visibleItems);

                if (currentCarouselIndex >= maxIndex) {
                    currentCarouselIndex = 0;
                } else {
                    currentCarouselIndex++;
                }

                track.style.transform = `translateX(-${currentCarouselIndex * itemWidth}px)`;
            }, autoSlideDelay);
        }

        function stopAutoSlide() {
            if (autoSlideInterval) {
                clearInterval(autoSlideInterval);
            }
        }

        // Search functionality
        function handleSearch() {
            const searchInput = document.getElementById('home-search-input');
            const query = searchInput.value.trim();
            if (query) {
                window.location.href = `/products?search=${encodeURIComponent(query)}`;
            }
        }

        function renderSearchSuggestions(suggestions, query) {
            const container = document.getElementById('home-search-suggestions');
            if (!container) return;

            if (!query || suggestions.length === 0) {
                container.innerHTML = suggestions.length === 0 && query
                    ? '<div class="search-suggestions-empty">No matches found</div>'
                    : '';
                container.classList.toggle('hidden', !query);
                return;
            }

            container.innerHTML = suggestions.map(item => {
                const image = item.image_url || '/images/placeholder.jpg';
                const typeLabel = item.type === 'category' ? 'Category' : 'Product';
                const meta = item.type === 'product' && item.price
                    ? (() => {
                        const base = parseFloat(item.price || 0);
                        const discount = item.discount_price != null ? parseFloat(item.discount_price) : null;
                        const retail = discount != null && discount < base ? discount : base;
                        if (discount != null && discount < base) {
                            return `${typeLabel} ‚Ä¢ ${formatCurrency(retail)} (was ${formatCurrency(base)})`;
                        }
                        return `${typeLabel} ‚Ä¢ ${formatCurrency(retail)}`;
                    })()
                    : typeLabel;

                return `
                    <div class="search-suggestion-item" data-type="${item.type}" data-id="${item.id}">
                        <img src="${image}" alt="${item.name}" class="search-suggestion-image" onerror="this.src='/images/placeholder.jpg'">
                        <div class="search-suggestion-text">
                            <div class="search-suggestion-name">${item.name}</div>
                            <div class="search-suggestion-meta">${meta}</div>
                        </div>
                    </div>
                `;
            }).join('');

            container.classList.remove('hidden');

            // Click handling
            container.querySelectorAll('.search-suggestion-item').forEach(el => {
                el.addEventListener('click', () => {
                    const type = el.getAttribute('data-type');
                    const id = el.getAttribute('data-id');

                    if (type === 'category') {
                        window.location.href = `/products?category=${encodeURIComponent(id)}`;
                    } else {
                        window.location.href = `/product-details?id=${encodeURIComponent(id)}`;
                    }
                });
            });
        }

        async function loadSearchSuggestions(query) {
            const trimmed = query.trim().toLowerCase();
            const container = document.getElementById('home-search-suggestions');
            if (!container) return;

            if (!trimmed) {
                container.innerHTML = '';
                container.classList.add('hidden');
                return;
            }

            // Build suggestions from in-memory products and categories
            const productMatches = (carouselProducts || []).filter(p => {
                const name = (p.name || '').toLowerCase();
                return name.includes(trimmed);
            }).slice(0, 8).map(p => ({
                type: 'product',
                id: p.id,
                name: p.name,
                image_url: p.image_url,
                price: p.price
            }));

            const categoryMatches = (homeCategories || []).filter(c => {
                const name = (c.name || '').toLowerCase();
                return name.includes(trimmed);
            }).slice(0, 5).map(c => ({
                type: 'category',
                id: c.id,
                name: c.name,
                image_url: c.image_url
            }));

            const suggestions = [...productMatches, ...categoryMatches];
            renderSearchSuggestions(suggestions, trimmed);
        }

        function debounce(fn, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => fn.apply(this, args), wait);
            };
        }

        const debouncedSuggestions = debounce(loadSearchSuggestions, 300);

        // Initialize page
        document.addEventListener('DOMContentLoaded', () => {
            loadCategories();
            loadHomepageSections();
            loadCarouselProducts();

            // Wire carousel navigation
            document.getElementById('carousel-prev').addEventListener('click', () => {
                stopAutoSlide();
                slideCarousel('prev');
                startAutoSlide();
            });

            document.getElementById('carousel-next').addEventListener('click', () => {
                stopAutoSlide();
                slideCarousel('next');
                startAutoSlide();
            });

            // Wire search
            const searchInput = document.getElementById('home-search-input');
            const searchBtn = document.getElementById('home-search-btn');
            const suggestionsContainer = document.getElementById('home-search-suggestions');

            if (searchBtn) {
                searchBtn.addEventListener('click', handleSearch);
            }

            if (searchInput) {
                searchInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleSearch();
                    }
                });

                searchInput.addEventListener('input', (e) => {
                    debouncedSuggestions(e.target.value || '');
                });

                searchInput.addEventListener('focus', (e) => {
                    if (e.target.value && e.target.value.trim().length >= 2) {
                        debouncedSuggestions(e.target.value);
                    }
                });
            }

            // Hide suggestions on click outside
            document.addEventListener('click', (e) => {
                if (!suggestionsContainer) return;
                const isInsideSearch = e.target.closest('.search-container');
                if (!isInsideSearch) {
                    suggestionsContainer.classList.add('hidden');
                }
            });

            // Account dropdown toggle
            const accountToggle = document.getElementById('account-toggle');
            const accountDropdown = document.getElementById('account-dropdown');

            if (accountToggle && accountDropdown) {
                accountToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    accountDropdown.classList.toggle('hidden');
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.account-menu')) {
                        accountDropdown.classList.add('hidden');
                    }
                });
            }

            // Account logout handler
            const accountLogout = document.getElementById('account-logout');
            if (accountLogout) {
                accountLogout.addEventListener('click', async () => {
                    if (await showConfirmDialog('Are you sure you want to logout?', { title: 'Logout', confirmText: 'Logout' })) {
                        await auth.logout();
                    }
                });
            }
        });
    </script>
</body>
</html>
